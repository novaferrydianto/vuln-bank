---
- name: Deploy VulnBank App to Hosting
  hosts: hosting
  become: true

  vars:
    app_dir: /opt/vuln-bank
    source_path: "/tmp/vulnbank-latest"

  tasks:

    - name: Sync latest project files from bastion â†’ hosting
      ansible.posix.synchronize:
        src: "{{ source_path }}/"
        dest: "{{ app_dir }}/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.github"
          - "--exclude=ansible"
          - "--exclude=*.md"
      delegate_to: bastion-node

    - name: Ensure .env exists
      ansible.builtin.command: cp .env.example .env
      args:
        chdir: "{{ app_dir }}"
        creates: "{{ app_dir }}/.env"

    - name: Docker compose down
      ansible.builtin.command: docker compose down
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: true

    - name: Rebuild and restart app
      ansible.builtin.command: docker compose up -d --build
      args:
        chdir: "{{ app_dir }}"

    - name: Prune dangling images
      ansible.builtin.command: docker image prune -f

    - name: Wait for app to be ready
      ansible.builtin.pause:
        seconds: 20

    - name: Health check HTTP
      ansible.builtin.command: curl -f http://localhost:5000
      register: health
      failed_when: health.rc != 0
