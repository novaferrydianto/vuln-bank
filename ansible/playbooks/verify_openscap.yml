---
- name: Verify CIS Compliance Post-Hardening (v5)
  hosts: hosting-node
  become: true

  vars:
    scap_data_path: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    profile_id: xccdf_org.ssgproject.content_profile_cis_server_l1

    scap_results_xml: /root/openscap-results.xml
    scap_report_html: /root/openscap-report.html

    compliance_threshold: 90

  tasks:
    - name: Ensure xmllint installed
      ansible.builtin.package:
        name: libxml2
        state: present

    - name: Run OpenSCAP CIS Server Level 1 Scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile {{ profile_id }}
        --results {{ scap_results_xml }}
        --report {{ scap_report_html }}
        {{ scap_data_path }}
      register: scan_result
      failed_when: scan_result.rc not in [0,2]
      changed_when: true

    - name: Check XML exists
      stat:
        path: "{{ scap_results_xml }}"
      register: xml_stat

    - name: Fail if XML missing
      fail:
        msg: "OpenSCAP XML missing — scan failed."
      when: not xml_stat.stat.exists

    # -------------------------------------------------------------
    # XML PARSING (PRIMARY)
    # -------------------------------------------------------------
    - name: Extract score from XML (namespace-agnostic)
      command: >
        xmllint --xpath
        'string(//*[local-name()="score"][1])'
        {{ scap_results_xml }}
      register: xml_score_raw_cmd
      failed_when: false
      changed_when: false

    - name: Normalize XML score
      set_fact:
        xml_score_raw: "{{ xml_score_raw_cmd.stdout | trim }}"

    - name: Extract numeric XML score
      set_fact:
        xml_score_num: "{{ xml_score_raw | regex_search('([0-9]+(?:\\.[0-9]+)?)', '\\1') }}"
      when: xml_score_raw | length > 0

    # -------------------------------------------------------------
    # HTML PARSING (FALLBACK)
    # -------------------------------------------------------------
    - name: Slurp HTML
      slurp:
        path: "{{ scap_report_html }}"
      register: html_raw
      when: xml_score_num is not defined

    - name: Decode HTML
      set_fact:
        html_text: "{{ html_raw.content | b64decode }}"
      when: html_raw is defined

    - name: Extract score from HTML
      set_fact:
        html_score_num: "{{ html_text | regex_search('([0-9]+(?:\\.[0-9]+)?)%', '\\1') }}"
      when: html_text is defined

    # -------------------------------------------------------------
    # FINAL SCORE DECISION
    # -------------------------------------------------------------
    - name: Final score string
      set_fact:
        final_score_str: >-
          {% if xml_score_num is defined and xml_score_num|length > 0 %}
          {{ xml_score_num }}
          {% elif html_score_num is defined and html_score_num|length > 0 %}
          {{ html_score_num }}
          {% else %}
          ''
          {% endif %}

    - name: Convert to float (if exists)
      set_fact:
        final_score_num: "{{ final_score_str | float }}"
      when: final_score_str | length > 0

    # -------------------------------------------------------------
    # SUMMARY
    # -------------------------------------------------------------
    - name: Summary
      debug:
        msg:
          - "XML score raw : {{ xml_score_raw | default('N/A') }}"
          - "XML numeric   : {{ xml_score_num | default('N/A') }}"
          - "HTML numeric  : {{ html_score_num | default('N/A') }}"
          - "Final score   : {{ final_score_str | default('unknown') }}"
          - "Threshold     : {{ compliance_threshold }}"

    # -------------------------------------------------------------
    # DECISION GATE
    # -------------------------------------------------------------
    - name: Fail only if valid score < threshold
      fail:
        msg: "❌ HARDENING FAILED — Score {{ final_score_num }} < Threshold {{ compliance_threshold }}"
      when:
        - final_score_num is defined
        - final_score_num < compliance_threshold

    - name: Warn if score cannot be parsed
      debug:
        msg: "⚠ Score could not be parsed; check HTML manually. Pipeline not failed."
      when: final_score_num is not defined
