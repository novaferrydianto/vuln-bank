---
- name: Verify CIS Compliance Post-Hardening (v5-final)
  hosts: hosting
  become: true

  vars:
    scap_data_path: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    cis_profile: xccdf_org.ssgproject.content_profile_cis_server_l1
    results_xml: /root/openscap-results.xml
    report_html: /root/openscap-report.html
    compliance_threshold: 90

  tasks:
    - name: Ensure xmllint installed
      ansible.builtin.package:
        name: libxml2
        state: present

    - name: Run OpenSCAP CIS Server Level 1 Scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile {{ cis_profile }}
        --results {{ results_xml }}
        --report {{ report_html }}
        {{ scap_data_path }}
      register: oscap_result
      changed_when: true
      failed_when: oscap_result.rc not in [0, 2]

    - name: Check results XML exists
      ansible.builtin.stat:
        path: "{{ results_xml }}"
      register: results_xml_stat

    - name: Fail if XML missing
      ansible.builtin.fail:
        msg: "‚ùå OpenSCAP results XML not found at {{ results_xml }}"
      when: not results_xml_stat.stat.exists

    - name: Extract CIS score from XML (namespace-agnostic)
      ansible.builtin.command: >
        xmllint --xpath "string(//*[local-name()='score'][1])" {{ results_xml }}
      register: score_cmd
      changed_when: false
      failed_when: score_cmd.rc != 0

    - name: Convert CIS score
      ansible.builtin.set_fact:
        cis_score_raw: "{{ score_cmd.stdout | trim }}"
        cis_score_percent: "{{ (score_cmd.stdout | float) | round(1) }}"

    - name: Debug score
      ansible.builtin.debug:
        msg:
          - "CIS Score : {{ cis_score_percent }}%"
          - "Threshold : {{ compliance_threshold }}%"

    - name: FAIL if below threshold
      ansible.builtin.fail:
        msg: "‚ùå HARDENING FAILED ‚Äî Score {{ cis_score_percent }}% < Threshold {{ compliance_threshold }}%"
      when: cis_score_percent | float < compliance_threshold | float

    # GitHub Actions Summary Output
    - name: Set summary path
      ansible.builtin.set_fact:
        gha_summary_path: "{{ lookup('env', 'GITHUB_STEP_SUMMARY') | default('', true) }}"

    - name: Publish CIS score to GitHub Actions Summary
      ansible.builtin.shell: |
        cat << EOF >> "{{ gha_summary_path }}"
        ## üõ°Ô∏è CIS OpenSCAP Result ‚Äî Rocky Linux 9
        - Host: {{ inventory_hostname }}
        - Score: **{{ cis_score_percent }}%**
        - Threshold: **{{ compliance_threshold }}%**
        - Status: {{ '‚úÖ PASS' if cis_score_percent | float >= compliance_threshold | float else '‚ùå FAIL' }}
        EOF
      args:
        executable: /bin/bash
      when: gha_summary_path | length > 0
      delegate_to: localhost
      changed_when: false
