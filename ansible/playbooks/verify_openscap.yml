---
- name: Verify CIS Compliance Post-Hardening (v3.1)
  hosts: hosting-node
  become: true
  vars:
    scap_profile: xccdf_org.ssgproject.content_profile_cis_server_l1
    scap_ds: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    report_xml: /root/openscap-results.xml
    report_html: /root/openscap-report.html
    compliance_threshold: 90

  tasks:
    # -------------------------------------------------------------
    # 1. RUN FINAL SCAN
    # -------------------------------------------------------------
    - name: Run OpenSCAP CIS Server Level 1 Scan
      command: >
        oscap xccdf eval
        --profile {{ scap_profile }}
        --results {{ report_xml }}
        --report {{ report_html }}
        {{ scap_ds }}
      register: scan_res
      failed_when: scan_res.rc not in [0,2]

    # -------------------------------------------------------------
    # 2. FETCH TO BASTION
    # -------------------------------------------------------------
    - name: Fetch OpenSCAP XML to Bastion
      fetch:
        src: "{{ report_xml }}"
        dest: "./openscap_results.xml"
        flat: yes

    - name: Fetch OpenSCAP HTML to Bastion
      fetch:
        src: "{{ report_html }}"
        dest: "./openscap_report.html"
        flat: yes

    # -------------------------------------------------------------
    # 3. PARSE SCORE (XPATH → REGEX STRICT → REGEX LENIENT → FAILSAFE)
    # -------------------------------------------------------------
    - name: Extract score via XPATH
      xml:
        path: "./openscap_results.xml"
        content: text
        xpath: "/Benchmark/RuleResult/score | //score"
      register: xpath_score
      failed_when: false

    - name: Save XPATH score
      set_fact:
        score_xpath: "{{ xpath_score.matches[0] | default('') }}"
      failed_when: false

    - name: Extract score via strict regex
      shell: "grep -Po '(?<=<score>)[0-9\\.]+(?=</score>)' ./openscap_results.xml || true"
      register: strict_regex_score
      changed_when: false

    - name: Extract score via lenient regex
      shell: "grep -Po '[0-9]{1,3}\\.[0-9]{1,2}' ./openscap_results.xml | head -n 1 || true"
      register: fallback_regex_score
      changed_when: false

    - name: Finalize score (multi fallback)
      set_fact:
        final_compliance_score: >-
          {{
            score_xpath
            if (score_xpath | string | length > 0)
            else (
              strict_regex_score.stdout
              if (strict_regex_score.stdout | string | length > 0)
              else (
                fallback_regex_score.stdout
                if (fallback_regex_score.stdout | string | length > 0)
                else '0.0'
              )
            )
          }}

    - name: Debug final score
      debug:
        msg:
          - "Final Score (raw): {{ final_compliance_score }}"
          - "Threshold      : {{ compliance_threshold }}"

    # -------------------------------------------------------------
    # 4. FAIL IF LOW SCORE
    # -------------------------------------------------------------
    - name: FAIL if compliance score is below threshold
      fail:
        msg: "❌ HARDENING FAILED — Score {{ final_compliance_score }}% < Threshold {{ compliance_threshold }}%"
      when: (final_compliance_score | float) < (compliance_threshold | float)

    - name: SUCCESS summary
      debug:
        msg: "✅ HARDENING PASS — Score {{ final_compliance_score }}%"
      when: (final_compliance_score | float) >= (compliance_threshold | float)
