---
- name: Verify CIS Compliance Post-Hardening (v6-final)
  hosts: hosting
  become: true

  vars:
    scap_data_path: "{{ scap_data_path | default('/usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml') }}"
    cis_profile: "{{ cis_profile | default('xccdf_org.ssgproject.content_profile_cis_server_l1') }}"
    results_xml: "{{ results_xml | default('/root/openscap-results.xml') }}"
    report_html: "{{ report_html | default('/root/openscap-report.html') }}"
    compliance_threshold: "{{ cis_min_score | default(90) }}"

  tasks:
    # -------------------------------------------------------------
    # PREP
    # -------------------------------------------------------------
    - name: Ensure xmllint installed
      ansible.builtin.package:
        name: libxml2
        state: present

    # -------------------------------------------------------------
    # RUN SCAN
    # -------------------------------------------------------------
    - name: Run OpenSCAP CIS Server Level 1 Scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile {{ cis_profile }}
        --results {{ results_xml }}
        --report {{ report_html }}
        {{ scap_data_path }}
      register: oscap_result
      changed_when: true
      failed_when: oscap_result.rc not in [0, 2]

    - name: Check results XML exists
      ansible.builtin.stat:
        path: "{{ results_xml }}"
      register: xml_stat

    - name: Fail if XML missing
      ansible.builtin.fail:
        msg: "‚ùå OpenSCAP results XML not found at {{ results_xml }}"
      when: not xml_stat.stat.exists

    # -------------------------------------------------------------
    # EXTRACT SCORE (Namespace-agnostic)
    # -------------------------------------------------------------
    - name: Extract CIS score via XPATH
      ansible.builtin.command: >
        xmllint --xpath "string(//*[local-name()='score'][1])" {{ results_xml }}
      register: xpath_score
      changed_when: false
      failed_when: xpath_score.rc != 0

    - name: Normalize score
      ansible.builtin.set_fact:
        cis_score_raw: "{{ xpath_score.stdout | trim }}"
        cis_score_percent: "{{ (xpath_score.stdout | float | round(1)) if xpath_score.stdout|length > 0 else 0 }}"

    # Extra fallback: if score missing or 0.0 ‚Üí mark as failure
    - name: Validate extracted score
      ansible.builtin.fail:
        msg: "‚ùå Invalid CIS score extracted: '{{ cis_score_raw }}'. Scan may have failed."
      when: cis_score_percent == 0

    # -------------------------------------------------------------
    # SHOW RESULT
    # -------------------------------------------------------------
    - name: Debug final score
      ansible.builtin.debug:
        msg:
          - "CIS SCORE     : {{ cis_score_percent }}%"
          - "MIN THRESHOLD : {{ compliance_threshold }}%"
          - "STATUS        : {{ 'PASS' if cis_score_percent|float >= compliance_threshold|float else 'FAIL' }}"

    # -------------------------------------------------------------
    # ENFORCE THRESHOLD
    # -------------------------------------------------------------
    - name: FAIL if below threshold
      ansible.builtin.fail:
        msg: "‚ùå HARDENING FAILED ‚Äî Score {{ cis_score_percent }}% < Threshold {{ compliance_threshold }}%"
      when: cis_score_percent | float < compliance_threshold | float

    # -------------------------------------------------------------
    # GITHUB ACTIONS SUMMARY OUTPUT
    # -------------------------------------------------------------
    - name: Locate GitHub Summary Path
      ansible.builtin.set_fact:
        gha_summary_path: "{{ lookup('env', 'GITHUB_STEP_SUMMARY') | default('', true) }}"

    - name: Publish CIS Score to GitHub Actions Summary
      ansible.builtin.shell: |
        cat << 'EOF' >> "{{ gha_summary_path }}"
        ## üõ°Ô∏è CIS OpenSCAP Compliance ‚Äî Rocky Linux 9
        | Field | Value |
        |-------|-------|
        | Host | **{{ inventory_hostname }}** |
        | Score | **{{ cis_score_percent }}%** |
        | Threshold | **{{ compliance_threshold }}%** |
        | Status | {{ '‚úÖ PASS' if cis_score_percent | float >= compliance_threshold | float else '‚ùå FAIL' }} |

        üìÑ HTML Report: {{ report_html }}
        üì¶ XML Results: {{ results_xml }}
        EOF
      args:
        executable: /bin/bash
      when: gha_summary_path | length > 0
      delegate_to: localhost
      changed_when: false
