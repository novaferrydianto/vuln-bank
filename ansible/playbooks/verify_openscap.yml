---
- name: Verify CIS Compliance Post-Hardening
  hosts: hosting-node
  become: true

  vars:
    scap_data_path: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    compliance_threshold: 90
    result_xml: /root/openscap-results.xml
    result_html: /root/openscap-report.html

  tasks:
    # -------------------------------------------------------------
    # 1. RUN FINAL SCAN
    # -------------------------------------------------------------
    - name: Run OpenSCAP CIS Server Level 1 Scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile xccdf_org.ssgproject.content_profile_cis_server_l1
        --results {{ result_xml }}
        --report {{ result_html }}
        {{ scap_data_path }}
      register: scan_result
      failed_when: scan_result.rc not in [0, 2]

    # -------------------------------------------------------------
    # 2. FETCH RESULTS TO BASTION
    # -------------------------------------------------------------
    - name: Fetch OpenSCAP XML report to Bastion
      ansible.builtin.fetch:
        src: "{{ result_xml }}"
        dest: "/tmp/scap_results/{{ inventory_hostname }}/openscap-results.xml"
        flat: yes

    - name: Fetch OpenSCAP HTML report to Bastion
      ansible.builtin.fetch:
        src: "{{ result_html }}"
        dest: "/tmp/scap_results/{{ inventory_hostname }}/openscap-report.html"
        flat: yes

    # -------------------------------------------------------------
    # 3. PARSE SCORE (LOCALHOST)
    # -------------------------------------------------------------
    - name: Extract compliance score from XML
      ansible.builtin.command: >
        xmllint --xpath 'string(//TestResult/score)'
        /tmp/scap_results/{{ inventory_hostname }}/openscap-results.xml
      register: compliance_score_raw
      delegate_to: localhost

    - name: Convert score to usable float
      ansible.builtin.set_fact:
        final_compliance_score: "{{ compliance_score_raw.stdout | float | round(2) }}"
      delegate_to: localhost

    - name: Debug score type
      debug:
        msg: "Type: {{ final_compliance_score | type_debug }}"
      delegate_to: localhost
      run_once: true

    # -------------------------------------------------------------
    # 4. SECURITY GATE CHECK
    # -------------------------------------------------------------
    - name: FAIL if compliance score is below threshold
      ansible.builtin.fail:
        msg: "❌ HARDENING FAILED — Score {{ final_compliance_score }}% < Threshold {{ compliance_threshold }}%"
      when: (final_compliance_score | float) < (compliance_threshold | float)
      run_once: true

    - name: SUCCESS — Compliance passed!
      ansible.builtin.debug:
        msg: "✅ SECURITY GATE PASSED — Score: {{ final_compliance_score }}%"
      when: (final_compliance_score | float) >= (compliance_threshold | float)
      run_once: true

    # -------------------------------------------------------------
    # 5. Auto-open report (only on FAILURE)
    # -------------------------------------------------------------
    - name: Open OpenSCAP report in Firefox (optional)
      ansible.builtin.command: >
        firefox /tmp/scap_results/{{ inventory_hostname }}/openscap-report.html
      delegate_to: localhost
      become: false
      async: 0
      poll: 0
      ignore_errors: true
      when:
        - ansible_env.DISPLAY is defined
        - final_compliance_score < compliance_threshold
