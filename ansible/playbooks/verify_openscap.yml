---
- name: Verify CIS Compliance Post-Hardening
  hosts: hosting-node
  become: true
  vars:
    scap_data_path: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    report_file: /root/openscap-report.html
    compliance_threshold: 90

  tasks:
    # -------------------------------------------------------------
    # 1. RUN FINAL SCAN
    # -------------------------------------------------------------
    - name: Run OpenSCAP Compliance Scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile xccdf_org.ssgproject.content_profile_cis_server_l1
        --results /root/openscap-results.xml
        --report /root/openscap-report.html
        {{ scap_data_path }}
      register: scan_result
      failed_when: scan_result.rc not in [0, 2]

    # -------------------------------------------------------------
    # 2. FETCH RESULTS XML TO BASTION (LOCALHOST)
    # -------------------------------------------------------------
    - name: Fetch OpenSCAP XML Results to Bastion
      ansible.builtin.fetch:
        src: /root/openscap-results.xml
        dest: /tmp/scap_results/{{ inventory_hostname }}/openscap-results.xml
        flat: yes

    # -------------------------------------------------------------
    # 3. PARSE SCORE FROM XML (LOCALHOST)
    # -------------------------------------------------------------
    - name: Extract compliance score from XML
      ansible.builtin.command: >
        xmllint --xpath 'string(//TestResult/score)'
        /tmp/scap_results/{{ inventory_hostname }}/openscap-results.xml
      register: compliance_score_raw
      delegate_to: localhost

    - name: Convert score to float and set fact
      ansible.builtin.set_fact:
        final_compliance_score: "{{ compliance_score_raw.stdout | float | round(2) }}"
      delegate_to: localhost
      run_once: true

    # -------------------------------------------------------------
    # 4. SECURITY GATE CHECK
    # -------------------------------------------------------------
    - name: FAIL if Compliance Score is below threshold
      ansible.builtin.fail:
        msg: "❌ HARDENING FAILED! Compliance score ({{ final_compliance_score }}%) is below requirement ({{ compliance_threshold }}%)."
      when: (final_compliance_score | float) < (compliance_threshold | float)
      delegate_to: bastion-node
      run_once: true

    - name: SUCCESS — Allow deployment
      ansible.builtin.debug:
        msg: "✅ SECURITY GATE PASSED — Score: {{ final_compliance_score }}%. Proceeding..."
      when: (final_compliance_score | float) >= (compliance_threshold | float)
      delegate_to: localhost
      run_once: true
