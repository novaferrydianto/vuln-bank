---
# ==============================================================
# VERIFY CIS COMPLIANCE (v3)
# + Universal Parser
# + Summary output
# + Guaranteed final_compliance_score always exists
# ==============================================================

- name: Verify CIS Compliance Post-Hardening (v3)
  hosts: hosting-node
  become: true
  vars:
    scap_data_path: /usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml
    report_xml: /root/openscap-results.xml
    report_html: /root/openscap-report.html
    compliance_threshold: 90

  tasks:

    # -------------------------------------------------------------
    # 1. RUN FINAL SCAN
    # -------------------------------------------------------------
    - name: Run OpenSCAP CIS Server Level 1 Scan
      command: >
        oscap xccdf eval
        --profile xccdf_org.ssgproject.content_profile_cis_server_l1
        --results {{ report_xml }}
        --report {{ report_html }}
        {{ scap_data_path }}
      register: scan_result
      failed_when: scan_result.rc not in [0, 2]

    # -------------------------------------------------------------
    # 2. FETCH REPORTS KE BASTION
    # -------------------------------------------------------------
    - name: Fetch OpenSCAP XML to Bastion
      fetch:
        src: "{{ report_xml }}"
        dest: "./openscap-results.xml"
        flat: yes

    - name: Fetch OpenSCAP HTML to Bastion
      fetch:
        src: "{{ report_html }}"
        dest: "./openscap-report.html"
        flat: yes

    # -------------------------------------------------------------
    # 3. EXTRACT SCORE (v3 ‚Äî dual parser)
    # -------------------------------------------------------------
    - name: Extract score via XPATH
      delegate_to: localhost
      command: >
        xmllint --xpath "string(//score[1])" openscap-results.xml
      register: score_xpath
      failed_when: false

    - name: Extract score via regex fallback
      delegate_to: localhost
      set_fact:
        score_regex: >-
          {{
            lookup('file', 'openscap-results.xml')
            | regex_search('(?s)<score[^>]*>([0-9.]+)</score>', '\\1')
          }}

    - name: Determine final score (v3)
      delegate_to: localhost
      set_fact:
        final_compliance_score: >-
          {{
            (score_xpath.stdout | trim)
            if (score_xpath.stdout | trim != '')
            else (score_regex | default('0') | trim)
          }}

    - name: Debug final score
      delegate_to: localhost
      debug:
        msg: "üîé FINAL SCORE: {{ final_compliance_score }}% (Threshold: {{ compliance_threshold }}%)"

    # -------------------------------------------------------------
    # 4. PUSH SUMMARY KE GITHUB STEP SUMMARY
    # -------------------------------------------------------------
    - name: Write GitHub Summary
      delegate_to: localhost
      become: false
      run_once: true
      environment:
        GITHUB_STEP_SUMMARY: "{{ lookup('env', 'GITHUB_STEP_SUMMARY') }}"
      shell: |
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## üõ°Ô∏è CIS Hardening Summary (OpenSCAP v3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Final Score**: {{ final_compliance_score }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold**: {{ compliance_threshold }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **XML Report**: openscap-results.xml" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Report**: openscap-report.html" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $(printf "%.0f" {{ final_compliance_score }}) -lt {{ compliance_threshold }} ]; then
            echo "‚ùå Hardening FAILED (score < threshold)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Hardening PASSED (score ‚â• threshold)" >> $GITHUB_STEP_SUMMARY
          fi
        fi

    # -------------------------------------------------------------
    # 5. PASS / FAIL (Stable)
    # -------------------------------------------------------------
    - name: FAIL if compliance score is below threshold
      fail:
        msg: "‚ùå HARDENING FAILED ‚Äî Score {{ final_compliance_score }}% < Threshold {{ compliance_threshold }}%"
      when: final_compliance_score | float < compliance_threshold | float

    - name: SUCCESS ‚Äî CIS Hardening Passed
      debug:
        msg: "üéâ SUCCESS ‚Äî Score {{ final_compliance_score }}% ‚â• Threshold {{ compliance_threshold }}%"
      when: final_compliance_score | float >= compliance_threshold | float
