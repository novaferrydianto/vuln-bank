---
- name: Verify OpenSCAP CIS score
  hosts: hosting,db
  become: true

  vars:
    cis_min_score: "{{ cis_min_score | default(0.8) }}"

  tasks:
    - name: Read last OpenSCAP score
      command: awk -F= '/score/ {print $2}' /var/oscap/last-score.txt
      register: score_cmd
      changed_when: false
      failed_when: false

    - name: Set fact for score
      set_fact:
        cis_score: "{{ score_cmd.stdout | default('0') | float }}"

    - name: Fail if score below threshold
      fail:
        msg: "CIS score {{ cis_score }} is below minimum {{ cis_min_score }}"
      when: cis_score < cis_min_score
