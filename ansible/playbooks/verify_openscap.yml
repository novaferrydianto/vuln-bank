---
- name: Verify OpenSCAP CIS score
  hosts: hosting
  become: true

  tasks:
    - name: Jalankan OpenSCAP evaluation
      command: >
        oscap xccdf eval
        --profile {{ cis_profile }}
        --results /var/tmp/openscap-results.xml
        --report /var/tmp/openscap-report.html
        /usr/share/xml/scap/ssg/content/ssg-rocky9-ds.xml
      register: oscap_eval
      changed_when: false

    - name: Parse score dari results.xml (simple grep)
      command: "grep -m1 'score system' /var/tmp/openscap-results.xml"
      register: oscap_score_raw
      changed_when: false

    - name: Print score raw (manual check)
      debug:
        msg: "{{ oscap_score_raw.stdout }}"

    - name: Fail jika score di bawah minimum
      fail:
        msg: "CIS score di bawah {{ cis_min_score }} â€” perbaiki dulu sebelum deploy."
      when: cis_min_score | int > 80  # adjust condition sesuai parsing real
