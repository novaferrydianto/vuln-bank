# ansible/playbooks/setup_monitoring_v4.yml
---
- name: Setup Monitoring Stack (Prometheus + Grafana) on Bastion
  hosts: bastion-node
  become: true
  vars:
    monitoring_root: /opt/monitoring
    prometheus_dir: /opt/monitoring/prometheus
    alert_rules_dir: /opt/monitoring/prometheus/alert-rules
    grafana_dir: /opt/monitoring/grafana
    prometheus_config: /opt/monitoring/prometheus/prometheus.yml
    docker_compose_file: /opt/monitoring/docker-compose.yml

  tasks:
    - name: Ensure Docker & tools are installed on bastion
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      register: docker_install
      failed_when: false

    - name: Enable & start Docker service on bastion
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create monitoring directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ monitoring_root }}"
        - "{{ prometheus_dir }}"
        - "{{ alert_rules_dir }}"
        - "{{ grafana_dir }}"

    # ---------------------------------------------------------
    # Prometheus config + alert rules
    # ---------------------------------------------------------
    - name: Deploy prometheus.yml (scrape VulnBank exporters)
      copy:
        dest: "{{ prometheus_config }}"
        mode: "0644"
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 30s

          rule_files:
            - "alert-rules/vulnbank-rules.yml"

          scrape_configs:
            - job_name: 'node-exporter'
              static_configs:
                - targets:
                    - '192.168.107.131:9100'  # hosting-node
                    - '192.168.107.130:9100'  # db-node

            - job_name: 'cadvisor'
              static_configs:
                - targets:
                    - '192.168.107.131:8080'  # hosting-node containers

            - job_name: 'postgres-exporter'
              static_configs:
                - targets:
                    - '192.168.107.130:9187'  # db-node postgres_exporter

    - name: Deploy VulnBank alert rules
      copy:
        dest: "{{ alert_rules_dir }}/vulnbank-rules.yml"
        mode: "0644"
        content: |
          groups:
            - name: vulnbank-core
              rules:
                # 1. Generic: instance / exporter down
                - alert: InstanceDown
                  expr: up == 0
                  for: 2m
                  labels:
                    severity: critical
                  annotations:
                    summary: "Instance {{ $labels.instance }} is DOWN"
                    description: "Prometheus target {{ $labels.job }} on {{ $labels.instance }} is not responding."

                # 2. Hosting-node CPU too high (app node)
                - alert: HostingHighCPU
                  expr: |
                    avg by (instance) (
                      rate(node_cpu_seconds_total{mode!="idle",instance="192.168.107.131:9100"}[5m])
                    ) > 0.85
                  for: 5m
                  labels:
                    severity: warning
                  annotations:
                    summary: "High CPU usage on hosting-node"
                    description: "Average CPU usage > 85% for 5m on hosting-node (VulnBank app)."

                # 3. Hosting-node memory low
                - alert: HostingLowMemory
                  expr: |
                    (node_memory_MemAvailable_bytes{instance="192.168.107.131:9100"} /
                     node_memory_MemTotal_bytes{instance="192.168.107.131:9100"}) < 0.15
                  for: 5m
                  labels:
                    severity: warning
                  annotations:
                    summary: "Low available memory on hosting-node"
                    description: "Available memory < 15% on hosting-node (VulnBank app)."

                # 4. PostgreSQL exporter down (DB critical)
                - alert: PostgresExporterDown
                  expr: up{job="postgres-exporter"} == 0
                  for: 1m
                  labels:
                    severity: critical
                  annotations:
                    summary: "PostgreSQL exporter down"
                    description: "Postgres exporter on db-node is not reachable. Check container postgres_exporter."

                # 5. PostgreSQL not healthy (pg_up = 0)
                - alert: PostgresDown
                  expr: pg_up == 0
                  for: 1m
                  labels:
                    severity: critical
                  annotations:
                    summary: "PostgreSQL is DOWN"
                    description: "pg_up == 0 from postgres_exporter. VulnBank DB is not reachable."

            - name: vulnbank-capacity
              rules:
                # Disk usage near full on hosting-node
                - alert: HostingDiskAlmostFull
                  expr: |
                    (node_filesystem_size_bytes{fstype!~"tmpfs|overlay",instance="192.168.107.131:9100"} -
                     node_filesystem_free_bytes{fstype!~"tmpfs|overlay",instance="192.168.107.131:9100"})
                    /
                    node_filesystem_size_bytes{fstype!~"tmpfs|overlay",instance="192.168.107.131:9100"} > 0.85
                  for: 10m
                  labels:
                    severity: warning
                  annotations:
                    summary: "Hosting-node disk usage > 85%"
                    description: "Disk usage on hosting-node (VulnBank app) is above 85%."

    # ---------------------------------------------------------
    # Docker Compose for Prometheus + Grafana
    # ---------------------------------------------------------
    - name: Deploy monitoring docker-compose.yml
      copy:
        dest: "{{ docker_compose_file }}"
        mode: "0644"
        content: |
          version: "3.8"
          services:
            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              restart: unless-stopped
              volumes:
                - "{{ prometheus_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
                - "{{ alert_rules_dir }}:/etc/prometheus/alert-rules:ro"
              command:
                - "--config.file=/etc/prometheus/prometheus.yml"
                - "--web.enable-lifecycle"
              ports:
                - "9090:9090"

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=admin
              ports:
                - "3000:3000"
              volumes:
                - "{{ grafana_dir }}:/var/lib/grafana"

          networks:
            default:
              name: monitoring_net

    - name: Start Prometheus + Grafana stack
      shell: |
        cd {{ monitoring_root }}
        docker compose down || true
        docker compose up -d
      args:
        executable: /bin/bash

# ====================================================================
# Exporters on hosting-node (app node): node-exporter + cAdvisor
# ====================================================================
- name: Setup exporters on hosting-node
  hosts: hosting-node
  become: true

  tasks:
    - name: Ensure Docker is installed on hosting-node
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      register: docker_install
      failed_when: false

    - name: Enable & start Docker service on hosting-node
      service:
        name: docker
        state: started
        enabled: yes

    # node-exporter
    - name: Pull node-exporter image
      command: docker pull prom/node-exporter:latest
      register: pull_node_exporter
      failed_when: false
      changed_when: "'Downloaded' in pull_node_exporter.stdout or 'Pulling' in pull_node_exporter.stdout"

    - name: Ensure node-exporter container is running
      shell: |
        docker rm -f node-exporter || true
        docker run -d \
          --name node-exporter \
          --restart unless-stopped \
          --net="host" \
          --pid="host" \
          -v "/:/host:ro,rslave" \
          prom/node-exporter:latest \
          --path.rootfs=/host
      args:
        executable: /bin/bash

    # cAdvisor
    - name: Pull cAdvisor image
      command: docker pull gcr.io/cadvisor/cadvisor:latest
      register: pull_cadvisor
      failed_when: false
      changed_when: "'Downloaded' in pull_cadvisor.stdout or 'Pulling' in pull_cadvisor.stdout"

    - name: Ensure cAdvisor container is running
      shell: |
        docker rm -f cadvisor || true
        docker run -d \
          --name cadvisor \
          --restart unless-stopped \
          -p 8080:8080 \
          -v /:/rootfs:ro \
          -v /var/run:/var/run:ro \
          -v /sys:/sys:ro \
          -v /var/lib/docker/:/var/lib/docker:ro \
          gcr.io/cadvisor/cadvisor:latest
      args:
        executable: /bin/bash

# ====================================================================
# node-exporter on db-node (biar DB OS-nya ke-monitor juga)
# ====================================================================
- name: Setup node-exporter on db-node
  hosts: db-node
  become: true

  tasks:
    - name: Ensure Docker is installed on db-node
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      register: docker_install
      failed_when: false

    - name: Enable & start Docker service on db-node
      service:
        name: docker
        state: started
        enabled: yes

    - name: Pull node-exporter image on db-node
      command: docker pull prom/node-exporter:latest
      register: pull_node_exporter_db
      failed_when: false
      changed_when: "'Downloaded' in pull_node_exporter_db.stdout or 'Pulling' in pull_node_exporter_db.stdout"

    - name: Ensure node-exporter container is running on db-node
      shell: |
        docker rm -f node-exporter || true
        docker run -d \
          --name node-exporter \
          --restart unless-stopped \
          --net="host" \
          --pid="host" \
          -v "/:/host:ro,rslave" \
          prom/node-exporter:latest \
          --path.rootfs=/host
      args:
        executable: /bin/bash
