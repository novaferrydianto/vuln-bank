---
- name: Setup DB server with PostgreSQL 16 (stable docker_container)
  hosts: db-node
  become: true
  vars:
    pg_version: "16"
    pg_user: "postgres"
    pg_password: "postgres"
    pg_db: "vulnerable_bank"
    pg_port: "5432"
    pg_data_dir: "/opt/postgres-data"

  tasks:

    - name: Ensure required system packages are installed
      dnf:
        name:
          - dnf-plugins-core
          - python3
          - python3-pip
        state: present

    - name: Install Docker CE repo
      ansible.builtin.command: >
        dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    - name: Enable + start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add DB user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Create PostgreSQL data dir
      ansible.builtin.file:
        path: "{{ pg_data_dir }}"
        state: directory
        owner: 999
        group: 999
        mode: '0755'

    # ===============================================================
    #  PULL IMAGE
    # ===============================================================

    - name: Pull PostgreSQL 16 image
      community.docker.docker_image:
        name: "postgres:{{ pg_version }}"
        source: pull

    # ===============================================================
    #  RUN POSTGRES CONTAINER (STABLE)
    # ===============================================================

    - name: Run PostgreSQL 16 container (stable mode)
      community.docker.docker_container:
        name: vuln-postgres
        image: "postgres:{{ pg_version }}"
        state: started
        restart_policy: always
        env:
          POSTGRES_DB: "{{ pg_db }}"
          POSTGRES_USER: "{{ pg_user }}"
          POSTGRES_PASSWORD: "{{ pg_password }}"
          PGDATA: "/var/lib/postgresql/data"
        volumes:
          - "{{ pg_data_dir }}:/var/lib/postgresql/data"
        published_ports:
          - "{{ pg_port }}:5432"
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U {{ pg_user }}"]
          interval: 10s
          timeout: 5s
          retries: 5

    - name: Show running containers
      community.docker.docker_container_info:
        name: vuln-postgres
      register: db_info

    - name: Display container info
      debug:
        var: db_info
