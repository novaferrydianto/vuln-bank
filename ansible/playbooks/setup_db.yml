---
- name: Setup DB server with PostgreSQL 16 (stable docker_container)
  hosts: db-node
  become: true
  vars:
    pg_version: "16"
    pg_user: "postgres"
    pg_password: "postgres"
    pg_db: "vulnerable_bank"
    pg_port: "5432"
    pg_data_dir: "/opt/postgres-data"

  tasks:

    - name: Ensure required system packages are installed
      dnf:
        name:
          - dnf-plugins-core
          - python3
          - python3-pip
        state: present

    - name: Install Docker CE repo
      ansible.builtin.command: >
        dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    - name: Enable + start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add DB user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Force Ansible connection to reset for new group permissions
      # Kritis: Memaksa sesi SSH diakhiri dan dibuka kembali untuk memuat ulang izin grup 'docker'.
      ansible.builtin.meta: reset_connection

    - name: Create PostgreSQL data dir
      ansible.builtin.file:
        path: "{{ pg_data_dir }}"
        state: directory
        owner: 999
        group: 999
        mode: '0755'

    # ===============================================================
    #  PULL IMAGE
    # ===============================================================

    - name: Pull PostgreSQL 16 image via CLI (stable)
      ansible.builtin.command: "docker pull postgres:16"
      register: pull_output
      changed_when: "'Downloaded' in pull_output.stdout or 'Pulling' in pull_output.stdout"


    # ===============================================================
    #  RUN POSTGRES CONTAINER (STABLE)
    # ===============================================================

    - name: Run PostgreSQL 16 container
      ansible.builtin.command: >
        docker run -d
        --name postgres16
        --restart unless-stopped
        -e POSTGRES_PASSWORD={{ pg_password }}
        -e POSTGRES_USER={{ pg_user }}
        -e POSTGRES_DB={{ pg_db }}
        -v {{ pg_data_dir }}:/var/lib/postgresql/data
        -p 5432:5432
        postgres:16
      args:
        creates: /var/lib/docker/containers

    - name: Show running containers
      community.docker.docker_container_info:
        name: vuln-postgres
      register: db_info

    - name: Display container info
      debug:
        var: db_info
