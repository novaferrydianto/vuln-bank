---
- name: Setup PRO-grade PostgreSQL 16 on DB server
  hosts: db-node
  become: true
  vars:
    pg_version: "16"
    pg_user: "postgres"
    pg_password: "postgres"
    pg_db: "vulnerable_bank"
    pg_port: "5432"
    pg_data_dir: "/opt/postgres-data"
    exporter_port: "9187"
    container_name: "postgres16"
    exporter_name: "postgres_exporter"

  tasks:

    # ---------------------------------------------------------
    # 1. Install dependencies
    # ---------------------------------------------------------
    - name: Ensure required packages are installed
      dnf:
        name:
          - dnf-plugins-core
          - python3
          - python3-pip
        state: present

    - name: Add Docker CE repo
      ansible.builtin.command: >
        dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    - name: Enable & start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add DB user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Reset ssh connection to apply docker group
      meta: reset_connection


    # ---------------------------------------------------------
    # 2. Auto-detect Postgres UID/GID inside the image
    # ---------------------------------------------------------
    - name: Detect UID inside postgres container
      ansible.builtin.command: >
        docker run --rm postgres:{{ pg_version }} id -u
      register: pg_uid
      changed_when: false

    - name: Detect GID inside postgres container
      ansible.builtin.command: >
        docker run --rm postgres:{{ pg_version }} id -g
      register: pg_gid
      changed_when: false

    # ---------------------------------------------------------
    # 3. Create data directory with correct permissions
    # ---------------------------------------------------------
    - name: Create PostgreSQL data directory
      ansible.builtin.file:
        path: "{{ pg_data_dir }}"
        state: directory
        owner: "{{ pg_uid.stdout }}"
        group: "{{ pg_gid.stdout }}"
        mode: "0755"


    # ---------------------------------------------------------
    # 4. Ensure Postgres image exists (pull)
    # ---------------------------------------------------------
    - name: Pull PostgreSQL image
      ansible.builtin.command: "docker pull postgres:{{ pg_version }}"
      register: pull_output
      changed_when: "'Downloaded' in pull_output.stdout or 'Pulling' in pull_output.stdout"


    # ---------------------------------------------------------
    # 5. Ensure Postgres container exists (create or start)
    # ---------------------------------------------------------
    - name: Check if container exists
      ansible.builtin.command: >
        docker ps -a --filter name={{ container_name }} --format '{{ "{{.Names}}" }}'
      register: exists
      changed_when: false

    - name: Start existing stopped container
      ansible.builtin.command: "docker start {{ container_name }}"
      when: exists.stdout != ""


    - name: Create and run PostgreSQL container if not exists
      ansible.builtin.command: >
        docker run -d
        --name {{ container_name }}
        --restart unless-stopped
        -e POSTGRES_USER={{ pg_user }}
        -e POSTGRES_PASSWORD={{ pg_password }}
        -e POSTGRES_DB={{ pg_db }}
        -v {{ pg_data_dir }}:/var/lib/postgresql/data
        -p {{ pg_port }}:5432
        postgres:{{ pg_version }}
      when: exists.stdout == ""


    # ---------------------------------------------------------
    # 6. Wait until Postgres is ready
    # ---------------------------------------------------------
    - name: Wait for PostgreSQL to be ready
      shell: |
        for i in {1..30}; do
          if docker exec {{ container_name }} pg_isready -U {{ pg_user }}; then
            exit 0
          fi
          sleep 2
        done
        exit 1
      register: wait_pg
      retries: 5
      delay: 3
      changed_when: false


    # ---------------------------------------------------------
    # 7. Bootstrap SQL schema / user / table
    # ---------------------------------------------------------
    - name: Ensure schema and initial table exist
      shell: |
        docker exec -u {{ pg_user }} {{ container_name }} psql -d {{ pg_db }} -c "
        CREATE TABLE IF NOT EXISTS accounts (
          id SERIAL PRIMARY KEY,
          username VARCHAR(100),
          balance INTEGER DEFAULT 0
        );"
      register: schema_output
      changed_when: "'CREATE TABLE' in schema_output.stdout"


    # ---------------------------------------------------------
    # 8. Install postgres_exporter for monitoring
    # ---------------------------------------------------------
    - name: Pull postgres_exporter
      ansible.builtin.command: "docker pull quay.io/prometheuscommunity/postgres-exporter"
      register: pull_output_exporter
      changed_when: false

    - name: Ensure postgres_exporter container exists
      ansible.builtin.command: >
        docker run -d
        --name {{ exporter_name }}
        --restart unless-stopped
        -p {{ exporter_port }}:9187
        -e DATA_SOURCE_NAME=postgres://{{ pg_user }}:{{ pg_password }}@localhost:{{ pg_port }}/{{ pg_db }}?sslmode=disable
        quay.io/prometheuscommunity/postgres-exporter
      register: exporter_status
      failed_when: false
      changed_when: "'Unable to find image' in exporter_status.stdout"


    # ---------------------------------------------------------
    # 9. Display containers
    # ---------------------------------------------------------
    - name: Show running containers
      ansible.builtin.command: "docker ps"
      register: psout
      changed_when: false

    - name: Print running containers info
      debug:
        msg: "{{ psout.stdout }}"
