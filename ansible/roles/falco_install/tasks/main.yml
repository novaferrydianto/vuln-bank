---
- name: Ensure dependencies for Falco are installed
  dnf:
    name:
      - curl
      - ca-certificates
    state: present

- name: Import Falco GPG key
  rpm_key:
    state: present
    key: https://falco.org/repo/falcosecurity-packages.asc

- name: Install Falco YUM repo
  get_url:
    url: https://falco.org/repo/falcosecurity-rpm.repo
    dest: /etc/yum.repos.d/falcosecurity.repo
    mode: '0644'

- name: Install Falco
  dnf:
    name: falco
    state: present
    update_cache: true

- name: Ensure Falco service enabled
  service:
    name: falco
    enabled: true

- name: Ensure Falco config directory exists
  file:
    path: /etc/falco
    state: directory
    mode: '0755'

# ----------------------------------------------
# Custom Runtime Rules (Vuln Bank)
# ----------------------------------------------
- name: Deploy custom Falco rules for Vuln Bank
  copy:
    dest: /etc/falco/rules.d/vuln-bank-rules.yaml
    mode: '0644'
    content: |
      - rule: VulnBank Suspicious Shell
        desc: Detect shell executions inside vuln-bank container
        condition: >
          spawned_process and container and
          container.name = "vuln-bank-app" and
          proc.name in (bash, sh, zsh)
        output: >
          VulnBank Suspicious Shell
          (user=%user.name container=%container.name
           proc=%proc.name cmd=%proc.cmdline)
        priority: WARNING
        tags: [vuln-bank, runtime, container]
  notify: restart_falco

# ----------------------------------------------
# Slack Output Configuration
# ----------------------------------------------
- name: Configure Falco Slack output
  blockinfile:
    path: /etc/falco/falco.yaml
    marker: "# {mark} ANSIBLE MANAGED FALCO OUTPUT"
    block: |
      outputs:
        rate: 1
        max_burst: 10
        http_output:
          enabled: true
          url: "{{ falco_slack_webhook }}"
  notify: restart_falco

# ----------------------------------------------
# Validate configuration BEFORE restart
# ----------------------------------------------
- name: Validate Falco configuration
  command: falco --dry-run
  changed_when: false
