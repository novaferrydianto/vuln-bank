---
# Deployment Aplikasi di VM Hosting (User: hosting)

- name: 1. Buat direktori project App
  file:
    path: "{{ remote_app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0750'

- name: 2. Copy docker-compose.yml App
  copy:
    src: "../containers/app/docker-compose.yml"
    dest: "{{ remote_app_dir }}/docker-compose.yml"

# =========================================================
# COSIGN VERIFICATION
# =========================================================

- name: 3. Buat file Kunci Publik Cosign
  copy:
    content: |
      {{ lookup('env', 'COSIGN_PUBLIC_KEY') | replace('\\n', '\n') }}
    dest: /tmp/cosign.pub
    mode: '0644'

- name: 4. Assert required deployment variables
  ansible.builtin.assert:
    that:
      # Variabel diubah dari 'image_digest' menjadi 'image_ref'
      - image_ref is defined 
      - dockerhub_username is defined
      - dockerhub_token is defined
      - db_password is defined
    fail_msg: "Required deployment variables are missing"

- name: 5. Login ke Docker Hub pada Host Target (KRITIS)
  community.docker.docker_login:
    registry_url: https://index.docker.io/v1/
    username: "{{ dockerhub_username }}"
    password: "{{ dockerhub_token }}"

- name: 6. Pull image by digest (safe)
  shell: |
    docker pull "{{ image_ref }}"
  args:
    executable: /bin/bash

- name: 7. Verifikasi Image Docker menggunakan Digest
  shell: "/usr/local/bin/cosign verify --key /tmp/cosign.pub {{ image_ref }}"
  register: cosign_verify
  failed_when: cosign_verify.rc != 0

# =========================================================
# DEPLOYMENT
# =========================================================

- name: 8. Buat file .env untuk Aplikasi
  copy:
    dest: "{{ remote_app_dir }}/.env"
    content: |
      # =========================
      # DATABASE
      # =========================
      DB_HOST={{ db_host }}
      DB_PORT=5432
      DB_NAME=vulnerable_bank
      DB_USER=postgres
      DB_PASSWORD={{ db_password }}

      # =========================
      # APPLICATION SECRETS
      # =========================
      FLASK_SECRET_KEY={{ app_secret }}
      JWT_SECRET_KEY={{ jwt_secret }}
      DEEPSEEK_API_KEY={{ deepseek_key }}

      # =========================
      # IMAGE (IMMUTABLE, DIGEST)
      # =========================
      # KRITIS: Menggunakan {{ image_ref }} yang memuat full image reference
      IMAGE_WITH_TAG={{ image_ref }} 

      # =========================
      # APP CONFIG
      # =========================
      APP_PORT=5000
      DEBUG=false

- name: 9. Restart Container Aplikasi
  community.docker.docker_compose_v2:
    project_src: "{{ remote_app_dir }}"
    state: present
    pull: never

- name: 10. Hapus Kunci Publik (Pembersihan)
  file:
    path: "/tmp/cosign.pub"
    state: absent

- name: 11. Hapus Image Tak Terpakai (Dangling)
  shell: docker image prune -f
  tags: cleanup

- name: 12. Konfigurasi Hardening Nginx (Template)
  become: yes
  template:
    src: "../templates/nginx_hardened.conf.j2"
    dest: "/etc/nginx/conf.d/vuln_bank.conf"
  notify: Restart Nginx

- name: 13. Pastikan Nginx running dan enabled
  become: yes
  systemd:
    name: nginx
    state: started
    enabled: yes