---
# Deployment Aplikasi di VM Hosting (User: hosting)

- name: 1. Buat direktori project App
  file:
    path: "{{ remote_app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0750'

- name: 2. Copy docker-compose.yml App
  copy:
    src: "../containers/app/docker-compose.yml"
    dest: "{{ remote_app_dir }}/docker-compose.yml"

# =========================================================
# COSIGN VERIFICATION
# =========================================================

- name: 3. Buat file Kunci Publik Cosign
  copy:
    # Menggunakan filter | trim untuk membersihkan whitespace/newline yang mungkin merusak PEM
    content: "{{ cosign_pub_key | trim }}" 
    dest: "/tmp/cosign.pub"
    mode: '0644'

# ---------------------------------------------------------
# DIAGNOSTIK KRITIS: Tampilkan Kunci Publik RAW (Ganti Task Diagnostik Lama)
# ---------------------------------------------------------
- name: DIAGNOSTIK: Tampilkan Konten /tmp/cosign.pub (Verifikasi Integritas)
  ansible.builtin.shell: cat /tmp/cosign.pub
  register: cosign_pub_content

- name: DEBUG: Kunci Publik yang Digunakan (Cek Integritas PEM RAW)
  ansible.builtin.debug:
    # Output ini akan menunjukkan raw string kunci yang dibaca Cosign, kita cari spasi/newline rusak di sini
    msg: "KUNCI PUBLIK RAW:\n{{ cosign_pub_content.stdout }}"
# ---------------------------------------------------------

- name: 3.5 Login ke Docker Hub pada Host Target (KRITIS)
  # Menjalankan login docker di VM hosting menggunakan user hosting
  community.docker.docker_login:
    registry_url: https://index.docker.io/v1/
    username: "{{ DOCKERHUB_USERNAME }}"
    password: "{{ DOCKERHUB_TOKEN }}"

- name: 4. Pull Image Terbaru Berdasarkan Digest
  # Menggunakan Digest: [USER]/[IMAGE_NAME]@[DIGEST]
  command: docker pull {{ docker_repo_user }}/vuln-bank@{{ image_digest }}
  args:
    chdir: "{{ remote_app_dir }}"

- name: 5. Verifikasi Image Docker menggunakan Digest
  # Gunakan modul shell dengan full path ke Cosign
  shell: /usr/local/bin/cosign verify --key /tmp/cosign.pub {{ DOCKERHUB_USERNAME }}/vuln-bank@{{ image_digest }}
  args:
    chdir: "{{ remote_app_dir }}"

# =========================================================
# DEPLOYMENT
# =========================================================

- name: 6. Buat file .env untuk Aplikasi
  copy:
    dest: "{{ remote_app_dir }}/.env"
    content: |
      DB_HOST={{ db_host }}
      DB_PORT=5432
      DB_NAME=vulnerable_bank
      DB_USER=postgres
      DB_PASSWORD={{ db_password }}

      FLASK_SECRET_KEY={{ app_secret }}
      JWT_SECRET_KEY={{ jwt_secret }}
      DEEPSEEK_API_KEY={{ deepseek_key }}

      APP_PORT=80
      DEBUG=false

- name: 7. Restart Container Aplikasi
  community.docker.docker_compose_v2:
    project_src: "{{ remote_app_dir }}"
    state: present
    pull: never

- name: 8. Hapus Kunci Publik (Pembersihan)
  file:
    path: "/tmp/cosign.pub"
    state: absent