---
# Deployment Aplikasi di VM Hosting (User: hosting)

- name: 1. Buat direktori project App
  file:
    path: "{{ remote_app_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0750'

- name: 2. Copy docker-compose.yml App
  copy:
    src: "../containers/app/docker-compose.yml"
    dest: "{{ remote_app_dir }}/docker-compose.yml"

# =========================================================
# COSIGN VERIFICATION
# =========================================================

- name: 3. Buat file Kunci Publik Cosign
  copy:
    # Catatan: Variabel COSIGN_PUBLIC_KEY_CLEAN diekspor di run block GitHub Actions
    content: "{{ lookup('env', 'COSIGN_PUBLIC_KEY_CLEAN') | trim }}"
    dest: /tmp/cosign.pub
    mode: '0644'
  no_log: true

- name: Assert required deployment variables
  ansible.builtin.assert:
    that:
      # Variabel diubah dari 'image_digest' menjadi 'image_ref'
      - image_ref is defined 
      - dockerhub_username is defined
      - dockerhub_token is defined
      - db_password is defined
    fail_msg: "Required deployment variables are missing"

- name: 3.5 Login ke Docker Hub pada Host Target (KRITIS)
  community.docker.docker_login:
    registry_url: https://index.docker.io/v1/
    username: "{{ dockerhub_username }}"
    password: "{{ dockerhub_token }}"

- name: 4. Pull Image Terbaru Berdasarkan Digest
  # KRITIS: Menggunakan {{ image_ref }} yang dikirim dari GitHub Actions
  command: docker pull {{ image_ref }}
  args:
    chdir: "{{ remote_app_dir }}"

- name: 5. Verifikasi Image Docker menggunakan Digest
  # KRITIS: Menggunakan {{ image_ref }}
  shell: >
    /usr/local/bin/cosign verify
    --key /tmp/cosign.pub
    {{ image_ref }}
  args:
    chdir: "{{ remote_app_dir }}"
  register: cosign_verify
  failed_when: cosign_verify.rc != 0

# =========================================================
# DEPLOYMENT
# =========================================================

- name: 6. Buat file .env untuk Aplikasi
  copy:
    dest: "{{ remote_app_dir }}/.env"
    content: |
      # =========================
      # DATABASE
      # =========================
      DB_HOST={{ db_host }}
      DB_PORT=5432
      DB_NAME=vulnerable_bank
      DB_USER=postgres
      DB_PASSWORD={{ db_password }}

      # =========================
      # APPLICATION SECRETS
      # =========================
      FLASK_SECRET_KEY={{ app_secret }}
      JWT_SECRET_KEY={{ jwt_secret }}
      DEEPSEEK_API_KEY={{ deepseek_key }}

      # =========================
      # IMAGE (IMMUTABLE, DIGEST)
      # =========================
      # KRITIS: Menggunakan {{ image_ref }} yang memuat full image reference
      IMAGE_WITH_TAG={{ image_ref }} 

      # =========================
      # APP CONFIG
      # =========================
      APP_PORT=5000
      DEBUG=false

- name: 7. Restart Container Aplikasi
  community.docker.docker_compose_v2:
    project_src: "{{ remote_app_dir }}"
    state: present
    pull: never

- name: 8. Hapus Kunci Publik (Pembersihan)
  file:
    path: "/tmp/cosign.pub"
    state: absent