---
- name: Ensure OpenSCAP packages are installed
  dnf:
    name:
      - openscap-scanner
      - scap-security-guide
    state: present

- name: Create report directory
  file:
    path: /var/oscap-reports
    state: directory
    owner: root
    group: root
    mode: '0750'

- name: Set OpenSCAP datastream and profile (Rocky 9)  # adjust if needed
  set_fact:
    oscap_datastream: "/usr/share/xml/scap/ssg/content/ssg-rl9-ds.xml"
    oscap_profile: "xccdf_org.ssgproject.content_profile_standard"

- name: Check that datastream exists
  stat:
    path: "{{ oscap_datastream }}"
  register: ds_stat

- name: Fail if datastream not found
  fail:
    msg: "OSCAP datastream not found at {{ oscap_datastream }} â€” adjust for your distro."
  when: not ds_stat.stat.exists

- name: Run OpenSCAP CIS-like scan (this may take a while)
  command: >
    oscap xccdf eval
    --profile {{ oscap_profile }}
    --report /var/oscap-reports/{{ inventory_hostname }}-oscap-report.html
    --results-arf /var/oscap-reports/{{ inventory_hostname }}-oscap-results.arf.xml
    {{ oscap_datastream }}
  args:
    creates: "/var/oscap-reports/{{ inventory_hostname }}-oscap-report.html"
  register: oscap_run
  changed_when: false
  failed_when: oscap_run.rc not in [0, 2]   # 2 = non-compliant but scan OK

- name: Debug OpenSCAP result code
  debug:
    msg: "OpenSCAP exit code for {{ inventory_hostname }}: {{ oscap_run.rc }} (0=pass, 2=non-compliant)"
