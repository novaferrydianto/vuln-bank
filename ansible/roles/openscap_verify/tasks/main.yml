---
- name: Run OpenSCAP CIS Level 1 scan
  shell: |
    profile="xccdf_org.ssgproject.content_profile_cis_server_l1"
    date_str=$(date +%Y%m%d-%H%M%S)
    xml="{{ openscap_report_dir }}/oscap-{{ inventory_hostname }}-${date_str}.xml"
    html="{{ openscap_report_dir }}/oscap-{{ inventory_hostname }}-${date_str}.html"

    oscap xccdf eval \
      --profile "${profile}" \
      --results "${xml}" \
      --report  "${html}" \
      /usr/share/xml/scap/ssg/content/ssg-rocky9-ds.xml || true

    score=$(oscap xccdf eval --profile "${profile}" --results "${xml}" \
      /usr/share/xml/scap/ssg/content/ssg-rocky9-ds.xml 2>/dev/null \
      | grep -i 'score' | tail -1 | sed 's/[^0-9.]//g')

    echo "${score:-0}" > "{{ openscap_report_dir }}/last_score.txt"
  args:
    creates: "{{ openscap_report_dir }}/last_score.txt"

- name: Read last OpenSCAP score
  slurp:
    src: "{{ openscap_report_dir }}/last_score.txt"
  register: oscap_score_raw

- set_fact:
    oscap_score: "{{ (oscap_score_raw.content | b64decode) | float }}"

- name: Fail if score below threshold
  fail:
    msg: "OpenSCAP CIS score {{ oscap_score }} < required {{ cis_min_score }}"
  when: oscap_score < cis_min_score
