---
- name: Ensure compose dir exists
  file:
    path: "{{ db_compose_dir }}"
    state: directory
    mode: '0755'

- name: Copy DB docker-compose file
  copy:
    src: docker-compose.db.yml
    dest: "{{ db_compose_dir }}/docker-compose.yml"
    mode: '0644'

- name: Allow PostgreSQL from hosting-node only
  firewalld:
    port: "{{ db_port }}/tcp"
    source: "{{ hostvars['hosting-node'].ansible_host | default('192.168.107.131') }}"
    permanent: true
    state: enabled
    immediate: true

- name: Start DB via docker compose
  shell: |
    cd {{ db_compose_dir }}
    docker compose pull || true
    docker compose up -d
  args:
    creates: "{{ db_compose_dir }}/.first_run_done"

- name: Mark first run
  file:
    path: "{{ db_compose_dir }}/.first_run_done"
    state: touch
