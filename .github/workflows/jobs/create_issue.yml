name: Create Issue for High/Critical

on:
  workflow_call:

jobs:
  create_issue:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Create GitHub Issue (summary)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let body = "Auto-generated security summary for latest run.\n\n";
            if (fs.existsSync('security-reports/trivy-fs.json')) {
              body += "- Trivy FS report found.\n";
            }
            if (fs.existsSync('security-reports/snyk-sca.json')) {
              body += "- Snyk SCA report found.\n";
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "[Security] Auto-created issue - review findings",
              body,
              labels: ["security", "auto-created"]
            });
