name: Security Pipeline

on:
  workflow_call:
    outputs:
      block_deploy:
        description: "true jika ada critical/high + EPSS tinggi"
        value: ${{ jobs.scans.outputs.block_deploy }}

jobs:
  scans:
    runs-on: ubuntu-latest
    outputs:
      block_deploy: ${{ steps.decide.outputs.block_deploy }}
    env:
      REPORT_DIR: security-reports

    steps:
      - uses: actions/checkout@v4

      - name: Prepare report dir
        run: mkdir -p $REPORT_DIR

      # ---------- Secret Scanning: TruffleHog ----------
      - name: Secret scanning (TruffleHog)
        uses: trufflesecurity/trufflehog@v3
        with:
          path: .
          json: true
        continue-on-error: true

      # ---------- SCA: Snyk + EPSS tagging ----------
      - name: Install Snyk
        uses: snyk/actions/setup@master
        with:
          snyk-version: latest

      - name: Snyk SCA scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects --severity-threshold=medium \
            --json-file-output=${REPORT_DIR}/snyk-sca.json || true

      - name: EPSS-based prioritization (mock)
        id: epss
        run: |
          # Di real world: parse snyk-sca.json, call EPSS API
          # Di tugas: kita flag saja kalau ada "critical" di report
          if grep -qi "critical" ${REPORT_DIR}/snyk-sca.json; then
            echo "high_epss=true" >> $GITHUB_OUTPUT
          else
            echo "high_epss=false" >> $GITHUB_OUTPUT
          fi

      # ---------- IaC Scan: Checkov ----------
      - name: IaC scan (Checkov)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          output_format: cli,json
          output_file_path: ${{ env.REPORT_DIR }}/checkov-report

      # ---------- Container Scan: Trivy ----------
      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.23.0
        with:
          scan-type: fs
          scan-ref: .
          format: 'json'
          output: '${{ env.REPORT_DIR }}/trivy-fs.json'
          severity: 'HIGH,CRITICAL'
        continue-on-error: true

      # ---------- SAST: Semgrep ----------
      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: 'p/owasp-top-ten'
          json: true
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      # ---------- SAST: SonarQube Scanner ----------
      - name: SonarQube scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}  # Sonar di VM1
        run: |
          ./sonar-scanner \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN \
            -Dproject.settings=sonar-project.properties || true

      # ---------- Decide block / not ----------
      - name: Decide block_deploy
        id: decide
        run: |
          BLOCK="false"

          if [ -f "${REPORT_DIR}/trivy-fs.json" ]; then
            if grep -qi '"Severity":"CRITICAL"' "${REPORT_DIR}/trivy-fs.json"; then
              BLOCK="true"
            fi
          fi

          if [ "${{ steps.epss.outputs.high_epss }}" = "true" ]; then
            BLOCK="true"
          fi

          echo "block_deploy=${BLOCK}" >> $GITHUB_OUTPUT

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}
