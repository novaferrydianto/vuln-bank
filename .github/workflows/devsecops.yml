name: Vuln Bank Python DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: xbash81/vuln-bank
  IMAGE_TAG: latest

jobs:
  # 1. TAHAP PERSIAPAN & INSTALL DEPENDENCIES (DI RUNNER)
  setup:
    name: Setup Environment
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          # Ambil requirements dari lokasi folder baru
          if [ -f containers/app/requirements.txt ]; then
            pip install -r containers/app/requirements.txt
          fi
          pip install safety semgrep

  # 2. TAHAP SECURITY SCANNING (PARALLEL)
  security_scans:
    name: Security Analysis
    needs: setup
    runs-on: self-hosted
    continue-on-error: true
    strategy:
      matrix:
        scan_type: [trufflehog, safety, semgrep, trivy, snyk, sonarqube]
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Security Scans
        run: |
          # Gunakan variabel matrix yang benar
          SCAN_NOW="${{ matrix.scan_type }}"

          if [ "$SCAN_NOW" == "trufflehog" ]; then 
            trufflehog filesystem . --no-update --fail --json > trufflehog-report.json || true
          fi
          
          if [ "$SCAN_NOW" == "safety" ]; then 
            safety check -r containers/app/requirements.txt --json > safety-report.json || true
          fi
          
          if [ "$SCAN_NOW" == "semgrep" ]; then 
            semgrep scan --config auto --json > semgrep-report.json || true
          fi
          
          if [ "$SCAN_NOW" == "trivy" ]; then 
            trivy config containers/app/Dockerfile --format json --output trivy-report.json || true
          fi

      - name: SonarQube Scan
        if: matrix.scan_type == 'sonarqube'
        run: |
          if [ -z "${{ secrets.SONARQUBE_TOKEN }}" ]; then
            echo "ERROR: SONARQUBE_TOKEN is empty!"
            exit 1
          fi
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.host.url=http://192.168.107.132:9000 \
            -Dsonar.login=${{ secrets.SONARQUBE_TOKEN }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan_type }}
          path: "*-report.json"

  # 3. TAHAP UPLOAD KE DEFECTDOJO
  upload_to_defectdojo:
    name: DefectDojo Integration
    needs: security_scans
    runs-on: self-hosted
    if: always()
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
      - name: Push to DefectDojo API
        run: |
          upload() {
            curl -X POST "http://192.168.107.132:8080/api/v2/import-scan/" \
            -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
            -F "active=true" -F "verified=true" \
            -F "scan_type=$2" -F "product_name=Vuln Bank Python" \
            -F "engagement_name=Build-${{ github.run_number }}" -F "file=@$1"
          }
          upload "reports-trufflehog/trufflehog-report.json" "Trufflehog Scan"
          upload "reports-safety/safety-report.json" "Safety Scan"
          upload "reports-semgrep/semgrep-report.json" "Semgrep JSON Report"
          upload "reports-trivy/trivy-report.json" "Trivy Scan"

  # 4. TAHAP NOTIFIKASI & GUARDRAIL
  notifications:
    name: Slack Guardrail
    needs: upload_to_defectdojo
    runs-on: self-hosted
    steps:
      - name: Check Vulnerabilities & Notify
        run: |
          if grep -riqE "critical|high" .; then
            curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ðŸš¨ *SECURITY ALERT*: Temuan CRITICAL/HIGH ditemukan di Vuln Bank! Build #${{ github.run_number }} dibatalkan.\"}" \
            ${{ secrets.SLACK_WEBHOOK }}
            exit 1
          fi

  # 5. TAHAP BUILD, SBOM & SIGNING (DENGAN CUSTOM DOCKERFILE PATH)
  build_and_sign:
    name: Build & Sign Image
    needs: notifications
    runs-on: self-hosted
    outputs:
      image_digest: ${{ steps.push_step.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Docker Login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      
      - name: Build and Push
        id: push_step
        run: |
          # Build menggunakan Dockerfile di subfolder, konteks tetap di root (.)
          docker build -f containers/app/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG
          # Ambil Digest SHA256
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_NAME:$IMAGE_TAG)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
      
      - name: SBOM & Sign
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          IMAGE_REF: ${{ steps.push_step.outputs.digest }}
        run: |
          syft $IMAGE_REF -o json > sbom.json
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key --yes $IMAGE_REF
          rm cosign.key

  # 6. TAHAP DEPLOYMENT (ANSIBLE)
  deploy:
    name: Ansible Deployment
    needs: build_and_sign
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Execute Ansible Playbook
        env:
          ANSIBLE_CONFIG: ./ansible/ansible.cfg
          COSIGN_PUBLIC_KEY: ${{ secrets.COSIGN_PUBLIC_KEY }}
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_digest }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_temp
          chmod 600 ~/.ssh/id_temp
          
          export COSIGN_PUBLIC_KEY_CLEAN="$(printf '%s' "$COSIGN_PUBLIC_KEY" | tr -d '\r')"
          
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_temp \
            -e "image_ref=$IMAGE_REF" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}" \
            -e "deepseek_key=${{ secrets.DEEPSEEK_API_KEY }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"
            
          rm -f ~/.ssh/id_temp

  # 7. TAHAP DAST
  dast:
    name: DAST Scan
    needs: deploy
    runs-on: self-hosted
    steps:
      - name: OWASP ZAP Full Scan
        run: |
          docker run --rm -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py -t http://192.168.107.135:5000 -r zap-report.html