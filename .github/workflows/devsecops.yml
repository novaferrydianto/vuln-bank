name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_full_deploy:
        description: "Build + Push + Deploy?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: read
  security-events: write
  issues: write
  id-token: write

concurrency:
  group: vulnbank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  APP_URL: http://192.168.107.135:5000
  REPORT_DIR: security-reports

  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  REQUIREMENTS_PATH: containers/app/requirements.txt

  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_NAME: "Build-${{ github.run_number }}"

  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  FAIL_ON_SEVERITIES: "CRITICAL,HIGH"

  EPSS_THRESHOLD: "0.5"
  PYTHON_BIN: python3

###############################################################################
# 1) SETUP
###############################################################################
jobs:
  setup:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Workspace
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"
          python3 -m pip install --upgrade pip
          command -v jq >/dev/null 2>&1 || sudo dnf install -y jq

      - name: Install Tools
        run: |
          set -euo pipefail
          if [ -f "${REQUIREMENTS_PATH}" ]; then
            pip install -r "${REQUIREMENTS_PATH}"
          fi

          command -v pipx >/dev/null 2>&1 || sudo dnf install -y pipx
          export PATH="$HOME/.local/bin:$PATH"

          command -v semgrep >/dev/null 2>&1 || pipx install --force semgrep
          command -v docker  >/dev/null 2>&1 || { echo "[FATAL] docker missing"; exit 1; }

###############################################################################
# 2) SECURITY SCANS (PARALLEL)
###############################################################################
  security_scans:
    needs: setup
    runs-on: self-hosted

    strategy:
      fail-fast: false
      matrix:
        scan: [trufflehog, semgrep, trivy, snyk, sonarqube, checkov]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: mkdir -p "${REPORT_DIR}"

      # ======================= TRUFFLEHOG =======================
      - name: TruffleHog
        if: matrix.scan == 'trufflehog'
        run: |
          set -euo pipefail
          trufflehog git file://$(pwd) \
            --json --only-verified --no-update \
            > "${REPORT_DIR}/trufflehog.json" || true

      # ======================= SEMGREP =======================
      - name: Semgrep
        if: matrix.scan == 'semgrep'
        run: |
          set -euo pipefail
          semgrep scan \
            --config auto \
            --config p/security-audit \
            --config p/secrets \
            --config p/owasp-top-ten \
            --config p/python \
            --json > "${REPORT_DIR}/semgrep.json" || true

      # ======================= CHECKOV ========================
      - name: Checkov
        if: matrix.scan == 'checkov'
        run: |
          set -euo pipefail
          command -v checkov >/dev/null 2>&1 || pipx install checkov
          checkov -d ansible \
            --output json > "${REPORT_DIR}/checkov_ansible.json" || true
          checkov -f "${DOCKERFILE_PATH}" \
            --output json > "${REPORT_DIR}/checkov_docker.json" || true

      # ======================= TRIVY ==========================
      - name: Trivy Config
        if: matrix.scan == 'trivy'
        run: |
          set -euo pipefail
          trivy config . --severity "${FAIL_ON_SEVERITIES}" \
            --format json \
            --output "${REPORT_DIR}/trivy.json" || true

      # ======================= SNYK ===========================
      - name: Snyk
        if: matrix.scan == 'snyk'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -euo pipefail
          snyk code test --sarif > snyk-code.sarif || true
          snyk code test --json > "${REPORT_DIR}/snyk-code.json" || true
          snyk test --json > "${REPORT_DIR}/snyk-sca.json" || true
          snyk iac test --json > "${REPORT_DIR}/snyk-iac.json" || true

      - name: Upload SARIF
        if: matrix.scan == 'snyk'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      # ======================= SONAR ==========================
      - name: SonarQube
        if: matrix.scan == 'sonarqube'
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN:     ${{ secrets.SONAR_TOKEN }}
        run: |
          set -euo pipefail
          command -v sonar-scanner >/dev/null 2>&1 || { echo "[SKIP] sonar-scanner not installed"; exit 0; }
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

      # ========== Upload Artifacts (All Reports) ==========
      - name: Upload Scan Reports
        if: matrix.scan != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan }}
          path: ${{ env.REPORT_DIR }}/*.json
          if-no-files-found: ignore

###############################################################################
# 3) EPSS / KEV GATE + AUTO ISSUES + DASHBOARD
###############################################################################
  gate_and_summary:
    needs: security_scans
    runs-on: self-hosted
    continue-on-error: false

    steps:
      - uses: actions/checkout@v4

      - name: Download All Scan Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - run: mkdir -p "${REPORT_DIR}"

      - name: Discover Reports
        id: discover
        run: |
          set -euo pipefail

          find_json() {
            local pattern="$1"
            local f
            # gunakan -iname dan wildcard untuk lebih toleran terhadap struktur artifact
            f=$(find all-reports -type f -iname "$pattern" -print | head -n 1 || true)
            if [[ -z "$f" ]]; then
              echo ""
            else
              echo "$f"
            fi
          }

          echo "snyk_sca=$(find_json 'snyk-sca.json')"   >> "$GITHUB_OUTPUT"
          echo "trivy=$(find_json 'trivy.json')"         >> "$GITHUB_OUTPUT"
          echo "snyk_code=$(find_json 'snyk-code.json')" >> "$GITHUB_OUTPUT"

          echo "[DISCOVER] snyk-sca:   ${{ steps.discover.outputs.snyk_sca }}"
          echo "[DISCOVER] trivy:      ${{ steps.discover.outputs.trivy }}"
          echo "[DISCOVER] snyk-code:  ${{ steps.discover.outputs.snyk_code }}"

      - name: Run EPSS Gate
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"

          INPUTS=()

          if [[ "${{ steps.discover.outputs.snyk_sca }}" != "" ]]; then
            INPUTS+=( --input "${{ steps.discover.outputs.snyk_sca }}" )
          fi
          if [[ "${{ steps.discover.outputs.trivy }}" != "" ]]; then
            INPUTS+=( --input "${{ steps.discover.outputs.trivy }}" )
          fi
          if [[ "${{ steps.discover.outputs.snyk_code }}" != "" ]]; then
            INPUTS+=( --input "${{ steps.discover.outputs.snyk_code }}" )
          fi

          if [[ ${#INPUTS[@]} -eq 0 ]]; then
            echo "[INFO] No EPSS inputs found; skipping EPSS gate."
            exit 0
          fi

          echo "[INFO] Running EPSS Gate with inputs:"
          printf '  %s\n' "${INPUTS[@]}"

          ${PYTHON_BIN} scripts/epss_gate.py \
            --threshold "${EPSS_THRESHOLD}" \
            --output "${REPORT_DIR}/epss-findings.json" \
            "${INPUTS[@]}"

      - name: Security Gate + Auto Issues + Summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          epss="${REPORT_DIR}/epss-findings.json"

          if [[ ! -f "$epss" ]]; then
            echo "### EPSS Gate" >> "$GITHUB_STEP_SUMMARY"
            echo "No EPSS report. Gate PASS (no data)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          crit=$(jq '.high_risk_count // 0' "$epss")

          echo "### ðŸ›¡ EPSS Security Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "- High-Risk CVEs (EPSS/KEV/CVSS>=9): **$crit**" >> "$GITHUB_STEP_SUMMARY"

          if [[ "$crit" -gt 0 ]]; then
            EPSS_FILE="$epss" ${PYTHON_BIN} scripts/epss_create_issues.py
            ${PYTHON_BIN} scripts/gate_summary.py

            msg="ðŸš¨ EPSS Gate FAILED â€” $crit high-risk CVEs detected"
            curl -sS -X POST -H 'Content-type: application/json' \
              --data "$(jq -n --arg t "$msg" '{text:$t}')" \
              "$SLACK_URL"

            exit 1
          fi

      - name: Render EPSS Dashboard
        env:
          EPSS_FINDINGS: ${{ env.REPORT_DIR }}/epss-findings.json
          EPSS_OUT: ${{ env.REPORT_DIR }}/epss-dashboard.md
        run: |
          set -euo pipefail
          if [[ -f "${EPSS_FINDINGS}" ]]; then
            ${PYTHON_BIN} scripts/render_epss_dashboard.py
          else
            echo "[INFO] No EPSS findings file; skipping dashboard render."
          fi

      - name: Upload EPSS Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: epss-dashboard
          path: ${{ env.REPORT_DIR }}/epss-dashboard.md
          if-no-files-found: ignore

###############################################################################
# 4) DEFECTDOJO UPLOAD
###############################################################################
  upload_to_defectdojo:
    needs: security_scans
    runs-on: self-hosted
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Upload Reports to DefectDojo
        env:
          DD_TOKEN: ${{ secrets.DEFECTDOJO_API_KEY }}
        run: |
          set -euo pipefail

          upload() {
            local pattern="$1"
            local type="$2"
            local f
            f=$(find all-reports -type f -name "$pattern" | head -n 1 || true)
            if [[ -z "$f" ]]; then
              echo "[SKIP] $pattern"
              return
            fi
            echo "[UPLOAD] $f -> $type"
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "scan_type=${type}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement_name=${DEFECTDOJO_ENGAGEMENT_NAME}" \
              -F "verified=true" \
              -F "file=@${f}" >/dev/null
          }

          upload "semgrep.json"          "Semgrep JSON Report"
          upload "snyk-code.json"        "Snyk Scan"
          upload "snyk-sca.json"         "Snyk Scan"
          upload "snyk-iac.json"         "Snyk IaC"
          upload "trivy.json"            "Trivy Scan"
          upload "checkov_ansible.json"  "Checkov Ansible"
          upload "checkov_docker.json"   "Checkov Docker"

###############################################################################
# 5) BUILD + SIGN + SBOM  (Mode A: only workflow_dispatch + run_full_deploy=true)
###############################################################################
  build_and_sign:
    needs: gate_and_summary
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_deploy == 'true'
    runs-on: self-hosted
    outputs:
      image_ref: ${{ steps.export.outputs.image_ref }}

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Syft + Cosign
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b "$HOME/.local/bin"
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o "$HOME/.local/bin/cosign"
          chmod +x "$HOME/.local/bin/cosign"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Build & Push Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}

      - name: Export Image Ref
        id: export
        run: |
          set -euo pipefail
          digest="${{ steps.build.outputs.digest }}"
          echo "image_ref=${DOCKERHUB_REPO}@${digest}" >> "$GITHUB_OUTPUT"

      - name: SBOM + Attestation
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          set -euo pipefail
          syft "${{ steps.export.outputs.image_ref }}" -o cyclonedx-json=sbom.json
          cosign sign --yes "${{ steps.export.outputs.image_ref }}"
          cosign attest --yes \
            --predicate sbom.json \
            --type cyclonedx \
            "${{ steps.export.outputs.image_ref }}"

      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

###############################################################################
# 6) DEPLOY
###############################################################################
  deploy:
    needs: build_and_sign
    if: needs.build_and_sign.result == 'success'
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Deploy Image
        env:
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_ref }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner
          chmod 600 ~/.ssh/id_runner

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_runner \
            -e "image_ref=${IMAGE_REF}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"

###############################################################################
# 7) DAST SCAN (ZAP)
###############################################################################
  dast_scan:
    needs: deploy
    runs-on: self-hosted

    steps:
      - name: ZAP Baseline Scan
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"
          docker run --rm \
            -v "$(pwd)/${REPORT_DIR}:/zap/wrk/" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t "${APP_URL}" -J zap_report.json || true

      - name: Upload ZAP to DefectDojo
        run: |
          set -euo pipefail
          ZAP_FILE="${REPORT_DIR}/zap_report.json"
          if [[ ! -f "$ZAP_FILE" ]]; then
            echo "[SKIP] No ZAP report generated"
            exit 0
          fi

          curl -sS -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
            -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_KEY }}" \
            -F "scan_type=ZAP Scan" \
            -F "product=${{ secrets.DEFECTDOJO_PRODUCT_ID }}" \
            -F "engagement_name=DAST-${{ github.run_number }}" \
            -F "verified=true" \
            -F "file=@${ZAP_FILE}"

      - name: Cleanup
        run: |
          set -euo pipefail
          docker image prune -f || true
