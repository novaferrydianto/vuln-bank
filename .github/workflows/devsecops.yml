name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main", "staging"]
  pull_request:
    branches: ["staging"]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  SBOM_DIR: security-sbom
  PYTHON_BIN: python3

  IMAGE_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  # Dynamic environment
  APP_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

  DAST_TARGET_STAGING: http://192.168.107.135:5500
  DAST_TARGET_PRODUCTION: http://192.168.107.135:5500

  EPSS_THRESHOLD: "0.5"

  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:

  # ======================================================
  # SECURITY SCANS (RUNS ON STAGING & PRODUCTION)
  # ======================================================
  security_scans:
    name: Security Scans
    runs-on: self-hosted
    env:
      IMAGE_REF: ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
      DAST_URL: ${{ github.ref == 'refs/heads/main' && env.DAST_TARGET_PRODUCTION || env.DAST_TARGET_STAGING }}

    steps:
      - uses: actions/checkout@v4

      - name: Prepare report directories
        run: mkdir -p $REPORT_DIR $SBOM_DIR

      # SECRET SCAN
      - name: Secret Scanning (Gitleaks)
        run: gitleaks detect --source . --report-format json --report-path "$REPORT_DIR/gitleaks.json" || true

      # BUILD IMAGE
      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Image
        run: docker build -t "${IMAGE_REF}" -f "${DOCKERFILE_PATH}" .

      - name: Push Image
        run: docker push "${IMAGE_REF}"

      # SCA
      - name: Trivy SCA
        run: trivy fs --security-checks vuln --format json --output "$REPORT_DIR/trivy-sca.json" .

      # MISCONFIG
      - name: Trivy Config
        run: trivy config --format json --output "$REPORT_DIR/trivy-misconfig.json" .

      # IMAGE SCAN
      - name: Trivy Image
        run: trivy image --format json --output "$REPORT_DIR/trivy-image.json" "${IMAGE_REF}" || true

      # SBOM
      - name: SBOM (SPDX)
        run: trivy image --format spdx-json --output "$SBOM_DIR/sbom.spdx.json" "${IMAGE_REF}" || true

      # SEMGREP
      - name: Semgrep SAST
        run: semgrep ci --config p/owasp-top-ten --json --output "$REPORT_DIR/semgrep.json" || true

      # EPSS GATE
      - name: EPSS Gate
        id: epss
        run: |
          ${PYTHON_BIN} scripts/epss_gate.py \
            --input "$REPORT_DIR/trivy-sca.json" \
            --output "$REPORT_DIR/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}"

          echo "HIGH_RISK=$(jq '.high_risk | length' $REPORT_DIR/epss-findings.json)" >> $GITHUB_OUTPUT

      - name: Fail if high EPSS in production
        if: github.ref == 'refs/heads/main' && steps.epss.outputs.HIGH_RISK != '0'
        run: |
          echo "High-risk EPSS vulnerabilities detected. Blocking PRODUCTION deploy."
          exit 1

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            $REPORT_DIR
            $SBOM_DIR

  # ======================================================
  # SONARQUBE SCAN (RUNS ON STAGING & PRODUCTION)
  # ======================================================
  sonarqube_scan:
    name: SonarQube SAST
    runs-on: self-hosted
    needs: security_scans

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "17"

      - name: SonarScanner
        run: |
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.sources=. \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

  # ======================================================
  # DAST (RUNS ON STAGING & PRODUCTION)
  # ======================================================
  dast_scan:
    name: DAST (OWASP ZAP)
    runs-on: self-hosted
    needs:
      - security_scans
      - sonarqube_scan

    env:
      DAST_URL: ${{ github.ref == 'refs/heads/main' && env.DAST_TARGET_PRODUCTION || env.DAST_TARGET_STAGING }}

    steps:
      - uses: actions/checkout@v4

      - name: Create report folder
        run: mkdir -p $REPORT_DIR/zap

      - name: Run ZAP Baseline
        run: |
          docker run --rm \
            -v "${PWD}/${REPORT_DIR}/zap:/zap/wrk" \
            owasp/zap2docker-stable \
              zap-baseline.py -t "${DAST_URL}" \
              -J zap.json -r zap.html || true

      - uses: actions/upload-artifact@v4
        with:
          name: dast-zap
          path: $REPORT_DIR/zap

  # ======================================================
  # DEFECTDOJO IMPORT (PRODUCTION ONLY)
  # ======================================================
  defectdojo_import:
    name: Import to DefectDojo
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    needs:
      - security_scans
      - sonarqube_scan
      - dast_scan

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: reports/security

      - uses: actions/download-artifact@v4
        with:
          name: dast-zap
          path: reports/zap

      - name: Import SCA to DefectDojo
        run: |
          FILE="reports/security/security-reports/trivy-sca.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Trivy Scan" -F "file=@$FILE" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" -F "verified=true"
          fi

      - name: Import ZAP to DefectDojo
        run: |
          FILE="reports/zap/zap.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=ZAP Scan" -F "file=@$FILE" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" -F "verified=true"
          fi

  # ======================================================
  # DEPLOY ONLY PRODUCTION
  # ======================================================
  deploy:
    name: Deploy to VM2/VM3 (Production Only)
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    needs:
      - security_scans
      - sonarqube_scan
      - dast_scan
      - defectdojo_import

    env:
      IMAGE_REF: ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy with Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_rsa \
            -e "app_image=${IMAGE_REF}" \
            -e "app_env=production"

  # ======================================================
  # NOTIFICATION (RUNS ON STAGING & PRODUCTION)
  # ======================================================
  notify:
    name: Notify Slack
    runs-on: self-hosted
    needs:
      - security_scans
      - sonarqube_scan
      - dast_scan

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: reports/security

      - name: Parse EPSS
        id: check
        run: |
          FILE="reports/security/security-reports/epss-findings.json"
          COUNT=$(jq '.high_risk | length' "$FILE")
          echo "COUNT=$COUNT" >> $GITHUB_OUTPUT

      - name: Slack Alert
        if: steps.check.outputs.COUNT != '0'
        run: |
          MSG="[${{ env.APP_ENV }}] High EPSS vulnerabilities found. Check pipeline."
          curl -X POST -H 'Content-Type: application/json' \
            --data "{\"text\": \"$MSG\"}" \
            "${SLACK_WEBHOOK_URL}"
