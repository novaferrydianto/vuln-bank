name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write
  id-token: write  # Penting untuk Cosign keyless

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  # Docker
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile
  REQUIREMENTS_PATH: containers/app/requirements.txt
  # DefectDojo
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: "Build-${{ github.run_number }}"
  # Slack & Policy
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  FAIL_ON_SEVERITIES: "CRITICAL,HIGH"

jobs:
  setup:
    name: Setup Environment
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Prepare workspace
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"
          python3 -m pip install --upgrade pip
          command -v jq >/dev/null 2>&1 || sudo dnf install -y jq
      - name: Install security tools
        shell: bash
        run: |
          set -euo pipefail
          pip install -q safety
          if ! command -v semgrep >/dev/null 2>&1; then
            pipx install semgrep
          fi

  security_scans:
    name: Security Scans (Parallel)
    needs: setup
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        scan_type: [trufflehog, safety, semgrep, trivy, snyk, sonarqube]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Scan
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mkdir -p "${REPORT_DIR}"
          case "${{ matrix.scan_type }}" in
            trufflehog)
              trufflehog git file://$(pwd) --json --only-verified --no-update > "${REPORT_DIR}/trufflehog.json" || true
              ;;
            safety)
              safety check -r "${REQUIREMENTS_PATH}" --json > "${REPORT_DIR}/safety.json" || true
              ;;
            semgrep)
              semgrep scan --config auto --json > "${REPORT_DIR}/semgrep.json" || true
              ;;
            trivy)
              trivy config "${DOCKERFILE_PATH}" --severity "${FAIL_ON_SEVERITIES}" --format json --output "${REPORT_DIR}/trivy.json" || true
              ;;
            snyk)
              snyk test --json > "${REPORT_DIR}/snyk.json" || true
              ;;
            sonarqube)
              sonar-scanner -Dsonar.projectKey=vuln-bank -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.login="${SONAR_TOKEN}"
              ;;
          esac

      - name: Upload Artifacts
        if: matrix.scan_type != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan_type }}
          path: ${{ env.REPORT_DIR }}/*.json

  gate_and_summary:
    name: Gate + Slack + Step Summary
    needs: security_scans
    runs-on: self-hosted
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Aggregate & Notify
        shell: bash
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          TRUFFLE="all-reports/reports-trufflehog/trufflehog.json"
          SAFETY="all-reports/reports-safety/safety.json"
          SEMGREP="all-reports/reports-semgrep/semgrep.json"
          TRIVY="all-reports/reports-trivy/trivy.json"
          SNYK="all-reports/reports-snyk/snyk.json"

          crit=0; high=0; notes=()

          # TruffleHog
          if [ -f "$TRUFFLE" ]; then
            c=$(jq -R 'fromjson? | select(.Verified==true)' "$TRUFFLE" | wc -l); [ "$c" -gt 0 ] && { crit=$((crit+c)); notes+=("TruffleHog: $c verified secrets"); }
          fi
          # Semgrep
          if [ -f "$SEMGREP" ]; then
            c_crit=$(jq '[.results[]? | select(.extra.severity=="ERROR")] | length' "$SEMGREP" || echo 0)
            c_high=$(jq '[.results[]? | select(.extra.severity=="WARNING")] | length' "$SEMGREP" || echo 0)
            crit=$((crit+c_crit)); high=$((high+c_high)); [ $((c_crit+c_high)) -gt 0 ] && notes+=("Semgrep: $c_crit Crit, $c_high High")
          fi
          # Trivy (Vuln + Config)
          if [ -f "$TRIVY" ]; then
            t_crit=$(jq '([.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length) + ([.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length)' "$TRIVY" || echo 0)
            t_high=$(jq '([.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length) + ([.Results[]?.Misconfigurations[]? | select(.Severity=="HIGH")] | length)' "$TRIVY" || echo 0)
            crit=$((crit+t_crit)); high=$((high+t_high)); [ $((t_crit+t_high)) -gt 0 ] && notes+=("Trivy: $t_crit Crit, $t_high High")
          fi
          # Safety
          if [ -f "$SAFETY" ]; then
            c=$(jq 'length' "$SAFETY" || echo 0); [ "$c" -gt 0 ] && { high=$((high+c)); notes+=("Safety: $c vulns"); }
          fi
          # Snyk
          if [ -f "$SNYK" ]; then
            s_crit=$(jq '[.vulnerabilities[]? | select(.severity=="critical")] | length' "$SNYK" || echo 0)
            s_high=$(jq '[.vulnerabilities[]? | select(.severity=="high")] | length' "$SNYK" || echo 0)
            crit=$((crit+s_crit)); high=$((high+s_high)); [ $((s_crit+s_high)) -gt 0 ] && notes+=("Snyk: $s_crit Crit, $s_high High")
          fi

          # GitHub Summary
          echo "### ðŸ›¡ï¸ Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ CRITICAL: $crit" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŸ  HIGH: $high" >> $GITHUB_STEP_SUMMARY
          for n in "${notes[@]}"; do echo "- $n" >> $GITHUB_STEP_SUMMARY; done

          if [ "$crit" -gt 0 ] || [ "$high" -gt 0 ]; then
            msg="ðŸš¨ *SECURITY GATE FAILED* (#${{ github.run_number }})\nâ€¢ CRITICAL: $crit\nâ€¢ HIGH: $high"
            curl -s -X POST -H 'Content-type: application/json' --data "$(jq -n --arg text "$msg" '{text:$text}')" "$SLACK_URL"
            exit 1
          fi

  upload_to_defectdojo:
    name: DefectDojo Integration
    needs: security_scans
    if: always()
    runs-on: self-hosted
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-reports
      - name: Upload to DD
        shell: bash
        env:
          DD_TOKEN: ${{ secrets.DEFECTDOJO_API_KEY }}
        run: |
          upload_to_dd() {
            curl -s -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "active=true" -F "verified=true" -F "scan_type=$2" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "file=@$1" > /dev/null
          }
          upload_to_dd "all-reports/reports-trufflehog/trufflehog.json" "Trufflehog Scan"
          upload_to_dd "all-reports/reports-safety/safety.json" "Safety Scan"
          upload_to_dd "all-reports/reports-semgrep/semgrep.json" "Semgrep JSON Report"
          upload_to_dd "all-reports/reports-trivy/trivy.json" "Trivy Scan"
          upload_to_dd "all-reports/reports-snyk/snyk.json" "Snyk Scan"

  build_and_sign:
    name: Build + Push + Sign
    needs: gate_and_summary
    runs-on: self-hosted
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - uses: actions/checkout@v4
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}
      - name: Export Ref & Sign
        id: meta
        shell: bash
        run: |
          IMG="${DOCKERHUB_REPO}@${{ steps.build.outputs.digest }}"
          echo "image_ref=${IMG}" >> "$GITHUB_OUTPUT"
          cosign sign --yes "${IMG}"
      - name: Attest SBOM
        shell: bash
        run: |
          syft "${DOCKERHUB_REPO}@${{ steps.build.outputs.digest }}" -o cyclonedx-json > sbom.json
          cosign attest --yes --predicate sbom.json --type cyclonedx "${DOCKERHUB_REPO}@${{ steps.build.outputs.digest }}"

  deploy:
    name: Deploy (Ansible)
    needs: build_and_sign
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Verify Signature
        run: cosign verify --certificate-oidc-issuer "https://token.actions.githubusercontent.com" "${{ needs.build_and_sign.outputs.image_ref }}"
      - name: Ansible Execute
        env:
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_ref }}
        run: |
          mkdir -p ~/.ssh && echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner_temp && chmod 600 ~/.ssh/id_runner_temp
          ansible-playbook -i ansible/inventory.ini ansible/site.yml --private-key ~/.ssh/id_runner_temp \
            -e "image_ref=${IMAGE_REF}" -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}"
          rm -f ~/.ssh/id_runner_temp