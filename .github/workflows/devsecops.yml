name: Vuln Bank DevSecOps Pipeline

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_full_deploy:
        description: "Build + Sign + Deploy?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: read
  security-events: write
  issues: write
  checks: write
  id-token: write

concurrency:
  group: vulnbank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  APP_URL: http://192.168.107.135:5000

  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"
  COMPOSITE_THRESHOLD: "0.65"
  PYTHON_BIN: python3

  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile
  REQUIREMENTS_PATH: containers/app/requirements.txt

  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_NAME: "Build-${{ github.run_number }}"

  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  LLM_SCAN_PATH: "."
  LLM_REPORT: "security-reports/llm-findings.json"

  COPILOT_SECURITY_REPORT: security-reports/copilot-security.json

jobs:
################################################################################
# 0) AUTO-FIX (Copilot Autofix)
################################################################################
  autofix:
    name: Copilot Autofix (via CodeQL)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      pull-requests: write
      contents: write
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python # Sesuaikan dengan bahasa Vuln Bank (Python)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

################################################################################
# 1) SETUP
################################################################################
  setup:
    needs: [autofix]
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Workspace
        run: |
          set -e
          mkdir -p "${REPORT_DIR}"
          python3 -m pip install --upgrade pip
          command -v jq || sudo dnf install -y jq

      - name: Install Base Tools
        run: |
          command -v pipx >/dev/null || sudo dnf install -y pipx
          export PATH="$HOME/.local/bin:$PATH"
          command -v semgrep   || pipx install --force semgrep
          command -v checkov   || pipx install --force checkov
          command -v trivy     || echo "[WARN] trivy not installed"
          command -v snyk      || echo "[WARN] snyk not installed"
          command -v sonar-scanner || echo "[WARN] sonar not installed"
          command -v docker || { echo "[FATAL] docker missing"; exit 1; }

################################################################################
# 2) SECURITY SCANS (Parallel Matrix)
################################################################################
  security_scans:
    needs: setup
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        scan: [trufflehog, semgrep, trivy, snyk, sonarqube, checkov]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: mkdir -p "${REPORT_DIR}"

      # TruffleHog
      - name: TruffleHog
        if: matrix.scan == 'trufflehog'
        run: |
          trufflehog git file://$(pwd) \
            --json --only-verified --no-update \
            > ${REPORT_DIR}/trufflehog.json || true

      # Semgrep
      - name: Semgrep
        if: matrix.scan == 'semgrep'
        run: |
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/python \
            --json > ${REPORT_DIR}/semgrep.json || true

      # Checkov
      - name: Checkov
        if: matrix.scan == 'checkov'
        run: |
          checkov -d ansible --output json > ${REPORT_DIR}/checkov_ansible.json || true
          checkov -f "${DOCKERFILE_PATH}" --output json > ${REPORT_DIR}/checkov_docker.json || true

      # Trivy
      - name: Trivy Config
        if: matrix.scan == 'trivy'
        run: |
          trivy config . \
            --format json \
            --output ${REPORT_DIR}/trivy.json || true

      # Snyk
      - name: Snyk Scan
        if: matrix.scan == 'snyk'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk code test --sarif > snyk-code.sarif || true
          snyk code test --json > ${REPORT_DIR}/snyk-code.json || true
          snyk test --json > ${REPORT_DIR}/snyk-sca.json || true
          snyk iac test --json > ${REPORT_DIR}/snyk-iac.json || true

      - uses: github/codeql-action/upload-sarif@v4
        if: matrix.scan == 'snyk'
        with:
          sarif_file: snyk-code.sarif

      # SonarQube
      - name: SonarQube Analysis
        if: matrix.scan == 'sonarqube'
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN:     ${{ secrets.SONAR_TOKEN }}
        run: |
          command -v sonar-scanner || exit 0
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

      # Upload artifacts
      - name: Upload Reports
        if: matrix.scan != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan }}
          path: ${{ env.REPORT_DIR }}/*.json

################################################################################
# 3) AI SECURITY (LLM + COPILOT SECURITY)
################################################################################
  ai_security:
    needs: security_scans
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Download All Scan Reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      # STEP 1: LLM SECURITY SCAN
      - name: Run LLM Security Pipeline
        run: |
          ${PYTHON_BIN} scripts/llm_pipeline.py

      # STEP 2: COPY CODEQL SARIF (already generated in previous job)
      - name: Copy CodeQL SARIF for Composite Gate
        run: |
          mkdir -p security-reports
          CODEQL_SARIF_FILE="$(find all-reports -name '*.sarif' | head -n 1 || true)"
          if [ -z "$CODEQL_SARIF_FILE" ]; then
            echo "[WARN] No CodeQL SARIF found, creating empty SARIF."
            echo '{"runs":[{"results":[]}]}'>security-reports/codeql-results.sarif
          else
            cp "$CODEQL_SARIF_FILE" security-reports/codeql-results.sarif
          fi

      # Upload AI Security Report
      - name: Upload AI Reports
        uses: actions/upload-artifact@v4
        with:
          name: ai-security
          path: security-reports/*.json

################################################################################
# 4) EPSS + KEV + Composite Security Gate
################################################################################
  composite_gate:
    needs: ai_security
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: EPSS Gate
        run: |
          ${PYTHON_BIN} scripts/epss_gate.py \
            --threshold "${EPSS_THRESHOLD}" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --input all-reports/reports-snyk/snyk-sca.json \
            --input all-reports/reports-trivy/trivy.json \
            || true

      - name: Run Composite Security Gate
        run: |
          ${PYTHON_BIN} scripts/composite_security_gate.py

      - name: Render Composite Dashboard
        run: |
          export COMPOSITE_FINDINGS="security-reports/epss-findings.json"
          export COMPOSITE_DASHBOARD="security-reports/composite-dashboard.md"
          python3 scripts/render_composite_dashboard.py >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: composite-dashboard
          path: security-reports/composite-dashboard.md

      - name: Fail if Composite Gate Failed
        run: |
          status=$(jq -r '.status' security-reports/composite-findings.json)
          echo "Composite status: $status"
          [[ "$status" == "FAIL" ]] && exit 1 || exit 0

################################################################################
# 5) BUILD + SIGN + SBOM
################################################################################
  build_and_sign:
    needs: composite_gate
    if: github.event.inputs.run_full_deploy == 'true'
    runs-on: self-hosted
    outputs:
      image_ref: ${{ steps.export.outputs.image_ref }}

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Syft + Cosign
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b $HOME/.local/bin
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o $HOME/.local/bin/cosign
          chmod +x $HOME/.local/bin/cosign
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Build & Push Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}

      - name: Export Image Ref
        id: export
        run: |
          digest="${{ steps.build.outputs.digest }}"
          echo "image_ref=${DOCKERHUB_REPO}@${digest}" >> $GITHUB_OUTPUT

      - name: Generate SBOM + Attestation
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          syft "${{ steps.export.outputs.image_ref }}" -o cyclonedx-json=sbom.json
          cosign sign --yes "${{ steps.export.outputs.image_ref }}"
          cosign attest --yes \
            --predicate sbom.json --type cyclonedx \
            "${{ steps.export.outputs.image_ref }}"

################################################################################
# 6) DEPLOY (ANSIBLE)
################################################################################
  deploy:
    needs: build_and_sign
    if: needs.build_and_sign.result == 'success'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Application
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_rsa \
            -e "image_ref=${{ needs.build_and_sign.outputs.image_ref }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"

################################################################################
# 7) DAST (ZAP)
################################################################################
  dast_scan:
    needs: deploy
    runs-on: self-hosted
    steps:
      - name: ZAP Baseline Scan
        run: |
          docker run --rm -v "$(pwd):/zap/wrk/" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t "${APP_URL}" -J zap_report.json || true

      - name: Upload to DefectDojo
        run: |
          [[ ! -f zap_report.json ]] && exit 0
          curl -sS -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
            -H "Authorization: Token ${{ secrets.DEFECTDOJO_API_KEY }}" \
            -F "scan_type=ZAP Scan" \
            -F "product=${{ secrets.DEFECTDOJO_PRODUCT_ID }}" \
            -F "engagement_name=DAST-${{ github.run_number }}" \
            -F "verified=true" \
            -F "file=@zap_report.json"

      - run: docker image prune -f

################################################################################
# 8) NOTIFICATIONS
################################################################################
  notify:
    needs: [composite_gate, deploy, dast_scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ contains(needs.*.result, 'failure') && 'danger' || 'good' }}
          SLACK_TITLE: "VulnBank Security Report"
          SLACK_MESSAGE: "Pipeline Status: ${{ github.run_id }}\nCheck GitHub Actions Summary for Details."