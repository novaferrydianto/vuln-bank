name: Vuln Bank Python DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: xbash81/vuln-bank
  IMAGE_TAG: latest

jobs:
  # 1. TAHAP PERSIAPAN
  setup:
    name: Setup Environment
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f containers/app/requirements.txt ]; then
            pip install -r containers/app/requirements.txt
          fi
          pip install safety semgrep

  # 2. TAHAP SECURITY SCANNING (PARALLEL)
  security_scans:
    name: Security Analysis
    needs: setup
    runs-on: self-hosted
    continue-on-error: true
    strategy:
      matrix:
        scan_type: [trufflehog, safety, semgrep, trivy, snyk, sonarqube]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Penting untuk TruffleHog scan history

      # --- TRUFFLEHOG OFFICIAL ACTION ---
      - name: TruffleHog Secret Scan
        if: matrix.scan_type == 'trufflehog'
        run: |
          # Menggunakan binary lokal agar pipe '|' berfungsi mengalihkan output ke file
          trufflehog git file://$(pwd) --json --only-verified --fail --no-update > trufflehog-report.json || true

      # --- TOOLS LAINNYA ---
      - name: Run Security Scans
        if: matrix.scan_type != 'trufflehog' && matrix.scan_type != 'sonarqube'
        run: |
          case "${{ matrix.scan_type }}" in
            safety)
              safety check -r containers/app/requirements.txt --json > safety-report.json || true
              ;;
            semgrep)
              semgrep scan --config auto --json > semgrep-report.json || true
              ;;
            trivy)
              trivy config containers/app/Dockerfile --format json --output trivy-report.json || true
              ;;
            snyk)
              snyk test --json --auth=${{ secrets.SNYK_TOKEN }} > snyk-report.json || true
              ;;
          esac

      - name: SonarQube Scan
        if: matrix.scan_type == 'sonarqube'
        run: |
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Upload Artifacts
        if: matrix.scan_type != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan_type }}
          path: "*.json"

  # 3. TAHAP UPLOAD KE DEFECTDOJO
  upload_to_defectdojo:
    name: DefectDojo Integration
    needs: security_scans
    runs-on: self-hosted
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports
      - name: Push to DefectDojo API
        env:
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          DD_URL: "http://192.168.107.132:8080"
        run: |
          upload_to_dd() {
            if [ -f "$1" ]; then
              curl -X POST "$DD_URL/api/v2/import-scan/" \
                -H "Authorization: Token $DD_TOKEN" \
                -F "active=true" -F "verified=true" \
                -F "scan_type=$2" -F "product_name=Vuln Bank Python" \
                -F "engagement_name=Build-${{ github.run_number }}" -F "file=@$1"
            fi
          }
          upload_to_dd "all-reports/reports-trufflehog/trufflehog-report.json" "Trufflehog Scan"
          upload_to_dd "all-reports/reports-safety/safety-report.json" "Safety Scan"
          upload_to_dd "all-reports/reports-semgrep/semgrep-report.json" "Semgrep JSON Report"
          upload_to_dd "all-reports/reports-trivy/trivy-report.json" "Trivy Scan"
          upload_to_dd "all-reports/reports-snyk/snyk-report.json" "Snyk Scan"

  # 4. TAHAP NOTIFIKASI & GUARDRAIL
  notifications:
    name: Slack Guardrail
    needs: upload_to_defectdojo
    runs-on: self-hosted
    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: inspection-reports
      - name: Check Vulnerabilities & Notify
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if grep -riqE "critical|high" inspection-reports; then
            if [ -n "$SLACK_URL" ]; then
              curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸš¨ *SECURITY ALERT*: Temuan bahaya di Vuln Bank! Build #${{ github.run_number }} dibatalkan.\"}" \
              "$SLACK_URL"
            fi
            exit 1
          fi

  # 5. TAHAP BUILD & SIGNING (DIGEST)
  build_and_sign:
    name: Build & Sign Image
    needs: notifications
    runs-on: self-hosted
    outputs:
      image_digest: ${{ steps.push_step.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      - name: Docker Login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      - name: Build and Push
        id: push_step
        run: |
          docker build -f containers/app/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_NAME:$IMAGE_TAG)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
      - name: Sign Image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          IMAGE_REF: ${{ steps.push_step.outputs.digest }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key --yes $IMAGE_REF
          rm cosign.key

  # 6. TAHAP DEPLOYMENT (ANSIBLE)
  deploy:
    name: Ansible Deployment
    needs: build_and_sign
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Execute Ansible
        env:
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_digest }}
        run: |
          mkdir -p ~/.ssh && echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_temp && chmod 600 ~/.ssh/id_temp
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_temp \
            -e "image_ref=$IMAGE_REF" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}" \
            -e "deepseek_key=${{ secrets.DEEPSEEK_API_KEY }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"
          rm -f ~/.ssh/id_temp