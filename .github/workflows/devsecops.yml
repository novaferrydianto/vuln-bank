name: VulnBank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  REPORT_DIR: security-reports
  ZAP_TARGET_URL: http://192.168.107.135:5000

jobs:
  security-pipeline:
    runs-on: self-hosted
    name: Security & Deployment Pipeline

    steps:
      # ====================================================
      # 1. CHECKOUT & PREP
      # ====================================================
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: mkdir -p ${REPORT_DIR}/{snyk,trivy,semgrep,zap,sbom}

      # ====================================================
      # 2. SECRET SCAN
      # ====================================================
      - name: TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          extra_args: --only-verified
        continue-on-error: true

      # ====================================================
      # 3. SAST
      # ====================================================
      - name: Semgrep
        run: semgrep scan --config=p/security-audit --json > ${REPORT_DIR}/semgrep/results.json
        continue-on-error: true

      # ====================================================
      # 4. BUILD & DIGEST
      # ====================================================
      - name: Login Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Image
        id: build
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank:latest

      - name: Capture Image Digest
        run: |
          echo "IMAGE_REF=${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank@${{ steps.build.outputs.digest }}" >> $GITHUB_ENV

      # ====================================================
      # 5. SCA (IMAGE)
      # ====================================================
      - name: Snyk Image Scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.IMAGE_REF }}
          args: --severity-threshold=high --json-file-output=${REPORT_DIR}/snyk/results.json
        continue-on-error: true

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: json
          output: ${REPORT_DIR}/trivy/results.json
          severity: CRITICAL,HIGH
        continue-on-error: true

      # ====================================================
      # 6. SUPPLY CHAIN
      # ====================================================
      - uses: sigstore/cosign-installer@v3

      - name: Cosign Sign Image
        run: cosign sign --yes --key env://COSIGN_PRIVATE_KEY "$IMAGE_REF"
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE_REF }}
          format: spdx-json
          output-file: security-reports/sbom/sbom.spdx.json
          upload-artifact: false
          dependency-snapshot: false

      # ====================================================
      # 7. DEPLOY
      # ====================================================
      - name: Ansible Deploy
        run: |
          ansible-galaxy collection install community.docker
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key key.pem \
            -e image_ref=${IMAGE_REF}

      # ====================================================
      # 8. DAST (ZAP SAFE MODE)
      # ====================================================
      - name: ZAP Baseline Scan
        continue-on-error: true
        run: |
          ZAP_DIR="$RUNNER_TEMP/zap"
          mkdir -p "$ZAP_DIR"

          docker run --rm --network=host \
            -v "$ZAP_DIR:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t ${ZAP_TARGET_URL} \
              -a \
              -J /zap/wrk/report.json

          cp "$ZAP_DIR/report.json" ${REPORT_DIR}/zap/report.json

      # ====================================================
      # 9. DEFECTDOJO
      # ====================================================
      - name: Upload to DefectDojo
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          for f in ${REPORT_DIR}/**/*.json; do
            [ -f "$f" ] || continue
            curl -s -X POST \
              "$DEFECTDOJO_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DEFECTDOJO_API_KEY" \
              -F "file=@$f" \
              -F "scan_type=Generic Findings Import" \
              -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID"
          done

      # ====================================================
      # 10. SLACK NOTIFICATION (FINAL)
      # ====================================================
      - name: Slack Security Notification
        if: always()
        run: |
          count() {
            jq "$1" "$2" 2>/dev/null || echo 0
          }

          TRIVY=$(count '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' "${REPORT_DIR}/trivy/results.json")
          SNYK=$(count '[.vulnerabilities[]? | select(.severity=="high" or .severity=="critical")] | length' "${REPORT_DIR}/snyk/results.json")
          SEMGREP=$(count '[.results[]? | select(.extra.severity=="ERROR")] | length' "${REPORT_DIR}/semgrep/results.json")

          TOTAL=$((TRIVY + SNYK + SEMGREP))

          if [ "$TOTAL" -gt 0 ]; then
            COLOR="danger"
            STATUS="ðŸš¨ SECURITY ALERT"
          else
            COLOR="good"
            STATUS="âœ… PIPELINE SECURE"
          fi

          payload=$(cat <<EOF
          {
            "attachments": [{
              "color": "$COLOR",
              "title": "$STATUS â€” VulnBank DevSecOps",
              "fields": [
                { "title": "Trivy", "value": "$TRIVY", "short": true },
                { "title": "Snyk", "value": "$SNYK", "short": true },
                { "title": "Semgrep", "value": "$SEMGREP", "short": true },
                { "title": "Image", "value": "$IMAGE_REF", "short": false }
              ]
            }]
          }
          EOF
          )

          curl -s -X POST -H "Content-Type: application/json" \
            --data "$payload" ${{ secrets.SLACK_WEBHOOK_URL }}
