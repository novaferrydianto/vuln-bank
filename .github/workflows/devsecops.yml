name: Vuln Bank Python DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: xbash81/vuln-bank
  IMAGE_TAG: latest

jobs:
  # 1. TAHAP PERSIAPAN
  setup:
    name: Setup Environment
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f containers/app/requirements.txt ]; then
            pip install -r containers/app/requirements.txt
          fi
          pip install safety semgrep

  # 2. TAHAP SECURITY SCANNING (PARALLEL)
  security_scans:
    name: Security Analysis
    needs: setup
    runs-on: self-hosted
    continue-on-error: true
    strategy:
      matrix:
        scan_type: [trufflehog, safety, semgrep, trivy, snyk, sonarqube]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # --- TRUFFLEHOG OFFICIAL ACTION ---
      - name: TruffleHog Secret Scan
        if: matrix.scan_type == 'trufflehog'
        run: |
          trufflehog git file://$(pwd) --json --only-verified --fail --no-update > trufflehog-report.json || true

      # --- TOOLS LAINNYA ---
      - name: Run Security Scans
        if: matrix.scan_type != 'trufflehog' && matrix.scan_type != 'sonarqube'
        run: |
          case "${{ matrix.scan_type }}" in
            safety)
              safety check -r containers/app/requirements.txt --json > safety-report.json || true
              ;;
            semgrep)
              semgrep scan --config auto --json > semgrep-report.json || true
              ;;
            trivy)
              trivy config containers/app/Dockerfile --format json --output trivy-report.json || true
              ;;
            snyk)
              snyk test --json --auth=${{ secrets.SNYK_TOKEN }} > snyk-report.json || true
              ;;
          esac

      - name: SonarQube Scan
        if: matrix.scan_type == 'sonarqube'
        run: |
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Upload Artifacts
        if: matrix.scan_type != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan_type }}
          path: "*.json"

  # 3. TAHAP UPLOAD KE DEFECTDOJO
  upload_to_defectdojo:
    name: DefectDojo Integration
    needs: security_scans
    runs-on: self-hosted
    if: always()
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Push to DefectDojo API
        env:
          # PASTIKAN DUA VARIABEL INI ADA DI SINI
          DD_TOKEN: ${{ secrets.DEFECTDOJO_API_KEY }}
          DD_URL: "http://192.168.107.132:8080" 
        run: |
          # Debugging singkat untuk memastikan URL terbaca
          echo "Target URL: $DD_URL"
          
          upload_to_dd() {
            if [ -f "$1" ]; then
              echo "Uploading $2 from $1..."
              curl -X POST "$DD_URL/api/v2/import-scan/" \
                -H "Authorization: Token $DD_TOKEN" \
                -F "active=true" -F "verified=true" \
                -F "scan_type=$2" -F "product_name=Vuln Bank Python" \
                -F "engagement_name=Build-${{ github.run_number }}" -F "file=@$1"
            else
              echo "File $1 tidak ditemukan."
            fi
          }
          upload_to_dd "all-reports/reports-trufflehog/trufflehog-report.json" "Trufflehog Scan"
          upload_to_dd "all-reports/reports-safety/safety-report.json" "Safety Scan"
          upload_to_dd "all-reports/reports-semgrep/semgrep-report.json" "Semgrep JSON Report"
          upload_to_dd "all-reports/reports-trivy/trivy-report.json" "Trivy Scan"
          upload_to_dd "all-reports/reports-snyk/snyk-report.json" "Snyk Scan"

  # 4. TAHAP NOTIFIKASI & GUARDRAIL
  notifications:
    name: Slack Guardrail & Summary
    needs: upload_to_defectdojo
    runs-on: self-hosted
    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: inspection-reports

      - name: Analyze, Notify & Summary
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        shell: bash
        run: |
          CRIT_COUNT=$(grep -ri "critical" inspection-reports | wc -l || echo 0)
          HIGH_COUNT=$(grep -ri "high" inspection-reports | wc -l || echo 0)
          
          # Generate GitHub Step Summary
          echo "### ðŸ›¡ï¸ DevSecOps Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Findings |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          
          for tool in trufflehog safety semgrep trivy snyk; do
            if ls inspection-reports/reports-$tool/*.json >/dev/null 2>&1; then
              T_CRIT=$(grep -i "critical" inspection-reports/reports-$tool/*.json | wc -l || echo 0)
              [ "$T_CRIT" -gt 0 ] && ST="âŒ Failed" || ST="âœ… Passed"
              echo "| ${tool^} | $ST | $T_CRIT Critical |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [ "$CRIT_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            MSG="ðŸš¨ *SECURITY ALERT: BUILD #${{ github.run_number }}* ðŸš¨\n*Status:* âŒ Dibatalkan\nâ€¢ ðŸ”´ Critical: *$CRIT_COUNT*\nâ€¢ ðŸŸ  High: *$HIGH_COUNT*"
            [ -n "$SLACK_URL" ] && curl -sS -X POST -H 'Content-type: application/json' --data "$(jq -n --arg text "$MSG" '{text:$text}')" "$SLACK_URL"
            exit 1
          fi

  # 5. TAHAP BUILD & SIGNING (DIGEST)
  build_and_sign:
    name: Build & Sign Image
    needs: notifications
    runs-on: self-hosted
    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push with Cache
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: containers/app/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sign Image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key --yes "${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}"
          rm cosign.key

  # 6. TAHAP DEPLOYMENT (ANSIBLE)
  deploy:
    name: Ansible Deployment
    needs: build_and_sign
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Execute Ansible
        env:
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_digest }}
        run: |
          mkdir -p ~/.ssh && echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_temp && chmod 600 ~/.ssh/id_temp
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_temp \
            -e "image_ref=$IMAGE_REF" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}" \
            -e "deepseek_key=${{ secrets.DEEPSEEK_API_KEY }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"
          rm -f ~/.ssh/id_temp