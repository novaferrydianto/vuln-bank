name: VulnBank DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  REPORT_DIR: security-reports

jobs:
  security-pipeline:
    name: Security & Deployment Pipeline
    runs-on: self-hosted
    
    steps:
      # ====================================================
      # 1. CHECKOUT CODE
      # ====================================================
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare report directories
        run: |
          mkdir -p "${REPORT_DIR}/"{snyk,trivy,semgrep,zap,sbom}

      # ====================================================
      # 2. SECRET SCANNING (TRUFFLEHOG)
      # ====================================================
      - name: Secret Scanning (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

      # ====================================================
      # 3. SCA (SNYK & TRIVY)
      # ====================================================
      - name: SCA Scan (Snyk)
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank@${{ env.IMAGE_REFERENCE_DIGEST }}
          args: --severity-threshold=high --json-file-output=${{ env.REPORT_DIR }}/snyk/results.json
        continue-on-error: true

      - name: SCA & Misconfig Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: '${{ env.REPORT_DIR }}/trivy/results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # ====================================================
      # 4. SAST (SEMGREP & SONARQUBE)
      # ====================================================
      - name: SAST Scan (Semgrep)
        run: |
          export PATH=$PATH:$HOME/.local/bin
          semgrep scan --config=p/security-audit --json --output="${REPORT_DIR}/semgrep/results.json"
        continue-on-error: true

      - name: SAST Scan (SonarQube)
        env:
          SONAR_HOST_URL: "http://192.168.107.132:9000"
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.sources=. \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN
        continue-on-error: true

      # ====================================================
      # 5. BUILD & PUSH IMAGE (DOCKER HUB) - Capture Digest
      # ====================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: .
          file: containers/app/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank:latest
          outputs: type=image,names=${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank:latest,digest=true
        
      - name: Set Image Digest Variable
        run: |
          IMAGE_DIGEST="${{ steps.docker_build.outputs.digest }}"
          echo "IMAGE_REFERENCE_DIGEST=$IMAGE_DIGEST" >> $GITHUB_ENV
          echo "Digest yang Digunakan: $IMAGE_DIGEST"

      # ====================================================
      # 5.5 SUPPLY CHAIN SECURITY (SBOM & COSIGN) - Menggunakan Digest
      # ====================================================
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.3.0

      # Sign Image menggunakan Digest
      - name: Sign image with a key
        run: |
          cosign sign --yes --key env://COSIGN_PRIVATE_KEY "$DOCKER_USER/vuln-bank@${{ env.IMAGE_REFERENCE_DIGEST }}"
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }} 

      # Generate SBOM menggunakan Digest
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ secrets.DOCKERHUB_USERNAME }}/vuln-bank@${{ env.IMAGE_REFERENCE_DIGEST }}
          format: spdx-json
          output-file: ${{ env.REPORT_DIR }}/sbom/sbom.spdx.json

      # ====================================================
      # 6. DEPLOYMENT (ANSIBLE) - Menggunakan Digest & Kunci Publik
      # ====================================================
      - name: Setup SSH Key & Deploy
        run: |
          # Perbaikan: Install Collection Docker sebelum menjalankan Playbook
          ansible-galaxy collection install community.docker
          
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner_temp
          chmod 600 ~/.ssh/id_runner_temp

          export COSIGN_PUBLIC_KEY_CLEAN="$(printf '%s' "${{ secrets.COSIGN_PUBLIC_KEY }}" | tr -d '\r')"

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_runner_temp \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "deepseek_key=${{ secrets.DEEPSEEK_API_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}" \
            -e "image_digest=${{ env.IMAGE_REFERENCE_DIGEST }}" \
            -e "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}"
            
          rm -f ~/.ssh/id_runner_temp
        env:
          ANSIBLE_CONFIG: ./ansible/ansible.cfg

      # ====================================================
      # 7. DAST (OWASP ZAP)
      # ====================================================
      - name: Pull ZAP Image (GHCR)
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      - name: DAST Scan (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://192.168.107.135:5000'
          allow_issue_writing: false
          cmd_options: >
            -a
            -J ${{ env.REPORT_DIR }}/zap/report.json
            -w ${{ env.REPORT_DIR }}/zap/report.md
            -r ${{ env.REPORT_DIR }}/zap/report.html
        env:
          ZAP_DOCKER_USER: "${{ runner.os != 'Windows' && format('{0}:{1}', '$(id -u)', '$(id -g)') || '' }}"
        continue-on-error: true

      # ====================================================
      # 8. REPORTING & NOTIFICATION
      # ====================================================
      - name: Upload All Reports to DefectDojo
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          upload_scan() {
            FILE="$1"
            SCAN_TYPE="$2"

            if [ ! -f "$FILE" ]; then
              echo "[SKIP] $FILE not found"
              return
            fi

            echo "Uploading $SCAN_TYPE to DefectDojo..."
            curl -sS -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
              -H "Authorization: Token $DEFECTDOJO_API_KEY" \
              -F "scan_type=$SCAN_TYPE" \
              -F "file=@$FILE" \
              -F "engagement=$DEFECTDOJO_ENGAGEMENT_ID" \
              -F "active=true" \
              -F "verified=true" \
              -F "minimum_severity=High"
          }

          upload_scan "security-reports/trivy/results.json" "Trivy Scan"
          upload_scan "security-reports/snyk/results.json" "Snyk Scan"
          upload_scan "security-reports/semgrep/results.json" "Semgrep JSON Report"
          upload_scan "security-reports/zap/report.json" "ZAP Scan"
          upload_scan "security-reports/sbom/sbom.spdx.json" "Generic Header Analysis"

      - name: Slack Notification
        if: always()
        run: |
          # Note: jq is needed on the self-hosted runner for this.
          TRIVY_CRIT=$(jq '[.Results[] | .Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "${REPORT_DIR}/trivy/results.json" 2>/dev/null || echo 0)
          SNYK_CRIT=$(jq '[.vulnerabilities[]? | select(.severity=="high")] | length' "${REPORT_DIR}/snyk/results.json" 2>/dev/null || echo 0)
          SEMGREP_CRIT=$(jq '[.results[]? | select(.extra.severity=="ERROR")] | length' "${REPORT_DIR}/semgrep/results.json" 2>/dev/null || echo 0)
          TOTAL_CRIT=$((TRIVY_CRIT + SNYK_CRIT + SEMGREP_CRIT))
          
          if [ "$TOTAL_CRIT" -gt "0" ]; then
            curl -X POST -H 'Content-type: application/json' --data "{
              'text': 'ðŸš¨ *Security Alert Vuln Bank* ðŸš¨\nTotal Temuan Critical/High: *$TOTAL_CRIT*\n- Trivy: $TRIVY_CRIT\n- Snyk: $SNYK_CRIT\n- Semgrep: $SEMGREP_CRIT\nImage Signed & SBOM Generated. âœ…\nMohon cek DefectDojo segera.'
            }" ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "Pipeline aman. Image Signed & SBOM Generated. âœ…"
          fi