name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

  workflow_dispatch:
    inputs:
      run_full_deploy:
        description: "Run build + push + deploy?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: read
  security-events: write
  issues: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  APP_URL: http://192.168.107.135:5000
  REPORT_DIR: security-reports
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile
  REQUIREMENTS_PATH: containers/app/requirements.txt
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: "Build-${{ github.run_number }}"
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  FAIL_ON_SEVERITIES: "CRITICAL,HIGH"
  EPSS_THRESHOLD: "0.5"

# ============================================================================
# 1. SETUP RUNNER
# ============================================================================
jobs:
  setup:
    name: Setup Environment
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"
          python3 -m pip install --upgrade pip
          sudo dnf install -y jq pipx || true

      - name: Install security tools
        run: |
          set -euo pipefail

          if [ -f "${REQUIREMENTS_PATH}" ]; then
            pip install -r "${REQUIREMENTS_PATH}"
          fi

          pipx install --force semgrep
          pipx install --force checkov || true

          command -v docker >/dev/null || exit 1
          docker buildx version >/dev/null || exit 1

####################################
  # 2. Tahap Security Scans (Parallel)
  ####################################
  security_scans:
    name: Security Scans (Parallel)
    needs: setup
    runs-on: self-hosted
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        scan_type: [trufflehog, semgrep, trivy, snyk, sonarqube, checkov]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Init report dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}"

      - name: TruffleHog Scan
        if: matrix.scan_type == 'trufflehog'
        run: trufflehog git file://$(pwd) --json --only-verified --no-update > "${REPORT_DIR}/trufflehog.json" || true

      - name: Semgrep Banking Scan
        if: matrix.scan_type == 'semgrep'
        run: |
          semgrep scan --config auto \
            --config "p/security-audit" \
            --config "p/secrets" \
            --config "p/owasp-top-ten" \
            --config "p/python" \
            --json > "${REPORT_DIR}/semgrep.json" || true

      - name: Checkov CIS Compliance Scan
        if: matrix.scan_type == 'checkov'
        run: |
          pipx install checkov --force
          export PATH="$HOME/.local/bin:$PATH"
          checkov -d ansible --check CKV_PAN_1,CKV_PAN_2,CKV_PAN_6 --output json > "${REPORT_DIR}/checkov_ansible.json" || true
          checkov -f "${DOCKERFILE_PATH}" --check CKV_DOCKER_1,CKV_DOCKER_2,CKV_DOCKER_7 --output json > "${REPORT_DIR}/checkov_docker.json" || true

      - name: Trivy Scan (Config)
        if: matrix.scan_type == 'trivy'
        shell: bash
        run: |
          set -euo pipefail
          trivy config "${DOCKERFILE_PATH}" \
            --severity "${FAIL_ON_SEVERITIES}" \
            --format json \
            --output "${REPORT_DIR}/trivy.json" || true

      - name: Snyk Advanced Scans
        if: matrix.scan_type == 'snyk'
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -euo pipefail
          
          # 1. SAST - Snyk Code (Output SARIF untuk GitHub & JSON untuk DefectDojo)
          snyk code test --sarif > snyk-code.sarif || true
          snyk code test --json > "${REPORT_DIR}/snyk-code.json" || true

          # 2. SCA - Snyk Open Source
          snyk test --json > "${REPORT_DIR}/snyk-sca.json" || true
          snyk monitor --all-projects || true

          # 3. IaC - Infrastructure as Code
          snyk iac test --json > "${REPORT_DIR}/snyk-iac.json" || true

      - name: Upload SARIF to GitHub
        if: matrix.scan_type == 'snyk' && always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif

      - name: SonarQube Scan
        if: matrix.scan_type == 'sonarqube'
        shell: bash
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${SONAR_HOST_URL:-}" ] || [ -z "${SONAR_TOKEN:-}" ]; then
            echo "[SKIP] Missing SonarQube secrets"
            exit 0
          fi
          if ! command -v sonar-scanner >/dev/null 2>&1; then
            echo "[SKIP] sonar-scanner not installed"
            exit 0
          fi
          sonar-scanner \
            -Dsonar.projectKey=vuln-bank \
            -Dsonar.python.coverage.reportPaths=${REPORT_DIR}/coverage.xml \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

      - name: Upload scan artifacts
        if: matrix.scan_type != 'sonarqube'
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan_type }}
          path: ${{ env.REPORT_DIR }}/*.json
          if-no-files-found: warn
          retention-days: 14

# ============================================================================
# 3. EPSS + KEV GATE
# ============================================================================
  epss_gate:
    name: EPSS + KEV Gate
    needs: security_scans
    runs-on: self-hosted
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Run EPSS Gate
        run: |
          python3 scripts/epss_gate.py \
            --threshold "${EPSS_THRESHOLD}" \
            --mode A \
            --input all-reports/reports-snyk/snyk-sca.json \
            --input all-reports/reports-trivy/trivy.json \
            --output security-reports/epss-findings.json

      - name: Upload EPSS Gateway Result
        uses: actions/upload-artifact@v4
        with:
          name: epss-report
          path: security-reports/epss-findings.json

# ============================================================================
# 4. AUTO-GITHUB ISSUE MGMT (CREATE / UPDATE / AUTO-CLOSE)
# ============================================================================
  github_issues_auto:
    name: GitHub Issues Automation
    needs: epss_gate
    runs-on: self-hosted
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: epss-report
          path: security-reports

      - name: Run GitHub Issue Manager
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/create_github_issues.py \
            --repo "${{ github.repository }}" \
            --epss "security-reports/epss-findings.json"

# ============================================================================
# 5. DEFECTDOJO UPLOAD
# ============================================================================
  upload_to_defectdojo:
    needs: security_scans
    runs-on: self-hosted
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Upload to DefectDojo
        env:
          DD_TOKEN: ${{ secrets.DEFECTDOJO_API_KEY }}
        run: |
          upload() {
            f="$1"; type="$2"
            if [ -f "$f" ]; then
              curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
                -H "Authorization: Token ${DD_TOKEN}" \
                -F "active=true" -F "verified=true" \
                -F "scan_type=${type}" \
                -F "product=${DEFECTDOJO_PRODUCT_ID}" \
                -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
                -F "file=@$f"
            fi
          }

          upload all-reports/reports-semgrep/semgrep.json "Semgrep JSON Report"
          upload all-reports/reports-checkov/checkov_ansible.json "Checkov Scan"
          upload all-reports/reports-snyk/snyk-code.json "Snyk Scan"
          upload all-reports/reports-snyk/snyk-sca.json "Snyk Scan"

# ============================================================================
# 6. BUILD â†’ SIGN â†’ SBOM
# ============================================================================
  build_and_sign:
    needs: epss_gate
    runs-on: self-hosted
    if: github.event.inputs.run_full_deploy == 'true'
    outputs:
      image_ref: ${{ steps.export.outputs.image_ref }}

    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Syft & Cosign
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b $HOME/.local/bin
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /usr/local/bin/cosign
          chmod +x /usr/local/bin/cosign

      - name: Build & Push Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.DOCKERHUB_REPO }}:${{ env.IMAGE_TAG }}

      - name: Export Image Ref
        id: export
        run: |
          DIGEST="${{ steps.build.outputs.digest }}"
          IMG="${{ env.DOCKERHUB_REPO }}@${DIGEST}"
          echo "image_ref=${IMG}" >> $GITHUB_OUTPUT
          echo "IMAGE_TO_SIGN=${IMG}" >> $GITHUB_ENV

      - name: Generate SBOM
        run: syft "${IMAGE_TO_SIGN}" -o cyclonedx-json=sbom.json

      - name: Sign Image
        run: cosign sign --yes "${IMAGE_TO_SIGN}"
        env:
          COSIGN_EXPERIMENTAL: 1

      - name: Attest SBOM
        run: cosign attest --predicate sbom.json --type cyclonedx "${IMAGE_TO_SIGN}"

# ============================================================================
# 7. DEPLOYMENT
# ============================================================================
  deploy:
    needs: build_and_sign
    runs-on: self-hosted
    if: needs.build_and_sign.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Deploy via Ansible
        run: |
          IMAGE_REF="${{ needs.build_and_sign.outputs.image_ref }}"
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner_temp
          chmod 600 ~/.ssh/id_runner_temp

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_runner_temp \
            -e "image_ref=${IMAGE_REF}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}"

      - name: Notify Slack â€“ Deployment Success
        if: success()
        run: |
          MSG="ðŸš€ Deployment Successful  
          â€¢ App: ${APP_NAME}  
          â€¢ Image: ${{ needs.build_and_sign.outputs.image_ref }}  
          â€¢ Target: ${APP_URL}"
          curl -X POST -H "Content-type: application/json" \
            --data "$(jq -n --arg text "$MSG" '{text:$text}')" \
            "${SLACK_WEBHOOK_URL}"

# ============================================================================
# 8. DAST (OWASP ZAP)
# ============================================================================
  dast_scan:
    needs: deploy
    runs-on: self-hosted

    steps:
      - name: Run OWASP ZAP Baseline
        run: |
          docker run --rm -v "$(pwd):/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t "${APP_URL}" \
            -J zap_report.json || true

      - name: Upload ZAP to DefectDojo
        run: |
          if [ -f zap_report.json ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "active=true" \
              -F "verified=true" \
              -F "scan_type=ZAP Scan" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement_name=DAST-${{ github.run_number }}" \
              -F "file=@zap_report.json"
          fi

# ============================================================================
# 9. SLACK ENHANCED SECURITY REPORT
# ============================================================================
  slack_enhanced_report:
    needs: [epss_gate, deploy, dast_scan]
    runs-on: self-hosted
    if: always()

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: epss-report
          path: security-reports

      - name: Generate Slack Enhanced Summary
        run: |
          python3 scripts/slack_report_builder.py \
            --repo "vuln-bank" \
            --env "production" \
            --pipeline "${{ github.workflow }}" \
            --deploy-status "Run #${{ github.run_number }}" \
            --epss "security-reports/epss-findings.json" \
            --summary "security-reports/scan-summary.json" \
            --output slack_payload.json

      - name: Send Slack Summary
        run: |
          curl -X POST -H "Content-type: application/json" \
            --data @slack_payload.json \
            "${SLACK_WEBHOOK_URL}"
