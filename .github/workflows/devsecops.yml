name: Vuln Bank DevSecOps Pipeline

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      run_full_deploy:
        description: "Build + Sign + Deploy?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  security-events: write
  issues: write
  checks: write
  id-token: write
  pull-requests: write # Penting untuk Post PR Comment

concurrency:
  group: vulnbank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  APP_URL: http://192.168.107.135:5000
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"
  COMPOSITE_THRESHOLD: "0.65"
  PYTHON_BIN: python3
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}

jobs:
################################################################################
# 0) AUTO-FIX & SETUP (Parallel Execution)
################################################################################
  autofix:
    name: Copilot Autofix (via CodeQL)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"
          upload: "always" # Upload langsung agar Autofix bekerja

  setup:
    name: Infrastructure Setup
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Python Cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
      - name: Prepare Workspace & Tools
        run: |
          mkdir -p "${REPORT_DIR}"
          python3 -m pip install --upgrade pip
          # Ensure Tools are present (Trivy, Snyk, Semgrep, Checkov)
          command -v semgrep || pip3 install semgrep
          command -v checkov || pip3 install checkov

################################################################################
# 1) SECURITY SCANS (Parallel Matrix)
################################################################################
  security_scans:
    needs: setup
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        scan: [trufflehog, semgrep, trivy, snyk, checkov]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: mkdir -p "${REPORT_DIR}"

      - name: Run Scan (${{ matrix.scan }})
        run: |
          if [ "${{ matrix.scan }}" == "trufflehog" ]; then
            trufflehog git file://$(pwd) --json --only-verified > ${REPORT_DIR}/trufflehog.json || true
          elif [ "${{ matrix.scan }}" == "semgrep" ]; then
            semgrep scan --config p/owasp-top-ten --json > ${REPORT_DIR}/semgrep.json || true
          elif [ "${{ matrix.scan }}" == "checkov" ]; then
            checkov -d . --output json > ${REPORT_DIR}/checkov.json || true
          elif [ "${{ matrix.scan }}" == "trivy" ]; then
            trivy fs . --scanners vuln --format json --output ${REPORT_DIR}/trivy-fs.json || true
          elif [ "${{ matrix.scan }}" == "snyk" ]; then
            export SNYK_TOKEN=${{ secrets.SNYK_TOKEN }}
            snyk test --json > ${REPORT_DIR}/snyk-sca.json || true
          fi

      - name: Upload Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.scan }}
          path: ${{ env.REPORT_DIR }}/*.json

################################################################################
# 2) AI SECURITY & COMPOSITE GATE
################################################################################
  ai_and_gate:
    needs: security_scans
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Run AI & Risk Analysis
        run: |
          mkdir -p "${REPORT_DIR}"
          # Jalankan skrip yang sudah Anda buat
          ${PYTHON_BIN} scripts/llm_pipeline.py
          ${PYTHON_BIN} scripts/epss_gate.py --threshold "${EPSS_THRESHOLD}" --output "${REPORT_DIR}/epss-findings.json" $(find all-reports -name "*.json" -printf "--input %p ")
          ${PYTHON_BIN} scripts/composite_security_gate.py
          ${PYTHON_BIN} scripts/render_composite_dashboard.py

      # --- BEST PRACTICE: FEEDBACK LANGSUNG DI PR ---
      - name: Post PR Dashboard
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: security-reports/composite-dashboard.md
          comment_tag: security_dashboard
          mode: upsert

      - name: Check Gate Status
        run: |
          status=$(jq -r '.status' security-reports/composite-findings.json)
          if [ "$status" == "FAIL" ]; then echo "Security Gate Failed!"; exit 1; fi

################################################################################
# 3) DEPLOYMENT (Conditional)
################################################################################
  build_deploy:
    needs: ai_and_gate
    if: github.event.inputs.run_full_deploy == 'true' || github.ref == 'refs/heads/main'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Docker Build & Sign
        run: |
          docker build -t ${DOCKERHUB_REPO}:${IMAGE_TAG} -f ${DOCKERFILE_PATH} .
          # Tambahkan Cosign Sign di sini jika diperlukan
      - name: Ansible Deploy
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
          -e "image_tag=${IMAGE_TAG}"

################################################################################
# 4) DAST & NOTIFY
################################################################################
  dast_and_notify:
    needs: build_deploy
    runs-on: self-hosted
    if: always()
    steps:
      - name: ZAP DAST Scan
        if: needs.build_deploy.result == 'success'
        run: |
          docker run --rm -v "$(pwd):/zap/wrk/" ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t "${APP_URL}" -J zap_report.json || true

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ needs.ai_and_gate.result == 'success' && 'good' || 'danger' }}
          SLACK_MESSAGE: "VulnBank Security Report: ${{ needs.ai_and_gate.result }}"