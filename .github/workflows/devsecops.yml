name: Vuln Bank DevSecOps Pipeline (Self-Hosted Clean + Snyk)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"

  # Docker image
  IMAGE_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  # DAST target (app running on VM2)
  DAST_TARGET_URL: http://192.168.107.135:5500

  # Slack
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # SonarQube (VM4)
  SONAR_HOST_URL: "http://192.168.107.132:9000"
  SONAR_PROJECT_KEY: "vuln-bank"

  # DefectDojo
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

jobs:
  # ==========================================================
  # 1. SECURITY SCANS
  # ==========================================================
  security_scans:
    name: Security Scans (Secrets / SCA / SAST / Misconfig / SBOM / SonarQube / Snyk)
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p ${REPORT_DIR}
          mkdir -p ${REPORT_DIR}/snyk

      # ------------------------------
      # Secret Scanning (Gitleaks)
      # ------------------------------
      - name: Secret Scan (Gitleaks)
        run: |
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path "${REPORT_DIR}/gitleaks.json" || true

      # ------------------------------
      # SCA Scan (Trivy FS)
      # ------------------------------
      - name: SCA Scan (Trivy filesystem)
        run: |
          trivy fs \
            --security-checks vuln,secret \
            --format json \
            --output "${REPORT_DIR}/trivy-sca.json" \
            .

      # ------------------------------
      # SAST Python (Bandit)
      # ------------------------------
      - name: SAST Python (Bandit)
        run: |
          bandit -r \
            app.py auth.py database.py \
            containers/app containers/db \
            -f json -o "${REPORT_DIR}/bandit.json" || true

      # ------------------------------
      # SAST Multi-Language (Semgrep)
      # ------------------------------
      - name: SAST Semgrep
        run: |
          semgrep --config auto \
            --include app.py \
            --include auth.py \
            --include database.py \
            --include-dir templates \
            --include-dir static \
            --json > "${REPORT_DIR}/semgrep.json" || true

      # ------------------------------
      # Misconfiguration (Trivy Config)
      # ------------------------------
      - name: Misconfig Scan (Trivy Config)
        run: |
          trivy config \
            --format json \
            --output "${REPORT_DIR}/trivy-misconfig.json" \
            .

      # ------------------------------
      # Misconfiguration (Checkov)
      # ------------------------------
      - name: Misconfig Scan (Checkov)
        run: checkov -d . -o json > "${REPORT_DIR}/checkov.json" || true

      # ------------------------------
      # SBOM (Syft)
      # ------------------------------
      - name: Generate SBOM (Syft)
        run: syft dir:. -o json > "${REPORT_DIR}/sbom.json"

      # ------------------------------
      # SonarQube Scan
      # ------------------------------
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # ------------------------------
      # SNYK SECTION
      # ------------------------------
      - name: Snyk Authenticate
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "${SNYK_TOKEN}"

      # Snyk SCA
      - name: Snyk SCA (Python)
        run: |
          snyk test \
            --file=requirements.txt \
            --package-manager=pip \
            --json > "${REPORT_DIR}/snyk/snyk-sca.json" || true

      # Snyk Code (SAST)
      - name: Snyk Code Scan
        run: snyk code test --json > "${REPORT_DIR}/snyk/snyk-sast.json" || true

      # Snyk Container
      - name: Snyk Container Scan
        run: |
          snyk container test "${IMAGE_REPO}:${IMAGE_TAG}" \
            --file=${DOCKERFILE_PATH} \
            --json > "${REPORT_DIR}/snyk/snyk-container.json" || true

      # ------------------------------
      # Upload Reports
      # ------------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

  # ==========================================================
  # 2. EPSS GATE (BLOCK DEPLOYMENT)
  # ==========================================================
  epss_gate:
    name: EPSS Gate
    runs-on: self-hosted
    needs: security_scans

    outputs:
      can_deploy: ${{ steps.gate.outputs.can_deploy }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Run EPSS Gate
        id: epss
        run: |
          python3 scripts/epss_gate.py \
            --input "${REPORT_DIR}/trivy-sca.json" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}" || exit 1

      - name: Set Deployment Gate
        id: gate
        run: echo "can_deploy=true" >> "$GITHUB_OUTPUT"

  # ==========================================================
  # 3. BUILD & PUSH DOCKER IMAGE
  # ==========================================================
  build_and_push:
    name: Build & Push Docker Image
    runs-on: self-hosted
    needs: epss_gate

    if: needs.epss_gate.outputs.can_deploy == 'true'

    outputs:
      image: ${{ steps.image_ref.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" \
            | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t ${IMAGE_REPO}:${IMAGE_TAG} -f ${DOCKERFILE_PATH} .

      - name: Push image
        run: docker push ${IMAGE_REPO}:${IMAGE_TAG}

      - name: Export image ref
        id: image_ref
        run: echo "image=${IMAGE_REPO}:${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

  # ==========================================================
  # 4. DEPLOY VIA ANSIBLE (VM2 & VM3)
  # ==========================================================
  deploy:
    name: Deploy to VMs with Ansible
    runs-on: self-hosted
    needs: build_and_push

    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_ansible
          chmod 600 ~/.ssh/id_ansible

      - name: Deploy with Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_ansible \
            -e "image_ref=${{ needs.build_and_push.outputs.image }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}"

  # ==========================================================
  # 5. DAST (OWASP ZAP)
  # ==========================================================
  dast:
    name: DAST Scan (OWASP ZAP)
    runs-on: self-hosted
    needs: deploy

    steps:
      - uses: actions/checkout@v4

      - name: Run ZAP Baseline
        run: |
          docker compose -f docker-compose.dast.yml down || true
          docker compose -f docker-compose.dast.yml up --abort-on-container-exit
          docker compose -f docker-compose.dast.yml down

      - uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

  # ==========================================================
  # 6. DEFECTDOJO IMPORT
  # ==========================================================
  defectdojo_import:
    name: Import to DefectDojo
    runs-on: self-hosted
    needs: dast

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - uses: actions/download-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

      - name: Skip if DefectDojo variables missing
        run: |
          if [ -z "${DEFECTDOJO_URL}" ] || [ -z "${DEFECTDOJO_API_KEY}" ]; then
             echo "DefectDojo variables not set. Skipping import."
             exit 0
          fi

      - name: Import ZAP to DefectDojo
        run: |
          if [ -f "${REPORT_DIR}/zap/zap_alerts.json" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=ZAP Scan" \
              -F "file=@${REPORT_DIR}/zap/zap_alerts.json" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          else
            echo "No ZAP report found, skipping."
          fi
