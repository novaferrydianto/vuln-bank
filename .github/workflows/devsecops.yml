name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"

  IMAGE_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  DAST_TARGET_URL: http://192.168.107.135:5500

  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  SONAR_HOST_URL: "http://192.168.107.132:9000"
  SONAR_PROJECT_KEY: vuln-bank

  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

jobs:

  # =====================================================
  # 1. SECURITY SCANS
  # =====================================================
  security_scans:
    name: Security Scans (Secrets / SCA / SAST / Misconfig / SBOM / Snyk / SonarQube)
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p ${REPORT_DIR}
          mkdir -p ${REPORT_DIR}/snyk

      - name: Secret Scan (Gitleaks)
        run: |
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path "${REPORT_DIR}/gitleaks.json" || true

      - name: SCA Scan (Trivy FS)
        run: |
          trivy fs \
            --scanners vuln,secret \
            --format json \
            --output "${REPORT_DIR}/trivy-sca.json" \
            .

      - name: SAST Python (Bandit)
        run: |
          bandit -r \
            app.py auth.py database.py \
            containers/app containers/db \
            -f json -o "${REPORT_DIR}/bandit.json" || true

      - name: SAST Semgrep (Fixed)
        run: |
          semgrep scan \
            --config auto \
            --json \
            app.py \
            auth.py \
            database.py \
            containers/app \
            containers/db \
            templates \
            static \
            > "${REPORT_DIR}/semgrep.json" || true

      - name: Misconfig Scan (Trivy Config)
        run: |
          trivy config \
            --format json \
            --output "${REPORT_DIR}/trivy-misconfig.json" \
            .

      - name: Misconfig Scan (Checkov)
        run: |
          checkov -d . -o json > "${REPORT_DIR}/checkov.json" || true

      - name: SBOM Scan (Syft)
        run: |
          syft dir:. -o json > "${REPORT_DIR}/sbom.json"

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Snyk Authenticate
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Snyk SCA (pip)
        run: |
          snyk test \
            --file=requirements.txt \
            --package-manager=pip \
            --json > "${REPORT_DIR}/snyk/snyk-sca.json" || true

      - name: Snyk Code Test (SAST)
        run: |
          snyk code test \
            --json > "${REPORT_DIR}/snyk/snyk-sast.json" || true

      - name: Snyk Container Scan
        run: |
          snyk container test "${IMAGE_REPO}:${IMAGE_TAG}" \
            --file=${DOCKERFILE_PATH} \
            --json > "${REPORT_DIR}/snyk/snyk-container.json" || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

  # =====================================================
  # 2. EPSS GATE
  # =====================================================
  epss_gate:
    name: EPSS Gate
    runs-on: self-hosted
    needs: security_scans

    outputs:
      can_deploy: ${{ steps.decision.outputs.can_deploy }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: EPSS Gate Execution
        run: |
          python3 scripts/epss_gate.py \
            --input "${REPORT_DIR}/trivy-sca.json" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}"

      - name: Decision
        id: decision
        run: echo "can_deploy=true" >> "$GITHUB_OUTPUT"

  # =====================================================
  # 3. NOTIFICATION (CRITICAL + EPSS HIGH)
  # =====================================================
  notify:
    name: Slack Notification (Critical or EPSS High)
    runs-on: self-hosted
    needs: [security_scans, epss_gate]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Parse Findings
        id: parse
        run: |
          CRIT_FOUND="false"
          EPSS_FOUND="false"

          if jq -e '.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL" or .Severity=="HIGH")' \
            "${REPORT_DIR}/trivy-sca.json" >/dev/null 2>&1; then
            CRIT_FOUND="true"
          fi

          for f in "${REPORT_DIR}/snyk/snyk-sca.json" \
                   "${REPORT_DIR}/snyk/snyk-sast.json" \
                   "${REPORT_DIR}/snyk/snyk-container.json"; do
            if [ -f "$f" ]; then
              if jq -e '.vulnerabilities[] | select(.severity=="high" or .severity=="critical")' \
                "$f" >/dev/null 2>&1; then
                CRIT_FOUND="true"
              fi
            fi
          done

          if jq -e '.results[] | select(.extra.severity=="ERROR" or .extra.severity=="WARNING")' \
            "${REPORT_DIR}/semgrep.json" >/dev/null 2>&1; then
            CRIT_FOUND="true"
          fi

          if jq -e '.high_risk | length > 0' \
            "${REPORT_DIR}/epss-findings.json" >/dev/null 2>&1; then
            EPSS_FOUND="true"
          fi

          echo "crit=$CRIT_FOUND" >> "$GITHUB_OUTPUT"
          echo "epss=$EPSS_FOUND" >> "$GITHUB_OUTPUT"

      - name: Send Slack Alert
        if: steps.parse.outputs.crit == 'true' || steps.parse.outputs.epss == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TEXT="⚠️ *Vuln Bank Security Alert* ⚠️"

          if [ "${{ steps.parse.outputs.crit }}" = "true" ]; then
            TEXT="$TEXT\n• *Critical/High vulnerabilities detected*"
          fi

          if [ "${{ steps.parse.outputs.epss }}" = "true" ]; then
            TEXT="$TEXT\n• *EPSS High-Risk CVEs detected (>= ${EPSS_THRESHOLD})*"
          fi

          TEXT="$TEXT\n\nCommit: $GITHUB_SHA\nRepo: $GITHUB_REPOSITORY"

          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"$TEXT\"}" "$SLACK_WEBHOOK_URL"

  # =====================================================
  # 4. BUILD & PUSH
  # =====================================================
  build_and_push:
    name: Build & Push Docker Image
    runs-on: self-hosted
    needs: [epss_gate, notify]
    if: needs.epss_gate.outputs.can_deploy == 'true'

    outputs:
      image: ${{ steps.out.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" \
            | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t ${IMAGE_REPO}:${IMAGE_TAG} -f ${DOCKERFILE_PATH} .

      - name: Push image
        run: docker push ${IMAGE_REPO}:${IMAGE_TAG}

      - name: Output image
        id: out
        run: echo "image=${IMAGE_REPO}:${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

  # =====================================================
  # 5. DEPLOY (ANSIBLE)
  # =====================================================
  deploy:
    name: Deploy to VMs (Ansible)
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_ansible
          chmod 600 ~/.ssh/id_ansible

      - name: Deploy via Ansible
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_ansible \
            -e "image_ref=${{ needs.build_and_push.outputs.image }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}"

  # =====================================================
  # 6. DAST SCAN
  # =====================================================
  dast:
    name: DAST Scan (OWASP ZAP)
    runs-on: self-hosted
    needs: deploy

    steps:
      - uses: actions/checkout@v4

      - name: Run ZAP DAST
        run: |
          docker compose -f docker-compose.dast.yml down || true
          docker compose -f docker-compose.dast.yml up --abort-on-container-exit
          docker compose -f docker-compose.dast.yml down

      - uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

  # =====================================================
  # 7. DEFECTDOJO IMPORT (ZAP + SNYK)
  # =====================================================
  defectdojo_import:
    name: Import Scan Results to DefectDojo
    runs-on: self-hosted
    needs: dast

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - uses: actions/download-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

      - name: Check ENV
        run: |
          if [ -z "${DEFECTDOJO_URL}" ] || [ -z "${DEFECTDOJO_API_KEY}" ]; then
            echo "Missing DefectDojo credentials. Skipping import."
            exit 0
          fi

      - name: Import ZAP Scan
        run: |
          FILE="${REPORT_DIR}/zap/zap_alerts.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=ZAP Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          fi

      - name: Import Snyk SCA
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-sca.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Snyk Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          fi

      - name: Import Snyk Code Scan
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-sast.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Snyk Code Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          fi

      - name: Import Snyk Container Scan
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-container.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Snyk Container Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          fi
