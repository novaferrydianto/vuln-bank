name: Vuln Bank DevSecOps Pipeline (Self-Hosted Complete)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  APP_URL: "http://192.168.107.135"
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"

  IMAGE_REPO: ${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  DAST_TARGET_URL: http://192.168.107.135:5500

  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  SONAR_HOST_URL: "http://192.168.107.132:9000"
  SONAR_PROJECT_KEY: vuln-bank

  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

# =====================================================================
# 1. SECURITY SCANS
# =====================================================================
jobs:
  security_scans:
    name: Security Scans (All Tools)
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p "${REPORT_DIR}"
          mkdir -p "${REPORT_DIR}/snyk"

      - name: Secret Scan (Gitleaks)
        run: |
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path "${REPORT_DIR}/gitleaks.json" || true

      - name: SCA Scan (Trivy FS)
        run: |
          trivy fs --scanners vuln,secret \
            --format json \
            --output "${REPORT_DIR}/trivy-sca.json" .

      - name: SAST Python (Bandit)
        run: |
          bandit -r app.py auth.py database.py containers/app containers/db \
            -f json -o "${REPORT_DIR}/bandit.json" || true

      - name: SAST Semgrep
        run: |
          semgrep scan --config auto --json \
            app.py auth.py database.py containers/app containers/db templates static \
            > "${REPORT_DIR}/semgrep.json" || true

      - name: Misconfig Scan (Trivy Config)
        run: |
          trivy config --format json \
            --output "${REPORT_DIR}/trivy-misconfig.json" .

      - name: Misconfig Scan (Checkov)
        run: |
          checkov -d . -o json > "${REPORT_DIR}/checkov.json" || true

      - name: SBOM Scan (Syft)
        run: syft dir:. -o json > "${REPORT_DIR}/sbom.json"

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Snyk Authenticate
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Snyk SCA (pip)
        run: |
          snyk test --file=requirements.txt --package-manager=pip \
            --json > "${REPORT_DIR}/snyk/snyk-sca.json" || true

      - name: Snyk Code Test (SAST)
        run: snyk code test --json > "${REPORT_DIR}/snyk/snyk-sast.json" || true

      - name: Snyk Container Scan
        run: |
          snyk container test "${IMAGE_REPO}:${IMAGE_TAG}" \
            --file=${DOCKERFILE_PATH} \
            --json > "${REPORT_DIR}/snyk/snyk-container.json" || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

# =====================================================================
# 2. IMPORT STATIC SCANS â†’ DEFECTDOJO
# =====================================================================
  defectdojo_import_scans:
    name: Import Static Scans to DefectDojo
    runs-on: self-hosted
    needs: security_scans

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      # Gitleaks
      - name: Import Gitleaks
        run: |
          FILE="${REPORT_DIR}/gitleaks.json"
          if [ -f "$FILE" ]; then
            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Gitleaks Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Trivy SCA
      - name: Import Trivy SCA
        run: |
          FILE="${REPORT_DIR}/trivy-sca.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Trivy Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Bandit
      - name: Import Bandit
        run: |
          FILE="${REPORT_DIR}/bandit.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=Bandit Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Semgrep
      - name: Import Semgrep
        run: |
          FILE="${REPORT_DIR}/semgrep.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Semgrep JSON Report" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Trivy Config
      - name: Import Trivy Config
        run: |
          FILE="${REPORT_DIR}/trivy-misconfig.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Trivy Config Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Checkov
      - name: Import Checkov
        run: |
          FILE="${REPORT_DIR}/checkov.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Checkov Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # SBOM (Syft)
      - name: Import SBOM
        run: |
          FILE="${REPORT_DIR}/sbom.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=CycloneDX Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Snyk SCA
      - name: Import Snyk SCA
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-sca.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Snyk Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Snyk SAST
      - name: Import Snyk SAST
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-sast.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Snyk Code Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

      # Snyk Container
      - name: Import Snyk Container
        run: |
          FILE="${REPORT_DIR}/snyk/snyk-container.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -F "scan_type=Snyk Container Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}"
          fi

# =====================================================================
# 3. EPSS GATE (AFTER IMPORT OF STATIC SCANS)
# =====================================================================
  epss_gate:
    name: EPSS Gate
    runs-on: self-hosted
    needs: defectdojo_import_scans

    outputs:
      can_deploy: ${{ steps.dec.outputs.can_deploy }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Run EPSS Gate
        run: |
          python3 scripts/epss_gate.py \
            --input "${REPORT_DIR}/trivy-sca.json" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}" || true

      - name: EPSS Dashboard Summary
        run: python3 scripts/composite_security_gate.py >> "$GITHUB_STEP_SUMMARY"

      - name: Decision
        id: dec
        run: |
          if jq -e '.high_risk | length > 0' "${REPORT_DIR}/epss-findings.json"; then
            echo "can_deploy=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "can_deploy=true" >> "$GITHUB_OUTPUT"
          fi

# =====================================================================
# 4. NOTIFICATION
# =====================================================================
  notify:
    name: Slack Notification
    runs-on: self-hosted
    needs: [security_scans, epss_gate]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Parse Findings
        id: parse
        run: |
          CRIT=false
          EPSS=false

          if jq -e '.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL" or .Severity=="HIGH")' \
              "${REPORT_DIR}/trivy-sca.json"; then CRIT=true; fi

          if jq -e '.high_risk | length > 0' "${REPORT_DIR}/epss-findings.json"; then EPSS=true; fi

          echo "crit=$CRIT" >> "$GITHUB_OUTPUT"
          echo "epss=$EPSS" >> "$GITHUB_OUTPUT"

      - name: Send Slack Alert
        if: steps.parse.outputs.crit == 'true' || steps.parse.outputs.epss == 'true'
        run: |
          MSG="âš ï¸ Vuln Bank Security Alert â€” Critical/High/EPSS High Detected."
          curl -X POST -H 'Content-Type: application/json' \
            --data "{\"text\": \"$MSG\"}" "$SLACK_WEBHOOK_URL"

# =====================================================================
# 5. CREATE GITHUB ISSUES
# =====================================================================
  create_issues:
    name: Create GitHub Issues
    runs-on: self-hosted
    needs: [security_scans, epss_gate]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: Create Issues from Findings
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 scripts/epss_create_issues.py \
            --repo "$REPO" \
            --epss "${REPORT_DIR}/epss-findings.json" \
            --snyk-sca "${REPORT_DIR}/snyk/snyk-sca.json"

# =====================================================================
# 6. BUILD & SIGN (COSIGN v3)
# =====================================================================
  build_and_sign:
    name: Build + Push + Sign + SBOM
    runs-on: self-hosted
    needs: epss_gate
    if: needs.epss_gate.outputs.can_deploy == 'true'

    outputs:
      image_ref: ${{ steps.export.outputs.image_ref }}

    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Tools (Syft + Cosign)
        run: |
          mkdir -p $HOME/.local/bin

          # Syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b $HOME/.local/bin

          # Cosign v3
          curl -sSfL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o $HOME/.local/bin/cosign
          chmod +x $HOME/.local/bin/cosign

          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"

      - name: Debug Cosign
        run: |
          which cosign
          cosign version || true

      - name: Build and Push Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:latest
            ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

      - name: Export Image Ref
        id: export
        run: |
          DIGEST="${{ steps.build.outputs.digest }}"
          if [ -z "$DIGEST" ]; then
            echo "WARN: digest empty, fallback to tag"
            IMAGE_REF="${IMAGE_REPO}:${IMAGE_TAG}"
          else
            IMAGE_REF="${IMAGE_REPO}@${DIGEST}"
          fi
          
          echo "image_ref=${IMAGE_REPO}@${DIGEST}" >> $GITHUB_OUTPUT
          echo "IMAGE_TO_SIGN=${IMAGE_REPO}@${DIGEST}" >> $GITHUB_ENV

      - name: Generate SBOM (CycloneDX)
        run: syft "${IMAGE_TO_SIGN}" -o cyclonedx-json=sbom.json

      - name: Sign Image & Attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          cosign sign --yes "${IMAGE_TO_SIGN}"
          cosign attest \
            --predicate sbom.json \
            --type cyclonedx \
            "${IMAGE_TO_SIGN}"

      - uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json

# =====================================================================
# 7. DEPLOY (ANSIBLE + VERIFY SIGNATURE)
# =====================================================================
  deploy:
    name: Deploy (Ansible)
    needs: build_and_sign
    runs-on: self-hosted
    if: needs.build_and_sign.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Verify Signed Image
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          cosign verify "${{ needs.build_and_sign.outputs.image_ref }}"

      - name: Execute Ansible Deployment
        env:
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_ref }}
        run: |
          if [ -z "${IMAGE_REF}" ]; then
            IMAGE_REF="${IMAGE_REPO}:latest"
          fi

          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner_temp
          chmod 600 ~/.ssh/id_runner_temp

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_runner_temp \
            -e "image_ref=${IMAGE_REF}" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}" \
            -e "deepseek_key=${{ secrets.DEEPSEEK_API_KEY }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Notify Slack on Success
        if: success()
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          IMAGE_REF: ${{ needs.build_and_sign.outputs.image_ref }}
        run: |
          msg="ðŸš€ Deployment Success\nâ€¢ Image: ${IMAGE_REF}\nâ€¢ Target: ${APP_URL}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$msg\"}" "$SLACK_URL"

# =====================================================================
# 8. DAST (ZAP)
# =====================================================================
  dast:
    name: DAST Scan (OWASP ZAP)
    runs-on: self-hosted
    needs: deploy

    steps:
      - uses: actions/checkout@v4

      - name: Run ZAP DAST
        run: |
          docker compose -f docker-compose.dast.yml down || true
          docker compose -f docker-compose.dast.yml up --abort-on-container-exit
          docker compose -f docker-compose.dast.yml down

      - uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

# =====================================================================
# 9. IMPORT ZAP â†’ DEFECTDOJO
# =====================================================================
  defectdojo_import_dast:
    name: Import ZAP DAST to DefectDojo
    runs-on: self-hosted
    needs: dast

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap

      - name: Import ZAP Report
        run: |
          FILE="${REPORT_DIR}/zap/zap_alerts.json"
          if [ -f "$FILE" ]; then
            curl -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=ZAP Scan" \
              -F "file=@${FILE}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true"
          fi

# =====================================================================
# 10. DEFECTDOJO CLEANUP (FINAL STEP)
# =====================================================================
  cleanup_defectdojo:
    name: Cleanup & Enrich DefectDojo
    runs-on: self-hosted
    needs: [defectdojo_import_scans, defectdojo_import_dast]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Cleanup DefectDojo
        run: python3 scripts/cleanup_defectdojo.py
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}