# ======================================================
# Vuln Bank â€“ DevSecOps Pipeline (Refactored FULL)
# ======================================================

name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"   # 01:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  PYTHON_BIN: python3.11
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: "1"

# ======================================================
# 0) PREP â€“ SCAN MODE (LIGHT vs FULL)
# ======================================================
jobs:
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - id: mode
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            echo "mode=light" >> "$GITHUB_OUTPUT"
          fi

# ======================================================
# 1) SECURITY SCANS (SAST / SCA / EPSS)
# ======================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    outputs:
      critical_found: ${{ steps.flags.outputs.critical }}
      high_risk: ${{ steps.flags.outputs.high_risk }}
      epss_max: ${{ steps.epss.outputs.max }}

    steps:
      - uses: actions/checkout@v4

      - name: Export scan mode
        run: echo "SCAN_MODE=${{ needs.prep.outputs.scan_mode }}" >> "$GITHUB_ENV"

      # ---------- Tool bootstrap ----------
      - name: Install security tools
        run: |
          set -euo pipefail
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          # jq (safe install â€“ no chmod if already present)
          if ! command -v jq >/dev/null; then
            curl -sSL \
              https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \
              -o "$BIN/jq"
            chmod +x "$BIN/jq"
          fi

          # Trivy
          if ! command -v trivy >/dev/null; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
              | sh -s -- -b "$BIN"
          fi

          # Syft
          if ! command -v syft >/dev/null; then
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
              | sh -s -- -b "$BIN"
          fi

      - name: Verify tools
        run: |
          jq --version
          trivy --version
          syft --version

      - name: Prepare report dirs
        run: mkdir -p "$REPORT_DIR"/{secrets,sast,sca,misconfig,sbom}

      # ---------- Init flags (single source of truth) ----------
      - name: Init flags
        run: |
          echo "critical=false" > flags.env
          echo "high_risk=false" >> flags.env

      # ---------- SAST â€“ Semgrep ----------
      - name: SAST â€“ Semgrep
        run: |
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep ci --config p/ci --json \
            > "$REPORT_DIR/sast/semgrep.json" || true

          jq '[.results[]|select(.extra.severity=="ERROR")] | length' \
            "$REPORT_DIR/sast/semgrep.json" | grep -qv 0 \
            && sed -i 's/critical=false/critical=true/' flags.env || true

      # ---------- SCA â€“ Trivy FS ----------
      - name: SCA â€“ Trivy FS
        run: |
          trivy fs --severity HIGH,CRITICAL --format json \
            -o "$REPORT_DIR/sca/trivy.json" .
          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="CRITICAL")] | length' \
            "$REPORT_DIR/sca/trivy.json" | grep -qv 0 \
            && sed -i 's/critical=false/critical=true/' flags.env || true

      # ---------- Misconfig â€“ Trivy Config ----------
      - name: Misconfig â€“ Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL --format json \
            -o "$REPORT_DIR/misconfig/config.json" .
          jq '[.Results[].Misconfigurations[]?|select(.Severity=="CRITICAL")] | length' \
            "$REPORT_DIR/misconfig/config.json" | grep -qv 0 \
            && sed -i 's/critical=false/critical=true/' flags.env || true

      # ---------- SBOM â€“ Syft ----------
      - name: SBOM â€“ Syft
        run: syft . -o json > "$REPORT_DIR/sbom/sbom.json"

      # ---------- EPSS â€“ risk scoring ----------
      - name: EPSS
        id: epss
        run: |
          MAX=0
          jq -r '..|.VulnerabilityID?//empty' \
            "$REPORT_DIR/sca/trivy.json" | sort -u > cves.txt || true

          while read -r cve; do
            [ -z "$cve" ] && continue
            epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
              | jq -r '.data[0].epss // 0')

            # Track max EPSS
            awk -v e="$epss" -v m="$MAX" 'BEGIN{if(e>m) exit 0; else exit 1}' \
              && MAX="$epss"

            # Mark high_risk if above threshold
            awk -v e="$epss" -v t="${EPSS_THRESHOLD}" 'BEGIN{if(e>=t) exit 0; else exit 1}' \
              && sed -i 's/high_risk=false/high_risk=true/' flags.env
          done < cves.txt || true

          echo "max=$MAX" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      # ---------- Export flags as job outputs ----------
      - id: flags
        run: |
          source flags.env
          echo "critical=$critical"   >> "$GITHUB_OUTPUT"
          echo "high_risk=$high_risk" >> "$GITHUB_OUTPUT"

# ======================================================
# 2) SECURITY GATE (severity-based, MAIN only)
# ======================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "âŒ SECURITY GATE FAILED"
            exit 1
          fi
          echo "âœ… Security Gate Passed"

# ======================================================
# 3) AUTO ISSUE (FULL + HIGH_RISK on MAIN)
# ======================================================
  security_issue:
    runs-on: self-hosted
    needs: [prep, security_scans]
    if: >
      github.ref == 'refs/heads/main' &&
      needs.prep.outputs.scan_mode == 'full' &&
      needs.security_scans.outputs.high_risk == 'true'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            // Avoid spamming: check existing open epss-high issues
            const { data } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: "epss-high",
              state: "open"
            });

            if (data.length > 0) {
              console.log("epss-high issue already open, skipping.");
              return;
            }

            const epssMax = "${{ needs.security_scans.outputs.epss_max }}";

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ High-Risk Vulnerability (EPSS ${epssMax})`,
              body: `
                Critical vulnerabilities with high exploitation probability were detected.

                - **Max EPSS**: ${epssMax}
                - **Threshold**: ${process.env.EPSS_THRESHOLD || "0.5"}
                - **Branch**: ${context.ref}
                - **Workflow**: Vuln Bank DevSecOps Pipeline

                Please review the CI security artifacts (security-reports) in the latest workflow run.
              `,
              labels: ["security", "critical", "epss-high"]
            });

# ======================================================
# 4) BUILD, SIGN, PUSH
# ======================================================
  build:
    runs-on: self-hosted
    needs: security_gate
    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
          -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & push image
        run: |
          docker build -t "$IMAGE_REPO:$IMAGE_TAG" .
          docker push "$IMAGE_REPO:$IMAGE_TAG"

      - uses: sigstore/cosign-installer@v3

      - name: Cosign Sign
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: cosign sign --yes "$IMAGE_REPO:$IMAGE_TAG"

# ======================================================
# 5) DEPLOY (Hosting VM â€“ Docker Compose)
# ======================================================
  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Deploy to hosting VM
        run: |
          ssh hosting@192.168.107.135 <<EOF
          set -e
          docker pull "$IMAGE_REPO:$IMAGE_TAG"
          cd /opt/vuln-bank-app/containers/app
          IMAGE_WITH_TAG="$IMAGE_REPO:$IMAGE_TAG" docker compose up -d
          EOF

# ======================================================
# 6) PR COMMENT â€“ SECURITY SUMMARY
# ======================================================
  pr_summary:
    runs-on: self-hosted
    needs: [prep, security_scans]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
            ### ðŸ” Vuln Bank â€“ Security Summary

            - **Scan Mode:** \`${{ needs.prep.outputs.scan_mode }}\`
            - **Critical Found:** \`${{ needs.security_scans.outputs.critical_found }}\`
            - **Max EPSS:** \`${{ needs.security_scans.outputs.epss_max }}\`

            ðŸ“Ž Full JSON reports are available as workflow artifacts under \`security-reports\`.
              `
            });

# ======================================================
# 7) SLACK (EPSS-AWARE SEVERITY)
# ======================================================
  slack_notify:
    runs-on: self-hosted
    needs: [prep, security_scans, security_gate]
    if: always()
    steps:
      - name: Send Slack notification
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          MODE="${{ needs.prep.outputs.scan_mode }}"
          CRIT="${{ needs.security_scans.outputs.critical_found }}"
          HIGH_RISK="${{ needs.security_scans.outputs.high_risk }}"
          EPSS="${{ needs.security_scans.outputs.epss_max }}"

          if [[ "$HIGH_RISK" == "true" ]]; then
            STATUS="ðŸš¨ HIGH RISK (EPSS ${EPSS})"
          elif [[ "$CRIT" == "true" ]]; then
            STATUS="âš ï¸ FINDINGS (Low EPSS)"
          else
            STATUS="âœ… CLEAN"
          fi

          TEXT="Vuln Bank DevSecOps | Mode=${MODE} | Critical=${CRIT} | MaxEPSS=${EPSS} | ${STATUS}"

          curl -X POST -H "Content-type: application/json" \
            --data "{\"text\":\"${TEXT}\"}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
