name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB Daily Scan
  workflow_dispatch:

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11

  IMAGE_REPO: xbash81/vuln-bank

  # === Bastion → VM2 (App Host) ===
  APP_HOST: "192.168.107.135"
  SSH_USER: "hosting"
  SSH_PORT: "22"
  DAST_TARGET_URL: "http://192.168.107.135:5000"

jobs:
  security_build_deploy_dast:
    name: Security Scan → Build → Deploy → DAST
    runs-on: [self-hosted, linux]

    outputs:
      critical_found: ${{ steps.evaluate.outputs.critical_found }}

    steps:
      # ==================================================
      # 0) CHECKOUT
      # ==================================================
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"

      # ==================================================
      # 1) PYTHON & TEST
      # ==================================================
      - name: Show Python version
        run: $PYTHON_BIN --version || true

      - name: Install Python dependencies
        run: |
          $PYTHON_BIN -m pip install --upgrade pip
          [ -f requirements.txt ] && $PYTHON_BIN -m pip install -r requirements.txt

      - name: Run unit tests (optional)
        continue-on-error: true
        run: |
          $PYTHON_BIN -m pip install pytest
          pytest || true

      # ==================================================
      # 2) SECRET SCANNING
      # ==================================================
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: |
            detect
            --source .
            --no-git
            --redact
            --report-format json
            --report-path ${{ env.REPORT_DIR }}/gitleaks.json

      # ==================================================
      # 3) SCA
      # ==================================================
      - name: SCA with pip-audit
        continue-on-error: true
        run: |
          $PYTHON_BIN -m pip install pip-audit
          [ -f requirements.txt ] && \
            pip-audit -r requirements.txt -f json \
            -o "$REPORT_DIR/pip-audit.json" || true

      # ==================================================
      # 4) SAST
      # ==================================================
      - name: SAST with Bandit
        continue-on-error: true
        run: |
          $PYTHON_BIN -m pip install bandit
          bandit -r . -f json -o "$REPORT_DIR/bandit.json" || true

      # ==================================================
      # 5) MISCONFIG & FS SCAN
      # ==================================================
      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-fs.json
          severity: HIGH,CRITICAL

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-config.json
          severity: HIGH,CRITICAL

      # ==================================================
      # 6) BUILD → IMAGE SCAN → PUSH
      # ==================================================
      - name: Docker Hub login
        run: | 
          if ! docker info > /dev/null 2>&1; then
            echo "Docker not available on runner"
            exit 1
          fi

          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: |
          docker build \
            -f containers/app/Dockerfile \
            -t "$IMAGE_REPO:${{ github.sha }}" \
            -t "$IMAGE_REPO:latest" \
            .

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-image.json
          severity: HIGH,CRITICAL

      - name: Push image
        run: |
          docker push "$IMAGE_REPO:${{ github.sha }}"
          docker push "$IMAGE_REPO:latest"

      # ==================================================
      # 7) DEPLOY TO VM2
      # ==================================================
      - name: Deploy app to VM2
        run: |
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" << EOF
              set -e
              cd /opt/vuln-bank/containers/app

              echo '${{ secrets.DOCKERHUB_TOKEN }}' | \
                docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin

              export IMAGE_WITH_TAG=$IMAGE_REPO:${{ github.sha }}
              export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
              export DEEPSEEK_API_KEY='${{ secrets.DEEPSEEK_API_KEY }}'

              docker compose pull
              docker compose up -d
          EOF

      - name: Wait for application
        run: |
          for i in {1..30}; do
            curl -sf "$DAST_TARGET_URL" && exit 0
            sleep 5
          done
          exit 1

      # ==================================================
      # 8) DAST – OWASP ZAP (Baseline)
      # ==================================================
      - name: Prepare ZAP workspace
        run: chmod -R u+rwX "$GITHUB_WORKSPACE"

      - name: OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          target: ${{ env.DAST_TARGET_URL }}
          cmd_options: "-a -T 120"
          fail_action: false
          allow_issue_writing: false
          artifact_name: zap-baseline-report

      # ==================================================
      # 9) RESULT AGGREGATION
      # ==================================================
      - name: Evaluate findings
        id: evaluate
        run: |
          critical=false

          if grep -RqiE '"severity":\s*"(CRITICAL|HIGH)"' "$REPORT_DIR"; then
            critical=true
          fi
          
          echo "critical_found=$critical" >> "$GITHUB_OUTPUT"

      # ==================================================
      # 10) UPLOAD ARTIFACTS
      # ==================================================
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: vuln-bank-security-reports
          path: ${{ env.REPORT_DIR }}
          if-no-files-found: warn

  notify:
    name: Notify on Critical Findings
    needs: security_build_deploy_dast
    runs-on: [self-hosted, linux]
    if: needs.security_build_deploy_dast.outputs.critical_found == 'true'

    steps:
      - name: Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0
          curl -X POST -H "Content-type: application/json" \
            --data '{"text":":rotating_light: Vuln Bank – High/Critical vulnerabilities detected"}' \
            "$SLACK_WEBHOOK_URL"
