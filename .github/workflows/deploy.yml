name: DevSecOps Vuln Bank (Multi-Arch + SBOM + Cosign + SLSA + Verify Gate)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  REPORT_DIR: security-reports
  REGISTRY: docker.io
  IMAGE_NAME: vuln-bank
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  EPSS_THRESHOLD: "0.7"

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write
  issues: write

jobs:

  # =====================================================================
  # 1) TEST + SAST
  # =====================================================================
  test_and_sast:
    runs-on: ubuntu-latest
    name: Python Tests & SAST

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Basic Syntax Check
        run: python -m compileall .

      - name: Run Pytest (optional)
        run: |
          if [ -d "tests" ]; then
            pip install pytest
            pytest || echo "Tests failed (not blocking)"
          else
            echo "No tests directory, skipping pytest"
          fi

      - name: SonarCloud Scan (SAST)
        uses: sonarsource/sonarcloud-github-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=vuln-bank
            -Dsonar.projectKey=vulnbank

  # =====================================================================
  # 2) SECRET SCAN (TruffleHog stable)
  # =====================================================================
  secret_scan:
    runs-on: ubuntu-latest
    name: Secret Scanning (TruffleHog)

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog OSS Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@v3.63.10
        continue-on-error: true
        with:
          path: .
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --fail-verified --json

      - name: Fail if verified secrets found
        if: steps.trufflehog.outcome == 'failure'
        run: |
          echo "üî• TruffleHog found verified secrets. Failing pipeline."
          exit 1

      - name: Save TruffleHog Summary
        run: |
          mkdir -p security-reports
          echo "TruffleHog outcome: ${{ steps.trufflehog.outcome }}" > security-reports/trufflehog.txt

      - name: Upload TruffleHog Report
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: security-reports/trufflehog.txt

  # =====================================================================
  # 3) SCA + MISCONFIG + EPSS GATE
  # =====================================================================
  security_audit:
    runs-on: ubuntu-latest
    name: Snyk + Trivy + EPSS Gate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Snyk Python SCA
        uses: snyk/actions/python-3.11@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true
        with:
          args: --severity-threshold=low --json-file-output=snyk-report.json

      - name: Enforce Snyk Policy (fail on High/Critical)
        run: |
          HIGH=$(grep -o '"severity":"high"' snyk-report.json | wc -l || true)
          CRIT=$(grep -o '"severity":"critical"' snyk-report.json | wc -l || true)
          echo "High: $HIGH, Critical: $CRIT"
          if [ $((HIGH + CRIT)) -gt 0 ]; then
            echo "‚õî Snyk gate failed: High/Critical vulnerabilities detected"
            exit 1
          fi
          echo "‚úÖ Snyk gate passed"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Trivy FS (SCA)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          format: json
          output: trivy-report.json
          vuln-type: "os,library"
          ignore-unfixed: true

      - name: Trivy Config (Misconfiguration)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          format: json
          output: trivy-config-report.json

      - name: EPSS Risk Gate (from Trivy CVEs)
        run: |
          CVE_LIST=$(jq -r '.. | objects | select(has("VulnerabilityID")) | .VulnerabilityID' trivy-report.json | sort -u)
          if [ -z "$CVE_LIST" ]; then
            echo "‚úÖ No CVEs from Trivy, skipping EPSS gate"
            exit 0
          fi

          CVE_QUERY=$(echo "$CVE_LIST" | paste -sd "," -)
          echo "CVE(s): $CVE_QUERY"
          EPSS=$(curl -s "https://api.first.org/data/v1/epss?cve=$CVE_QUERY")

          HIGH_RISK=$(echo "$EPSS" | jq --arg thr "${{ env.EPSS_THRESHOLD }}" \
            '[.data[] | select((.epss|tonumber) >= ($thr|tonumber))] | length')

          echo "EPSS high-risk count (>= ${EPSS_THRESHOLD}): $HIGH_RISK"

          if [ "$HIGH_RISK" -gt 0 ]; then
            echo "‚õî EPSS gate failed: Found $HIGH_RISK high-risk CVEs"
            echo "$EPSS" > epss-report.json
            exit 1
          fi

          echo "‚úÖ EPSS gate passed (no CVE above threshold)"

      - name: Upload Security Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            snyk-report.json
            trivy-report.json
            trivy-config-report.json
            epss-report.json

  # =====================================================================
  # 4) MULTI-ARCH BUILD + SBOM (single source IMAGE_REF)
  # =====================================================================
  multiarch_build_push:
    runs-on: ubuntu-latest
    name: Multi-Arch Build + SBOM
    outputs:
      sha_tag: ${{ steps.meta.outputs.sha_tag }}
      image_repo: ${{ steps.meta.outputs.image_repo }}
      image_ref: ${{ steps.meta.outputs.image_ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - id: meta
        name: Prepare Image Metadata
        run: |
          TAG="${GITHUB_SHA::7}"
          REPO="docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          REF="$REPO:$TAG"

          echo "sha_tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "image_repo=$REPO" >> "$GITHUB_OUTPUT"
          echo "image_ref=$REF" >> "$GITHUB_OUTPUT"

          echo "IMAGE_REPO=$REPO"
          echo "SHA_TAG=$TAG"
          echo "IMAGE_REF=$REF"

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build & Push Multi-Arch Image
        run: |
          IMAGE="${{ steps.meta.outputs.image_repo }}"
          TAG="${{ steps.meta.outputs.sha_tag }}"

          if [ -z "$IMAGE" ] || [ -z "$TAG" ]; then
            echo "‚ùå IMAGE or TAG is empty, aborting build"
            exit 1
          fi

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "$IMAGE:$TAG" \
            -t "$IMAGE:latest" \
            -f Dockerfile \
            --push .

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Generate SBOM (CycloneDX)
        run: |
          mkdir -p sbom
          IMAGE_REF="${{ steps.meta.outputs.image_ref }}"
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty, cannot generate SBOM"
            exit 1
          fi

          syft "$IMAGE_REF" -o cyclonedx-json > sbom/sbom-cyclonedx.json

      - name: Upload SBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom/sbom-cyclonedx.json

  # =====================================================================
  # 5) COSIGN SIGN + SBOM + SLSA
  # =====================================================================
  cosign_sign:
    needs: [multiarch_build_push, security_audit, secret_scan, test_and_sast]
    runs-on: ubuntu-latest
    name: Cosign Sign + Attest + SLSA

    steps:
      - name: Install Cosign
        run: |
          wget https://github.com/sigstore/cosign/releases/download/v2.4.1/cosign-linux-amd64
          mv cosign-linux-amd64 cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version

      - name: DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom

      - name: Cosign Sign Image
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in cosign_sign, aborting"
            exit 1
          fi

          cosign sign --yes "$IMAGE_REF"

      - name: Cosign Attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in SBOM attest, aborting"
            exit 1
          fi

          cosign attest --yes \
            --predicate sbom/sbom-cyclonedx.json \
            --type cyclonedx \
            "$IMAGE_REF"

      - name: Generate SLSA Provenance
        env:
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in SLSA generation, aborting"
            exit 1
          fi

          cat <<EOF > provenance.json
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "predicateType": "https://slsa.dev/provenance/v1",
            "subject": [{"name": "$IMAGE_REF"}],
            "predicate": {
              "buildType": "github-actions",
              "repo": "${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "actor": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}"
            }
          }
          EOF

      - name: Cosign SLSA Attest
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in SLSA attest, aborting"
            exit 1
          fi

          cosign attest --yes \
            --predicate provenance.json \
            --type slsaprovenance \
            "$IMAGE_REF"

  # =====================================================================
  # 6) SUPPLY CHAIN VERIFY GATE
  # =====================================================================
  supplychain_gate:
    needs: [cosign_sign, multiarch_build_push]
    runs-on: ubuntu-latest
    name: Supply Chain Verify Gate

    steps:
      - name: Install Cosign
        run: |
          wget https://github.com/sigstore/cosign/releases/download/v2.4.1/cosign-linux-amd64
          mv cosign-linux-amd64 cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version

      - name: Verify Cosign Signature
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in verify gate, aborting"
            exit 1
          fi

          cosign verify "$IMAGE_REF"

      - name: Verify SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          cosign verify-attestation \
            --type cyclonedx \
            "$IMAGE_REF"

      - name: Verify SLSA Attestation
        env:
          COSIGN_EXPERIMENTAL: "1"
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          cosign verify-attestation \
            --type slsaprovenance \
            "$IMAGE_REF"

  # =====================================================================
  # 7) DAST (OWASP ZAP) ‚Äî ONLY VERIFIED IMAGE
  # =====================================================================
  dast_zap:
    needs: [supplychain_gate, multiarch_build_push]
    runs-on: ubuntu-latest
    continue-on-error: true
    name: OWASP ZAP DAST (Verified Image)

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Pull Verified Image
        env:
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          if [ -z "$IMAGE_REF" ]; then
            echo "‚ùå IMAGE_REF empty in DAST, aborting"
            exit 1
          fi
          docker pull "$IMAGE_REF"

      - name: Run Vuln Bank Container
        env:
          IMAGE_REF: ${{ needs.multiarch_build_push.outputs.image_ref }}
        run: |
          docker run -d --rm -p 5000:5000 \
            --name vuln-bank-dast \
            "$IMAGE_REF"

          echo "Waiting for app on :5000..."
          for i in {1..20}; do
            if curl -sSf http://localhost:5000 >/dev/null 2>&1; then
              echo "App is up!"
              exit 0
            fi
            echo "Still waiting..."
            sleep 3
          done

          echo "App did not start in time"
          docker logs vuln-bank-dast || true
          exit 1

      - name: Decide ZAP Script
        id: scan
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "script=zap-full-scan.py" >> "$GITHUB_OUTPUT"
          else
            echo "script=zap-baseline.py" >> "$GITHUB_OUTPUT"
          fi

      - name: Run ZAP Scan
        run: |
          mkdir -p "$REPORT_DIR"
          docker run --rm --network=host \
            -v "$(pwd)/${REPORT_DIR}:/zap/wrk/" \
            ghcr.io/zaproxy/zaproxy:stable \
            ${{ steps.scan.outputs.script }} \
            -t http://localhost:5000 \
            -r zap-report.html \
            -J zap-report.json || true

      - name: Stop App Container
        if: always()
        run: |
          docker stop vuln-bank-dast || true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            ${{ env.REPORT_DIR }}/zap-report.json
            ${{ env.REPORT_DIR }}/zap-report.html

  # =====================================================================
  # 8) PIPELINE SUMMARY
  # =====================================================================
  summary:
    needs: dast_zap
    runs-on: ubuntu-latest
    name: DevSecOps Pipeline Summary

    steps:
      - name: Write Summary
        run: |
          echo "## DevSecOps Pipeline ‚Äî Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Secret Scan (TruffleHog v3.63.10)" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Tests + SonarCloud SAST" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Snyk SCA + Trivy SCA & Config + EPSS Gate" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Multi-Arch Buildx ‚Üí DockerHub" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ SBOM (CycloneDX) via Syft" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Cosign Sign + SBOM Attestation + SLSA Provenance" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ Supply Chain Verify Gate (Signature + SBOM + SLSA)" >> "$GITHUB_STEP_SUMMARY"
          echo "- ‚úÖ OWASP ZAP DAST (Verified Image Only)" >> "$GITHUB_STEP_SUMMARY"
