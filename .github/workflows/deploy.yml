name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # 01:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  POLICY_DIR: policy
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: "1"
  DAST_TARGET_URL: "http://vuln-bank-dast:5000"

# ======================================================
# 0) PREP – DETERMINE SCAN MODE
# ======================================================
jobs:
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - id: mode
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            echo "mode=light" >> $GITHUB_OUTPUT
          fi

# ======================================================
# 1) SECURITY SCANS
# ======================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    outputs:
      critical_found: ${{ steps.flag.outputs.critical_found }}
      scan_mode: ${{ steps.scanmode.outputs.mode }}

    steps:
      - uses: actions/checkout@v4

      - id: scanmode
        run: |
          echo "SCAN_MODE=${{ needs.prep.outputs.scan_mode }}" >> $GITHUB_ENV
          echo "mode=${{ needs.prep.outputs.scan_mode }}" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/trivy
          key: security-${{ hashFiles('requirements.txt') }}

      - name: Prepare environment
        run: |
          set -e
          ${PYTHON_BIN} -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip pip-audit jq

      - name: Install security tools
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh
          curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | sh
          curl -L https://github.com/snyk/cli/releases/latest/download/snyk-linux -o snyk
          chmod +x snyk && sudo mv snyk /usr/local/bin/

      - run: |
          mkdir -p ${REPORT_DIR}/{secrets,sca,sast,misconfig,dast,sbom}
          echo "false" > critical_flag.txt

# ======================================================
# SECRET SCANNING
# ======================================================
      - name: Gitleaks
        run: |
          gitleaks detect --source . --report-format json \
            --report-path ${REPORT_DIR}/secrets/gitleaks.json || true
          jq -e 'length>0' ${REPORT_DIR}/secrets/gitleaks.json \
            && echo true > critical_flag.txt || true

# ======================================================
# SAST – SEMGREP
# ======================================================
      - name: Semgrep
        run: |
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep ci --config p/ci --json > ${REPORT_DIR}/sast/semgrep.json || true
          jq '[.results[]?|select(.extra.severity=="ERROR")] | length' \
            ${REPORT_DIR}/sast/semgrep.json | grep -qv 0 \
            && echo true > critical_flag.txt || true

# ======================================================
# SCA – DEPENDENCIES
# ======================================================
      - name: pip-audit
        if: env.SCAN_MODE == 'full'
        run: |
          pip-audit -r requirements.txt -f json \
            -o ${REPORT_DIR}/sca/pip-audit.json || true

      - name: Trivy FS
        run: |
          trivy fs --severity HIGH,CRITICAL \
            --format json -o ${REPORT_DIR}/sca/trivy.json .
          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/sca/trivy.json | grep -qv 0 \
            && echo true > critical_flag.txt || true

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > ${REPORT_DIR}/sca/snyk.json || true
          grep -qi '"critical"' ${REPORT_DIR}/sca/snyk.json \
            && echo true > critical_flag.txt || true

# ======================================================
# EPSS PRIORITIZATION
# ======================================================
      - name: EPSS Check
        run: |
          jq -r '..|.VulnerabilityID?//empty' ${REPORT_DIR}/sca/trivy.json | sort -u > cves.txt
          while read cve; do
            epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" | jq -r '.data[0].epss')
            awk "BEGIN{exit !($epss > ${EPSS_THRESHOLD})}" && echo true > critical_flag.txt
          done < cves.txt || true

# ======================================================
# MISCONFIGURATION
# ======================================================
      - name: Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json -o ${REPORT_DIR}/misconfig/config.json .
          jq '[.Results[].Misconfigurations[]?|select(.Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/misconfig/config.json | grep -qv 0 \
            && echo true > critical_flag.txt || true

# ======================================================
# DAST – ZAP (FULL ONLY)
# ======================================================
      - name: DAST
        if: env.SCAN_MODE == 'full'
        run: |
          docker build -t vuln-bank-dast .
          docker run -d --name vuln-bank-dast -p 5000:5000 vuln-bank-dast
          sleep 10
          docker run --rm -t owasp/zap2docker-stable zap-baseline.py \
            -t http://host.docker.internal:5000 \
            -J ${REPORT_DIR}/dast/zap.json || true
          jq '[.site[].alerts[]?|select(.riskcode=="3")] | length' \
            ${REPORT_DIR}/dast/zap.json | grep -qv 0 \
            && echo true > critical_flag.txt || true
          docker rm -f vuln-bank-dast

# ======================================================
# SBOM
# ======================================================
      - name: SBOM
        run: syft . -o json > ${REPORT_DIR}/sbom/sbom.json

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: flag
        run: echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT

# ======================================================
# 2) SECURITY GATE
# ======================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "SECURITY GATE FAILED"
            exit 1
          fi

# ======================================================
# 3) BUILD, SIGN, PUSH
# ======================================================
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
          -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & push
        run: |
          docker build -t $IMAGE_REPO:$IMAGE_TAG .
          docker push $IMAGE_REPO:$IMAGE_TAG

      - uses: sigstore/cosign-installer@v3
      - name: Cosign sign
        run: cosign sign --yes $IMAGE_REPO:$IMAGE_TAG

# ======================================================
# 4) DEPLOY (VM HOSTING)
# ======================================================
  deploy:
    runs-on: self-hosted
    needs: build_and_push
    steps:
      - run: |
          ssh hosting@192.168.107.135 <<EOF
          docker pull $IMAGE_REPO:$IMAGE_TAG
          cd /opt/vuln-bank-app/containers/app
          IMAGE_WITH_TAG=$IMAGE_REPO:$IMAGE_TAG docker compose up -d
          EOF

# ======================================================
# 5) SLACK NOTIFICATION
# ======================================================
  slack_notify:
    runs-on: self-hosted
    needs: security_scans
    if: always()
    steps:
      - run: |
          jq -n --arg msg \
          "Pipeline completed | Mode: ${{ needs.security_scans.outputs.scan_mode }} | Critical: ${{ needs.security_scans.outputs.critical_found }}" \
          '{text:$msg}' | curl -X POST -H 'Content-type: application/json' \
          --data @- ${{ secrets.SLACK_WEBHOOK_URL }}
