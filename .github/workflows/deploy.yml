name: Vuln Bank DevSecOps Pipeline (v7.2.1 UltraStable Rocky)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  POLICY_DIR: policy
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}

jobs:
# =====================================================================
# 0) Determine Scan Mode
# =====================================================================
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.out.outputs.scan_mode }}
    steps:
      - id: out
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "scan_mode=full" >> $GITHUB_OUTPUT
          else
            echo "scan_mode=light" >> $GITHUB_OUTPUT
          fi

# =====================================================================
# 1) SECURITY SCANS
# =====================================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    outputs:
      critical_found: ${{ steps.flag.outputs.critical_found }}
      scan_mode: ${{ steps.scanmode.outputs.mode }}

    steps:
      - uses: actions/checkout@v4

      # ---------------- Set Mode ----------------
      - id: scanmode
        run: |
          echo "mode=${{ needs.prep.outputs.scan_mode }}" >> $GITHUB_OUTPUT
          echo "SCAN_MODE=${{ needs.prep.outputs.scan_mode }}" >> $GITHUB_ENV

      # ---------------- Cache ----------------
      - uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/trivy
            ~/.cache/snyk
          key: ${{ runner.os }}-security-v721-${{ hashFiles('requirements.txt') }}

      # ---------------- Python & jq ----------------
      - name: Setup Python venv
        run: |
          $PYTHON_BIN -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip pip-audit==2.7.2

          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> $GITHUB_PATH

          if ! command -v jq >/dev/null; then
            curl -L -o "$BIN/jq" \
              https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
            chmod +x "$BIN/jq"
          fi

      # ---------------- Install Trivy ----------------
      - name: Install Trivy
        run: |
          if ! command -v trivy >/dev/null; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
              | sh -s -- -b "$RUNNER_TEMP/bin"
          fi

      # ---------------- Install Gitleaks ----------------
      - name: Install Gitleaks
        run: |
          if ! command -v gitleaks >/dev/null; then
            VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
            curl -sL https://github.com/gitleaks/gitleaks/releases/download/${VER}/gitleaks_${VER#v}_linux_x64.tar.gz \
              | tar -xz -C "$RUNNER_TEMP/bin"
          fi

      # ---------------- Install Snyk ----------------
      - name: Install Snyk
        run: |
          if ! command -v snyk >/dev/null; then
            curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
              -o "$RUNNER_TEMP/bin/snyk"
            chmod +x "$RUNNER_TEMP/bin/snyk"
          fi

      # ---------------- Install Syft ----------------
      - name: Install Syft (SBOM)
        run: |
          if ! command -v syft >/dev/null; then
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
              | sh -s -- -b "$RUNNER_TEMP/bin"
          fi

      # ---------------- Install Conftest ----------------
      - name: Install Conftest (Safe Rocky Edition)
        run: |
          if ! command -v conftest >/dev/null; then
            curl -sSL \
              https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz \
              -o conftest.tar.gz

            # Validate file is gzip (avoid HTML masquerading)
            filetype=$(file -b conftest.tar.gz)
            if [[ "$filetype" != *"gzip compressed"* ]]; then
              echo "‚ùå Conftest download returned invalid file"
              exit 1
            fi

            tar -xzf conftest.tar.gz -C "$RUNNER_TEMP/bin"
            chmod +x "$RUNNER_TEMP/bin/conftest"
          fi

      # ---------------- Prepare dirs ----------------
      - run: |
          mkdir -p ${REPORT_DIR}/{sast,secrets,sca,misconfig,dast,sbom}
          printf "false" > critical_flag.txt

      # ---------------- SEMGREP ----------------
      - name: Semgrep JSON (UltraStable Mode)
        run: |
          TEMP=$(mktemp -d)
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/src \
            -v "$TEMP":/out \
            returntocorp/semgrep:latest \
              semgrep ci --config p/ci --json \
              --force-run --no-error \
              --output /out/semgrep.json || true

          [[ ! -f "$TEMP/semgrep.json" ]] && echo "{}" > "$TEMP/semgrep.json"

          cp "$TEMP/semgrep.json" "${REPORT_DIR}/sast/semgrep.json"

          jq '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' \
            "${REPORT_DIR}/sast/semgrep.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Semgrep SARIF
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/src \
            -v "$GITHUB_WORKSPACE/${REPORT_DIR}/sast":/out \
            returntocorp/semgrep:latest \
              semgrep ci --config p/ci --sarif --output /out/semgrep.sarif || true

      # ---------------- GITLEAKS ----------------
      - name: Secret Scan
        run: |
          gitleaks detect --source . --report-format json \
            --report-path "${REPORT_DIR}/secrets/gitleaks.json" || true

          jq -e 'length>0' "${REPORT_DIR}/secrets/gitleaks.json" \
            && printf "true" > critical_flag.txt || true

      # ---------------- SCA ----------------
      - name: pip-audit
        if: env.SCAN_MODE == 'full'
        run: |
          [ -f requirements.txt ] && .venv/bin/pip-audit -r requirements.txt \
            -f json -o "${REPORT_DIR}/sca/pip-audit.json" || true

      - name: Trivy FS
        run: |
          trivy fs --scanners vuln --severity HIGH,CRITICAL \
            --format json --output "${REPORT_DIR}/sca/trivy-fs.json" .

          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            "${REPORT_DIR}/sca/trivy-fs.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Snyk SCA
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects --json > "${REPORT_DIR}/sca/snyk.json" || true
          grep -qi '"critical"\|"high"' "${REPORT_DIR}/sca/snyk.json" \
            && printf "true" > critical_flag.txt || true

      # ---------------- EPSS ----------------
      - name: EPSS Threat Intelligence
        run: |
          jq -r '.. | .VulnerabilityID? // empty' "${REPORT_DIR}/sca/trivy-fs.json" > cves.txt || true
          jq -r '.. | .identifiers?.CVE[]? // empty' "${REPORT_DIR}/sca/snyk.json" >> cves.txt || true
          sort -u cves.txt -o cves.txt

          if [ -s cves.txt ]; then
            cat cves.txt | xargs -I {} -P 12 sh -c '
              epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$1" | jq -r ".data[0].epss // 0")
              awk "BEGIN{exit !($epss > ${EPSS_THRESHOLD})}"
            ' _ {} && printf "true" > critical_flag.txt || true
          fi

      # ---------------- MISCONFIG ----------------
      - name: Trivy Config JSON
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json --output "${REPORT_DIR}/misconfig/trivy-config.json" .

          jq '[.Results[].Misconfigurations[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            "${REPORT_DIR}/misconfig/trivy-config.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Trivy Config SARIF
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format sarif --output "${REPORT_DIR}/misconfig/trivy-config.sarif" .

      # ---------------- POLICY-AS-CODE ----------------
      - name: Conftest Policy Check (Stable)
        run: |
          FAILED=0
          conftest test Dockerfile --policy $POLICY_DIR || FAILED=1
          ls docker-compose*.yml >/dev/null 2>&1 && conftest test docker-compose*.yml --policy $POLICY_DIR || true
          [ -d k8s ] && conftest test k8s --policy $POLICY_DIR || true

          [ "$FAILED" -ne 0 ] && printf "true" > critical_flag.txt

      # ---------------- SBOM ----------------
      - name: SBOM
        run: syft . -o json > "${REPORT_DIR}/sbom/sbom.json"

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: flag
        run: echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT

# =====================================================================
# 2) Artifact Download (GH CLI Retry)
# =====================================================================
  upload_sarif:
    runs-on: self-hosted
    needs: security_scans
    if: always()

    steps:
      - name: Install GH CLI (Portable Rocky)
        env:
          GH_VERSION: "2.69.0"
        run: |
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          curl -sL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz \
            | tar -xz
          mv gh_*/bin/gh "$BIN/gh"
          chmod +x "$BIN/gh"
          echo "$BIN" >> $GITHUB_PATH

      - name: Download artifact (UltraStable Retry)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for i in {1..5}; do
            echo "Attempt $i: Downloading security-reports..."
            if gh run download $GITHUB_RUN_ID -n security-reports -D security-reports; then
              echo "‚úî Artifact downloaded"
              break
            fi
            sleep 5
          done

          if [ ! -d security-reports ]; then
            echo "‚ùå Failed after 5 retries"
            exit 1
          fi

      - name: Upload SARIF ‚Üí GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/sast/semgrep.sarif

# =====================================================================
# 3) Auto Issue
# =====================================================================
  create_issue:
    runs-on: self-hosted
    needs: security_scans
    if: needs.security_scans.outputs.critical_found == 'true' && github.ref == 'refs/heads/main'
    permissions:
      issues: write
    steps:
      - run: |
          cat <<EOF > issue.md
          üö® Critical Security Findings Detected

          Scan Mode: ${{ needs.security_scans.outputs.scan_mode }}
          Commit: ${{ github.sha }}

          Check artifact: security-reports
          EOF

      - uses: actions/github-script@v8
        with:
          script: |
            const body = require('fs').readFileSync('issue.md','utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üö® Critical Security Findings",
              body,
              labels: ["security","critical"]
            });

# =====================================================================
# 4) Security Gate
# =====================================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "‚ùå Security Gate Failed"
            exit 1
          fi
          echo "‚úÖ Security Gate Passed"

# =====================================================================
# 5) Build + Push + Sign
# =====================================================================
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    if: needs.security_gate.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
              -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - run: docker build -t "$IMAGE_REPO:$IMAGE_TAG" .
      - run: docker push "$IMAGE_REPO:$IMAGE_TAG"

      - uses: sigstore/cosign-installer@v3

      - env:
          COSIGN_EXPERIMENTAL: "true"
        run: cosign sign --yes "$IMAGE_REPO:$IMAGE_TAG"

# =====================================================================
# 7) Deployment
# =====================================================================
  deploy:
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy App on Remote Host
        env:
          REMOTE_HOST: hosting@192.168.107.135
        run: |
          ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" bash -s <<EOF
            docker pull ${IMAGE_REPO}:${IMAGE_TAG}
            cd /opt/vuln-bank-app/containers/app
            IMAGE_WITH_TAG=${IMAGE_REPO}:${IMAGE_TAG} docker compose down
            IMAGE_WITH_TAG=${IMAGE_REPO}:${IMAGE_TAG} docker compose up -d
          EOF

# =====================================================================
# 8) Slack Notify
# =====================================================================
  slack_notify:
    runs-on: self-hosted
    needs: security_scans
    if: always()
    steps:
      - run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          STATUS="‚úî Pipeline Success"
          [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ] \
            && STATUS="üö® Critical Security Issues Detected"

          jq -n --arg t "$STATUS" '{text:$t}' \
            | curl -X POST -H "Content-type: application/json" \
              --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
