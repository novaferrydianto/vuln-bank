name: üîê Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    # Optional: nightly full scan jam 01:00 WIB (18:00 UTC)
    - cron: "0 18 * * *"

env:
  PYTHON_VERSION: "3.12"
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.7"              # Risk-based threshold
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}  # e.g. docker.io/novaferrydianto/vuln-bank

permissions:
  contents: read
  security-events: write
  id-token: write          # future-proof kalau mau cosign keyless
  packages: write

jobs:
  #####################################################################
  # JOB 1 ‚Äî SECURITY CI (runs on GitHub-hosted runner)
  #####################################################################
  security:
    name: üõ°Ô∏è Security CI (Secrets + SCA + SAST + Misconfig + DAST)
    runs-on: ubuntu-latest

    outputs:
      has_critical: ${{ steps.evaluate.outputs.has_critical }}
      epss_alert: ${{ steps.evaluate.outputs.epss_alert }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Prepare tools & report directory
        run: |
          mkdir -p "$REPORT_DIR"

          # Install TruffleHog (secrets)
          pip install "trufflehog==2.0.0"

          # Install Semgrep (SAST)
          pip install "semgrep==1.93.0"

          # Install Trivy (SCA + config)
          TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | \
                          grep tag_name | cut -d '"' -f 4)
          curl -sL "https://github.com/aquasecurity/trivy/releases/download/${TRIVY_VERSION}/trivy_$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m).tar.gz" \
            | tar zx -C /usr/local/bin --strip-components=1 trivy

          trivy --version
          semgrep --version || true
          trufflehog --version || true

      # --------------------------------------------------------------
      # SECRET SCANNING
      # --------------------------------------------------------------
      - name: üîë Secret Scanning (TruffleHog)
        continue-on-error: true
        run: |
          trufflehog filesystem . --only-verified --json > "$REPORT_DIR/trufflehog.json" || true

      # --------------------------------------------------------------
      # SCA (DEPENDENCY VULN)
      # --------------------------------------------------------------
      - name: üì¶ SCA (Trivy FS ‚Äì requirements.txt, system deps)
        run: |
          trivy fs \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/trivy-fs.json" \
            .

      # --------------------------------------------------------------
      # SAST (STATIC APP SEC TEST)
      # --------------------------------------------------------------
      - name: üß† SAST (Semgrep ‚Äì OWASP Top 10)
        continue-on-error: true
        run: |
          semgrep ci \
            --config "p/owasp-top-ten" \
            --json --output "$REPORT_DIR/semgrep.json" || true

      # --------------------------------------------------------------
      # MISCONFIG SCAN (INFRA / DOCKER / COMPOSE)
      # --------------------------------------------------------------
      - name: üß± Misconfiguration Scan (Trivy config)
        continue-on-error: true
        run: |
          trivy config \
            --format json \
            --output "$REPORT_DIR/trivy-config.json" \
            .

          # Extra: specific Dockerfile
          trivy config \
            --format json \
            --output "$REPORT_DIR/trivy-dockerfile.json" \
            Dockerfile || true

      # --------------------------------------------------------------
      # DAST (runnning app + OWASP ZAP)
      # --------------------------------------------------------------
      - name: üê≥ Build app image for DAST
        run: |
          docker build -t vuln-bank:${{ github.sha }} .
          echo "IMAGE_REF=vuln-bank:${{ github.sha }}" >> "$GITHUB_ENV"

      - name: üöÄ Run app container (for ZAP)
        run: |
          docker run -d --rm \
            -p 5000:5000 \
            --name vuln-bank-dast \
            "$IMAGE_REF"
          sleep 10

      - name: üåê DAST (OWASP ZAP Baseline)
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://127.0.0.1:5000"
          cmd_options: "-a"
        continue-on-error: true

      - name: üßπ Stop DAST container
        if: always()
        run: docker rm -f vuln-bank-dast || true

      # --------------------------------------------------------------
      # EVALUATE CRITICAL + EPSS
      # --------------------------------------------------------------
      - name: üßÆ Evaluate Critical + EPSS (Trivy report)
        id: evaluate
        env:
          TRIVY_FS_REPORT: ${{ env.REPORT_DIR }}/trivy-fs.json
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}
        run: |
          python - << 'PY'
          import json, os, urllib.request, urllib.parse, sys

          report_path = os.path.join(os.environ["REPORT_DIR"], "trivy-fs.json")
          threshold = float(os.environ.get("EPSS_THRESHOLD", "0.7"))

          has_critical = False
          epss_alert = False
          cves = set()

          if not os.path.exists(report_path):
              print(f"Report not found: {report_path}")
          else:
              with open(report_path, "r") as f:
                  data = json.load(f)

              for result in data.get("Results", []):
                  for vuln in result.get("Vulnerabilities", []):
                      severity = vuln.get("Severity", "").upper()
                      vid = vuln.get("VulnerabilityID") or vuln.get("VulnID")
                      if severity in ("HIGH", "CRITICAL"):
                          has_critical = True
                          if vid and vid.startswith("CVE-"):
                              cves.add(vid)

              if cves:
                  # FIRST EPSS API
                  # Docs: https://first.org/epss/api
                  query = urllib.parse.urlencode({"cve": ",".join(sorted(cves))})
                  url = f"https://api.first.org/data/v1/epss?{query}"
                  try:
                      with urllib.request.urlopen(url) as resp:
                          api = json.load(resp)
                      for row in api.get("data", []):
                          score = float(row.get("epss", 0.0))
                          if score >= threshold:
                              epss_alert = True
                              break
                  except Exception as e:
                      print(f"EPSS lookup failed: {e}", file=sys.stderr)

          gh_out = os.environ["GITHUB_OUTPUT"]
          with open(gh_out, "a") as f:
              f.write(f"has_critical={'true' if has_critical else 'false'}\n")
              f.write(f"epss_alert={'true' if epss_alert else 'false'}\n")

          print("has_critical:", has_critical)
          print("epss_alert:", epss_alert)
          PY

      # --------------------------------------------------------------
      # UPLOAD ARTIFACTS
      # --------------------------------------------------------------
      - name: üìé Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: ${{ env.REPORT_DIR }}

  #####################################################################
  # JOB 2 ‚Äî NOTIFICATION (Discord / Slack via webhook)
  #####################################################################
  notify:
    name: üì£ Security Alert Notification
    needs: security
    runs-on: ubuntu-latest
    if: needs.security.outputs.has_critical == 'true' || needs.security.outputs.epss_alert == 'true'

    steps:
      - name: Send alert to Discord / Slack
        env:
          WEBHOOK_URL: ${{ secrets.SECURITY_ALERT_WEBHOOK }}
          HAS_CRITICAL: ${{ needs.security.outputs.has_critical }}
          EPSS_ALERT: ${{ needs.security.outputs.epss_alert }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "No SECURITY_ALERT_WEBHOOK configured. Skipping notification."
            exit 0
          fi

          msg="‚ö†Ô∏è *Vuln Bank Security Alert* ‚ö†Ô∏è
          Repo: $REPO
          Run: https://github.com/$REPO/actions/runs/$RUN_ID

          ‚Ä¢ has_critical: $HAS_CRITICAL
          ‚Ä¢ epss_alert (>= threshold): $EPSS_ALERT"

          # Generic webhook (Discord style). For Slack: adjust payload structure.
          payload=$(jq -n --arg content "$msg" '{content: $content}')

          curl -X POST -H "Content-Type: application/json" \
            -d "$payload" \
            "$WEBHOOK_URL"

  #####################################################################
  # JOB 3 ‚Äî BUILD & DEPLOY (Self-hosted runner on Bastion)
  #####################################################################
  deploy:
    name: üöÄ Build Image & Deploy via Ansible (VMware lab)
    needs: security
    # Hanya deploy kalau TIDAK ada critical/high risk-based (EPSS) finding
    if: needs.security.outputs.has_critical == 'false' && needs.security.outputs.epss_alert == 'false'

    # Self-hosted runner di bastion VM: label sesuaikan sama runner kamu
    runs-on: [ self-hosted, bastion-vulnbank ]

    env:
      DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üê≥ Build & Push image
        id: build_push
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE_TAG="$DOCKERHUB_REPO:$SHORT_SHA"

          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"

          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: ‚öôÔ∏è Deploy with Ansible to VMware lab
        run: |
          cd /home/bastion/actions-runner/_work/vuln-bank/vuln-bank/ansible

          # Use local ansible.cfg ALWAYS
          export ANSIBLE_CONFIG=$(pwd)/ansible.cfg

          # Optional: vault password kalau pakai Ansible Vault
          if [ ! -z "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" ]; then
            echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > vault-pass.txt
            VAULT_FLAG="--vault-password-file vault-pass.txt"
          else
            VAULT_FLAG=""
          fi

          # Pass image tag ke playbook (buat update docker-compose env)
          ansible-playbook -i inventory.ini site.yml \
            --extra-vars "docker_image=${{ steps.build_push.outputs.image_tag }}" \
            $VAULT_FLAG
