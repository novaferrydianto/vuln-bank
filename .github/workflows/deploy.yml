name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  IMAGE_NAME: vuln-bank
  DOCKERHUB_REPO: docker.io/${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  REPORT_DIR: security-reports
  DAST_TARGET_URL: http://vuln-bank.local
  PYTHON_BIN: python3.11

# ==========================================================
# 1) SECURITY SCANS
# ==========================================================
jobs:
  security_scans:
    name: Security Scans
    runs-on: self-hosted

    outputs:
      critical_found: ${{ steps.setflag.outputs.critical_found }}

    steps:
      - uses: actions/checkout@v4

      - name: Runner sanity check
        shell: bash
        run: |
          set -euo pipefail
          $PYTHON_BIN --version
          docker --version || true

      - name: Install base tools
        shell: bash
        run: |
          set -euo pipefail
          $PYTHON_BIN -m pip install --upgrade pip
          $PYTHON_BIN -m pip install pip-audit semgrep
          command -v jq >/dev/null || sudo dnf install -y jq || sudo yum install -y jq

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sudo sh -s -- -b /usr/local/bin

      - name: Install Gitleaks
        run: |
          set -e
          VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/$VER/gitleaks_${VER#v}_linux_x64.tar.gz \
          | sudo tar -xz -C /usr/local/bin gitleaks

      - name: Install Snyk CLI (pinned)
        run: |
          curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
          -o snyk && chmod +x snyk && sudo mv snyk /usr/local/bin/snyk

      - name: Init critical flag
        run: echo "false" > critical_flag.txt

      - name: Prepare report dirs
        run: mkdir -p ${REPORT_DIR}/{secrets,sca,sast,misconfig}

      # ---------------- SECRET SCAN ----------------
      - name: Gitleaks
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path ${REPORT_DIR}/secrets/gitleaks.json || true
          jq -e 'length>0' ${REPORT_DIR}/secrets/gitleaks.json && echo true > critical_flag.txt || true

      # ---------------- SCA ----------------
      - name: pip-audit
        run: |
          test -f requirements.txt && \
          $PYTHON_BIN -m pip_audit -r requirements.txt -f json \
          -o ${REPORT_DIR}/sca/pip-audit.json || true

      - name: Trivy FS
        run: |
          trivy fs --scanners vuln \
            --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/sca/trivy-fs.json .

          jq '[.Results[].Vulnerabilities[]? |
              select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length'
          ${REPORT_DIR}/sca/trivy-fs.json | grep -qv '^0$' && echo true > critical_flag.txt || true

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects --severity-threshold=high --json \
          > ${REPORT_DIR}/sca/snyk.json || true
          grep -qi '"severity":"\(high\|critical\)"' ${REPORT_DIR}/sca/snyk.json && \
          echo true > critical_flag.txt || true

      # ---------------- SAST ----------------
      - name: Semgrep
        run: |
          semgrep ci --config p/ci \
          --json --output ${REPORT_DIR}/sast/semgrep.json || true

          jq '[.results[]?|select(.extra.severity=="ERROR"
              or .extra.severity=="HIGH"
              or .extra.severity=="CRITICAL")] | length'
          ${REPORT_DIR}/sast/semgrep.json | grep -qv '^0$' && echo true > critical_flag.txt || true

      # ---------------- MISCONFIG ----------------
      - name: Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/misconfig/trivy-config.json .

          jq '[.Results[].Misconfigurations[]?|select(.Severity=="HIGH"
              or .Severity=="CRITICAL")] | length'
          ${REPORT_DIR}/misconfig/trivy-config.json | grep -qv '^0$' && echo true > critical_flag.txt || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: setflag
        run: echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT

# ==========================================================
# 2) SECURITY GATE
# ==========================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    steps:
      - run: |
          [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ] && exit 1
          echo "âœ… Security Gate Passed"

# ==========================================================
# 3) BUILD & PUSH
# ==========================================================
  build_and_push:
    runs-on: self-hosted, bastion
    needs: security_gate
    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        shell: bash
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      - name: Cleanup before build
        run: docker system prune -af

      - name: Build Image
        run: |
          docker build -t $DOCKERHUB_REPO/$IMAGE_NAME:$IMAGE_TAG .

      - name: Push Image
        run: |
          docker push $DOCKERHUB_REPO/$IMAGE_NAME:$IMAGE_TAG

# ==========================================================
# 4) DEPLOY
# ==========================================================
  deploy_k8s:
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - run: |
          sed -i "s|IMAGE_PLACEHOLDER|$DOCKERHUB_REPO/$IMAGE_NAME:$IMAGE_TAG|" k3s/app/values.yaml
          kubectl apply -f k3s/db/
          kubectl apply -f k3s/app/
          kubectl rollout status deployment/vuln-bank -n vuln-bank-app --timeout=120s

# ==========================================================
# 5) SLACK (ALWAYS)
# ==========================================================
  slack_notify:
    runs-on: self-hosted
    needs: [security_scans]
    if: always()
    steps:
      - run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0
          MSG="âœ… Pipeline Succeeded"
          [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ] && \
          MSG="ðŸš¨ HIGH/CRITICAL vulnerabilities detected"
          jq -n --arg msg "$MSG" '{text:$msg}' |
          curl -X POST -H 'Content-type: application/json' \
          --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
