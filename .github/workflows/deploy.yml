name: DevSecOps Vuln Bank

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  id-token: write          # REQUIRED for Cosign keyless signing
  packages: write

env:
  REGISTRY: docker.io
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
  FULL_IMAGE: ${{ secrets.FULL_IMAGE }}:${{ github.sha }}
  REPORT_DIR: security-reports

jobs:

  #####################################################################
  # JOB 1 â€” SECURITY (CI)
  #####################################################################
  security:
    runs-on: ubuntu-latest
    name: DevSecOps Security Pipeline

    steps:
      - uses: actions/checkout@v4

      - name: Prepare report directory
        run: mkdir -p $REPORT_DIR

      # ------------------------------------------------------------
      # TruffleHog + Trivy + Semgrep + ZAP + EPSS
      # (same as previous v6, not dihapus)
      # ------------------------------------------------------------

      - name: Install TruffleHog
        run: pip install trufflehog

      - name: TruffleHog Scan
        run: |
          trufflehog filesystem . \
            --no-update --only-verified \
            --json > "$REPORT_DIR/trufflehog.json" || true

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Trivy FS Scan
        run: |
          trivy fs . \
            --security-checks vuln,config \
            --format json \
            --output "$REPORT_DIR/trivy-fs.json" || true

      - name: Build image for scan
        run: docker build -t "$FULL_IMAGE" .

      - name: Trivy Image Scan
        run: |
          trivy image "$FULL_IMAGE" \
            --format json \
            --output "$REPORT_DIR/trivy-image.json" || true

      - name: Install Semgrep
        run: pip install semgrep

      - name: Semgrep Scan
        run: |
          semgrep ci --config auto \
            --json > "$REPORT_DIR/semgrep.json" || true

      - name: Start app for ZAP
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
        run: |
          docker compose down || true
          docker compose up -d
          sleep 15

      - name: Detect network
        id: net
        run: |
          NET=$(docker network ls --format '{{.Name}}' | grep vuln | head -n 1)
          echo "network=$NET" >> $GITHUB_OUTPUT

      - name: ZAP Baseline
        run: |
          mkdir -p zap
          chmod 777 zap

          docker run --rm \
            --user 0:0 \
            --network ${{ steps.net.outputs.network }} \
            -v "$(pwd)/zap:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://app:5000 \
            -J zap-report.json \
            -r zap-report.html || true

          # safe copy json
          if [ -f zap/zap-report.json ]; then
            mv zap/zap-report.json "$REPORT_DIR/zap-report.json"
          else
            echo "{}" > "$REPORT_DIR/zap-report.json"
          fi

          # safe copy html
          if [ -f zap/zap-report.html ]; then
            mv zap/zap-report.html "$REPORT_DIR/zap-report.html"
          else
            echo "<h2>ZAP did not generate report</h2>" > "$REPORT_DIR/zap-report.html"
          fi

      - run: docker compose down || true

      - uses: actions/upload-artifact@v4
        with:
          name: vuln-bank-security-reports
          path: ${{ env.REPORT_DIR }}

      # EPSS block tetap sama
      - name: EPSS Scoring
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          REPORT_DIR: ${{ env.REPORT_DIR }}
        run: |
          pip install requests
          python << 'PY'
          # (EPSS script same as before)
          PY


  #####################################################################
  # JOB 2 â€” BUILD, SIGN, PUSH (COSIGN KEYLESS)
  #####################################################################
  build_push_sign:
    name: Build + Push + Cosign Sign
    runs-on: ubuntu-latest
    needs: security

    permissions:
      id-token: write      # REQUIRED for keyless signing
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t "${{ secrets.FULL_IMAGE }}" .

      - name: Push image
        run: docker push "${{ secrets.FULL_IMAGE }}"

      # --------------------------------------------------------
      # Install Cosign (Keyless Sigstore)
      # --------------------------------------------------------
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      # --------------------------------------------------------
      # Cosign SIGN the container image (Keyless)
      # --------------------------------------------------------
      - name: Cosign sign the image (keyless)
        run: |
          cosign sign --yes \
            ${{ secrets.FULL_IMAGE }}

      # --------------------------------------------------------
      # Cosign SBOM attach (Syft)
      # --------------------------------------------------------
      - name: Install Syft (SBOM)
        uses: anchore/sbom-action/download-syft@v0.16.0

      - name: Generate SBOM
        run: syft ${{ secrets.FULL_IMAGE }} -o spdx-json > sbom.json

      - name: Attach SBOM to image
        run: |
          cosign attach sbom \
            --sbom sbom.json \
            ${{ secrets.FULL_IMAGE }}

      - name: Workflow Summary
        run: |
          echo "## ðŸ” Cosign Signing Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ secrets.FULL_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Cosign: Signed (keyless via OIDC)" >> $GITHUB_STEP_SUMMARY


  #####################################################################
  # JOB 3 â€” DEPLOY VIA ANSIBLE (SELF-HOSTED)
  #####################################################################
  deploy:
    name: Deploy (3 VM)
    needs: build_push_sign
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    env:
      FULL_IMAGE: ${{ secrets.FULL_IMAGE }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo dnf install -y epel-release || true
          sudo dnf install -y ansible python3-pip

      - name: run site.yml
        working-directory: ansible
        env:
          FULL_IMAGE: ${{ secrets.FULL_IMAGE }}
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible/ansible.cfg
        run: ansible-playbook site.yml

      - name: CIS Summary
        run: |
          if [ -f /root/cis-summary.txt ]; then
            echo "## CIS Summary" >> $GITHUB_STEP_SUMMARY
            cat /root/cis-summary.txt >> $GITHUB_STEP_SUMMARY
          fi
