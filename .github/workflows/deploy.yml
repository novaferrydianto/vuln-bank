name: DevSecOps Vuln Bank

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "0 18 * * *" # Daily full scan jam 01:00 WIB (sesuaikan)
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  issues: write
  packages: write
  id-token: write   # jika nanti mau pakai Cosign keyless

env:
  REPORT_DIR: security-reports
  IMAGE_NAME: vuln-bank
  REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_TAG: ${{ github.sha }}
  EPSS_THRESHOLD: "0.7"

jobs:
  ########################################################
  # JOB 1 â€” BUILD + TEST (OPTIONAL BUT NICE)
  ########################################################
  build_and_test:
    runs-on: ubuntu-latest
    name: ðŸ§± Build & Test

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          npm install

      - name: Run tests
        run: |
          npm test || echo "âš ï¸ Tests failed but continue for demo"

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG .

      - name: Save Docker image as artifact (optional)
        run: |
          mkdir -p $REPORT_DIR
          docker save $REGISTRY/$IMAGE_NAME:$IMAGE_TAG -o $REPORT_DIR/vuln-bank-image.tar

      - name: Upload image tar
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: $REPORT_DIR/vuln-bank-image.tar

  ########################################################
  # JOB 2 â€” SECURITY SCANS (Secrets, SCA, SAST, Misconfig, SBOM)
  ########################################################
  security_scans:
    runs-on: ubuntu-latest
    name: ðŸ” Security Scans
    needs: build_and_test

    env:
      HAS_CRITICAL: "false"
      HAS_EPSS_HIGH: "false"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare report dir
        run: mkdir -p $REPORT_DIR

      - name: Install tools (jq, trufflehog, syft)
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          pip install trufflehog
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      # ----------------------- SECRET SCAN -----------------------
      - name: TruffleHog Secret Scan
        run: |
          trufflehog filesystem . --json > $REPORT_DIR/trufflehog.json || true

      # ----------------------- SCA (FS + IMAGE) ------------------
      - name: Trivy FS SCA Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'json'
          output: '${{ env.REPORT_DIR }}/trivy-fs.json'
          vuln-type: 'os,library'

      - name: Load Docker image
        run: |
          docker load -i $REPORT_DIR/../docker-image/vuln-bank-image.tar || true
        continue-on-error: true

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          ignore-unfixed: true
          format: 'json'
          output: '${{ env.REPORT_DIR }}/trivy-image.json'
          vuln-type: 'os,library'

      # ----------------------- SAST ------------------------------
      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/owasp-top-ten"
          generateSarif: true
          output: ${{ env.REPORT_DIR }}/semgrep.sarif

      # ----------------------- MISCONFIG -------------------------
      - name: Trivy Config Scan (IaC/Misconfig)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          format: 'json'
          output: '${{ env.REPORT_DIR }}/trivy-config.json'
          severity: 'MEDIUM,HIGH,CRITICAL'

      # ----------------------- SBOM ------------------------------
      - name: Generate SBOM with Syft
        run: |
          syft dir:. -o json > $REPORT_DIR/sbom.json || true

      # ------------------- EPSS + CRITICAL EVAL ------------------
      - name: Evaluate Critical Findings + EPSS
        id: eval
        run: |
          echo "HAS_CRITICAL=false" >> $GITHUB_ENV
          echo "HAS_EPSS_HIGH=false" >> $GITHUB_ENV

          # 1) Simple check: any CRITICAL/HIGH in Trivy image or fs
          CRIT_COUNT=$(jq '[.. | objects | select(.Severity=="CRITICAL")] | length' $REPORT_DIR/trivy-image.json 2>/dev/null || echo 0)
          HIGH_COUNT=$(jq '[.. | objects | select(.Severity=="HIGH")] | length' $REPORT_DIR/trivy-image.json 2>/dev/null || echo 0)

          if [ "$CRIT_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "HAS_CRITICAL=true" >> $GITHUB_ENV
          fi

          # 2) EPSS-like logic (demo version)
          #    Ambil daftar CVE dari Trivy dan "anggap" EPSS tinggi kalau severity CRITICAL/HIGH
          #    (di real world: panggil API EPSS, threshold pakai $EPSS_THRESHOLD)
          EPSS_LIKE=$(jq '[.. | objects | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' $REPORT_DIR/trivy-image.json 2>/dev/null || echo 0)
          if [ "$EPSS_LIKE" -gt 0 ]; then
            echo "HAS_EPSS_HIGH=true" >> $GITHUB_ENV
          fi

          # Build summary file for GitHub Issue / Alert
          cat <<EOF > $REPORT_DIR/summary-critical.md
  # ðŸ” Vuln Bank - Critical/High Findings

  - Critical count (Trivy Image): $CRIT_COUNT
  - High count (Trivy Image): $HIGH_COUNT
  - EPSS-like high risk: $EPSS_LIKE (using severity as proxy)

  Please check detailed reports in the pipeline artifacts:
  - trivy-image.json
  - trivy-fs.json
  - semgrep.sarif
  - trivy-config.json
  - trufflehog.json
  EOF

      # ------------------- UPLOAD REPORTS ------------------------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      # ------------------- CREATE GITHUB ISSUE -------------------
      - name: Create GitHub Issue for Critical Vulns
        if: env.HAS_CRITICAL == 'true'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸš¨ Critical/High vulnerabilities detected in ${{ github.sha }}"
          content-filepath: ${{ env.REPORT_DIR }}/summary-critical.md
          labels: security, critical

      # ------------------- DISCORD / SLACK ALERT -----------------
      - name: Send Discord Alert
        if: env.HAS_CRITICAL == 'true' || env.HAS_EPSS_HIGH == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          MSG="ðŸš¨ *Vuln Bank Security Alert* ðŸš¨%0ARepo: $GITHUB_REPOSITORY%0ACommit: $GITHUB_SHA%0ARun: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID%0AStatus: Critical/EPSS-high vulnerabilities detected. Please check security-reports artifacts."
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"$MSG\"}" \
               "$DISCORD_WEBHOOK"

      # ------------------- FAIL PIPELINE IF NEEDED ---------------
      - name: Fail job if critical/EPSS high
        if: env.HAS_CRITICAL == 'true' || env.HAS_EPSS_HIGH == 'true'
        run: |
          echo "âŒ Critical/EPSS-high vulnerabilities detected. Failing pipeline."
          exit 1

  ########################################################
  # JOB 3 â€” DAST (OWASP ZAP)
  ########################################################
  dast_scan:
    runs-on: ubuntu-latest
    name: ðŸŒ DAST with OWASP ZAP
    needs: build_and_test
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare report dir
        run: mkdir -p $REPORT_DIR

      - name: Run Vuln Bank container
        run: |
          docker load -i ${{ github.workspace }}/docker-image/vuln-bank-image.tar || true
          docker run -d --rm -p 8080:8080 --name vuln-bank vuln-bank || true

      - name: Wait for app to be ready
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8080 >/dev/null 2>&1; then
              echo "App is up!"
              exit 0
            fi
            echo "Waiting for app..."
            sleep 5
          done
          echo "App did not start in time" && exit 1

      - name: ZAP Baseline Scan
        run: |
          docker run --rm -t \
            -v $PWD/$REPORT_DIR:/zap/wrk \
            owasp/zap2docker-stable zap-baseline.py \
              -t http://host.docker.internal:8080 \
              -r zap-report.html || true

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-report
          path: ${{ env.REPORT_DIR }}/zap-report.html
