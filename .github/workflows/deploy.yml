name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  IMAGE_NAME: vuln-bank
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  REPORT_DIR: security-reports
  DAST_TARGET_URL: http://vuln-bank:5000
  PYTHON_BIN: python3.11
  DOCKER_BUILDKIT: 1
  EPSS_THRESHOLD: "0.5"

jobs:
  # ==========================================================
  # 1) SECURITY SCANS (SECRETS, SCA, SAST, MISCONFIG, DAST, SBOM)
  # ==========================================================
  security_scans:
    name: DevSecOps Continuous Assurance
    runs-on: self-hosted
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    outputs:
      critical_found: ${{ steps.setflag.outputs.critical_found }}

    steps:
      - uses: actions/checkout@v4

      - name: Runner sanity check
        shell: bash
        run: |
          set -euo pipefail
          $PYTHON_BIN --version
          docker --version || true

      - name: Install base tools
        shell: bash
        run: |
          set -euo pipefail
          $PYTHON_BIN -m pip install --upgrade pip
          $PYTHON_BIN -m pip install pip-audit semgrep
          command -v jq >/dev/null || sudo dnf install -y jq || sudo yum install -y jq

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sudo sh -s -- -b /usr/local/bin

      - name: Install Gitleaks
        run: |
          set -e
          VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/$VER/gitleaks_${VER#v}_linux_x64.tar.gz \
          | sudo tar -xz -C /usr/local/bin gitleaks

      - name: Install Snyk CLI
        run: |
          curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
          -o snyk && chmod +x snyk && sudo mv snyk /usr/local/bin/snyk

      - name: Install Syft (SBOM)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
          | sudo sh -s -- -b /usr/local/bin

      - name: Init critical flag
        run: echo "false" > critical_flag.txt

      - name: Prepare report dirs
        run: mkdir -p ${REPORT_DIR}/{secrets,sca,sast,misconfig,dast,sbom}

      # ---------------- SECRET SCANNING (Gitleaks) ----------------
      - name: Gitleaks
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path ${REPORT_DIR}/secrets/gitleaks.json || true

          jq -e 'length>0' ${REPORT_DIR}/secrets/gitleaks.json \
            && echo true > critical_flag.txt || true

      # ---------------- SCA (pip-audit + Trivy FS + Snyk) ----------------
      - name: pip-audit
        run: |
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f json \
              -o ${REPORT_DIR}/sca/pip-audit.json || true
          fi

      - name: Trivy FS
        run: |
          trivy fs --scanners vuln \
            --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/sca/trivy-fs.json .

          jq '[.Results[].Vulnerabilities[]? |
              select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/sca/trivy-fs.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects --json > ${REPORT_DIR}/sca/snyk.json || true
          grep -qi '"severity":"high"\|"severity":"critical"' \
            ${REPORT_DIR}/sca/snyk.json && echo true > critical_flag.txt || true

      # ================= EPSS SMART FILTER =================
      - name: EPSS Score Check (Smart SCA)
        run: |
          jq -r '.. | .id? // empty' ${REPORT_DIR}/sca/snyk.json | sort -u > cves.txt || true

          if [ -s cves.txt ]; then
            while read cve; do
              epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
                | jq -r '.data[0].epss // 0')
              awk "BEGIN{exit !($epss > ${EPSS_THRESHOLD})}" \
                && echo true > critical_flag.txt
            done < cves.txt
          fi

      # ---------------- SAST (Semgrep) ----------------
      - name: Semgrep
        run: |
          semgrep ci --config p/ci --json \
            --output ${REPORT_DIR}/sast/semgrep.json || true

          jq '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' \
            ${REPORT_DIR}/sast/semgrep.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      # ---------------- MISCONFIG (Trivy Config) ----------------
      - name: Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/misconfig/trivy-config.json .

          jq '[.Results[].Misconfigurations[]? |
              select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/misconfig/trivy-config.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      # ================= DAST (ZAP) =================
      - name: Build local image for DAST
        run: |
          docker build -t vuln-bank:${{ github.sha }} .

      - name: Start DAST environment (Docker Compose)
        run: |
          IMAGE_TAG=${{ github.sha }} docker compose \
            -f docker-compose.dast.yml up -d

      - name: Wait for app to be ready (DAST)
        run: |
          for i in {1..20}; do
            if docker exec vuln-bank-dast \
              python -c "import requests; requests.get('http://localhost:5000', timeout=2)" \
              > /dev/null; then
              echo "‚úÖ App ready for DAST"
              exit 0
            fi
            echo "‚è≥ Waiting app..."
            sleep 5
          done

          echo "‚ùå App not ready"
          docker compose -f docker-compose.dast.yml ps
          exit 1

      - name: OWASP ZAP Baseline
        if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
        shell: bash
        run: |
          docker exec zap zap-baseline.py \
            -t $DAST_TARGET_URL \
            -J zap-baseline.json \
            -r zap-baseline.html \
            -m 2 || true

          mv security-reports/dast/zap-baseline.* security-reports/dast/ || true

      - name: Get JWT token for Active ZAP
        if: github.event_name == 'schedule'
        shell: bash
        env:
          ZAP_LOGIN_USER: ${{ secrets.DAST_USER }}
          ZAP_LOGIN_PASS: ${{ secrets.DAST_PASS }}
        run: |
          token=$(docker exec zap curl -s -X POST \
            http://vuln-bank:5000/auth/login \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$ZAP_LOGIN_USER\",\"password\":\"$ZAP_LOGIN_PASS\"}" \
            | jq -r '.token')

          [ -z "$token" -o "$token" = "null" ] && exit 1

          echo "ZAP_AUTH_HEADER=Authorization: Bearer $token" >> $GITHUB_ENV

      - name: OWASP ZAP Active Scan (Authenticated)
        if: github.event_name == 'schedule'
        shell: bash
        run: |
          docker exec zap zap-full-scan.py \
            -t $DAST_TARGET_URL \
            -J zap-active.json \
            -r zap-active.html \
            -m 10 \
            -z "
              -config replacer.full_list(0).description=auth
              -config replacer.full_list(0).enabled=true
              -config replacer.full_list(0).matchtype=REQ_HEADER
              -config replacer.full_list(0).matchstr=Authorization
              -config replacer.full_list(0).replacement=$ZAP_AUTH_HEADER
            " || true

          mv security-reports/dast/zap-active.* security-reports/dast/ || true

      - name: Evaluate ZAP findings (HIGH)
        shell: bash
        run: |
          FILE=$(ls ${REPORT_DIR}/dast/zap-*.json | head -1 || true)

          if [ -z "$FILE" ]; then
            echo "‚ö†Ô∏è No ZAP report found"
            exit 0
          fi

          high=$(jq '[.site[].alerts[]? | select(.riskcode=="3")] | length' "$FILE")
          echo "ZAP HIGH findings: $high"

          if [ "$high" != "0" ]; then
            echo "true" > critical_flag.txt
          fi

      - name: Cleanup DAST container
        if: always()
        run: |
          docker compose -f docker-compose.dast.yml down -v

      # ================= SBOM =================
      - name: Generate SBOM
        run: |
          syft . -o json > ${REPORT_DIR}/sbom/sbom.json

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: setflag
        run: echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT

  # ==========================================================
  # 2) AUTO GITHUB ISSUE (ON HIGH / CRITICAL)
  # ==========================================================
  create_security_issue:
    name: Create Security GitHub Issue
    runs-on: self-hosted
    needs: security_scans
    if: needs.security_scans.outputs.critical_found == 'true'
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Prepare issue body
        shell: bash
        run: |
          cat <<EOF > issue.md
          ## üö® SECURITY ALERT ‚Äì High / Critical Vulnerabilities Detected

          **Repository:** ${GITHUB_REPOSITORY}  
          **Branch:** ${GITHUB_REF_NAME}  
          **Commit:** ${GITHUB_SHA}  
          **Workflow Run:** https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}

          ### üîç Security Scans Triggered
          - ‚úÖ Gitleaks (Secrets)
          - ‚úÖ Snyk / Trivy / pip-audit (SCA + EPSS)
          - ‚úÖ Semgrep (SAST)
          - ‚úÖ Trivy Config (IaC Misconfiguration)
          - ‚úÖ OWASP ZAP (DAST ‚Äì Baseline / Active)

          ### üìÅ Full Reports
          Download here:
          **Actions ‚Üí Artifacts ‚Üí security-reports**

          ### üõë Risk Impact
          - Possible data leakage
          - Account takeover
          - Privilege escalation
          - Financial fraud risk

          ### ‚úÖ Required Actions
          - Triage HIGH / CRITICAL findings
          - Apply fixes or mitigations
          - Re-run pipeline

          ---
          _This issue was automatically created by the Vuln Bank DevSecOps Pipeline._
          EOF

      - name: Create GitHub Issue
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("issue.md", "utf8");

            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "security,critical"
            });

            if (existing.data.length > 0) {
              console.log("‚úÖ Security issue already exists. Skipping creation.");
              console.log(`#${existing.data[0].number}: ${existing.data[0].title}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üö® Security: High / Critical Vulnerabilities Detected",
              body: body,
              labels: ["security", "critical", "devsecops", "automated"]
            });

            console.log("üöÄ New security issue created.");

  # ==========================================================
  # 3) SECURITY GATE (BLOCK BUILD/DEPLOY IF RISKY)
  # ==========================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - name: Evaluate Security Gate
        shell: bash
        run: |
          echo "Critical found: ${{ needs.security_scans.outputs.critical_found }}"

          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "‚ùå HIGH/CRITICAL vulnerabilities detected"
            exit 1
          fi

          echo "‚úÖ Security Gate Passed"

  # ==========================================================
  # 4) BUILD + SIGN + PUSH + ATTEST
  # ==========================================================
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    if: github.ref == 'refs/heads/main' && needs.security_scans.outputs.critical_found == 'false'

    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      - name: Cleanup before build
        run: |
          docker image prune -af || true
          docker builder prune -af || true

      - name: Build Image
        run: |
          docker build \
            --provenance=true \
            --sbom=true \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t $IMAGE_REPO:$IMAGE_TAG .

      - name: Push Image
        run: |
          docker push $IMAGE_REPO:$IMAGE_TAG

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Cosign Sign Image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes $IMAGE_REPO:$IMAGE_TAG

      - name: Cosign Attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest \
            --yes \
            --predicate ${REPORT_DIR}/sbom/sbom.json \
            --type spdxjson \
            $IMAGE_REPO:$IMAGE_TAG

      - name: Verify SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify-attestation \
            --type spdxjson \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            $IMAGE_REPO:$IMAGE_TAG

      - name: Cosign Verify Image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-identity-regexp "https://github.com/.+/.+/.github/workflows/.+.yml@refs/heads/main" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            $IMAGE_REPO:$IMAGE_TAG

  # ==========================================================
  # 5) DEPLOY (DOCKER COMPOSE KE VM2)
  # ==========================================================
  deploy_compose:
    name: Deploy via Docker Compose (VM2 Hosting)
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to VM2 (Frontend)
        shell: bash
        run: |
          ssh hosting@192.168.107.131 << 'EOF'
            set -euo pipefail

            cd /opt/vuln-bank-app

            echo "‚¨áÔ∏è Pull new image"
            docker pull xbash81/vuln-bank:${{ github.sha }}

            echo "üîÑ Update image tag in compose file"
            sed -i "s|IMAGE_PLACEHOLDER|xbash81/vuln-bank:${{ github.sha }}|g" docker-compose.yml

            echo "üîÑ Restart stack"
            docker compose down
            docker compose up -d

            echo "‚è≥ Wait for app health"
            for i in {1..30}; do
              status=$(docker inspect -f '{{.State.Health.Status}}' vuln-bank-app || true)
              echo "Health: \$status"
              [ "\$status" = "healthy" ] && exit 0
              sleep 3
            done

            echo "‚ùå App failed to become healthy"
            docker compose ps
            docker logs vuln-bank-app
            exit 1
          EOF

  # ==========================================================
  # 6) SLACK NOTIFY (ALWAYS)
  # ==========================================================
  slack_notify:
    runs-on: self-hosted
    needs: [security_scans, build_and_push]
    if: always()
    steps:
      - name: Send Slack Notification
        shell: bash
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          STATUS="‚úÖ Pipeline Succeeded"
          COLOR="good"

          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            STATUS="üö® HIGH/CRITICAL vulnerabilities detected"
            COLOR="danger"
          elif [ "${{ job.status }}" != "success" ]; then
            STATUS="‚ö†Ô∏è Pipeline failed (non-security reason)"
            COLOR="warning"
          fi

          jq -n \
            --arg text "$STATUS" \
            '{text:$text}' \
          | curl -X POST -H 'Content-type: application/json' \
            --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
