# ======================================================
# Vuln Bank ‚Äì DevSecOps Pipeline (FINAL ‚úÖ)
# ======================================================

name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  PYTHON_BIN: python3.11
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: "1"

# ======================================================
# 0) PREP ‚Äì SCAN MODE
# ======================================================
jobs:
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - id: mode
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            echo "mode=light" >> "$GITHUB_OUTPUT"
          fi

# ======================================================
# 1) SECURITY SCANS
# ======================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    outputs:
      critical_found: ${{ steps.flags.outputs.critical }}
      high_risk: ${{ steps.flags.outputs.high_risk }}
      epss_max: ${{ steps.epss.outputs.max }}

    steps:
      - uses: actions/checkout@v4
      - run: echo "SCAN_MODE=${{ needs.prep.outputs.scan_mode }}" >> "$GITHUB_ENV"

      # ---------- Python ----------
      - run: |
          $PYTHON_BIN -m venv .venv
          .venv/bin/pip install --upgrade pip pip-audit

      # ---------- Tools ----------
      - name: Install security tools
        run: |
          set -euo pipefail
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          command -v jq >/dev/null || curl -sSL https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 -o "$BIN/jq"
          chmod +x "$BIN/jq"

          command -v trivy >/dev/null || curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b "$BIN"
          command -v syft  >/dev/null || curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b "$BIN"

      - run: mkdir -p "$REPORT_DIR"/{secrets,sast,sca,misconfig,sbom}

      # ---------- SAST ----------
      - name: Semgrep
        run: |
          CRITICAL=false
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep ci --config p/ci --json > "$REPORT_DIR/sast/semgrep.json" || true
          jq '[.results[]|select(.extra.severity=="ERROR")] | length' \
            "$REPORT_DIR/sast/semgrep.json" | grep -qv 0 && CRITICAL=true
          echo "critical=$CRITICAL" >> $GITHUB_ENV

      # ---------- SCA ----------
      - name: Trivy FS
        run: |
          trivy fs --severity HIGH,CRITICAL --format json -o "$REPORT_DIR/sca/trivy.json" .
          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="CRITICAL")] | length' \
            "$REPORT_DIR/sca/trivy.json" | grep -qv 0 && echo "critical=true" >> $GITHUB_ENV

      # ---------- EPSS ----------
      - name: EPSS
        id: epss
        run: |
          MAX=0
          HIGH_RISK=false

          jq -r '..|.VulnerabilityID?//empty' "$REPORT_DIR/sca/trivy.json" | sort -u > cves.txt || true

          while read -r cve; do
            epss=$(curl -s https://api.first.org/data/v1/epss?cve=$cve | jq -r '.data[0].epss // 0')
            awk -v e="$epss" -v m="$MAX" 'BEGIN{if(e>m) exit 0; else exit 1}' && MAX="$epss"
            awk -v e="$epss" -v t="${EPSS_THRESHOLD}" 'BEGIN{if(e>=t) exit 0; else exit 1}' && HIGH_RISK=true
          done < cves.txt || true

          echo "max=$MAX" >> "$GITHUB_OUTPUT"
          echo "high_risk=$HIGH_RISK" >> "$GITHUB_ENV"

      # ---------- EXPORT FLAGS ----------
      - id: flags
        run: |
          echo "critical=${critical:-false}" >> "$GITHUB_OUTPUT"
          echo "high_risk=${high_risk:-false}" >> "$GITHUB_OUTPUT"

# ======================================================
# 2) SECURITY GATE
# ======================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ] && exit 1
          echo "‚úÖ Security Gate Passed"

# ======================================================
# 4) PR COMMENT (FIXED FORMAT)
# ======================================================
  pr_summary:
    runs-on: self-hosted
    needs: [prep, security_scans]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
            ### üîê Vuln Bank ‚Äì Security Summary

              - **Scan Mode:** \`${{ needs.prep.outputs.scan_mode }}\`
              - **Critical Found:** \`${{ needs.security_scans.outputs.critical_found }}\`
              - **Max EPSS:** \`${{ needs.security_scans.outputs.epss_max }}\`
              `
            })

# ======================================================
# 5) SLACK (EPSS EXPLICIT)
# ======================================================
  slack_notify:
    runs-on: self-hosted
    needs: [prep, security_scans, security_gate]
    if: always()
    steps:
      - run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          EPSS="${{ needs.security_scans.outputs.epss_max }}"

          if [[ "${{ needs.security_scans.outputs.high_risk }}" == "true" ]]; then
            STATUS="üö® HIGH RISK (EPSS ${EPSS})"
            COLOR="#E01E5A"
          elif [[ "${{ needs.security_scans.outputs.critical_found }}" == "true" ]]; then
            STATUS="‚ö†Ô∏è FINDINGS (Low EPSS)"
            COLOR="#ECB22E"
          else
            STATUS="‚úÖ CLEAN"
            COLOR="#2EB886"
          fi

          curl -X POST -H "Content-type: application/json" \
            --data "{\"text\":\"Vuln Bank | $STATUS\"}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
