name: Vuln Bank DevSecOps Pipeline v4 Ultra-Performance

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

env:
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

# =========================================================
# 0) FAST PREP JOB – Determines scan mode
# =========================================================
jobs:
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.setmode.outputs.scan_mode }}
    steps:
      - id: setmode
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then MODE=full; else MODE=light; fi
          echo "scan_mode=$MODE" >> $GITHUB_OUTPUT

# =========================================================
# 1) PARALLEL JOBS START HERE
# =========================================================

# ---------------------------------------------------------
# 1A) SECRET SCAN (Gitleaks)
# ---------------------------------------------------------
  secrets:
    runs-on: self-hosted
    needs: prep
    outputs:
      critical: ${{ steps.flag.outputs.critical }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORT_DIR/secrets
      - run: >
          gitleaks detect -s . -f json -r $REPORT_DIR/secrets/gitleaks.json || true
      - id: flag
        run: |
          if jq -e 'length>0' $REPORT_DIR/secrets/gitleaks.json; then echo "critical=true" >> $GITHUB_OUTPUT; else echo "critical=false" >> $GITHUB_OUTPUT; fi

# ---------------------------------------------------------
# 1B) SAST (Semgrep)
# ---------------------------------------------------------
  sast:
    runs-on: self-hosted
    needs: prep
    outputs:
      critical: ${{ steps.flag.outputs.critical }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORT_DIR/sast
      - run: |
          docker run --rm \
            -v "$PWD":/src \
            returntocorp/semgrep semgrep ci --json -o $REPORT_DIR/sast/semgrep.json || true
      - id: flag
        run: |
          if jq -e '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")]|length>0' $REPORT_DIR/sast/semgrep.json; \
          then echo "critical=true" >> $GITHUB_OUTPUT; else echo "critical=false" >> $GITHUB_OUTPUT; fi

# ---------------------------------------------------------
# 1C) SCA – MATRIX (pip-audit, Snyk, Trivy-FS)
# ---------------------------------------------------------
  sca:
    runs-on: self-hosted
    needs: prep
    strategy:
      fail-fast: false
      matrix:
        scanner: [pip-audit, snyk, trivy-fs]
    outputs:
      critical_${{ matrix.scanner }}: ${{ steps.flag.outputs.critical }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORT_DIR/sca

      - name: pip-audit
        if: matrix.scanner == 'pip-audit'
        run: |
          $PYTHON_BIN -m venv .venv
          .venv/bin/pip install --upgrade pip pip-audit
          .venv/bin/pip-audit -r requirements.txt -f json -o $REPORT_DIR/sca/pip-audit.json || true

      - name: Snyk
        if: matrix.scanner == 'snyk'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --all-projects --json > $REPORT_DIR/sca/snyk.json || true

      - name: Trivy FS
        if: matrix.scanner == 'trivy-fs'
        run: trivy fs --scanners vuln --format json -o $REPORT_DIR/sca/trivy-fs.json .

      - id: flag
        run: |
          FILE="$REPORT_DIR/sca/${{ matrix.scanner }}.json"
          if grep -qi '"severity":"critical"\|"CRITICAL"\|"HIGH"' "$FILE"; \
          then echo "critical=true" >> $GITHUB_OUTPUT; else echo "critical=false" >> $GITHUB_OUTPUT; fi

# ---------------------------------------------------------
# 1D) MISCONFIG (Trivy Config)
# ---------------------------------------------------------
  misconfig:
    runs-on: self-hosted
    needs: prep
    outputs:
      critical: ${{ steps.flag.outputs.critical }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORT_DIR/misconfig
      - run: trivy config --severity HIGH,CRITICAL --format json -o $REPORT_DIR/misconfig/trivy-config.json .
      - id: flag
        run: |
          if jq -e '[.Results[].Misconfigurations[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")]|length>0' \
            $REPORT_DIR/misconfig/trivy-config.json; \
          then echo "critical=true" >> $GITHUB_OUTPUT; else echo "critical=false" >> $GITHUB_OUTPUT; fi

# ---------------------------------------------------------
# 1E) SBOM (Syft)
# ---------------------------------------------------------
  sbom:
    runs-on: self-hosted
    needs: prep
    outputs:
      sbom_path: ${{ steps.out.outputs.path }}
    steps:
      - uses: actions/checkout@v4
      - run: mkdir -p $REPORT_DIR/sbom
      - id: out
        run: |
          syft . -o json > $REPORT_DIR/sbom/sbom.json
          echo "path=$REPORT_DIR/sbom/sbom.json" >> $GITHUB_OUTPUT


# ---------------------------------------------------------
# 1F) EPSS GATE (collects ALL SCA findings)
# ---------------------------------------------------------
  epss:
    runs-on: self-hosted
    needs: [sca]
    outputs:
      critical: ${{ steps.flag.outputs.critical }}
    steps:
      - uses: actions/checkout@v4
      - run: |
          jq -r '..|.VulnerabilityID?//empty' security-reports/sca/trivy-fs.json > cves.txt || true
          jq -r '..|.id?//empty' security-reports/sca/pip-audit.json >> cves.txt || true
          jq -r '..|.identifiers?.CVE[]?//empty' security-reports/sca/snyk.json >> cves.txt || true
          sort -u cves.txt -o cves.txt

      - run: |
          cat cves.txt | xargs -I {} -P 10 sh -c '
            epss=$(curl -s "https://api.first.org/data/v1/epss?cve={}" | jq -r ".data[0].epss//0");
            awk "BEGIN{exit !($epss>${EPSS_THRESHOLD})}"
          ' && touch critical.flag || true

      - id: flag
        run: |
          if [ -f critical.flag ]; then echo "critical=true" >> $GITHUB_OUTPUT; else echo "critical=false" >> $GITHUB_OUTPUT; fi


# =========================================================
# 2) SECURITY AGGREGATOR
# =========================================================
  gate:
    runs-on: self-hosted
    needs: [secrets, sast, sca, misconfig, epss]
    outputs:
      approved: ${{ steps.out.outputs.ok }}
    steps:
      - id: out
        run: |
          if [[ \
            "${{needs.secrets.outputs.critical}}" == "true" || \
            "${{needs.sast.outputs.critical}}" == "true" || \
            "${{needs.sca.outputs.critical_pip-audit}}" == "true" || \
            "${{needs.sca.outputs.critical_snyk}}" == "true" || \
            "${{needs.sca.outputs.critical_trivy-fs}}" == "true" || \
            "${{needs.misconfig.outputs.critical}}" == "true" || \
            "${{needs.epss.outputs.critical}}" == "true" \
          ]]; then
            echo "ok=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "ok=true" >> $GITHUB_OUTPUT
          fi


# =========================================================
# 3) BUILD, SIGN, PUSH (ONLY IF APPROVED)
# =========================================================
  build:
    runs-on: self-hosted
    needs: gate
    if: needs.gate.outputs.approved == 'true'
    steps:
      - uses: actions/checkout@v4
      - run: |
          docker build -t $IMAGE_REPO:$IMAGE_TAG .
          docker push $IMAGE_REPO:$IMAGE_TAG
      - uses: sigstore/cosign-installer@v3
      - run: cosign sign --yes $IMAGE_REPO:$IMAGE_TAG


# =========================================================
# 4) DAST (Run only on main)
# =========================================================
  dast:
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - run: docker compose -f docker-compose.dast.yml up -d
      - run: |
          for i in {1..30}; do
            if docker run --rm --network dastnet curlimages/curl -sf http://vuln-bank-dast:5000 >/dev/null; then exit 0; fi
            sleep 3
          done
          exit 1
      - run: |
          docker exec zap zap-baseline.py \
            -t http://vuln-bank-dast:5000 \
            -J zap.json -I || true
          docker cp zap:/zap/wrk/zap.json security-reports/dast/zap.json
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/dast/zap.json


# =========================================================
# 5) DEPLOY
# =========================================================
  deploy:
    runs-on: self-hosted
    needs: [build, dast]
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          ssh hosting@192.168.107.135 "
            cd /opt/vuln-bank-app/containers/app &&
            docker pull $IMAGE_REPO:$IMAGE_TAG &&
            IMAGE_TAG=$IMAGE_TAG docker compose up -d
          "

# =========================================================
# 6) SLACK NOTIFICATION
# =========================================================
  notify:
    runs-on: self-hosted
    needs: [gate, deploy]
    if: always()
    steps:
      - run: |
          MSG="Pipeline completed."
          [ "${{needs.gate.outputs.approved}}" = "false" ] && MSG="❌ Security Gate Failed"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\"}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
