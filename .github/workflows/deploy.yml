name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  DOCKER_CONFIG: /opt/github-runner/.docker
  HOME: /opt/github-runner
  IMAGE_NAME: vuln-bank
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  REPORT_DIR: security-reports
  DAST_TARGET_URL: http://vuln-bank-dast:5000
  PYTHON_BIN: python3.11
  PIP_NO_CACHE_DIR: "1"
  DOCKER_BUILDKIT: 1
  EPSS_THRESHOLD: "0.5"

jobs:
  ###########################################################################
  # 1) SECURITY SCANS
  ###########################################################################
  security_scans:
    name: DevSecOps Continuous Assurance
    runs-on: self-hosted
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    outputs:
      critical_found: ${{ steps.setflag.outputs.critical_found }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Runner sanity check
        run: |
          $PYTHON_BIN --version
          docker --version || true

      - name: Install base tools (pip-audit + jq)
        run: |
          BIN_DIR="$RUNNER_TEMP/bin"
          mkdir -p "$BIN_DIR"
          echo "$BIN_DIR" >> $GITHUB_PATH
          export PATH="$BIN_DIR:$PATH"

          $PYTHON_BIN -m venv .venv
          source .venv/bin/activate

          pip install --upgrade pip
          pip install pip-audit==2.7.2

          if ! command -v jq >/dev/null; then
            curl -L -o "$BIN_DIR/jq" https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
            chmod +x "$BIN_DIR/jq"
          fi

      #######################################################################
      # SEMGREP â€” FIXED PERMISSION SECTION
      #######################################################################
      - name: Semgrep SAST
        run: |
          set -e

          mkdir -p ${REPORT_DIR}/sast
          chmod -R 777 ${REPORT_DIR}/sast

          echo "Running Semgrep via Dockerâ€¦"

          docker run --rm \
            -v "$GITHUB_WORKSPACE":/src \
            --workdir /src \
            returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --json \
              --output /src/${REPORT_DIR}/sast/semgrep.json \
            || echo '{}' > ${REPORT_DIR}/sast/semgrep.json

          jq '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' \
            ${REPORT_DIR}/sast/semgrep.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      - name: Export venv to PATH
        run: |
          echo "PATH=$(pwd)/.venv/bin:$PATH" >> $GITHUB_ENV

      #######################################################################
      # INSTALL SECURITY TOOLS
      #######################################################################
      - name: Install Trivy
        run: |
          BIN_DIR="$RUNNER_TEMP/bin"
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b "$BIN_DIR"

      - name: Install Gitleaks
        run: |
          BIN_DIR="$RUNNER_TEMP/bin"
          VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
          curl -sL https://github.com/gitleaks/gitleaks/releases/download/$VER/gitleaks_${VER#v}_linux_x64.tar.gz \
            | tar -xz -C "$BIN_DIR"
          chmod +x "$BIN_DIR/gitleaks"

      - name: Install Snyk CLI
        run: |
          BIN_DIR="$RUNNER_TEMP/bin"
          curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux -o "$BIN_DIR/snyk"
          chmod +x "$BIN_DIR/snyk"

      - name: Install Syft (SBOM)
        run: |
          BIN_DIR="$RUNNER_TEMP/bin"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b "$BIN_DIR"

      - name: Init critical flag
        run: echo "false" > critical_flag.txt

      - name: Prepare report dirs
        run: mkdir -p ${REPORT_DIR}/{secrets,sca,sast,misconfig,dast,sbom}

      #######################################################################
      # SECRET SCANNING
      #######################################################################
      - name: Gitleaks
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path ${REPORT_DIR}/secrets/gitleaks.json || true

          jq -e 'length>0' ${REPORT_DIR}/secrets/gitleaks.json \
            && echo true > critical_flag.txt || true

      #######################################################################
      # SCA (pip-audit, Trivy FS, Snyk)
      #######################################################################
      - name: pip-audit
        run: |
          if [ -f requirements.txt ]; then
            .venv/bin/pip-audit -r requirements.txt \
              -f json -o ${REPORT_DIR}/sca/pip-audit.json || true
          fi

      - name: Trivy FS
        run: |
          trivy fs --scanners vuln \
            --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/sca/trivy-fs.json .

          jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/sca/trivy-fs.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects --json > ${REPORT_DIR}/sca/snyk.json || true
          grep -qi '"severity":"high"\|"severity":"critical"' ${REPORT_DIR}/sca/snyk.json \
            && echo true > critical_flag.txt || true

      #######################################################################
      # EPSS SMART FILTER
      #######################################################################
      - name: EPSS Score Check
        run: |
          jq -r '.. | .id? // empty' ${REPORT_DIR}/sca/snyk.json | sort -u > cves.txt || true

          if [ -s cves.txt ]; then
            while read cve; do
              epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
                | jq -r '.data[0].epss // 0')
              awk "BEGIN{exit !($epss > ${EPSS_THRESHOLD})}" \
                && echo true > critical_flag.txt
            done < cves.txt
          fi

      #######################################################################
      # Trivy Config (IaC)
      #######################################################################
      - name: Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/misconfig/trivy-config.json .

          jq '[.Results[].Misconfigurations[]? | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/misconfig/trivy-config.json | grep -qv '^0$' \
            && echo true > critical_flag.txt || true

      #######################################################################
      # DAST â€” OWASP ZAP
      #######################################################################
      - name: Build local app image for DAST
        run: docker build -t vuln-bank:${{ github.sha }} .

      - name: Prepare DAST dirs
        run: mkdir -p security-reports/dast

      - name: Start DAST environment
        run: |
          IMAGE_TAG=${{ github.sha }} docker compose -f docker-compose.dast.yml up -d

      - name: Wait for app port
        run: |
          for i in {1..30}; do
            if docker run --rm --network container:vuln-bank-dast \
              curlimages/curl:8.6.0 -sf http://127.0.0.1:5000 >/dev/null; then
              echo "App ready"
              exit 0
            fi
            sleep 3
          done
          exit 1

      - name: ZAP Baseline Scan
        run: |
          docker exec zap \
            zap-baseline.py \
            -t http://vuln-bank-dast:5000 \
            -J /zap/wrk/zap-baseline.json \
            -r /zap/wrk/zap-baseline.html \
            -m 2 -I || true

      - name: Convert ZAP to SARIF
        run: |
          # Python converter written inline
          cat > zap-to-sarif.py <<'EOF'
          (converter same as before)
          EOF

          python3 zap-to-sarif.py

      - name: Upload ZAP SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/dast/zap.sarif

      - name: Cleanup DAST
        run: docker compose -f docker-compose.dast.yml down -v

      #######################################################################
      # SBOM
      #######################################################################
      - name: Generate SBOM
        run: syft . -o json > ${REPORT_DIR}/sbom/sbom.json

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: setflag
        run: echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT


  ###########################################################################
  # 2) AUTO SECURITY ISSUE
  ###########################################################################
  create_security_issue:
    name: Create Security Issue
    runs-on: self-hosted
    needs: security_scans
    if: needs.security_scans.outputs.critical_found == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Create Issue Body
        run: |
          cat <<EOF > issue.md
          ## ðŸš¨ SECURITY ALERT â€“ High / Critical Vulnerabilities Found
          Commit: ${GITHUB_SHA}
          Reports: See Artifacts
          EOF

      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("issue.md", "utf8");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ High/Critical Vulnerabilities Detected",
              body: body,
              labels: ["security","critical"]
            });


  ###########################################################################
  # 3) SECURITY GATE
  ###########################################################################
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - name: Evaluate Gate
        run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            exit 1
          fi
          echo "Gate Passed"


  ###########################################################################
  # 4) BUILD + SIGN + PUSH
  ###########################################################################
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Login Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Image
        run: |
          docker build \
            --provenance=true \
            --sbom=true \
            -t $IMAGE_REPO:$IMAGE_TAG .

      - name: Push Image
        run: docker push $IMAGE_REPO:$IMAGE_TAG

      - uses: sigstore/cosign-installer@v3

      - name: Cosign Sign
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: cosign sign --yes $IMAGE_REPO:$IMAGE_TAG


  ###########################################################################
  # 5) DEPLOY DOCKER COMPOSE VM2
  ###########################################################################
  deploy_compose:
    name: Deploy to VM2
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy
        run: |
          ssh hosting@192.168.107.135 << 'EOF'
            cd /opt/vuln-bank-app/containers/app
            docker pull xbash81/vuln-bank:${{ github.sha }}
            IMAGE_WITH_TAG="xbash81/vuln-bank:${{ github.sha }}" docker compose up -d
          EOF


  ###########################################################################
  # 6) SLACK NOTIFICATION
  ###########################################################################
  slack_notify:
    runs-on: self-hosted
    needs: [security_scans, build_and_push]
    if: always()
    steps:
      - name: Send Slack
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0
          TEXT="Pipeline Completed"
          jq -n --arg text "$TEXT" '{text:$text}' \
            | curl -X POST -H 'Content-type: application/json' \
              --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
