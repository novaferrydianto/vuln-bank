name: üîê Vuln Bank DevSecOps Pipeline (Enterprise v3)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # Daily full scan (‚âà 01:00 WIB)
  workflow_dispatch:

env:
  REPORT_DIR: security-reports
  REGISTRY: docker.io
  IMAGE_NAME: vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  FULL_IMAGE: docker.io/xbash/vuln-bank:${{ github.sha }}
  EPSS_THRESHOLD: "0.7"

jobs:
  #################################################################
  # JOB 1 ‚Äî SECURITY CI (MAIN GATE)
  #################################################################
  security-ci:
    name: üõ°Ô∏è Security CI (SAST / SCA / Secrets / DAST / Misconfig / SBOM / Cosign / Snyk)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      id-token: write
      packages: write
      issues: write

    outputs:
      image_digest: ${{ steps.image_meta.outputs.digest }}

    steps:
      #################################################################
      # 0. Checkout + Python
      #################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare security reports directory
        run: mkdir -p "$REPORT_DIR"

      #################################################################
      # 1. Install security / supply-chain tools
      #################################################################
      - name: Install CLI security tools
        run: |
          set -e

          pip install --upgrade pip
          pip install \
            bandit==1.* \
            semgrep==1.*

          # TruffleHog (official install script)
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

          # Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

          # Syft (SBOM)
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin

          # Cosign
          COSIGN_VERSION="v2.4.1"
          curl -sSLo /usr/local/bin/cosign \
            "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
          chmod +x /usr/local/bin/cosign

          # ZAP Baseline
          curl -L https://github.com/zaproxy/zaproxy/releases/latest/download/zap-baseline.py \
            -o /usr/local/bin/zap-baseline.py
          chmod +x /usr/local/bin/zap-baseline.py

      - name: Verify installed tools
        run: |
          trufflehog --version
          bandit --version
          semgrep --version
          trivy --version
          syft version || true
          cosign version || true
          python3 /usr/local/bin/zap-baseline.py --help || true

      #################################################################
      # 2. Tests (opsional)
      #################################################################
      - name: Install app dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt;
          else
            echo "No requirements.txt, skipping...";
          fi

      - name: Run unit tests (non-blocking)
        run: |
          if ls tests 2>/dev/null; then
            pytest -q || true;
          else
            echo "No tests/ dir, skipping...";
          fi

      #################################################################
      # 3. Secret Scan (TruffleHog)
      #################################################################
      - name: üîë Secret scan (TruffleHog)
        run: |
          trufflehog filesystem --json . > "$REPORT_DIR/trufflehog.json" || true

      #################################################################
      # 4. SAST ‚Äî Bandit (JSON ‚Üí SARIF via Bandit2SARIF) + Semgrep SARIF
      #################################################################
      - name: üß± SAST (Bandit ‚Üí JSON)
        run: |
          bandit -r . --exit-zero -f json -o "$REPORT_DIR/bandit.json"

      - name: üß± Convert Bandit JSON ‚Üí SARIF
        run: |
          python3 << 'PY'
          import json, os

          report_dir = os.environ.get("REPORT_DIR", "security-reports")
          src = os.path.join(report_dir, "bandit.json")
          dst = os.path.join(report_dir, "bandit.sarif")

          if not os.path.exists(src):
              print("No bandit.json found, skipping SARIF conversion")
              raise SystemExit(0)

          with open(src) as f:
              data = json.load(f)

          # Minimal SARIF wrapper (Bandit2SARIF-lite)
          sarif = {
              "version": "2.1.0",
              "runs": [
                  {
                      "tool": {
                          "driver": {
                              "name": "bandit",
                              "informationUri": "https://bandit.readthedocs.io/",
                              "rules": []
                          }
                      },
                      "results": []
                  }
              ]
          }

          run = sarif["runs"][0]
          rules_index = {}

          for issue in data.get("results", []):
              rule_id = issue.get("test_id", "BANDIT")
              severity = issue.get("issue_severity", "MEDIUM")
              conf = issue.get("issue_confidence", "MEDIUM")
              msg = issue.get("issue_text", "")
              fname = issue.get("filename", "")
              line = issue.get("line_number", 1)

              if rule_id not in rules_index:
                  rule = {
                      "id": rule_id,
                      "name": issue.get("test_name", rule_id),
                      "shortDescription": {"text": msg[:80]},
                      "properties": {
                          "severity": severity,
                          "confidence": conf
                      }
                  }
                  run["tool"]["driver"]["rules"].append(rule)
                  rules_index[rule_id] = len(run["tool"]["driver"]["rules"]) - 1

              result = {
                  "ruleId": rule_id,
                  "message": {"text": msg},
                  "locations": [
                      {
                          "physicalLocation": {
                              "artifactLocation": {"uri": fname},
                              "region": {"startLine": line}
                          }
                      }
                  ],
                  "properties": {
                      "severity": severity,
                      "confidence": conf
                  }
              }
              run["results"].append(result)

          with open(dst, "w") as f:
              json.dump(sarif, f, indent=2)

          print(f"Converted {src} ‚Üí {dst}")
          PY

      - name: üß± SAST (Semgrep ‚Üí SARIF)
        run: |
          semgrep ci --config auto \
            --sarif --output "$REPORT_DIR/semgrep.sarif" || true

      - name: üìä Upload Semgrep SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.REPORT_DIR }}/semgrep.sarif

      - name: üìä Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.REPORT_DIR }}/bandit.sarif

      #################################################################
      # 5. Build container
      #################################################################
      - name: üê≥ Build container image
        run: docker build -t "$FULL_IMAGE" .

      #################################################################
      # 6. Trivy ‚Äî Image & Config
      #################################################################
      - name: üì¶ Trivy image scan
        run: |
          trivy image \
            --scanners vuln,secret \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-image.json" \
            --exit-code 0 \
            "$FULL_IMAGE"

      - name: ‚öôÔ∏è Trivy config scan
        run: |
          trivy config \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-config.json" \
            --exit-code 0 \
            .

      #################################################################
      # 7. Snyk SCA + Container (NO SARIF, JSON only)
      #################################################################
      - name: üîç Check if Snyk token available
        id: snyk_enabled
        run: |
          if [ -z "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "Snyk token missing ‚Äî skipping Snyk scans."
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üõ† Install Snyk CLI
        if: steps.snyk_enabled.outputs.enabled == 'true'
        run: |
          curl -sL https://static.snyk.io/cli/latest/snyk-linux \
            -o /usr/local/bin/snyk
          chmod +x /usr/local/bin/snyk

      - name: üîê Snyk auth
        if: steps.snyk_enabled.outputs.enabled == 'true'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: üì¶ Snyk SCA Scan (Dependencies)
        if: steps.snyk_enabled.outputs.enabled == 'true'
        run: |
          snyk test \
            --json \
            --severity-threshold=high \
            > "$REPORT_DIR/snyk-sca.json" \
            || true

      - name: üê≥ Snyk Container Scan
        if: steps.snyk_enabled.outputs.enabled == 'true'
        run: |
          snyk container test "$FULL_IMAGE" \
            --file=Dockerfile \
            --json \
            --severity-threshold=high \
            > "$REPORT_DIR/snyk-container.json" \
            || true

      #################################################################
      # 8. DAST (OWASP ZAP Baseline)
      #################################################################
      - name: üöÄ Run app container for DAST
        run: |
          docker run -d --rm \
            -p 5000:5000 \
            --name vuln-bank \
            "$FULL_IMAGE"

      - name: üåê ZAP Baseline
        env:
          TARGET_URL: http://localhost:5000
        run: |
          python3 /usr/local/bin/zap-baseline.py \
            -t "$TARGET_URL" \
            -x "$REPORT_DIR/zap-report.xml" || true

      - name: üßØ Stop DAST container
        if: always()
        run: docker stop vuln-bank || true

      #################################################################
      # 9. EPSS + Severity Gate (risk-based)
      #################################################################
      - name: üìä Evaluate EPSS + HIGH/CRITICAL
        env:
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}
        run: |
          python3 << 'PY'
          import json, os, sys, ssl, urllib.request, urllib.parse

          report_dir = os.environ.get("REPORT_DIR", "security-reports")
          path = os.path.join(report_dir, "trivy-image.json")
          epss_threshold = float(os.environ.get("EPSS_THRESHOLD", "0.7"))

          if not os.path.exists(path):
              print("No Trivy image report found")
              summary_path = os.path.join(report_dir, "epss-summary.txt")
              with open(summary_path, "w") as f:
                  f.write("# Vuln Bank - Risk-based summary (Trivy + EPSS)\n\n")
                  f.write("- No Trivy image report found.\n")
              sys.exit(0)

          with open(path) as f:
              data = json.load(f)

          vulns = []
          for r in data.get("Results", []):
              for v in r.get("Vulnerabilities", []):
                  vulns.append(v)

          highcrit = [v for v in vulns if v.get("Severity") in ("HIGH","CRITICAL")]

          def epss(cve):
              try:
                  url = "https://api.first.org/data/v1/epss?cve=" + urllib.parse.quote(cve)
                  ctx = ssl.create_default_context()
                  with urllib.request.urlopen(url, context=ctx, timeout=5) as resp:
                      d = json.loads(resp.read().decode())
                      dat = d.get("data", [])
                      return float(dat[0].get("epss", 0.0)) if dat else 0.0
              except Exception as e:
                  print(f"[EPSS] Failed for {cve}: {e}")
                  return 0.0

          risky = []
          for v in highcrit:
              vuln_id = v.get("VulnerabilityID","")
              if vuln_id.startswith("CVE-"):
                  score = epss(vuln_id)
                  if score >= epss_threshold:
                      v["EPSS"] = score
                      risky.append(v)

          summary_path = os.path.join(report_dir, "epss-summary.txt")
          with open(summary_path, "w") as f:
              f.write("# Vuln Bank - Risk-based summary (Trivy + EPSS)\n\n")
              f.write(f"- Total vulns scanned: {len(vulns)}\n")
              f.write(f"- HIGH/CRITICAL: {len(highcrit)}\n")
              f.write(f"- HIGH/CRITICAL with EPSS >= {epss_threshold}: {len(risky)}\n\n")
              if risky:
                  f.write("Top risky findings (EPSS-based):\n")
                  for v in risky[:10]:
                      f.write(
                          f"- {v.get('VulnerabilityID')} | "
                          f"{v.get('Severity')} | "
                          f"EPSS={v.get('EPSS', 0):.3f} | "
                          f"{v.get('Title','')}\n"
                      )
              else:
                  f.write("No HIGH/CRITICAL vulnerabilities above EPSS threshold.\n")

          if highcrit or risky:
              print("‚ùå HIGH/CRITICAL or high EPSS detected")
              sys.exit(1)

          print("‚úÖ Clean ‚Äî No HIGH/CRITICAL or high EPSS issues")
          sys.exit(0)
          PY

      #################################################################
      # 10. SBOM (Syft)
      #################################################################
      - name: üì¶ Generate SBOM (Syft)
        run: |
          syft "$FULL_IMAGE" -o json > "$REPORT_DIR/sbom.json"
          syft "$FULL_IMAGE" -o spdx-json > "$REPORT_DIR/sbom-spdx.json"
          syft "$FULL_IMAGE" -o cyclonedx-json > "$REPORT_DIR/sbom-cyclonedx.json"

      #################################################################
      # 11. Push + Cosign (keyless, digest-based)
      #################################################################
      - name: üîê Login DockerHub
        run: |
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üì§ Push image
        run: docker push "$FULL_IMAGE"

      - name: üìå Export digest
        id: image_meta
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$FULL_IMAGE")
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "Image digest: $DIGEST"

      - name: üîè Cosign sign (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign "${{ steps.image_meta.outputs.digest }}" --yes

      #################################################################
      # 12. Upload Reports + Summary
      #################################################################
      - name: üìé Upload security reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - name: üìù Append security summary
        run: |
          echo "## üîê Vuln Bank - Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Image: \`$FULL_IMAGE\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- EPSS threshold: \`${EPSS_THRESHOLD}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- SBOM: sbom.json / sbom-spdx.json / sbom-cyclonedx.json" >> "$GITHUB_STEP_SUMMARY"
          echo "- Cosign: keyless sign with Sigstore (OIDC)" >> "$GITHUB_STEP_SUMMARY"
          echo "- SAST: Semgrep + Bandit (SARIF uploaded to Security tab)" >> "$GITHUB_STEP_SUMMARY"
          echo "- SCA: Trivy + Snyk (JSON artifacts)" >> "$GITHUB_STEP_SUMMARY"

  #################################################################
  # JOB 2 ‚Äî NOTIFY ON FAILURE (Discord + GitHub Issue)
  #################################################################
  notify-and-issues:
    name: üö® Notify & Create Issue
    needs: security-ci
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Show EPSS summary
        run: |
          echo "=== EPSS summary ==="
          cat security-reports/epss-summary.txt || echo "No epss-summary.txt found."

      - name: üîî Discord notify (auto-skip if no webhook)
        env:
          HOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$HOOK" ]; then
            echo "No webhook, skipping Discord notify.";
            exit 0;
          fi

          MSG="üö® Vuln Bank ‚Äî Security pipeline FAILED for $GITHUB_SHA
          Repo: $GITHUB_REPOSITORY
          Ref : $GITHUB_REF

          Check artifacts: security-reports/* and epss-summary.txt"
          JSON=$(printf '{"content":"%s"}' "$MSG")

          curl -X POST -H "Content-Type: application/json" \
            -d "$JSON" "$HOOK"

      - name: üìù Create GitHub Issue from EPSS summary
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "üî¥ High/CRITICAL or EPSS-detected risks in ${{ github.sha }}"
          content-filepath: security-reports/epss-summary.txt
          labels: |
            security
            critical
            devsecops
            auto-created

  #################################################################
  # JOB 3 ‚Äî DEPLOY VIA ANSIBLE (SELF-HOSTED RUNNER)
  #################################################################
  deploy:
    name: üöÄ Deploy to VMware Lab
    needs: security-ci
    if: success()
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible (if missing)
        run: |
          if ! command -v ansible-playbook >/dev/null 2>&1; then
            sudo dnf install -y ansible-core;
          else
            echo "Ansible already installed.";
          fi

      - name: Run Ansible deploy (digest-first)
        env:
          IMAGE_DIGEST: ${{ needs.security-ci.outputs.image_digest }}
          FULL_IMAGE: ${{ env.FULL_IMAGE }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          VULN_ENV_FILE: ${{ secrets.VULN_ENV_FILE }}
          DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
          BASTION_HOST: ${{ secrets.BASTION_HOST }}
        run: |
          IMAGE="${IMAGE_DIGEST:-$FULL_IMAGE}"

          ansible-playbook -i inventory.ini site.yml \
            --tags deploy_vuln_bank \
            -e "FULL_IMAGE=$IMAGE" \
            -e "db_user=$DB_USER" \
            -e "db_password=$DB_PASSWORD" \
            -e "flask_secret_key=$FLASK_SECRET_KEY" \
            -e "vuln_env_file=$VULN_ENV_FILE" \
            -e "dockerhub_repo=$DOCKERHUB_REPO" \
            -e "bastion_host=$BASTION_HOST"
