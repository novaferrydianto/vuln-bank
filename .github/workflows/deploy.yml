name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB daily (optional continuous assurance)

permissions:
  contents: read
  security-events: write
  issues: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports

  # Target network (on-prem)
  DAST_TARGET_URL: "http://192.168.107.135:5500"

  # Image build/push
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}   # e.g. xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: containers/app/Dockerfile

  # SonarQube (VM4)
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}   # e.g. http://192.168.107.132:9000
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_PROJECT_KEY: vuln-bank

  # DefectDojo (VM4)
  DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}   # e.g. http://192.168.107.132:8080
  DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
  DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
  DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}

  # Slack
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # EPSS gate
  EPSS_THRESHOLD: "0.5"

jobs:
  security_scans:
    name: Security Scans (Secret + SCA/EPSS + SAST + Misconfig)
    runs-on: [self-hosted, bastion]

    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
      gate_failed: ${{ steps.gate_eval.outputs.gate_failed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        shell: bash
        run: |
          set -euo pipefail
          test -d scripts
          chmod +x scripts/*.py
          ls -la scripts

      - name: Verify tools (scan-only, no install)
        shell: bash
        run: |
          set -euo pipefail
          echo "==> Verify required tools"
          for t in trivy hadolint python3; do
            command -v "$t" >/dev/null 2>&1 || { echo "Missing tool: $t"; exit 1; }
            echo "- $t: $(command -v "$t")"
          done
          if command -v checkov >/dev/null 2>&1; then
            echo "- checkov: $(command -v checkov)"
          else
            echo "- checkov: NOT INSTALLED (will be skipped)"
          fi
          trivy --version
          hadolint --version
          python3 --version

      - name: Prepare folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}" "${REPORT_DIR}/sarif" "${REPORT_DIR}/zap"

      # ------------------------------
      # SECRET SCANNING (TruffleHog)
      # ------------------------------
      - name: Secret Scan (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: ${{ github.event.pull_request.base.sha || '' }}
          head: ${{ github.event.pull_request.head.sha || '' }}
          extra_args: --only-verified --json
        continue-on-error: true

      # ------------------------------
      # SCA (Trivy FS / deps) + SARIF
      # ------------------------------
      - name: SCA (Trivy FS)
        shell: bash
        run: |
          set -euo pipefail
          echo "Running Trivy FS..."
          trivy fs --scanners vuln,secret,license \
            --format json --output "${REPORT_DIR}/trivy-sca.json" .
          trivy fs --scanners vuln,secret,license \
            --format sarif --output "${REPORT_DIR}/sarif/trivy-sca.sarif" . || true
          echo "Trivy FS done."

      # ------------------------------
      # EPSS GATE (expects scripts/epss_gate.py)
      # ------------------------------
      - name: EPSS Gate (HIGH exploitability filter)
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/epss_gate.py \
            --input "${REPORT_DIR}/trivy-sca.json" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}"

      # ------------------------------
      # SAST (SonarQube)
      # ------------------------------
            - name: SAST (SonarQube scan)
        shell: bash
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        run: |
          set -euo pipefail
          # ... install sonar-scanner if missing ...

          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "Main branch: enforcing Sonar Quality Gate"
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.token="${SONAR_TOKEN}" \
              -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
              -Dsonar.sources=. \
              -Dsonar.qualitygate.wait=true
          else
            echo "PR branch: Sonar advisory (do not fail pipeline)"
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.token="${SONAR_TOKEN}" \
              -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
              -Dsonar.sources=. \
              -Dsonar.qualitygate.wait=true || true
          fi

      # ------------------------------
      # MISCONFIG SCANNING
      # ------------------------------
      - name: Misconfig (Hadolint Dockerfile)
        shell: bash
        run: |
          set -euo pipefail
          hadolint --version
          hadolint "${DOCKERFILE_PATH}" | tee "${REPORT_DIR}/hadolint.txt" || true

      - name: Misconfig (Trivy Config)
        shell: bash
        run: |
          set -euo pipefail
          trivy config --format json --output "${REPORT_DIR}/trivy-config.json" .
          trivy config --format sarif --output "${REPORT_DIR}/sarif/trivy-config.sarif" . || true

      - name: "Misconfig (Checkov IaC) [scan-only: skip if missing]"
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v checkov >/dev/null 2>&1; then
            echo "[SKIP] checkov not installed on runner"
            echo '{"summary":{"failed":0},"results":{}}' > "${REPORT_DIR}/checkov.json"
            exit 0
          fi
          checkov -d . -o json > "${REPORT_DIR}/checkov.json" || true

      # ------------------------------
      # BUILD META (image_ref output)
      # ------------------------------
      - name: Set image metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          echo "image_ref=${DOCKERHUB_REPO}:${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

      # ------------------------------
      # EVALUATE GATE + SLACK NOTIFY (on high/critical or EPSS-high)
      # ------------------------------
      - name: Evaluate gate + notify Slack
        id: gate_eval
        shell: bash
        run: |
          set -euo pipefail

          python3 scripts/slack_alert.py \
            --webhook "${SLACK_WEBHOOK_URL}" \
            --run-url "https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            --trivy "${REPORT_DIR}/trivy-sca.json" \
            --epss "${REPORT_DIR}/epss-findings.json" \
            --hadolint "${REPORT_DIR}/hadolint.txt" \
            --checkov "${REPORT_DIR}/checkov.json" || true

          GATE_FAILED="false"
          if python3 scripts/gate_decision.py --trivy "${REPORT_DIR}/trivy-sca.json" --epss "${REPORT_DIR}/epss-findings.json" ; then
            echo "Gate PASSED"
          else
            echo "Gate FAILED"
            GATE_FAILED="true"
          fi

          echo "gate_failed=${GATE_FAILED}" >> "$GITHUB_OUTPUT"

          if [ "${GATE_FAILED}" = "true" ]; then
            exit 1
          fi

      # ------------------------------
      # UPLOAD ARTIFACTS
      # ------------------------------
      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}
          retention-days: 14

      - name: Upload SARIF (GitHub Security)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ env.REPORT_DIR }}/sarif
        continue-on-error: true

  build_and_push:
    name: Build + Push Image + SBOM
    runs-on: [self-hosted, bastion]
    needs: [security_scans]

    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    outputs:
      image_ref: ${{ steps.out.outputs.image_ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        shell: bash
        run: |
          set -euo pipefail
          if [ -d scripts ]; then
            chmod +x scripts/*.py 2>/dev/null || true
            ls -la scripts || true
          fi

      - name: Docker login
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & Push
        id: out
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_REF="${DOCKERHUB_REPO}:${IMAGE_TAG}"

          docker build -f "${DOCKERFILE_PATH}" -t "${IMAGE_REF}" .
          docker push "${IMAGE_REF}"

          echo "image_ref=${IMAGE_REF}" >> "$GITHUB_OUTPUT"

      - name: Generate SBOM (Syft) [requires syft installed on runner]
        shell: bash
        run: |
          set -euo pipefail
          command -v syft >/dev/null 2>&1 || { echo "Missing tool: syft (install it once on runner)"; exit 1; }
          mkdir -p "${REPORT_DIR}"
          syft "registry:${{ steps.out.outputs.image_ref }}" -o spdx-json > "${REPORT_DIR}/sbom.spdx.json"

      - name: Upload build artifacts (SBOM)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ${{ env.REPORT_DIR }}/sbom.spdx.json
          retention-days: 14

  deploy_and_dast:
    name: Deploy (Ansible) + DAST (ZAP) + Import DefectDojo
    runs-on: [self-hosted, bastion]
    needs: [build_and_push]

    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        shell: bash
        run: |
          set -euo pipefail
          if [ -d scripts ]; then
            chmod +x scripts/*.py 2>/dev/null || true
            ls -la scripts || true
          fi

      # ------------------------------
      # DEPLOY (ANSIBLE)
      # ------------------------------
      - name: Deploy via Ansible (VM2/VM3)
        shell: bash
        run: |
          set -euo pipefail

          python3 -m pip install --upgrade pip >/dev/null
          python3 -m pip install ansible >/dev/null
          ansible-galaxy collection install community.docker >/dev/null

          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_runner_temp
          chmod 600 ~/.ssh/id_runner_temp

          ansible-playbook -i ansible/inventory.ini ansible/site.yml \
            --private-key ~/.ssh/id_runner_temp \
            -e "image_ref=${{ needs.build_and_push.outputs.image_ref }}" \
            -e "db_password=${{ secrets.DB_PASSWORD }}" \
            -e "app_secret=${{ secrets.APP_SECRET_KEY }}" \
            -e "jwt_secret=${{ secrets.JWT_SECRET_KEY }}"

      # ------------------------------
      # DAST (OWASP ZAP) - run from VM1 to reach VM2
      # ------------------------------
      - name: DAST (OWASP ZAP Baseline)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}/zap"

          docker run --rm --network host \
            -v "$(pwd)/${REPORT_DIR}/zap:/zap/wrk:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "${DAST_TARGET_URL}" \
              -J zap_alerts.json \
              -r zap_report.html || true

          test -f "${REPORT_DIR}/zap/zap_alerts.json" || echo '{"site": []}' > "${REPORT_DIR}/zap/zap_alerts.json"

      - name: Upload DAST artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.REPORT_DIR }}/zap
          retention-days: 14

      # ------------------------------
      # DEFECTDOJO IMPORT (Trivy + ZAP + Checkov)
      # ------------------------------
      - name: Import scans to DefectDojo
        shell: bash
        run: |
          set -euo pipefail

          import_scan () {
            local scan_type="$1"
            local file_path="$2"
            if [ ! -f "$file_path" ]; then
              echo "[SKIP] Missing file: $file_path"
              return 0
            fi

            curl -sS -X POST "${DEFECTDOJO_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
              -F "scan_type=${scan_type}" \
              -F "file=@${file_path}" \
              -F "product=${DEFECTDOJO_PRODUCT_ID}" \
              -F "engagement=${DEFECTDOJO_ENGAGEMENT_ID}" \
              -F "active=true" \
              -F "verified=true" >/dev/null
          }

          import_scan "Trivy Scan" "${REPORT_DIR}/trivy-sca.json"
          import_scan "Checkov Scan" "${REPORT_DIR}/checkov.json"
          import_scan "ZAP Scan" "${REPORT_DIR}/zap/zap_alerts.json"

      # ------------------------------
      # SLACK DEPLOY NOTIFICATION (fixed heredoc)
      # ------------------------------
            - name: Slack notify (deploy)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, urllib.request

          webhook = os.environ["SLACK_WEBHOOK_URL"]
          image_ref = os.environ.get("IMAGE_REF", "")
          dast = os.environ.get("DAST_TARGET_URL", "")
          repo = os.environ.get("GITHUB_REPOSITORY", "")
          run_id = os.environ.get("GITHUB_RUN_ID", "")
          run_url = f"https://github.com/{repo}/actions/runs/{run_id}"

          text = (
            "*Vuln Bank* deployment completed on *main*.\n"
            f"• Image: {image_ref}\n"
            f"• DAST target: {dast}\n"
            f"• Run: {run_url}"
          )

          payload = json.dumps({"text": text}).encode("utf-8")
          req = urllib.request.Request(webhook, data=payload, headers={"Content-Type": "application/json"})
          urllib.request.urlopen(req, timeout=15).read()
          print("Slack notification sent.")
          PY
        env:
          IMAGE_REF: ${{ needs.build_and_push.outputs.image_ref }}

