name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # 01:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  PYTHON_BIN: python3.11
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: "1"

# ======================================================
# 0) PREP – SCAN MODE (LIGHT vs FULL)
# ======================================================
jobs:
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - id: mode
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            echo "mode=light" >> "$GITHUB_OUTPUT"
          fi

# ======================================================
# 1) SECURITY SCANS (SAST / SCA / SECRETS / MISCONFIG)
# ======================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}

    outputs:
      critical_found: ${{ steps.result.outputs.critical }}
      scan_mode: ${{ needs.prep.outputs.scan_mode }}

    steps:
      - uses: actions/checkout@v4

      - name: Export scan mode
        run: echo "SCAN_MODE=${{ needs.prep.outputs.scan_mode }}" >> "$GITHUB_ENV"

      # ---------- Python env ----------
      - name: Python environment
        run: |
          set -e
          $PYTHON_BIN -m venv .venv
          .venv/bin/pip install --upgrade pip pip-audit

      # ---------- Tool bootstrap ----------
      - name: Install security tools
        run: |
          set -euo pipefail
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          # jq
          if ! command -v jq >/dev/null; then
            curl -sSL https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \
              -o "$BIN/jq"
            chmod +x "$BIN/jq"
          fi

          # Trivy
          if ! command -v trivy >/dev/null; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
              | sh -s -- -b "$BIN"
          fi

          # Syft
          if ! command -v syft >/dev/null; then
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
              | sh -s -- -b "$BIN"
          fi

          # Gitleaks (robust, tar.gz only)
          if ! command -v gitleaks >/dev/null; then
            OS="linux"
            ARCH_RAW="$(uname -m)"
            case "$ARCH_RAW" in
              x86_64) ARCH="x64" ;;
              aarch64|arm64) ARCH="arm64" ;;
              *)
                echo "❌ Unsupported arch for gitleaks: $ARCH_RAW"
                exit 1
                ;;
            esac

            API_JSON="$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest)"

            ASSET_URL="$(echo "$API_JSON" | jq -r --arg arch "$ARCH" '
              .assets[]
              | select(
                  (.name | contains("linux_" + $arch))
                  and (.name | endswith(".tar.gz"))
                )
              | .browser_download_url
            ' | head -n1)"

            if [ -z "$ASSET_URL" ]; then
              echo "❌ Gitleaks asset not found for ${OS}_${ARCH}"
              echo "Available assets:"
              echo "$API_JSON" | jq -r '.assets[].name'
              exit 1
            fi

            echo "Downloading gitleaks from $ASSET_URL"
            curl -sSL "$ASSET_URL" -o gitleaks.tar.gz
            tar -xzf gitleaks.tar.gz -C "$BIN"
            chmod +x "$BIN/gitleaks"
          fi

          # Snyk
          if ! command -v snyk >/dev/null; then
            curl -sSL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
              -o "$BIN/snyk"
            chmod +x "$BIN/snyk"
          fi

      - name: Verify tools
        run: |
          jq --version
          trivy --version
          syft --version
          gitleaks version
          snyk --version

      # ---------- Reports ----------
      - name: Prepare report dirs
        run: |
          mkdir -p "$REPORT_DIR"/{secrets,sast,sca,misconfig,sbom}
          echo "false" > critical.flag

      # ---------- Secrets ----------
      - name: Gitleaks
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path "$REPORT_DIR/secrets/gitleaks.json" || true
          jq 'length>0' "$REPORT_DIR/secrets/gitleaks.json" \
            && echo true > critical.flag || true

      # ---------- SAST ----------
      - name: Semgrep
        run: |
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep ci --config p/ci --json \
            > "$REPORT_DIR/sast/semgrep.json" || true
          jq '[.results[]|select(.extra.severity=="ERROR")] | length' \
            "$REPORT_DIR/sast/semgrep.json" | grep -qv 0 \
            && echo true > critical.flag || true

      # ---------- SCA ----------
      - name: pip-audit (FULL)
        if: env.SCAN_MODE == 'full'
        run: |
          .venv/bin/pip-audit -r requirements.txt -f json \
            -o "$REPORT_DIR/sca/pip-audit.json" || true

      - name: Trivy FS
        run: |
          trivy fs --severity HIGH,CRITICAL --format json \
            -o "$REPORT_DIR/sca/trivy.json" .
          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="CRITICAL")] | length' \
            "$REPORT_DIR/sca/trivy.json" | grep -qv 0 \
            && echo true > critical.flag || true

      - name: Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > "$REPORT_DIR/sca/snyk.json" || true
          grep -qi '"critical"' "$REPORT_DIR/sca/snyk.json" \
            && echo true > critical.flag || true

      # ---------- EPSS ----------
      - name: EPSS Gate
        run: |
          jq -r '..|.VulnerabilityID?//empty' \
            "$REPORT_DIR/sca/trivy.json" | sort -u > cves.txt || true
          while read -r cve; do
            [ -z "$cve" ] && continue
            epss=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
              | jq -r '.data[0].epss // 0')
            awk "BEGIN {exit !($epss > ${EPSS_THRESHOLD})}" \
              && echo true > critical.flag
          done < cves.txt || true

      # ---------- Misconfig ----------
      - name: Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL --format json \
            -o "$REPORT_DIR/misconfig/config.json" .
          jq '[.Results[].Misconfigurations[]?|select(.Severity=="CRITICAL")] | length' \
            "$REPORT_DIR/misconfig/config.json" | grep -qv 0 \
            && echo true > critical.flag || true

      # ---------- SBOM ----------
      - name: Generate SBOM
        run: syft . -o json > "$REPORT_DIR/sbom/sbom.json"

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: result
        run: echo "critical=$(cat critical.flag)" >> "$GITHUB_OUTPUT"

# ======================================================
# 2) SECURITY GATE (MAIN ONLY)
# ======================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "❌ SECURITY GATE FAILED"
            exit 1
          fi
          echo "✅ SECURITY GATE PASSED"

# ======================================================
# 3) BUILD, SIGN, PUSH
# ======================================================
  build:
    runs-on: self-hosted
    needs: security_gate
    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
          -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build & push image
        run: |
          docker build -t "$IMAGE_REPO:$IMAGE_TAG" .
          docker push "$IMAGE_REPO:$IMAGE_TAG"

      - uses: sigstore/cosign-installer@v3

      - name: Cosign Sign
        run: cosign sign --yes "$IMAGE_REPO:$IMAGE_TAG"
        env:
          COSIGN_EXPERIMENTAL: "true"

# ======================================================
# 4) DEPLOY
# ======================================================
  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Deploy to hosting VM
        run: |
          ssh hosting@192.168.107.135 <<EOF
          set -e
          docker pull "$IMAGE_REPO:$IMAGE_TAG"
          cd /opt/vuln-bank-app/containers/app
          IMAGE_WITH_TAG="$IMAGE_REPO:$IMAGE_TAG" docker compose up -d
          EOF

# ======================================================
# 5) SLACK (FINAL STATUS)
# ======================================================
  slack_notify:
    runs-on: self-hosted
    needs: [prep, security_scans, security_gate]
    if: always()
    steps:
      - name: Send Slack notification
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          MODE="${{ needs.prep.outputs.scan_mode }}"
          CRIT="${{ needs.security_scans.outputs.critical_found }}"
          GATE="${{ needs.security_gate.result }}"

          if [[ "$GATE" == "failure" ]]; then
            STATUS="❌ BLOCKED (Security Gate)"
            COLOR="#E01E5A"
          elif [[ "$CRIT" == "true" && "$MODE" == "full" ]]; then
            STATUS="⚠️ CRITICAL FOUND"
            COLOR="#ECB22E"
          else
            STATUS="✅ PASSED"
            COLOR="#2EB886"
          fi

          payload=$(cat <<EOF
          {
            "attachments":[{
              "color":"$COLOR",
              "title":"Vuln Bank DevSecOps Pipeline",
              "fields":[
                {"title":"Mode","value":"$MODE","short":true},
                {"title":"Critical Found","value":"$CRIT","short":true},
                {"title":"Result","value":"$STATUS","short":false}
              ]
            }]
          }
          EOF
          )

          curl -X POST -H "Content-type: application/json" \
            --data "$payload" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
