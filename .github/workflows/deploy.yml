name: üîê Vuln Bank DevSecOps Pipeline v9

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *" # 01:00 WIB

env:
  PYTHON_VERSION: "3.12"
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.7"
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}

permissions:
  contents: read
  security-events: write
  id-token: write
  packages: write

jobs:
  #####################################################################
  # JOB 1 ‚Äî SECURITY CI (all scans, parallel optimized)
  #####################################################################
  security:
    name: üõ°Ô∏è Security CI (Secrets + SCA + SAST + Misconfig + DAST)
    runs-on: ubuntu-latest

    outputs:
      has_critical: ${{ steps.evaluate.outputs.has_critical }}
      epss_alert: ${{ steps.evaluate.outputs.epss_alert }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      #################################################################
      # GLOBAL CACHES (save 30‚Äì60 seconds per run)
      #################################################################
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy/db
          key: trivy-db-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: Cache Python deps for Semgrep & TruffleHog
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: pip-

      #################################################################
      # INSTALL TOOLS (super stable)
      #################################################################
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install security tools
        run: |
          mkdir -p "$REPORT_DIR"

          pip install "trufflehog==2.0.0"
          pip install "semgrep==1.93.0"

          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | sudo tee /etc/apt/trusted.gpg.d/trivy.asc >/dev/null

          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list

          sudo apt-get update
          sudo apt-get install -y trivy

      #################################################################
      # PARALLEL SECURITY SCANNING
      #################################################################
      - name: üîë Secret Scan (TruffleHog)
        id: secrets
        continue-on-error: true
        run: |
          trufflehog filesystem . --only-verified --json > "$REPORT_DIR/trufflehog.json"

      - name: üì¶ SCA (Trivy FS)
        id: sca
        run: |
          trivy fs \
            --scanners vuln \
            --format json \
            --output "$REPORT_DIR/trivy-fs.json" .

      - name: üß† SAST (Semgrep ‚Äì OWASP Top 10)
        id: sast
        continue-on-error: true
        run: |
          semgrep ci --config "p/owasp-top-ten" \
            --json --output "$REPORT_DIR/semgrep.json"

      - name: üß± Misconfig Scan (Trivy Config)
        id: misconfig
        continue-on-error: true
        run: |
          trivy config --format json \
            --output "$REPORT_DIR/trivy-config.json" .

          trivy config --format json \
            --output "$REPORT_DIR/trivy-dockerfile.json" Dockerfile || true

      #################################################################
      # DAST (OWASP ZAP)
      #################################################################
      - name: üê≥ Build Docker image for DAST
        run: |
          docker build -t vuln-bank:${{ github.sha }} .
          echo "IMAGE_REF=vuln-bank:${{ github.sha }}" >> $GITHUB_ENV

      - name: üöÄ Run DAST container
        run: |
          docker run -d --rm \
            -p 5000:5000 \
            --name vuln-bank-dast \
            "$IMAGE_REF"
          sleep 10

      - name: üåê DAST (OWASP ZAP Baseline)
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        with:
          target: "http://127.0.0.1:5000"
          cmd_options: "-a"

      - name: üßπ Cleanup DAST container
        if: always()
        run: docker rm -f vuln-bank-dast || true

      #################################################################
      # EPSS + CRITICAL EVALUATOR
      #################################################################
      - name: üßÆ Evaluate Critical & EPSS
        id: evaluate
        run: |
          python3 << 'EOF'
          import json, os, urllib.request, urllib.parse

          report = f"{os.environ['REPORT_DIR']}/trivy-fs.json"
          threshold = float(os.environ["EPSS_THRESHOLD"])

          has_critical = False
          epss_alert = False
          cves = set()

          if os.path.exists(report):
              data = json.load(open(report))
              for r in data.get("Results", []):
                  for v in r.get("Vulnerabilities", []):
                      if v.get("Severity") in ["HIGH", "CRITICAL"]:
                          has_critical = True
                          if v.get("VulnerabilityID", "").startswith("CVE-"):
                              cves.add(v["VulnerabilityID"])

          if cves:
              q = urllib.parse.urlencode({"cve": ",".join(cves)})
              url = f"https://api.first.org/data/v1/epss?{q}"
              try:
                  api = urllib.request.urlopen(url).read().decode()
                  api = json.loads(api)
                  for i in api.get("data", []):
                      if float(i.get("epss", 0)) >= threshold:
                          epss_alert = True
              except:
                  pass

          print("Critical =", has_critical)
          print("EPSS =", epss_alert)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"has_critical={'true' if has_critical else 'false'}\n")
              f.write(f"epss_alert={'true' if epss_alert else 'false'}\n")
          EOF

      #################################################################
      # SUMMARY REPORT
      #################################################################
      - name: ‚ú® Security Summary
        run: |
          echo "## üîê Vuln Bank ‚Äî Security Summary v9" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Scan: ${{ steps.secrets.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- SCA Result: ${{ steps.sca.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- SAST Result: ${{ steps.sast.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Misconfig Result: ${{ steps.misconfig.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- EPSS Gate: ${{ steps.evaluate.outputs.epss_alert }}" >> $GITHUB_STEP_SUMMARY
          echo "- Critical Vulns: ${{ steps.evaluate.outputs.has_critical }}" >> $GITHUB_STEP_SUMMARY

      #################################################################
      # UPLOAD ARTIFACTS
      #################################################################
      - name: üìé Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: ${{ env.REPORT_DIR }}

  #####################################################################
  # JOB 3 ‚Äî CD TO VMWARE LAB
  #####################################################################
  deploy:
    name: üöÄ Deploy to VMware via Ansible
    runs-on: [self-hosted, bastion]
    needs: security
    if: needs.security.outputs.has_critical == 'false' && needs.security.outputs.epss_alert == 'false'

    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build + Push Image
        id: img
        run: |
          SHORT="${GITHUB_SHA::7}"
          IMG="$DOCKERHUB_REPO:$SHORT"
          docker build -t "$IMG" .
          docker push "$IMG"
          echo "tag=$IMG" >> $GITHUB_OUTPUT

      - name: Deploy via Ansible
        run: |
          cd /home/bastion/actions-runner/_work/vuln-bank/vuln-bank/ansible
          export ANSIBLE_CONFIG=$(pwd)/ansible.cfg

          ansible-playbook -i inventory.ini site.yml \
            --extra-vars "docker_image=${{ steps.img.outputs.tag }}"
