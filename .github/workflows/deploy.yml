name: üîê Vuln Bank DevSecOps Pipeline (Enterprise v3 FINAL)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

env:
  REPORT_DIR: security-reports
  REGISTRY: docker.io
  IMAGE_NAME: vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  FULL_IMAGE: docker.io/xbash/vuln-bank:${{ github.sha }}
  EPSS_THRESHOLD: "0.7"

jobs:
  #################################################################
  # JOB 1 ‚Äî SECURITY CI
  #################################################################
  security-ci:
    name: üõ°Ô∏è Security CI (Secrets / SAST / SCA / DAST / SBOM / EPSS / Cosign)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      id-token: write
      packages: write
      issues: write

    outputs:
      image_digest: ${{ steps.image_meta.outputs.digest }}

    steps:
      #################################################################
      # 0. CHECKOUT + PYTHON
      #################################################################
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare directories
        run: mkdir -p "$REPORT_DIR"

      #################################################################
      # 1. INSTALL SECURITY TOOLS
      #################################################################
      - name: Install CLI security tools
        run: |
          set -e

          pip install --upgrade pip
          pip install bandit==1.* semgrep==1.*

          # TruffleHog ‚Äî FIXED installer
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh \
            | sh -s -- -b /usr/local/bin

          # Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

          # Syft
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin

          # Cosign
          curl -sSLo /usr/local/bin/cosign \
            https://github.com/sigstore/cosign/releases/download/v2.4.1/cosign-linux-amd64
          chmod +x /usr/local/bin/cosign

          # ZAP
          curl -L https://github.com/zaproxy/zaproxy/releases/latest/download/zap-baseline.py \
            -o /usr/local/bin/zap-baseline.py
          chmod +x /usr/local/bin/zap-baseline.py

      - name: Verify tools
        run: |
          trufflehog --version
          bandit --version
          semgrep --version
          trivy --version
          syft version
          cosign version

      #################################################################
      # TESTS
      #################################################################
      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests
        run: |
          if ls tests 2>/dev/null; then pytest -q || true; fi

      #################################################################
      # SECRET SCAN
      #################################################################
      - name: üîë Secret Scan (TruffleHog)
        run: |
          trufflehog filesystem --no-update --json . > "$REPORT_DIR/trufflehog.json" || true

      #################################################################
      # SAST (SARIF + fallback)
      #################################################################
      - name: üß± Bandit ‚Üí SARIF
        run: |
          bandit -r . --exit-zero -f sarif -o "$REPORT_DIR/bandit.sarif"

      - name: Ensure Bandit SARIF exists
        if: always()
        run: |
          if [ ! -f "$REPORT_DIR/bandit.sarif" ]; then
            echo '{"version":"2.1.0","runs":[]}' > "$REPORT_DIR/bandit.sarif"
          fi

      - name: üß± Semgrep ‚Üí SARIF
        run: |
          semgrep ci --config auto \
            --sarif --output "$REPORT_DIR/semgrep.sarif" || echo '{"runs":[]}' > "$REPORT_DIR/semgrep.sarif"

      #################################################################
      # Upload SARIF (guaranteed)
      #################################################################
      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.REPORT_DIR }}/semgrep.sarif

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.REPORT_DIR }}/bandit.sarif

      #################################################################
      # BUILD CONTAINER
      #################################################################
      - name: üê≥ Build container
        run: docker build -t "$FULL_IMAGE" .

      #################################################################
      # SCA / VULN SCAN
      #################################################################
      - name: üì¶ Trivy image scan
        run: |
          trivy image \
            --scanners vuln,secret \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-image.json" \
            --exit-code 0 \
            "$FULL_IMAGE"

      #################################################################
      # MISCONFIG SCAN
      #################################################################
      - name: ‚öôÔ∏è Trivy config scan
        run: |
          trivy config \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-config.json" \
            --exit-code 0 \
            .

      #################################################################
      # DAST
      #################################################################
      - name: üöÄ Start app for DAST
        run: |
          docker run -d --rm -p 5000:5000 --name vuln-bank "$FULL_IMAGE"

      - name: üåê ZAP Baseline
        env:
          TARGET_URL: http://localhost:5000
        run: |
          python3 /usr/local/bin/zap-baseline.py \
            -t "$TARGET_URL" \
            -x "$REPORT_DIR/zap-report.xml" || true

      - name: Stop DAST container
        if: always()
        run: docker stop vuln-bank || true

      #################################################################
      # EPSS + SEVERITY GATE
      #################################################################
      - name: üìä Evaluate EPSS + Severity
        env:
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}
        run: |
          python3 << 'PY'
          import json, os, sys, ssl, urllib.request, urllib.parse

          report = f"{os.environ['REPORT_DIR']}/trivy-image.json"
          epss_threshold = float(os.environ["EPSS_THRESHOLD"])

          if not os.path.exists(report):
              sys.exit(0)

          with open(report) as f:
              data = json.load(f)

          vulns = []
          for r in data.get("Results", []):
              for v in r.get("Vulnerabilities", []):
                  vulns.append(v)

          highcrit = [v for v in vulns if v["Severity"] in ("HIGH","CRITICAL")]

          def get_epss(cve):
              try:
                  url = f"https://api.first.org/data/v1/epss?cve={urllib.parse.quote(cve)}"
                  with urllib.request.urlopen(url, timeout=5) as resp:
                      obj = json.loads(resp.read().decode())
                  d = obj.get("data", [])
                  return float(d[0]["epss"]) if d else 0.0
              except:
                  return 0.0

          risky = []
          for v in highcrit:
              cve = v.get("VulnerabilityID","")
              if cve.startswith("CVE-"):
                  score = get_epss(cve)
                  if score >= epss_threshold:
                      v["EPSS"] = score
                      risky.append(v)

          if highcrit or risky:
              sys.exit(1)
          sys.exit(0)
          PY

      #################################################################
      # EPSS SUMMARY FILE (for Job 2)
      #################################################################
      - name: üìù Generate EPSS summary
        if: always()
        run: |
          FILE="${REPORT_DIR}/epss-summary.txt"
          echo "# EPSS Summary" > "$FILE"
          echo "- Commit: $GITHUB_SHA" >> "$FILE"
          echo "- Branch: $GITHUB_REF" >> "$FILE"
          echo "" >> "$FILE"
          echo "Jika pipeline gagal, berarti ada HIGH/CRITICAL atau EPSS >= threshold." >> "$FILE"

      #################################################################
      # SBOM
      #################################################################
      - name: üì¶ Generate SBOM
        run: |
          syft "$FULL_IMAGE" -o json > "$REPORT_DIR/sbom.json"
          syft "$FULL_IMAGE" -o spdx-json > "$REPORT_DIR/sbom-spdx.json"
          syft "$FULL_IMAGE" -o cyclonedx-json > "$REPORT_DIR/sbom-cyclonedx.json"

      #################################################################
      # PUSH + COSIGN
      #################################################################
      - name: üîê Login DockerHub
        run: |
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üì§ Push image
        run: docker push "$FULL_IMAGE"

      - name: üìå Export digest
        id: image_meta
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$FULL_IMAGE")
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: üîè Cosign sign digest
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign "${{ steps.image_meta.outputs.digest }}" --yes

      #################################################################
      # UPLOAD REPORTS
      #################################################################
      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

  #################################################################
  # JOB 2 ‚Äî NOTIFY + ISSUE
  #################################################################
  notify-and-issues:
    name: üö® Notify + Issue
    needs: security-ci
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: üîî Discord (auto-skip)
        env:
          HOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$HOOK" ]; then exit 0; fi
          MSG="üö® Vuln Bank ‚Äî Security pipeline FAILED for $GITHUB_SHA"
          JSON=$(printf '{"content":"%s"}' "$MSG")
          curl -X POST -H "Content-Type: application/json" -d "$JSON" "$HOOK"

      - uses: peter-evans/create-issue-from-file@v5
        with:
          title: "üî¥ High/CRITICAL or EPSS detected in ${{ github.sha }}"
          content-filepath: security-reports/epss-summary.txt

  #################################################################
  # JOB 3 ‚Äî DEPLOY via ANSIBLE
  #################################################################
  deploy:
    name: üöÄ Deploy to Lab
    needs: security-ci
    if: success()
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Ensure Ansible installed
        run: |
          if ! command -v ansible-playbook >/dev/null; then
            sudo dnf install -y ansible-core;
          fi

      - name: Run Ansible deploy
        env:
          IMAGE_DIGEST: ${{ needs.security-ci.outputs.image_digest }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          VULN_ENV_FILE: ${{ secrets.VULN_ENV_FILE }}
        run: |
          IMAGE="${IMAGE_DIGEST:-$FULL_IMAGE}"

          ansible-playbook -i inventory.ini site.yml \
            --tags deploy_vuln_bank \
            -e "FULL_IMAGE=$IMAGE" \
            -e "db_user=$DB_USER" \
            -e "db_password=$DB_PASSWORD" \
            -e "flask_secret_key=$FLASK_SECRET_KEY" \
            -e "vuln_env_file=$VULN_ENV_FILE"
