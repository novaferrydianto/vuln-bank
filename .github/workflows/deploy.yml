name: DevSecOps Vuln Bank

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write # Diperlukan untuk Job 1.6 (EPSS & GitHub Issues)

env:
  IMAGE_NAME: vulnbank-app
  IMAGE_TAG: ${{ github.sha }}
  FULL_IMAGE: vulnbank-app:${{ github.sha }}
  REPORT_DIR: security-reports
  
jobs:
  # =========================================================
  # JOB 1: SECURITY (CI)
  # =========================================================
  security:
    runs-on: ubuntu-latest
    name: DevSecOps Security Pipeline
    continue-on-error: false 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Diperlukan untuk TruffleHog agar memindai riwayat lengkap

      - name: Create reports directory
        run: mkdir -p "$REPORT_DIR"

      # -------------------------------------------------------------
      # 1. Secret Scanning (TruffleHog) - FAIL-FAST ENFORCEMENT
      # -------------------------------------------------------------
      - name: Install TruffleHog
        run: pip install trufflehog

      - name: TruffleHog Scan (Wajib Lulus)
        # Akan GAGAL jika secrets ditemukan.
        run: |
          trufflehog filesystem . \
            --no-update \
            --only-verified \
            --json > "$REPORT_DIR/trufflehog.json"

      # -------------------------------------------------------------
      # 2. Trivy SCA / Config Scan - FAIL-FAST ENFORCEMENT
      # -------------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Trivy FS Scan (SCA & Misconfig - Wajib Lulus)
        run: |
          trivy fs . \
            --security-checks vuln,config \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-fs.json"

      - name: Build image for Image Scan
        run: docker build -t "$FULL_IMAGE" .

      - name: Trivy Image Scan (Wajib Lulus)
        run: |
          trivy image "$FULL_IMAGE" \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-image.json"

      # -------------------------------------------------------------
      # 3. SAST (Semgrep) - FAIL-FAST ENFORCEMENT
      # -------------------------------------------------------------
      - name: Install Semgrep
        run: pip install semgrep

      - name: Semgrep Scan (Wajib Lulus)
        # --error flag memastikan kegagalan pada temuan High/Critical.
        run: |
          semgrep ci --config auto \
            --error \
            --json > "$REPORT_DIR/semgrep.json"

      # -------------------------------------------------------------
      # 4. DAST (OWASP ZAP) - Inject Secrets for Docker Compose
      # -------------------------------------------------------------
      - name: Start app with Docker Compose (Injecting Secrets)
        # Injeksi secrets DB dan Flask ke lingkungan runtime Docker Compose.
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          # DEEPSEEK_API_KEY tidak diinjeksikan karena tidak digunakan oleh aplikasi
        run: |
          docker compose down || true
          # Docker Compose akan mengambil secrets dari env yang disuntikkan di atas
          docker compose up -d
          sleep 15

      - name: Detect network dynamically
        id: net
        run: echo "network=$(docker network ls --format '{{.Name}}' | grep vuln | head -n 1)" >> $GITHUB_OUTPUT

      - name: ZAP Baseline Scan
        # DAST tidak membatalkan CI
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: http://app:5000
          docker_image: ghcr.io/zaproxy/zaproxy:stable
          cmd_options: '-t http://app:5000 -J zap-report.json -r zap-report.html'
          network: ${{ steps.net.outputs.network }}
          issue_title: 'DAST Findings for Vuln Bank'
          fail_action: false 

      - name: Move ZAP Reports
        if: always()
        run: |
          mv zap/zap-report.json "$REPORT_DIR/zap-report.json" || true
          mv zap/zap-report.html "$REPORT_DIR/zap-report.html" || true

      - name: Stop app
        if: always()
        run: docker compose down || true

      # -------------------------------------------------------------
      # 5. Upload reports
      # -------------------------------------------------------------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: vuln-bank-security-reports
          path: ${{ env.REPORT_DIR }}

      # -------------------------------------------------------------
      # 6. EPSS + Auto GitHub Issues (Improvement)
      # -------------------------------------------------------------
      - name: EPSS Scoring + Auto GitHub Issues
        id: epss # Tambahkan ID untuk referensi output
        # Step ini berjalan jika semua scan statis/secret LULUS.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          REPORT_DIR: ${{ env.REPORT_DIR }}
        run: |
          pip install requests

          python << 'PY'
          import json
          import os
          import requests
          import re
          
          REPO = os.getenv("GITHUB_REPOSITORY")
          TOKEN = os.getenv("GITHUB_TOKEN")
          REPORT_DIR = os.getenv("REPORT_DIR")
          HEADERS = {"Authorization": f"token {TOKEN}"}
          CRITICAL_FOUND = False

          def create_issue(title, body):
              url = f"https://api.github.com/repos/{REPO}/issues"
              resp = requests.post(url, json={"title": title, "body": body}, headers=HEADERS)
              if resp.status_code >= 300:
                  print(f"[ERROR] Issue creation failed: {resp.text}")
              else:
                  print(f"[ISSUE CREATED] {title}")

          def fetch_epss(cve_id):
              try:
                  url = f"https://api.first.org/data/v1/epss?cve={cve_id}"
                  res = requests.get(url, timeout=10).json()
                  if res.get("data"):
                      return res["data"][0].get("epss")
              except Exception as e:
                  print(f"[ERROR] EPSS fetch failed for {cve_id}: {e}")
              return None

          def load_trivy(path):
              global CRITICAL_FOUND
              if not os.path.isfile(path): return []
              with open(path) as f:
                  try:
                      data = json.load(f)
                  except:
                      print(f"[ERROR] JSON decode failed: {path}"); return []
              vulns = []
              for result in data.get("Results", []):
                  for v in result.get("Vulnerabilities", []):
                      if v.get("Severity") in ("CRITICAL", "HIGH"):
                          CRITICAL_FOUND = True 
                          vulns.append(v)
              return vulns

          def process_vulns(vulns):
              for v in vulns:
                  cve = v.get("VulnerabilityID")
                  epss_score = fetch_epss(cve)
                  epss_text = f"**{epss_score}**" if epss_score and float(epss_score) > 0.5 else epss_score or "N/A"

                  title = f"[EPSS] {cve} â€” {v.get('Severity')}"
                  body = f"""
          ### ðŸ“Œ Vulnerability Identified
          - **CVE:** `{cve}`
          - **Package:** `{v.get('PkgName')}`
          - **Installed:** `{v.get('InstalledVersion')}`
          - **Fixed:** `{v.get('FixedVersion')}`
          - **Severity:** `{v.get('Severity')}`
          - **EPSS Score:** {epss_text}
          - **URL:** {v.get('PrimaryURL')}
          - **Target:** {v.get('Target')}

          ### ðŸ§  EPSS Meaning
          EPSS > **0.50** â†’ High probability of exploit within 30 days.

          ### ðŸ›  Recommendation
          - Update to fixed version ASAP.
          - Add compensating controls (WAF/OPA/Kyverno).
          - Audit container layers related to this package.
          """
                  create_issue(title, body)

          paths = [
              f"{REPORT_DIR}/trivy-fs.json",
              f"{REPORT_DIR}/trivy-image.json",
          ]

          vulns = []
          for p in paths:
              vulns.extend(load_trivy(p))
              
          try:
              with open(f"{REPORT_DIR}/zap-report.html", 'r') as f:
                  zap_content = f.read()
                  if re.search(r'High (\d+)', zap_content) or re.search(r'Critical (\d+)', zap_content):
                       CRITICAL_FOUND = True
                       print("[ALERT] DAST ZAP menemukan temuan High/Critical.")
          except FileNotFoundError:
              print("[INFO] ZAP report not found, skipping DAST check.")
          
          print(f"[INFO] {len(vulns)} high/critical vulns from Trivy detected.")
          process_vulns(vulns)
          print("[DONE] EPSS enrichment and issue creation complete.")
          
          if CRITICAL_FOUND:
              print("::set-output name=critical_found::true")
          else:
              print("::set-output name=critical_found::false")
          PY

      # -------------------------------------------------------------
      # 7. Kirim Notifikasi Slack (Jika Ada Temuan Critical/High - Core Requirement)
      # -------------------------------------------------------------
      #- name: Kirim Notifikasi Slack (Critical Alert)
      #  if: ${{ steps.epss.outputs.critical_found == 'true' }} # Hanya jika ditemukan critical/high di langkah sebelumnya
      #  uses: rtCamp/action-slack-notify@v2
      #  env:
      #    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # Harus disetel di repo secrets
      #    SLACK_COLOR: '#FF0000' # Merah
      #    SLACK_TITLE: 'ðŸš¨ URGENT: CRITICAL VULNERABILITY ALERT! ðŸš¨'
      #    SLACK_MESSAGE: 'Vuln Bank Security Pipeline mendeteksi temuan **CRITICAL** (SCA/DAST/Misconfig) di commit ${{ github.sha }}. Laporan lengkap tersedia di Artifacts. Segera cek GitHub Issues yang telah dibuat.'
      #    SLACK_USERNAME: 'DevSecOps Bot'
      #    SLACK_ICON_EMOJI: ':warning:'
      #    SLACK_FOOTER: 'Pipeline Run ID: ${{ github.run_id }}'
      #    SLACK_CHANNEL: '#security-alert' # Ganti dengan channel Anda
      #    SLACK_LINK_NAMES: true

  # =========================================================
  # JOB 2: DEPLOY (SELF-HOSTED) - Hanya berjalan jika SECURITY PASS
  # =========================================================
  deploy:
    name: Deploy via Ansible (3 VM)
    needs: security # Memastikan hanya jalan jika security LULUS
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo dnf install -y epel-release || true
          sudo dnf install -y ansible python3-pip || true

      - name: Run site.yml
        working-directory: ansible
        env:
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible/ansible.cfg
        run: ansible-playbook site.yml