# .github/workflows/devsecops-vulnbank.yml
name: DevSecOps Vuln Bank

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  IMAGE_NAME: vulnbank-app
  IMAGE_TAG: ${{ github.sha }}
  FULL_IMAGE: vulnbank-app:${{ github.sha }}
  REPORT_DIR: security-reports

# =========================================================
# JOB 1: SECURITY (CI) - jalan di ubuntu-latest (GitHub runner)
# =========================================================
jobs:
  security:
    name: DevSecOps Security Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p "$REPORT_DIR"

      # ----------------------------------------
      # 1. SECRET SCANNING (TruffleHog)
      # ----------------------------------------
      - name: Install TruffleHog
        run: pip install trufflehog

      - name: Secret Scanning - TruffleHog
        run: |
          trufflehog filesystem . \
            --no-update \
            --only-verified \
            --json > "$REPORT_DIR/trufflehog.json" || true

      # ----------------------------------------
      # 2. SCA + CONFIG + IMAGE SCAN (Trivy)
      # ----------------------------------------
      - name: Install Trivy (Official Script)
        run: |
          sudo apt-get update -y
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Trivy FS (code + config)
        run: |
          trivy fs . \
            --security-checks vuln,config \
            --format json \
            --output "$REPORT_DIR/trivy-fs.json" || true

      - name: Build Docker Image
        run: |
          docker build -t "$FULL_IMAGE" .

      - name: Trivy Image Scan
        run: |
          trivy image "$FULL_IMAGE" \
            --format json \
            --output "$REPORT_DIR/trivy-image.json" || true

      # ----------------------------------------
      # 3. SAST (Semgrep)
      # ----------------------------------------
      - name: Install Semgrep
        run: pip install semgrep

      - name: SAST Scan (Semgrep)
        run: |
          semgrep ci \
            --config auto \
            --json > "$REPORT_DIR/semgrep.json" || true

      # ----------------------------------------
      # 4. DAST (OWASP ZAP) – pakai GitHub Action resmi
      # ----------------------------------------
      - name: Start app with Docker Compose (for DAST)
        run: |
          docker compose down || true
          docker compose up -d
          sleep 25

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: "http://host.docker.internal:5000"
          cmd_options: "-a"
          fail_action: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy ZAP reports
        run: |
          # action-baseline taruh report di ./zap.wrk/, kita pindah ke REPORT_DIR
          if [ -d "zap.wrk" ]; then
            mv zap.wrk/*.html "$REPORT_DIR/" 2>/dev/null || true
            mv zap.wrk/*.json "$REPORT_DIR/" 2>/dev/null || true
          fi

      - name: Stop app after DAST
        run: |
          docker compose down || true

      # ----------------------------------------
      # 5. Upload laporan sebagai artifact
      # ----------------------------------------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: vuln-bank-security-reports
          path: ${{ env.REPORT_DIR }}

      # ----------------------------------------
      # 6. Evaluate findings + Discord alert
      # ----------------------------------------
      - name: Evaluate findings & send alert
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          sudo apt-get install -y jq || true

          CRIT_COUNT=0
          HIGH_COUNT=0

          # Trivy FS
          if [ -f "$REPORT_DIR/trivy-fs.json" ]; then
            TF_CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$REPORT_DIR/trivy-fs.json" 2>/dev/null || echo 0)
            TF_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$REPORT_DIR/trivy-fs.json" 2>/dev/null || echo 0)
            CRIT_COUNT=$((CRIT_COUNT + TF_CRIT))
            HIGH_COUNT=$((HIGH_COUNT + TF_HIGH))
          fi

          # Trivy Image
          if [ -f "$REPORT_DIR/trivy-image.json" ]; then
            TI_CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$REPORT_DIR/trivy-image.json" 2>/dev/null || echo 0)
            TI_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$REPORT_DIR/trivy-image.json" 2>/dev/null || echo 0)
            CRIT_COUNT=$((CRIT_COUNT + TI_CRIT))
            HIGH_COUNT=$((HIGH_COUNT + TI_HIGH))
          fi

          # Simple Semgrep count
          if [ -f "$REPORT_DIR/semgrep.json" ]; then
            SG_FINDINGS=$(jq '.results | length' "$REPORT_DIR/semgrep.json" 2>/dev/null || echo 0)
          else
            SG_FINDINGS=0
          fi

          echo "Critical vulns: $CRIT_COUNT"
          echo "High vulns    : $HIGH_COUNT"
          echo "Semgrep issues: $SG_FINDINGS"

          if [ "$CRIT_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            STATUS="❌ HIGH/CRITICAL vulnerabilities detected"
          else
            STATUS="✅ No HIGH/CRITICAL vulnerabilities found"
          fi

          if [ -n "$DISCORD_WEBHOOK" ]; then
            CONTENT="Vuln Bank Security Scan → Critical: $CRIT_COUNT | High: $HIGH_COUNT | Semgrep: $SG_FINDINGS"

            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"${STATUS}\n${CONTENT}\"}" \
              "$DISCORD_WEBHOOK" || true
          fi

          echo "## DevSecOps Pipeline Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Critical: $CRIT_COUNT" >> "$GITHUB_STEP_SUMMARY"
          echo "- High: $HIGH_COUNT" >> "$GITHUB_STEP_SUMMARY"
          echo "- Semgrep Findings: $SG_FINDINGS" >> "$GITHUB_STEP_SUMMARY"

          # Fail build kalau ada HIGH / CRITICAL
          if [ "$CRIT_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "Breaking build due to HIGH/CRITICAL vulnerabilities"
            exit 1
          fi

  # =========================================================
  # JOB 2: DEPLOY – jalan di self-hosted runner (bastion-node)
  # =========================================================
  deploy:
    name: Deploy via Ansible (3-VM Lab)
    needs: security
    runs-on: self-hosted
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Ansible installed (Rocky / RHEL)
        run: |
          sudo dnf install -y epel-release || true
          sudo dnf install -y ansible python3-pip || true

      - name: Run Ansible site.yml
        working-directory: ansible
        env:
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible/ansible.cfg
        run: |
          ansible-playbook site.yml
