name: Vuln Bank DevSecOps Pipeline (v7.1 UltraStable Final)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # 01:00 WIB daily
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: write
  id-token: write

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  POLICY_DIR: policy
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  KYVERNO_ENABLED: "false"

jobs:
  # =====================================================================
  # 0) Determine Scan Mode (LIGHT vs FULL)
  # =====================================================================
  prep:
    runs-on: self-hosted
    outputs:
      scan_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - id: mode
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" || "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            echo "mode=full" >> "$GITHUB_OUTPUT"
          else
            echo "mode=light" >> "$GITHUB_OUTPUT"
          fi

  # =====================================================================
  # 1) SECURITY SCANS ‚Äî SAST, SCA, Secrets, Misconfig, Policy, SBOM
  # =====================================================================
  security_scans:
    runs-on: self-hosted
    needs: prep
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    outputs:
      critical_found: ${{ steps.flag.outputs.critical_found }}
      scan_mode: ${{ steps.scanmode.outputs.mode }}

    steps:
      - uses: actions/checkout@v4

      # --------------------------------------------
      # Set Scan Mode (env.SCAN_MODE)
      # --------------------------------------------
      - id: scanmode
        shell: bash
        run: |
          MODE="${{ needs.prep.outputs.scan_mode }}"
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "SCAN_MODE=$MODE" >> "$GITHUB_ENV"
          echo "Scan mode: $MODE"

      # --------------------------------------------
      # Cache Python + security tool caches
      # --------------------------------------------
      - uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pip
            ~/.cache/trivy
            ~/.cache/snyk
          key: ${{ runner.os }}-security-v7_1-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-security-v7_1-

      # --------------------------------------------
      # Setup Python, pip-audit, jq
      # --------------------------------------------
      - name: Setup Python + pip-audit + jq
        shell: bash
        run: |
          set -euo pipefail

          # venv
          if [ ! -d ".venv" ]; then
            $PYTHON_BIN -m venv .venv
          fi

          source .venv/bin/activate
          pip install --upgrade pip pip-audit==2.7.2

          # local bin
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          # jq
          if ! command -v jq >/dev/null 2>&1; then
            curl -L -o "$BIN/jq" \
              https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
            chmod +x "$BIN/jq"
          fi

      - name: Export venv to PATH
        shell: bash
        run: |
          echo "PATH=$(pwd)/.venv/bin:$PATH" >> "$GITHUB_ENV"

      # --------------------------------------------
      # Init flag + report directories
      # --------------------------------------------
      - name: Init flags & report dirs
        shell: bash
        run: |
          printf "false" > critical_flag.txt
          mkdir -p "${REPORT_DIR}"/{secrets,sca,sast,misconfig,dast,sbom}

      # --------------------------------------------
      # Install Security Tools (Trivy, Gitleaks, Snyk, Syft, Conftest)
      # --------------------------------------------
      - name: Install Trivy
        shell: bash
        run: |
          if ! command -v trivy >/dev/null 2>&1; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
              | sh -s -- -b "$RUNNER_TEMP/bin"
          else
            echo "Trivy already installed."
          fi

      - name: Install Gitleaks
        shell: bash
        run: |
          if ! command -v gitleaks >/dev/null 2>&1; then
            VER=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r .tag_name)
            curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VER}/gitleaks_${VER#v}_linux_x64.tar.gz" \
              | tar -xz -C "$RUNNER_TEMP/bin"
          else
            echo "Gitleaks already installed."
          fi

      - name: Install Snyk CLI
        shell: bash
        run: |
          if ! command -v snyk >/dev/null 2>&1; then
            curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
              -o "$RUNNER_TEMP/bin/snyk"
            chmod +x "$RUNNER_TEMP/bin/snyk"
          else
            echo "Snyk already installed."
          fi

      - name: Install Syft (SBOM)
        shell: bash
        run: |
          if ! command -v syft >/dev/null 2>&1; then
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
              | sh -s -- -b "$RUNNER_TEMP/bin"
          else
            echo "Syft already installed."
          fi

      - name: Install Conftest (UltraStable)
        shell: bash
        run: |
          if ! command -v conftest >/dev/null 2>&1; then
            VER=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest \
              | jq -r .tag_name)
            curl -sL \
              "https://github.com/open-policy-agent/conftest/releases/download/${VER}/conftest_${VER#v}_linux_amd64" \
              -o "$RUNNER_TEMP/bin/conftest"
            chmod +x "$RUNNER_TEMP/bin/conftest"
          else
            echo "Conftest already installed."
          fi

      # =====================================================================
      # SAST ‚Äî Semgrep JSON (UltraStable) + SARIF
      # =====================================================================
      - name: Semgrep JSON (UltraStable)
        shell: bash
        run: |
          set -euo pipefail
          TEMP=$(mktemp -d)

          docker run --rm \
            -v "$GITHUB_WORKSPACE":/src \
            -v "$TEMP":/out \
            returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --json \
              --output /out/semgrep.json \
              --no-error \
              || true

          # ULTRASTABLE: always ensure JSON exists
          if [[ ! -s "$TEMP/semgrep.json" ]]; then
            echo '{"results":[]}' > "$TEMP/semgrep.json"
          fi

          mkdir -p "${REPORT_DIR}/sast"
          cp "$TEMP/semgrep.json" "${REPORT_DIR}/sast/semgrep.json"

          jq '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' \
            "${REPORT_DIR}/sast/semgrep.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Semgrep SARIF
        shell: bash
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/src \
            -v "$GITHUB_WORKSPACE/${REPORT_DIR}/sast":/out \
            returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --sarif \
              --output /out/semgrep.sarif || true

      # =====================================================================
      # Secret Scanning ‚Äî Gitleaks
      # =====================================================================
      - name: Secret Scan (Gitleaks)
        shell: bash
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path "${REPORT_DIR}/secrets/gitleaks.json" || true

          jq -e 'length>0' "${REPORT_DIR}/secrets/gitleaks.json" \
            && printf "true" > critical_flag.txt || true

      # =====================================================================
      # SCA ‚Äî pip-audit (FULL only), Trivy FS, Snyk
      # =====================================================================
      - name: pip-audit (FULL only)
        if: env.SCAN_MODE == 'full'
        shell: bash
        run: |
          if [ -f requirements.txt ]; then
            .venv/bin/pip-audit -r requirements.txt \
              -f json \
              -o "${REPORT_DIR}/sca/pip-audit.json" || true
          else
            echo "requirements.txt not found, skipping pip-audit."
          fi

      - name: Trivy FS (SCA)
        shell: bash
        run: |
          trivy fs --scanners vuln \
            --severity HIGH,CRITICAL \
            --format json \
            --output "${REPORT_DIR}/sca/trivy-fs.json" .

          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            "${REPORT_DIR}/sca/trivy-fs.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Snyk SCA
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        shell: bash
        run: |
          if [ -z "${SNYK_TOKEN:-}" ]; then
            echo "No SNYK_TOKEN, skipping Snyk."
            exit 0
          fi

          snyk test --all-projects --json > "${REPORT_DIR}/sca/snyk.json" || true
          grep -qi '"severity":"high"\|"severity":"critical"' "${REPORT_DIR}/sca/snyk.json" \
            && printf "true" > critical_flag.txt || true

      # =====================================================================
      # EPSS Filtering ‚Äî Threat Prioritization
      # =====================================================================
      - name: EPSS Filtering
        shell: bash
        run: |
          # Kumpulkan CVE dari Trivy & Snyk (& pip-audit jika ada)
          jq -r '.. | .VulnerabilityID? // empty' "${REPORT_DIR}/sca/trivy-fs.json" > cves.txt || true
          jq -r '.. | .identifiers?.CVE[]? // empty' "${REPORT_DIR}/sca/snyk.json" >> cves.txt || true
          jq -r '.. | .id? // empty' "${REPORT_DIR}/sca/pip-audit.json" >> cves.txt 2>/dev/null || true

          sort -u cves.txt -o cves.txt || true

          if [ ! -s cves.txt ]; then
            echo "No CVEs found for EPSS evaluation."
            exit 0
          fi

          echo "EPSS threshold: ${EPSS_THRESHOLD}"
          while read -r CVE; do
            [ -z "$CVE" ] && continue
            EPS=$(curl -s "https://api.first.org/data/v1/epss?cve=${CVE}" \
              | jq -r '.data[0].epss // 0' 2>/dev/null || echo "0")
            echo "CVE: $CVE ‚Üí EPSS: $EPS"
            awk -v e="$EPS" -v t="$EPSS_THRESHOLD" 'BEGIN{exit !(e > t)}'
            if [ "$?" -eq 0 ]; then
              echo "EPSS > threshold detected ‚Üí marking critical."
              printf "true" > critical_flag.txt
              break
            fi
          done < cves.txt

      # =====================================================================
      # Misconfiguration ‚Äî Trivy Config (JSON + SARIF)
      # =====================================================================
      - name: Trivy Config JSON
        shell: bash
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json \
            --output "${REPORT_DIR}/misconfig/trivy-config.json" .

          jq '[.Results[].Misconfigurations[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            "${REPORT_DIR}/misconfig/trivy-config.json" | grep -qv 0 \
            && printf "true" > critical_flag.txt || true

      - name: Trivy Config SARIF
        shell: bash
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format sarif \
            --output "${REPORT_DIR}/misconfig/trivy-config.sarif" .

      # =====================================================================
      # Policy-as-Code ‚Äî OPA Conftest
      # =====================================================================
      - name: Conftest Policy Check
        shell: bash
        run: |
          FAILED=0

          if [ -f Dockerfile ]; then
            conftest test Dockerfile --policy "$POLICY_DIR" || FAILED=1
          fi

          if ls docker-compose*.yml >/dev/null 2>&1; then
            conftest test docker-compose*.yml --policy "$POLICY_DIR" || FAILED=1
          fi

          if [ -d k8s ]; then
            conftest test k8s --policy "$POLICY_DIR" || FAILED=1
          fi

          if [ "$FAILED" -ne 0 ]; then
            echo "Conftest policy violations detected."
            printf "true" > critical_flag.txt
          else
            echo "Conftest checks passed."
          fi

      # =====================================================================
      # SBOM ‚Äî Syft
      # =====================================================================
      - name: Generate SBOM (Syft)
        shell: bash
        run: |
          syft . -o json > "${REPORT_DIR}/sbom/sbom.json"

      - uses: actions/upload-artifact@v5
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

      - id: flag
        shell: bash
        run: echo "critical_found=$(cat critical_flag.txt)" >> "$GITHUB_OUTPUT"

  # =====================================================================
  # 2) Upload SARIF ke GitHub Security
  # =====================================================================
  upload_sarif:
    runs-on: self-hosted
    needs: security_scans
    if: always()
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: security-reports
          path: security-reports

      - name: Upload Semgrep SARIF
        if: hashFiles('security-reports/sast/semgrep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/sast/semgrep.sarif

      - name: Upload Trivy Config SARIF
        if: hashFiles('security-reports/misconfig/trivy-config.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: security-reports/misconfig/trivy-config.sarif

  # =====================================================================
  # 3) Auto GitHub Issue kalau ada HIGH/CRITICAL (main only)
  # =====================================================================
  create_issue:
    runs-on: self-hosted
    needs: security_scans
    if: needs.security_scans.outputs.critical_found == 'true' && github.ref == 'refs/heads/main'
    permissions:
      issues: write
      contents: read

    steps:
      - name: Prepare issue body
        shell: bash
        run: |
          cat <<EOF > issue.md
          üö® High/Critical Security Vulnerabilities Detected

          Mode   : ${{ needs.security_scans.outputs.scan_mode }}
          Commit : ${{ github.sha }}
          Run    : https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please review artifact **security-reports** for detailed findings.
          EOF

      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("issue.md", "utf8");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üö® Security Findings Detected (HIGH/CRITICAL)",
              body,
              labels: ["security", "critical", "devsecops"]
            });

  # =====================================================================
  # 4) AI Remediation (Optional, pakai OpenAI)
  # =====================================================================
  ai_remediation:
    runs-on: self-hosted
    needs: security_scans
    if: needs.security_scans.outputs.critical_found == 'true'
    env:
      HAS_OPENAI: ${{ secrets.OPENAI_API_KEY != '' }}

    steps:
      - name: Skip if no key
        if: env.HAS_OPENAI == 'false'
        shell: bash
        run: echo "No OPENAI_API_KEY, skipping AI remediation."

      - uses: actions/download-artifact@v5
        if: env.HAS_OPENAI == 'true'
        with:
          name: security-reports
          path: security-reports

      - name: Build minimal summary
        if: env.HAS_OPENAI == 'true'
        shell: bash
        run: |
          echo "## Vuln Bank ‚Äì Security Summary" > summary.md

          echo "### Gitleaks (secrets)" >> summary.md
          jq 'length' security-reports/secrets/gitleaks.json 2>/dev/null >> summary.md || echo "0" >> summary.md

          echo "### Trivy FS (SCA HIGH/CRITICAL)" >> summary.md
          jq '[.Results[].Vulnerabilities[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            security-reports/sca/trivy-fs.json 2>/dev/null >> summary.md || echo "0" >> summary.md

          echo "### Trivy Config (misconfig HIGH/CRITICAL)" >> summary.md
          jq '[.Results[].Misconfigurations[]?|select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            security-reports/misconfig/trivy-config.json 2>/dev/null >> summary.md || echo "0" >> summary.md

          echo "### Semgrep (ERROR/HIGH)" >> summary.md
          jq '[.results[]?|select(.extra.severity=="ERROR" or .extra.severity=="HIGH")] | length' \
            security-reports/sast/semgrep.json 2>/dev/null >> summary.md || echo "0" >> summary.md

      - name: Call OpenAI for remediation
        if: env.HAS_OPENAI == 'true'
        id: openai
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          BODY=$(jq -Rs '.' summary.md)

          cat > payload.json <<EOF
          {
            "model": "gpt-4.1-mini",
            "messages": [
              {
                "role": "system",
                "content": "You are a senior DevSecOps engineer. Produce prioritized remediation steps for a vulnerable banking web app."
              },
              {
                "role": "user",
                "content": $BODY
              }
            ]
          }
          EOF

          curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @payload.json \
            | jq -r '.choices[0].message.content' > remediation.md

      - name: Create AI remediation issue
        if: env.HAS_OPENAI == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("remediation.md", "utf8");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ü§ñ AI Remediation Suggestions ‚Äì " + process.env.GITHUB_SHA.slice(0,7),
              body,
              labels: ["security", "ai-remediation"]
            });

  # =====================================================================
  # 5) SECURITY GATE ‚Äî Block build for main if critical
  # =====================================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Evaluate Security Gate
        shell: bash
        run: |
          echo "critical_found: ${{ needs.security_scans.outputs.critical_found }}"
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "‚ùå Security Gate Failed (HIGH/CRITICAL detected)"
            exit 1
          fi
          echo "‚úÖ Security Gate Passed"

  # =====================================================================
  # 6) BUILD + SIGN + PUSH (Docker + Cosign)
  # =====================================================================
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    if: needs.security_gate.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Docker Login
        shell: bash
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      - name: Docker Build
        shell: bash
        run: |
          docker build -t "$IMAGE_REPO:$IMAGE_TAG" .

      - name: Docker Push
        shell: bash
        run: |
          docker push "$IMAGE_REPO:$IMAGE_TAG"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Cosign Sign (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        shell: bash
        run: |
          cosign sign --yes "$IMAGE_REPO:$IMAGE_TAG"

  # =====================================================================
  # 7) DEPLOY ke VM via Docker Compose
  # =====================================================================
  deploy:
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to VM (hosting@192.168.107.135)
        shell: bash
        env:
          REMOTE_HOST: hosting@192.168.107.135
        run: |
          ssh -o StrictHostKeyChecking=no "$REMOTE_HOST" bash -s <<EOF
            set -euo pipefail
            docker pull ${IMAGE_REPO}:${IMAGE_TAG}
            cd /opt/vuln-bank-app/containers/app
            IMAGE_WITH_TAG=${IMAGE_REPO}:${IMAGE_TAG} docker compose down
            IMAGE_WITH_TAG=${IMAGE_REPO}:${IMAGE_TAG} docker compose up -d
          EOF

  # =====================================================================
  # 8) SLACK NOTIFY ‚Äî Always
  # =====================================================================
  slack_notify:
    runs-on: self-hosted
    needs: security_scans
    if: always()
    steps:
      - name: Slack Notify
        shell: bash
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          STATUS="‚úÖ Pipeline success (mode: ${{ needs.security_scans.outputs.scan_mode }})"
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            STATUS="üö® HIGH/CRITICAL vulnerabilities detected (mode: ${{ needs.security_scans.outputs.scan_mode }})"
          elif [ "${{ job.status }}" != "success" ]; then
            STATUS="‚ö†Ô∏è Pipeline failed (non-security reason, mode: ${{ needs.security_scans.outputs.scan_mode }})"
          fi

          jq -n --arg text "$STATUS" '{text:$text}' \
            | curl -X POST -H "Content-type: application/json" \
              --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
