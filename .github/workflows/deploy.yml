name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB Daily Scan
  workflow_dispatch:

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  IMAGE_REPO: xbash81/vuln-bank

  # === Bastion â†’ VM2 (App Host) ===
  APP_HOST: "192.168.107.135"
  SSH_USER: "hosting"
  SSH_PORT: "22"
  DAST_TARGET_URL: "http://192.168.107.135:5000"

defaults:
  run:
    shell: bash

jobs:
  security_build_deploy_dast:
    name: Security Scan â†’ Build â†’ Deploy â†’ DAST
    runs-on: [self-hosted, linux]
    environment:
      name: production

    outputs:
      critical_found: ${{ steps.evaluate.outputs.critical_found }}

    steps:
      # ==================================================
      # 0) CHECKOUT & PREP
      # ==================================================
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare report directory
        run: |
          set -e
          mkdir -p "$REPORT_DIR"

      # ==================================================
      # 1) TOOLING SANITY + PYTHON CACHE
      # ==================================================
      - name: Ensure required CLI tools exist
        run: |
          set -e
          for cmd in jq bc curl; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "Installing $cmd..."
              sudo yum install -y "$cmd" 2>/dev/null || sudo apt-get update -y && sudo apt-get install -y "$cmd"
            fi
          done

      - name: Cache Python packages
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ==================================================
      # 2) PYTHON & TEST
      # ==================================================
      - name: Show Python version
        run: |
          set -e
          $PYTHON_BIN --version || true

      - name: Install Python dependencies
        run: |
          set -e
          $PYTHON_BIN -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            $PYTHON_BIN -m pip install -r requirements.txt
          else
            echo "requirements.txt not found, skipping dependency install"
          fi

      - name: Run unit tests (optional)
        continue-on-error: true
        run: |
          set -e
          $PYTHON_BIN -m pip install pytest
          pytest || true

      # ==================================================
      # 3) SECRET SCANNING â€“ GITLEAKS
      # ==================================================
      - name: Gitleaks scan
        continue-on-error: true
        run: |
          set -e

          BIN_DIR="$RUNNER_TEMP/bin"
          mkdir -p "$BIN_DIR"
          export PATH="$BIN_DIR:$PATH"

          if ! command -v gitleaks >/dev/null 2>&1; then
            echo "Installing gitleaks..."
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz \
              | tar -xz -C "$BIN_DIR"
            chmod +x "$BIN_DIR/gitleaks"
          fi

          gitleaks detect \
            --source . \
            --no-git \
            --redact \
            --report-format json \
            --report-path "$REPORT_DIR/gitleaks.json" || true

      # ==================================================
      # 4) SCA â€“ pip-audit
      # ==================================================
      - name: SCA with pip-audit
        continue-on-error: true
        run: |
          set -e
          $PYTHON_BIN -m pip install pip-audit
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt \
              -f json \
              -o "$REPORT_DIR/pip-audit.json" || true
          else
            echo "requirements.txt not found, skipping pip-audit"
          fi

      # ==================================================
      # 5) SAST â€“ Bandit
      # ==================================================
      - name: SAST with Bandit
        continue-on-error: true
        run: |
          set -e
          $PYTHON_BIN -m pip install bandit
          bandit -r . \
            -f json \
            -o "$REPORT_DIR/bandit.json" || true

      # ==================================================
      # 6) SAST â€“ SEMGREP
      # ==================================================
      - name: SAST with Semgrep
        continue-on-error: true
        uses: semgrep/semgrep-action@v1
        with:
          config: semgrep/
          format: json
          output: ${{ env.REPORT_DIR }}/semgrep.json

      # ==================================================
      # 7) SAST â€“ LLM (Application Logic Review)
      # ==================================================
      - name: LLM-SAST (Business Logic & Access Control)
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        env:
          AI_API_ENDPOINT: ${{ secrets.AI_API_ENDPOINT }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          set -e
          cd llm-sast
          pip install -r requirements.txt
          python main.py \
            --scan-path "$GITHUB_WORKSPACE" \
            > "../$REPORT_DIR/llm-sast.json" || true

      # ==================================================
      # 8) MISCONFIG & FS SCAN â€“ Trivy
      # ==================================================
      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-fs.json
          severity: HIGH,CRITICAL

      - name: Trivy config scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: config
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-config.json
          severity: HIGH,CRITICAL

      # ==================================================
      # 9) BUILD â†’ IMAGE SCAN â†’ PUSH
      # ==================================================
      - name: Runner disk hygiene (pre-build)
        run: |
          set -e
          echo "ðŸ§¹ Cleaning runner before build"
          docker system prune -af || true
          docker builder prune -af || true
          rm -rf ~/.cache/trivy || true

      - name: Docker Hub login
        run: |
          set -e

          if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker not available on runner"
            exit 1
          fi

          MAX_RETRY=5
          SLEEP_SEC=20

          for i in $(seq 1 $MAX_RETRY); do
            echo "ðŸ” Docker login attempt #$i/$MAX_RETRY ..."

            if echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
                docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin; then
              echo "âœ… Docker login succeeded."
              exit 0
            fi

            echo "âš ï¸ Docker login failed (attempt #$i)."

            if [ "$i" -lt "$MAX_RETRY" ]; then
              echo "â³ Waiting ${SLEEP_SEC}s before retry..."
              sleep "$SLEEP_SEC"
            else
              echo "âŒ Docker login failed after $MAX_RETRY attempts."
              exit 1
            fi
          done

      - name: Build image (with retry for network flakiness)
        run: |
          set -e
          MAX_RETRY=3
          n=1
          until [ $n -gt $MAX_RETRY ]; do
            echo "Docker build attempt #$n ..."
            if docker build \
              -f containers/app/Dockerfile \
              -t "$IMAGE_REPO:${{ github.sha }}" \
              -t "$IMAGE_REPO:latest" \
              .; then
              echo "Docker build succeeded."
              break
            fi
            echo "Docker build failed (attempt #$n)."
            if [ $n -eq $MAX_RETRY ]; then
              echo "Giving up after $MAX_RETRY attempts."
              exit 1
            fi
            n=$((n+1))
            sleep 10
          done

      - name: Trivy image scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-image.json
          severity: HIGH,CRITICAL

      # ==================================================
      # 10) EPSS RISK SCORING
      # ==================================================
      - name: EPSS risk evaluation
        id: epss
        continue-on-error: true
        run: |
          set -e
          epss_hit=false
          threshold=0.5

          if [ ! -f "$REPORT_DIR/trivy-image.json" ]; then
            echo "No Trivy image report found, skipping EPSS"
            echo "epss_hit=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CVES=$(jq -r '
            .Results[]?.Vulnerabilities[]? |
            select(.Severity=="HIGH" or .Severity=="CRITICAL") |
            .VulnerabilityID
          ' "$REPORT_DIR/trivy-image.json" | sort -u)

          for cve in $CVES; do
            score=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
              | jq -r '.data[0].epss // 0')

            echo "CVE=$cve | EPSS=$score"

            if (( $(echo "$score >= $threshold" | bc -l) )); then
              epss_hit=true
            fi

            sleep 0.3
          done

          echo "epss_hit=$epss_hit" >> "$GITHUB_OUTPUT"

      - name: Push image
        run: |
          set -e
          docker push "$IMAGE_REPO:${{ github.sha }}"
          docker push "$IMAGE_REPO:latest"

      # ==================================================
      # 11) SAFE DOCKER CLEANUP (AGE-BASED)
      # ==================================================
      - name: Docker cleanup (safe prune)
        if: always()
        run: |
          set -e
          echo "ðŸ§¹ Cleaning up old Docker artifacts..."

          if ! docker info > /dev/null 2>&1; then
            echo "Docker not available, skipping cleanup."
            exit 0
          fi

          docker image prune -a -f --filter "until=168h" || true
          docker builder prune -f --filter "until=168h" || true

          echo "âœ… Docker cleanup completed"

      # ==================================================
      # 12) DEPLOY TO VM2 (APP HOST)
      # ==================================================
      - name: Deploy app to VM2
        env:
          IMAGE_WITH_TAG: ${{ env.IMAGE_REPO }}:${{ github.sha }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          set -e
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" << EOF
              set -e
              cd /opt/vuln-bank/containers/app

              if [ -z "$IMAGE_WITH_TAG" ]; then
                echo "âŒ IMAGE_WITH_TAG is empty"
                exit 1
              fi

              echo '${{ secrets.DOCKERHUB_TOKEN }}' | \
                docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin

              export IMAGE_WITH_TAG="${IMAGE_WITH_TAG}"
              export DB_HOST="${DB_HOST}"
              export DB_USER="${DB_USER}"
              export DB_PASSWORD="${DB_PASSWORD}"
              export DEEPSEEK_API_KEY="${DEEPSEEK_API_KEY}"

              echo "Using image: \$IMAGE_WITH_TAG"
              docker compose pull
              docker compose up -d
          EOF

      - name: Docker image retention on VM2
        run: |
          set -e
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" \
            "KEEP_IMAGES=5 sudo /usr/local/bin/vuln-bank-image-retention.sh"

      - name: Wait for application
        run: |
          set -e
          for i in {1..30}; do
            if curl -sf "$DAST_TARGET_URL" > /dev/null; then
              echo "âœ… App is reachable at $DAST_TARGET_URL"
              exit 0
            fi
            echo "Waiting for app at $DAST_TARGET_URL... ($i/30)"
            sleep 5
          done
          echo "âŒ App did not become ready in time"
          exit 1

      # ==================================================
      # 13) DAST â€“ OWASP ZAP (Baseline)
      # ==================================================
      - name: Prepare ZAP workspace
        run: |
          set -e
          mkdir -p "$REPORT_DIR/zap"
          chmod -R u+rwX "$REPORT_DIR/zap"

      - name: OWASP ZAP baseline scan
        continue-on-error: true
        run: |
          set +e

          mkdir -p "$REPORT_DIR/zap"
          chmod -R u+rwX "$REPORT_DIR/zap"

          docker pull ghcr.io/zaproxy/zaproxy:stable

          docker run --rm \
            --userns=keep-id \
            -v "$REPORT_DIR/zap:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$DAST_TARGET_URL" \
              -J zap-report.json \
              -r zap-report.html \
              -m 5 \
              -T 120 || true

          echo "âœ… ZAP baseline completed"

          if jq -e '
            .site[].alerts[] |
            select(.riskcode == "3" or .riskcode == 3)
          ' "$REPORT_DIR/zap-report.json" >/dev/null 2>&1; then
            echo "âŒ ZAP HIGH risk vulnerabilities found"
          else
            echo "âœ… No ZAP HIGH risk vulnerabilities"
          fi

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: |
            security-reports/zap/zap-report.json
            security-reports/zap/zap-report.html
          if-no-files-found: warn

      # ==================================================
      # 14) RESULT AGGREGATION
      # ==================================================
      - name: Evaluate findings
        id: evaluate
        run: |
          set -e
          critical=false

          # Generic CRITICAL/HIGH markers in JSON reports
          if grep -RqiE '"severity":\s*"(CRITICAL|HIGH)"' "$REPORT_DIR"; then
            critical=true
          fi

          # Trivy-style Severity fields
          if jq -e '
            .. | objects |
            select(.Severity? == "CRITICAL" or .Severity? == "HIGH")
          ' "$REPORT_DIR"/*.json >/dev/null 2>&1; then
            critical=true
          fi

          # ZAP HIGH risk
          if [ -f "$REPORT_DIR/zap/zap-report.json" ]; then
            if jq -e '
              .site[].alerts[] |
              select(.riskcode == "3" or .riskcode == 3)
            ' "$REPORT_DIR/zap/zap-report.json" >/dev/null 2>&1; then
              critical=true
            fi
          fi

          echo "critical_found=$critical" >> "$GITHUB_OUTPUT"
          echo "Final security verdict: critical=$critical"

      # ==================================================
      # 15.5) ASVS SCORECARD
      # ==================================================
      - name: Generate ASVS scorecard
        run: |
          set -e
          python scripts/asvs_scorecard.py > "$REPORT_DIR/asvs-scorecard.json"

      # ==================================================
      # 15) AUTO GITHUB ISSUE (RISK-BASED)
      # ==================================================
      - name: Create GitHub Issue for exploitable vulnerabilities
        if: steps.evaluate.outputs.critical_found == 'true' && steps.epss.outputs.epss_hit == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ High-Risk Vulnerabilities Detected (EPSS â‰¥ 0.5)",
              body: `
            ### âš ï¸ Security Alert â€“ Vuln Bank

            This pipeline detected **HIGH/CRITICAL vulnerabilities** with **high EPSS probability**.

            **Why this matters:**
              - Vulnerabilities are likely to be exploited in the wild
              - Immediate investigation is recommended

            **Details:**
              - Image: \`${process.env.IMAGE_REPO}:${process.env.GITHUB_SHA}\`
              - Reports: See workflow artifacts

            **Next Actions:**
              - Patch dependencies
              - Rebuild image
              - Re-run security pipeline
            `,
              labels: ["security", "devsecops", "high-risk"]
            });

      # ==================================================
      # 16) DEVSECOPS PIPELINE SUMMARY
      # ==================================================
      - name: DevSecOps Pipeline Summary
        if: always()
        run: |
          {
            echo "# ðŸ” Vuln Bank â€“ DevSecOps Pipeline Summary"
            echo ""

            echo "## ðŸ§ª Security Scans Executed"
            echo "- âœ… Gitleaks (Secrets)"
            echo "- âœ… pip-audit (SCA)"
            echo "- âœ… Bandit (SAST)"
            echo "- âœ… Semgrep (SAST)"
            echo "- âœ… LLM-SAST (Business Logic)"
            echo "- âœ… Trivy FS & Config"
            echo "- âœ… Trivy Image"
            echo "- âœ… OWASP ZAP (DAST Baseline)"
            echo ""

            echo "## ðŸ³ Container Image"
            echo "- Image: \`${IMAGE_REPO}:${GITHUB_SHA}\`"
            echo ""

            echo "## ðŸŒ Deployment"
            echo "- Target: ${DAST_TARGET_URL}"
            echo "- Status: âœ… Application reachable"
            echo ""

            echo "## ðŸš¦ Security Verdict"
            if [ "${{ steps.evaluate.outputs.critical_found }}" = "true" ]; then
              echo "- âŒ **HIGH / CRITICAL vulnerabilities detected**"
            else
              echo "- âœ… **No HIGH / CRITICAL vulnerabilities found**"
            fi
            echo ""

            echo "## ðŸ” ASVS Compliance Scorecard"
            if [ -f "$REPORT_DIR/asvs-scorecard.json" ]; then
              jq -r '
                to_entries[] |
                "- \(.key) \(.value.name): âœ… \(.value.pass_pct)%"
              ' "$REPORT_DIR/asvs-scorecard.json"
            else
              echo "- âš ï¸ ASVS scorecard not generated"
            fi

            echo ""
            echo "## ðŸ“¦ Artifacts"
            echo "- ðŸ“„ Security reports uploaded as workflow artifact"
          } >> "$GITHUB_STEP_SUMMARY"

      # ==================================================
      # 17) UPLOAD ARTIFACTS
      # ==================================================
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: vuln-bank-security-reports
          path: ${{ env.REPORT_DIR }}
          if-no-files-found: warn

  notify:
    name: Notify on Critical Findings
    needs: security_build_deploy_dast
    runs-on: [self-hosted, linux]
    if: needs.security_build_deploy_dast.outputs.critical_found == 'true'

    steps:
      - name: Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL:-}" ]; then
            echo "SLACK_WEBHOOK_URL not set, skipping notification."
            exit 0
          fi

          curl -X POST -H "Content-type: application/json" \
            --data '{"text":":rotating_light: Vuln Bank â€“ High/Critical vulnerabilities detected"}' \
            "$SLACK_WEBHOOK_URL"
