name: Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB
  workflow_dispatch:

concurrency:
  group: vuln-bank-main-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  IMAGE_NAME: vuln-bank
  DOCKERHUB_REPO: docker.io/${{ secrets.DOCKERHUB_REPO }}
  IMAGE_TAG: ${{ github.sha }}
  REPORT_DIR: security-reports
  DAST_TARGET_URL: http://vuln-bank.local
  PYTHON_BIN: python3.11
  SONAR_HOST_URL: https://sonarcloud.io

jobs:
# ==========================================================
# 1) SECURITY SCANS
# ==========================================================
  security_scans:
    name: Security Scans
    runs-on: self-hosted

    outputs:
      critical_found: ${{ steps.setflag.outputs.critical_found }}

    steps:
      - uses: actions/checkout@v4

      - name: Runner sanity check (Python 3.11)
        run: |
          set -e
          $PYTHON_BIN --version
          $PYTHON_BIN -m pip --version
          docker --version || true
          command -v npm || true

      - name: Install base Python tools
        run: |
          $PYTHON_BIN -m pip install --upgrade pip
          $PYTHON_BIN -m pip install pip-audit semgrep coverage pytest
          if ! command -v jq &> /dev/null; then
            sudo dnf install -y jq || sudo yum install -y jq || true
          fi

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin

      - name: Install Gitleaks
        run: |
          GL_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name')
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${GL_VERSION}/gitleaks_${GL_VERSION#v}_linux_x64.tar.gz" \
            | sudo tar -xz -C /usr/local/bin gitleaks

      - name: Install Snyk CLI (safe)
        run: |
          curl -sL https://github.com/snyk/cli/releases/latest/download/snyk-linux -o snyk
          chmod +x snyk
          sudo mv snyk /usr/local/bin/snyk

      - name: Init critical flag
        run: echo "false" > critical_flag.txt

      - name: Prepare report dirs
        run: |
          mkdir -p ${REPORT_DIR}/secrets \
                   ${REPORT_DIR}/sca \
                   ${REPORT_DIR}/sast \
                   ${REPORT_DIR}/misconfig

      # ==========================
      # TEST + COVERAGE
      # ==========================
      - name: Python tests + coverage
        run: |
          if [ -f requirements.txt ]; then
            $PYTHON_BIN -m pip install -r requirements.txt
            coverage run -m pytest
            coverage xml -o coverage.xml
          else
            echo "No Python project detected, skipping Python tests"
          fi

      - name: Node.js tests + coverage
        run: |
          if [ -f package.json ] && command -v npm &> /dev/null; then
            npm install
            npm test -- --coverage || true
          else
            echo "No Node.js project detected, skipping Node tests"
          fi

      # ==========================
      # SONARCLOUD SCAN
      # ==========================
      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -sSLo sonar.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar.zip
          sudo mv sonar-scanner-* /opt/sonar-scanner
          sudo ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner

          sonar-scanner \
            -Dsonar.organization=${{ secrets.SONAR_ORG }} \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.sources=. \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.python.coverage.reportPaths=coverage.xml \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
            -Dsonar.exclusions=**/node_modules/**,**/vendor/**,**/dist/**,**/build/** \
            -Dsonar.qualitygate.wait=false

      - name: Enforce Sonar Quality Gate (HARD BLOCK)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "‚è≥ Waiting for SonarCloud Quality Gate..."
          for i in {1..20}; do
            STATUS=$(curl -s -u ${SONAR_TOKEN}: \
              "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${{ secrets.SONAR_PROJECT_KEY }}" \
              | jq -r '.projectStatus.status')

            echo "Sonar Quality Gate status: $STATUS"

            if [ "$STATUS" = "OK" ]; then
              echo "‚úÖ Sonar Quality Gate PASSED"
              exit 0
            fi

            if [ "$STATUS" = "ERROR" ]; then
              echo "‚ùå Sonar Quality Gate FAILED"
              exit 1
            fi

            sleep 10
          done

          echo "‚ùå Sonar Quality Gate timeout"
          exit 1

      # ==========================
      # SECURITY SCANS (existing)
      # ==========================
      - name: Secret Scanning - Gitleaks
        run: |
          gitleaks detect --source . \
            --report-format json \
            --report-path ${REPORT_DIR}/secrets/gitleaks.json || true

          if jq 'length > 0' ${REPORT_DIR}/secrets/gitleaks.json >/dev/null 2>&1; then
            echo "true" > critical_flag.txt
          fi

      - name: SCA - pip-audit
        run: |
          if [ -f requirements.txt ]; then
            $PYTHON_BIN -m pip_audit -r requirements.txt \
              -f json \
              -o ${REPORT_DIR}/sca/pip-audit.json || true
          else
            echo "requirements.txt not found, skipping pip-audit"
          fi

      - name: SCA - Trivy FS
        run: |
          trivy fs --scanners vuln \
            --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/sca/trivy-fs.json . || true

          HAS_CRIT=$(jq -r '[.Results[].Vulnerabilities[]?
            | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/sca/trivy-fs.json 2>/dev/null || echo 0)

          if [ "$HAS_CRIT" != "0" ]; then
            echo "true" > critical_flag.txt
          fi

      - name: SCA/SAST - Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --all-projects \
            --severity-threshold=high \
            --fail-on=upgradable \
            --json > ${REPORT_DIR}/sca/snyk.json || true

          if grep -q '"severity":"high"' ${REPORT_DIR}/sca/snyk.json || \
             grep -q '"severity":"critical"' ${REPORT_DIR}/sca/snyk.json; then
            echo "true" > critical_flag.txt
          fi

      - name: SAST - Semgrep
        run: |
          semgrep ci --config p/ci \
            --json \
            --output ${REPORT_DIR}/sast/semgrep.json || true

          HAS_HIGH=$(jq -r '[.results[]?
            | select(.extra.severity=="ERROR" or
                     .extra.severity=="HIGH" or
                     .extra.severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/sast/semgrep.json 2>/dev/null || echo 0)

          if [ "$HAS_HIGH" != "0" ]; then
            echo "true" > critical_flag.txt
          fi

      - name: Misconfig - Trivy Config
        run: |
          trivy config --severity HIGH,CRITICAL \
            --format json \
            --output ${REPORT_DIR}/misconfig/trivy-config.json . || true

          HAS_MISCONF=$(jq -r '[.Results[].Misconfigurations[]?
            | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' \
            ${REPORT_DIR}/misconfig/trivy-config.json 2>/dev/null || echo 0)

          if [ "$HAS_MISCONF" != "0" ]; then
            echo "true" > critical_flag.txt
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}
          retention-days: 30

      - name: Set critical output
        id: setflag
        run: |
          echo "critical_found=$(cat critical_flag.txt)" >> $GITHUB_OUTPUT

# ==========================================================
# 2) SECURITY GATE (still enforced)
# ==========================================================
  security_gate:
    runs-on: self-hosted
    needs: security_scans
    steps:
      - run: |
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            echo "‚ùå Security gate failed (HIGH/CRITICAL findings present)"
            exit 1
          fi
          echo "‚úÖ Security gate passed (no HIGH/CRITICAL findings)"

# ==========================================================
# 3) BUILD & PUSH (only if gate success)
# ==========================================================
  build_and_push:
    runs-on: self-hosted
    needs: security_gate
    if: needs.security_gate.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Cleanup workspace
        run: git clean -xfd

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" \
            | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t $DOCKERHUB_REPO/${IMAGE_NAME}:${IMAGE_TAG} .

      - name: Push image
        run: docker push $DOCKERHUB_REPO/${IMAGE_NAME}:${IMAGE_TAG}

# ==========================================================
# 4) DEPLOY TO K3s
# ==========================================================
  deploy_k8s:
    runs-on: self-hosted
    needs: build_and_push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Ensure kubectl installed
        run: |
          command -v kubectl || (
            curl -LO https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl &&
            sudo install -m 0755 kubectl /usr/local/bin/kubectl
          )

      - name: Inject image & deploy
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|${DOCKERHUB_REPO}/${IMAGE_NAME}:${IMAGE_TAG}|g" k3s/app/values.yaml
          kubectl apply -f k3s/db/
          kubectl apply -f k3s/app/
          kubectl rollout status deployment/vuln-bank -n vuln-bank-app --timeout=120s

# ==========================================================
# 5) SLACK NOTIFICATION
# ==========================================================
  slack_notify:
    runs-on: self-hosted
    needs: [security_scans]
    steps:
      - name: Ensure jq
        run: |
          command -v jq || sudo dnf install -y jq || sudo yum install -y jq || true

      - name: Send Slack message
        run: |
          [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ] && exit 0

          MSG="‚úÖ [main] Pipeline completed"
          if [ "${{ needs.security_scans.outputs.critical_found }}" = "true" ]; then
            MSG="üö® [main] HIGH/CRITICAL vulnerabilities detected"
          fi

          jq -n --arg msg "$MSG" \
            '{text:$msg}' \
          | curl -X POST -H 'Content-type: application/json' \
            --data @- "${{ secrets.SLACK_WEBHOOK_URL }}"
