name: ðŸ” Vuln Bank DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "0 18 * * *" # Daily full scan (â‰ˆ 01:00 WIB)
  workflow_dispatch:

env:
  REPORT_DIR: security-reports
  REGISTRY: docker.io
  IMAGE_NAME: vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  FULL_IMAGE: docker.io/xbash/vuln-bank:${{ github.sha }}
  EPSS_THRESHOLD: "0.7" # Risk-based threshold (nilai plus di laporan)

jobs:
  #################################################################
  # JOB 1 â€” SECURITY CI (runs on GitHub-hosted runner)
  #################################################################
  security-ci:
    name: ðŸ›¡ï¸ Security CI (SAST / SCA / Secrets / DAST / Misconfig)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      id-token: write
      packages: write
      issues: write

    steps:
      # -----------------------------------------------------------
      # 0. Checkout + Python environment
      # -----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare security reports directory
        run: mkdir -p "$REPORT_DIR"

      # -----------------------------------------------------------
      # 1. Install security tools
      # -----------------------------------------------------------
      - name: Install CLI security tools
        run: |
          pip install --upgrade pip
          pip install \
            bandit==1.* \
            semgrep==1.*

          # Install TruffleHog v3 (Go binary)
          curl -sSL https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_Linux_x86_64 \
            -o /usr/local/bin/trufflehog
          chmod +x /usr/local/bin/trufflehog
          
          # Install Trivy
          curl -L https://github.com/aquasecurity/trivy/releases/latest/download/trivy_Linux-64bit.tar.gz \
            -o /tmp/trivy.tgz
          sudo tar zxvf /tmp/trivy.tgz -C /usr/local/bin trivy
          
          # ZAP baseline script
          curl -L https://github.com/zaproxy/zaproxy/releases/latest/download/zap-baseline.py \
            -o /usr/local/bin/zap-baseline.py
          chmod +x /usr/local/bin/zap-baseline.py

      - name: Verify installed tools
        run: |
          trufflehog --version
          bandit --version
          semgrep --version
          trivy --version
          python /usr/local/bin/zap-baseline.py --help
          
      # -----------------------------------------------------------
      # 2. Optional: Unit tests (kalau ada)
      # -----------------------------------------------------------
      - name: Install app dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run unit tests (non-blocking if none)
        run: |
          if ls tests 2>/dev/null; then
            pytest -q || true
          else
            echo "No tests directory, skipping..."
          fi

      # -----------------------------------------------------------
      # 3. Secret Scanning (TruffleHog)
      # -----------------------------------------------------------
      - name: ðŸ”‘ Secret scan (TruffleHog)
        run: |
          trufflehog filesystem --json . > "$REPORT_DIR/trufflehog.json" || true

      # -----------------------------------------------------------
      # 4. SAST (Bandit + Semgrep)
      # -----------------------------------------------------------
      - name: ðŸ§± SAST (Bandit - Python)
        run: |
          bandit -r . -f json -o "$REPORT_DIR/bandit.json" || true

      - name: ðŸ§± SAST (Semgrep - generic rules)
        run: |
          semgrep ci \
            --config auto \
            --json --output "$REPORT_DIR/semgrep.json" || true

      # -----------------------------------------------------------
      # 5. Build container image (for SCA/Image Scan + DAST)
      # -----------------------------------------------------------
      - name: ðŸ³ Build container image
        run: |
          docker build -t "$FULL_IMAGE" .

      # -----------------------------------------------------------
      # 6. SCA + Image Scan (Trivy image)
      # -----------------------------------------------------------
      - name: ðŸ“¦ SCA & Image scan (Trivy image)
        run: |
          trivy image \
            --scanners vuln,secret \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-image.json" \
            --exit-code 0 \
            "$FULL_IMAGE"

      # -----------------------------------------------------------
      # 7. Misconfiguration Scan (Dockerfile, Compose, dsb)
      # -----------------------------------------------------------
      - name: âš™ï¸ Misconfiguration scan (Trivy config)
        run: |
          trivy config \
            --severity HIGH,CRITICAL \
            --format json \
            --output "$REPORT_DIR/trivy-config.json" \
            --exit-code 0 \
            .

      # -----------------------------------------------------------
      # 8. DAST (OWASP ZAP Baseline)
      # NOTE: This is a simple baseline scan; tweak target as needed.
      # -----------------------------------------------------------
      - name: ðŸš€ Run app container for DAST
        run: |
          docker run -d --rm \
            -p 5000:5000 \
            --name vuln-bank \
            "$FULL_IMAGE"

      - name: ðŸŒ DAST scan (OWASP ZAP Baseline)
        env:
          TARGET_URL: http://localhost:5000
        run: |
          python /usr/local/bin/zap-baseline.py \
            -t "$TARGET_URL" \
            -x "$REPORT_DIR/zap-report.xml" || true

      - name: ðŸ§¯ Stop DAST container
        if: always()
        run: docker stop vuln-bank || true

      # -----------------------------------------------------------
      # 9. Risk-based: Evaluate HIGH/CRITICAL + EPSS
      #    - Fail job if:
      #      * ada HIGH/CRITICAL
      #      * atau EPSS >= threshold (0.7)
      # -----------------------------------------------------------
      - name: ðŸ“Š Evaluate vulnerabilities (Severity + EPSS)
        env:
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}
        run: |
          python - << 'PY'
          import json, os, sys, subprocess

          report_path = os.path.join(os.environ["REPORT_DIR"], "trivy-image.json")
          epss_threshold = float(os.environ.get("EPSS_THRESHOLD", "0.7"))

          if not os.path.exists(report_path):
            print("Trivy image report not found, skipping evaluation.")
            sys.exit(0)

          with open(report_path) as f:
            data = json.load(f)

          vulns = []
          for res in data.get("Results", []):
            for v in res.get("Vulnerabilities", []):
              vulns.append(v)

          high_crit = [v for v in vulns if v.get("Severity") in ("HIGH", "CRITICAL")]

          # Simple EPSS lookup via FIRST API (optional, best-effort)
          def fetch_epss(cve_id):
            try:
              import urllib.request, urllib.parse, ssl
              ctx = ssl.create_default_context()
              url = f"https://api.first.org/data/v1/epss?cve={urllib.parse.quote(cve_id)}"
              with urllib.request.urlopen(url, context=ctx, timeout=5) as resp:
                obj = json.loads(resp.read().decode())
              data = obj.get("data", [])
              if not data:
                return 0.0
              return float(data[0].get("epss", 0.0))
            except Exception as e:
              print(f"[EPSS] Failed for {cve_id}: {e}")
              return 0.0

          over_epss = []
          for v in high_crit:
            cve = v.get("VulnerabilityID", "")
            if cve.startswith("CVE-"):
              score = fetch_epss(cve)
              if score >= epss_threshold:
                v["EPSS"] = score
                over_epss.append(v)

          summary_path = os.path.join(os.environ["REPORT_DIR"], "epss-summary.txt")
          with open(summary_path, "w") as f:
            f.write("# Vuln Bank - Risk-based summary (Trivy + EPSS)\n\n")
            f.write(f"- Total vulns scanned: {len(vulns)}\n")
            f.write(f"- HIGH/CRITICAL: {len(high_crit)}\n")
            f.write(f"- HIGH/CRITICAL with EPSS >= {epss_threshold}: {len(over_epss)}\n\n")

            if over_epss:
              f.write("Top risky findings (EPSS-based):\n")
              for v in over_epss[:10]:
                f.write(f"- {v.get('VulnerabilityID')} | {v.get('Severity')} | EPSS={v.get('EPSS', 0):.3f} | {v.get('Title','')}\n")

          # Fail job if we have high/critical OR EPSS >= threshold
          if high_crit or over_epss:
            print("âŒ HIGH/CRITICAL or high-EPSS vulnerabilities detected. Failing job to trigger notification.")
            sys.exit(1)

          print("âœ… No HIGH/CRITICAL or high-EPSS vulnerabilities detected.")
          sys.exit(0)
          PY

      # -----------------------------------------------------------
      # 10. Upload all reports as artifacts
      # -----------------------------------------------------------
      - name: ðŸ“Ž Upload security reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: ${{ env.REPORT_DIR }}

  #################################################################
  # JOB 2 â€” NOTIFICATION + ISSUE (runs only if security-ci fails)
  #################################################################
  notify-and-issues:
    name: ðŸš¨ Notify & Create Issue on Critical Findings
    needs: security-ci
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Show summary in logs
        run: |
          echo "=== Security reports ==="
          ls -R security-reports || true
          echo "=== EPSS summary (if any) ==="
          cat security-reports/epss-summary.txt || echo "No EPSS summary file."

      # -------------------------------
      # Discord / Slack / Telegram via webhook
      # -------------------------------
      - name: ðŸ”” Send Discord alert (example)
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          SUMMARY="ðŸš¨ Vuln Bank - Security pipeline FAILED
          Repo: $GITHUB_REPOSITORY
          Ref : $GITHUB_REF
          SHA : $GITHUB_SHA

          Please check GitHub Actions artifacts: security-reports/* and epss-summary.txt."
          
          # simple JSON payload (no jq needed)
          payload=$(printf '{"content": "%s"}' "$(echo "$SUMMARY" | sed 's/"/\\"/g')")
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

      # -------------------------------
      # Auto-create GitHub Issue for tracking
      # -------------------------------
      - name: ðŸ“ Create GitHub Issue for critical findings
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ”´ Critical / High-EPSS vulnerabilities detected in ${{ github.sha }}"
          content-filepath: security-reports/epss-summary.txt
          labels: |
            security
            critical
            devsecops
            auto-created

  #################################################################
  # JOB 3 â€” DEPLOY TO VMWARE LAB VIA ANSIBLE (BASTION RUNNER)
  #################################################################
  deploy:
    name: ðŸš€ Deploy to VMware lab (Ansible + Docker Compose)
    needs: security-ci
    if: success()
    runs-on: self-hosted  # self-hosted runner di VM Bastion

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure Ansible is installed
        run: |
          if ! command -v ansible-playbook >/dev/null 2>&1; then
            sudo dnf install -y ansible-core
          fi

      - name: Deploy via Ansible (passing secrets)
        env:
          # Image yg sudah LOLA (Lolos Semua Scan)
          FULL_IMAGE: ${{ env.FULL_IMAGE }}

          # Credentials from GitHub Secrets
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          VULN_ENV_FILE: ${{ secrets.VULN_ENV_FILE }}

          DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}
          BASTION_HOST: ${{ secrets.BASTION_HOST }}

        run: |
          ansible-playbook -i inventory.ini site.yml \
            --tags deploy_vuln_bank \
            -e "FULL_IMAGE=${FULL_IMAGE}" \
            -e "db_user=${DB_USER}" \
            -e "db_password=${DB_PASSWORD}" \
            -e "flask_secret_key=${FLASK_SECRET_KEY}" \
            -e "vuln_env_file=${VULN_ENV_FILE}" \
            -e "dockerhub_repo=${DOCKERHUB_REPO}" \
            -e "bastion_host=${BASTION_HOST}"

