name: Snyk Security (GHAS + EPSS Ready)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  snyk:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      # --------------------------------------------------
      # Install Snyk CLI (NO sudo, SELF-HOSTED SAFE)
      # --------------------------------------------------
      - name: Install Snyk CLI
        run: |
          set -euo pipefail
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          curl -sSL https://github.com/snyk/cli/releases/latest/download/snyk-linux \
            -o "$BIN/snyk"
          chmod +x "$BIN/snyk"

      - name: Verify Snyk
        run: snyk --version
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --------------------------------------------------
      # SNYK CODE (SAST) — SARIF
      # --------------------------------------------------
      - name: Snyk Code → SARIF
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk code test \
            --sarif-file-output=snyk-code.sarif \
            || true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code

      # --------------------------------------------------
      # SNYK SCA (Signal only)
      # --------------------------------------------------
      - name: Snyk Open Source
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk monitor --all-projects || true
