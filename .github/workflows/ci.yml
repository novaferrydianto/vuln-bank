name: Vuln Bank â€“ DevSecOps CI (Enterprise)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REPORT_DIR: security-reports
  BASELINE_DIR: security-baselines
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  DAST_URL: http://vuln-bank-dast:5000
  ZAP_FAIL_SEVERITY: HIGH

# =====================================================
# 0) DEFECTDOJO ENGAGEMENT (PR ONLY)
# =====================================================
jobs:
  create_engagement:
    if: github.event_name == 'pull_request'
    runs-on: self-hosted
    permissions:
      contents: read
    outputs:
      engagement_id: ${{ steps.out.outputs.id }}
    env:
      DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
    steps:
      - uses: actions/checkout@v4
      - run: chmod +x scripts/create_defectdojo_engagement.sh
      - run: bash scripts/create_defectdojo_engagement.sh
      - id: out
        run: echo "id=${DEFECTDOJO_ENGAGEMENT_ID:-}" >> "$GITHUB_OUTPUT"

# =====================================================
# 1) SECURITY SCANS (AUTHORITATIVE GATE)
# =====================================================
  security_scans:
    name: Security Scans & Gates
    runs-on: self-hosted
    needs: [create_engagement]
    if: always()
    permissions:
      contents: read
      security-events: write
    outputs:
      gate_failed: ${{ steps.gate.outputs.failed }}
    env:
      DEFECTDOJO_ENGAGEMENT_ID: ${{ needs.create_engagement.outputs.engagement_id }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0, clean: false }

      - name: Prepare workspace
        run: |
          mkdir -p $REPORT_DIR/{zap,governance}
          mkdir -p $BASELINE_DIR .trivy-cache
          rm -f $REPORT_DIR/gate_failed || true

      # ---------- Secrets ----------
      - name: Gitleaks
        run: |
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            detect --source /repo \
            --config /repo/.gitleaks.toml \
            --report-format sarif \
            --report-path /repo/$REPORT_DIR/gitleaks.sarif \
            --exit-code 0

      - uses: github/codeql-action/upload-sarif@v4
        with: { sarif_file: security-reports/gitleaks.sarif }

      - run: $PYTHON_BIN scripts/gitleaks_gate.py $REPORT_DIR/gitleaks.sarif

      # ---------- SAST ----------
      - name: Bandit
        run: |
          $PYTHON_BIN -m pip install -q bandit
          bandit -r app.py database.py auth.py ai_agent_deepseek.py \
            -f json -o $REPORT_DIR/bandit.json || true

      - run: $PYTHON_BIN scripts/bandit_normalize.py \
              $REPORT_DIR/bandit.json $REPORT_DIR/bandit_dd.json

      - name: Semgrep (OWASP / ASVS)
        run: |
          if [ -f "$BASELINE_DIR/semgrep-baseline.json" ]; then
            cp "$BASELINE_DIR/semgrep-baseline.json" "$REPORT_DIR/semgrep-baseline.json"
          fi
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep scan \
              --config p/owasp-top-ten \
              --config p/security-audit \
              --config p/python \
              --json \
              --output /src/$REPORT_DIR/semgrep.json || true

      - run: |
          if [ -f "$REPORT_DIR/semgrep-baseline.json" ]; then
            $PYTHON_BIN scripts/semgrep_owasp_gate.py \
              $REPORT_DIR/semgrep.json \
              $REPORT_DIR/semgrep-baseline.json
          else
            $PYTHON_BIN scripts/semgrep_owasp_gate.py $REPORT_DIR/semgrep.json
          fi

      # ---------- SCA ----------
      - name: Trivy FS
        run: |
          docker run --rm -u $(id -u):$(id -g) \
            -v "$PWD:/work" \
            -v "$PWD/.trivy-cache:/tmp/trivy-cache" \
            aquasec/trivy:0.49.1 \
            fs /work \
            --severity HIGH,CRITICAL \
            --format json \
            -o /work/$REPORT_DIR/trivy-sca.json

      - run: |
          $PYTHON_BIN scripts/epss_gate.py \
            --input $REPORT_DIR/trivy-sca.json \
            --output $REPORT_DIR/epss-findings.json \
            --threshold $EPSS_THRESHOLD

      # ---------- DAST ----------
      - run: docker build -t vuln-bank:ci -f containers/app/Dockerfile .
      - run: docker compose -f docker-compose.dast.yml up -d

      - name: ZAP Scan
        run: |
          chmod -R 777 $REPORT_DIR/zap || true
          docker run --rm --network vuln-bank_dastnet \
            -v "$PWD/$REPORT_DIR/zap:/zap/wrk" \
            -v "$PWD/security-policies/zap-automation.yml:/zap/automation.yml:ro" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -cmd -autorun /zap/automation.yml

      - run: |
          $PYTHON_BIN scripts/zap_severity_gate.py \
            $REPORT_DIR/zap/zap_alerts.json $ZAP_FAIL_SEVERITY

      - if: always()
        run: docker compose -f docker-compose.dast.yml down || true

      # ---------- Governance Outputs ----------
      - run: |
          $PYTHON_BIN scripts/asvs_export.py \
            --semgrep $REPORT_DIR/semgrep.json \
            --bandit $REPORT_DIR/bandit_dd.json \
            --out-json $REPORT_DIR/governance/asvs-coverage.json \
            --out-md $REPORT_DIR/governance/asvs-coverage.md

      - name: Final Gate
        id: gate
        run: |
          if [ -f "$REPORT_DIR/gate_failed" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "failed=false" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: security-reports

# =====================================================
# 2) GOVERNANCE (PR SUMMARY + LABELS + REGRESSION)
# =====================================================
  governance:
    name: Governance (Summary / Labels / Regression)
    needs: [security_scans]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: ASVS â†’ OWASP Labels
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/asvs_to_labels.py

      - name: Block PR on ASVS regression
        if: github.event_name == 'pull_request'
        env:
          BASELINE_DIR: security-baselines
        run: |
          python3 scripts/asvs_regression_gate.py \
            security-reports/governance/asvs-coverage.json \
            $BASELINE_DIR/asvs-baseline.json

# =====================================================
# 3) BASELINE UPDATE (MAIN ONLY, CLEAN RUN)
# =====================================================
  update_baselines:
    needs: [security_scans, governance]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.security_scans.outputs.gate_failed == 'false'
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { name: security-reports, path: security-reports }

      - run: |
          cp $REPORT_DIR/semgrep.json $BASELINE_DIR/semgrep-baseline.json
          cp $REPORT_DIR/governance/asvs-coverage.json \
             $BASELINE_DIR/asvs-baseline.json

      - run: |
          git config user.name "devsecops-bot"
          git config user.email "devsecops@vulnbank.local"
          git add $BASELINE_DIR || true
          git diff --cached --quiet || \
            git commit -m "chore(security): update baselines [auto]" && git push

# =====================================================
# 4) SLACK (RISK-AWARE, ENRICHED)
# =====================================================
  slack_notify:
    name: Slack Alert â€“ Risk Aware
    needs: [security_scans, governance]
    runs-on: self-hosted
    if: |
      always() &&
      (
        needs.security_scans.outputs.gate_failed == 'true' ||
        needs.governance.outputs.asvs_regression == 'true' ||
        needs.governance.outputs.zap_high != '0' ||
        needs.governance.outputs.epss_max >= '0.50'
      )

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Send Slack Alert
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          GATE_FAILED: ${{ needs.security_scans.outputs.gate_failed }}
          ASVS_REGRESSION: ${{ needs.governance.outputs.asvs_regression }}
          EPSS_MAX: ${{ needs.governance.outputs.epss_max }}
          ZAP_HIGH: ${{ needs.governance.outputs.zap_high }}
        run: |
          python3 - <<'PY'
          import os, json, urllib.request

          text = (
            "*ðŸš¨ Vuln Bank â€“ DevSecOps Risk Alert*\n"
            f"â€¢ Repo: `{os.getenv('REPO')}`\n"
            f"â€¢ Run: `{os.getenv('RUN_ID')}`\n\n"
            f"*Signals*\n"
            f"â€¢ Gate failed: `{os.getenv('GATE_FAILED')}`\n"
            f"â€¢ ASVS regression: `{os.getenv('ASVS_REGRESSION')}`\n"
            f"â€¢ EPSS max: `{os.getenv('EPSS_MAX')}`\n"
            f"â€¢ ZAP HIGH alerts: `{os.getenv('ZAP_HIGH')}`\n"
          )

          payload = {"text": text}

          req = urllib.request.Request(
            os.environ["SLACK_WEBHOOK_URL"],
            data=json.dumps(payload).encode(),
            headers={"Content-Type": "application/json"},
          )
          urllib.request.urlopen(req, timeout=10)
          print("[OK] Slack alert sent")
          PY
  
