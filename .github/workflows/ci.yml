name: Vuln Bank â€“ DevSecOps CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB
  workflow_dispatch:

concurrency:
  group: vuln-bank-${{ github.ref }}
  cancel-in-progress: true

# Default least privilege
permissions:
  contents: read

env:
  REPORT_DIR: security-reports
  BASELINE_DIR: security-baselines
  PYTHON_BIN: python3.11
  EPSS_THRESHOLD: "0.5"
  DAST_URL: http://vuln-bank-dast:5000
  ZAP_FAIL_SEVERITY: HIGH

jobs:
# =====================================================
# 0) DEFECTDOJO ENGAGEMENT (PR ONLY)
# =====================================================
  create_engagement:
    name: Create DefectDojo Engagement (PR)
    if: github.event_name == 'pull_request'
    runs-on: self-hosted
    permissions:
      contents: read
    outputs:
      engagement_id: ${{ steps.out.outputs.id }}
    env:
      DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Create / reuse engagement
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/create_defectdojo_engagement.sh
          bash scripts/create_defectdojo_engagement.sh

      - id: out
        name: Export engagement ID
        shell: bash
        run: |
          set -euo pipefail
          echo "id=${DEFECTDOJO_ENGAGEMENT_ID:-}" >> "$GITHUB_OUTPUT"

# =====================================================
# 1) SECURITY SCANS (AUTHORITATIVE GATE)
# =====================================================
  security_scans:
    name: Security Scans & Gates
    runs-on: self-hosted
    needs: [create_engagement]
    if: always()
    permissions:
      contents: read
      security-events: write
    outputs:
      gate_failed: ${{ steps.gate.outputs.failed }}
    env:
      DEFECTDOJO_ENGAGEMENT_ID: ${{ needs.create_engagement.outputs.engagement_id }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      - name: Prepare workspace
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${REPORT_DIR}/zap" "${REPORT_DIR}/governance"
          mkdir -p "${BASELINE_DIR}" ".trivy-cache"
          rm -f "${REPORT_DIR}/gate_failed" || true

# ---------------- SECRETS ----------------
      - name: Gitleaks (SARIF)
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            detect --source /repo \
            --config /repo/.gitleaks.toml \
            --report-format sarif \
            --report-path /repo/${REPORT_DIR}/gitleaks.sarif \
            --redact \
            --exit-code 0

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      - name: Gitleaks gate
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" scripts/gitleaks_gate.py "${REPORT_DIR}/gitleaks.sarif"

# ---------------- SAST ----------------
      - name: Bandit (JSON)
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" -m pip install -q bandit
          bandit -r app.py database.py auth.py ai_agent_deepseek.py \
            -f json -o "${REPORT_DIR}/bandit.json" || true
          test -f "${REPORT_DIR}/bandit.json" || echo '{"results":[]}' > "${REPORT_DIR}/bandit.json"

      - name: Bandit normalize (DefectDojo compatible)
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" scripts/bandit_normalize.py \
            "${REPORT_DIR}/bandit.json" \
            "${REPORT_DIR}/bandit_dd.json"
          test -f "${REPORT_DIR}/bandit_dd.json" || echo '{"findings":[]}' > "${REPORT_DIR}/bandit_dd.json"

      - name: Load Semgrep baseline (if exists)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${BASELINE_DIR}/semgrep-baseline.json" ]; then
            cp "${BASELINE_DIR}/semgrep-baseline.json" "${REPORT_DIR}/semgrep-baseline.json"
            echo "[INFO] Semgrep baseline loaded"
          else
            echo "[INFO] No Semgrep baseline found (first run ok)"
          fi

      - name: Semgrep scan (OWASP / ASVS)
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/src" returntocorp/semgrep \
            semgrep scan \
              --config p/owasp-top-ten \
              --config p/security-audit \
              --config p/python \
              --json \
              --output /src/${REPORT_DIR}/semgrep.json || true
          test -f "${REPORT_DIR}/semgrep.json" || echo '{"results":[]}' > "${REPORT_DIR}/semgrep.json"

      - name: Semgrep OWASP gate (baseline-aware)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${REPORT_DIR}/semgrep-baseline.json" ]; then
            "${PYTHON_BIN}" scripts/semgrep_owasp_gate.py \
              "${REPORT_DIR}/semgrep.json" \
              "${REPORT_DIR}/semgrep-baseline.json"
          else
            "${PYTHON_BIN}" scripts/semgrep_owasp_gate.py "${REPORT_DIR}/semgrep.json"
          fi

# ---------------- SCA ----------------
      - name: Trivy FS (rootless + cache-safe)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ".trivy-cache"
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -e TRIVY_CACHE_DIR=/tmp/trivy-cache \
            -v "$PWD:/work" \
            -v "$PWD/.trivy-cache:/tmp/trivy-cache" \
            aquasec/trivy:0.49.1 \
            fs /work \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --format json \
            -o /work/${REPORT_DIR}/trivy-sca.json
          test -f "${REPORT_DIR}/trivy-sca.json" || echo '{"Results":[]}' > "${REPORT_DIR}/trivy-sca.json"

      - name: EPSS + KEV gate
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" scripts/epss_gate.py \
            --input "${REPORT_DIR}/trivy-sca.json" \
            --output "${REPORT_DIR}/epss-findings.json" \
            --threshold "${EPSS_THRESHOLD}"
          test -f "${REPORT_DIR}/epss-findings.json" || echo '{"high_risk":[],"threshold":"'"${EPSS_THRESHOLD}"'"}' > "${REPORT_DIR}/epss-findings.json"

      - name: Install jsonschema
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install -q --upgrade pip
          python3 -m pip install -q jsonschema

# ---------------- DAST ----------------
      - name: Build app image (for DAST)
        shell: bash
        run: |
          set -euo pipefail
          docker build -t vuln-bank:ci -f containers/app/Dockerfile .

      - name: Start DAST stack
        shell: bash
        run: |
          set -euo pipefail
          docker compose -f docker-compose.dast.yml up -d

      - name: Wait for app readiness
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..20}; do
            docker run --rm --network vuln-bank_dastnet curlimages/curl:8.6.0 \
              curl -fs "${DAST_URL}" && exit 0
            sleep 5
          done
          echo "[ERROR] App not ready. Printing compose logs..."
          docker compose -f docker-compose.dast.yml logs || true
          exit 1

      - name: ZAP Automation (fixed vars)
        shell: bash
        env:
          TARGET_URL: ${{ env.DAST_URL }}
        run: |
          set -euo pipefail
          chmod -R 777 "${REPORT_DIR}/zap" || true
          docker run --rm \
            --network vuln-bank_dastnet \
            -e TARGET_URL="${DAST_URL}" \
            -v "$PWD/${REPORT_DIR}/zap:/zap/wrk" \
            -v "$PWD/security-policies/zap-automation.yml:/zap/automation.yml:ro" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -cmd -autorun /zap/automation.yml
          test -f "${REPORT_DIR}/zap/zap_alerts.json"

      - name: ZAP severity gate
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" scripts/zap_severity_gate.py \
            "${REPORT_DIR}/zap/zap_alerts.json" \
            "${ZAP_FAIL_SEVERITY}"

      - name: Incident â€“ OWASP A01/A02 (Highâ€“High)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          ZAP_JSON: security-reports/zap/zap_alerts.json
        run: python3 scripts/zap_a01_a02_incident.py

      - name: Stop DAST stack
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          docker compose -f docker-compose.dast.yml down || true

# ---------------- ASVS ----------------
      - name: ASVS export (JSON + MD)
        shell: bash
        run: |
          set -euo pipefail
          "${PYTHON_BIN}" scripts/asvs_export.py \
            --semgrep "${REPORT_DIR}/semgrep.json" \
            --bandit "${REPORT_DIR}/bandit_dd.json" \
            --out-json "${REPORT_DIR}/governance/asvs-coverage.json" \
            --out-md "${REPORT_DIR}/governance/asvs-coverage.md"
          test -f "${REPORT_DIR}/governance/asvs-coverage.json"

      - name: Validate ASVS coverage schema
        shell: bash
        run: |
          set -euo pipefail
          python3 - << 'EOF'
          import json
          from jsonschema import validate

          with open("schemas/asvs-coverage.schema.json") as f:
              schema = json.load(f)

          with open("security-reports/governance/asvs-coverage.json") as f:
              data = json.load(f)

          validate(instance=data, schema=schema)
          print("âœ… ASVS coverage schema valid")
          EOF

# ---------------- FINAL GATE ----------------
      - name: Final Gate
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${REPORT_DIR}/gate_failed" ]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "failed=false" >> "$GITHUB_OUTPUT"

      - name: Upload security reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports

# =====================================================
# 2) GOVERNANCE (LABELS + REGRESSION)
# =====================================================
  governance:
    name: Governance (Labels + Regression)
    needs: [security_scans]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      asvs_regression: ${{ steps.asvs.outputs.regression }}

    steps:
      - name: Prepare artifact directory (fix permission)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf security-reports
          mkdir -p security-reports

      - uses: actions/checkout@v4

      - name: Download security-reports artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - id: asvs
        name: ASVS regression gate -> output
        shell: bash
        run: |
          set -euo pipefail
          if python3 scripts/asvs_regression_gate.py \
            security-reports/governance/asvs-coverage.json \
            security-baselines/asvs-baseline.json; then
            echo "regression=false" >> "$GITHUB_OUTPUT"
          else
            echo "regression=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Apply PR labels (ASVS -> OWASP)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/asvs_to_labels.py

# =====================================================
# 3) UPDATE BASELINES (MAIN ONLY)
# =====================================================
  update_baselines:
    name: Update baselines (main only)
    needs: [security_scans, governance]
    if: github.ref == 'refs/heads/main' && needs.security_scans.outputs.gate_failed == 'false'
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - name: Prepare artifact directory (fix permission)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf security-reports
          mkdir -p security-reports

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download security-reports artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Write baselines
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${BASELINE_DIR}"
          cp "${REPORT_DIR}/semgrep.json" "${BASELINE_DIR}/semgrep-baseline.json"
          cp "${REPORT_DIR}/governance/asvs-coverage.json" "${BASELINE_DIR}/asvs-baseline.json"

      - name: Commit & push baselines (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "devsecops-bot"
          git config user.email "devsecops@vulnbank.local"

          git add "${BASELINE_DIR}" || true

          if ! git diff --cached --quiet; then
            git commit -m "chore(security): update baselines [auto]"
            git push
          else
            echo "[INFO] No baseline changes"
          fi

# =====================================================
# 4) SLACK (RISK-AWARE)
# =====================================================
  slack_notify:
    name: Slack notify (risk-aware)
    needs: [security_scans, governance]
    runs-on: self-hosted
    if: always()
    permissions:
      contents: read
    steps:
      - name: Prepare artifact directory (fix permission)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf security-reports
          mkdir -p security-reports

      - name: Download security-reports artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Slack decision notify
        shell: bash
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GATE_FAILED: ${{ needs.security_scans.outputs.gate_failed }}
          ASVS_REGRESSION: ${{ needs.governance.outputs.asvs_regression }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          python3 scripts/slack_decision.py

# =====================================================
# 5) SLACK â€“ SCA CRITICAL / EPSS HIGH
# =====================================================
  slack_sca_alert:
    name: Slack Alert â€“ SCA Critical / EPSS High
    needs: [security_scans]
    runs-on: self-hosted
    if: always()
    permissions:
      contents: read

    steps:
      - name: Prepare artifact directory
        shell: bash
        run: |
          set -euo pipefail
          rm -rf security-reports
          mkdir -p security-reports

      - name: Download security-reports artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Slack SCA notification
        shell: bash
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          REPORT_DIR: security-reports
          EPSS_THRESHOLD: ${{ env.EPSS_THRESHOLD }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          set -euo pipefail
          python3 scripts/slack_sca_alert.py

# =====================================================
# 6) DEFECTDOJO â€“ AUTO CLOSE FINDINGS ON PR MERGE
# =====================================================
  defectdojo_autoclose_on_merge:
    name: DefectDojo â€“ Auto-close findings on PR merge
    runs-on: ubuntu-latest

    # ðŸ”’ ONLY when PR is merged
    if: >
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true

    needs:
      - create_engagement

    permissions:
      contents: read

    env:
      DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      DEFECTDOJO_ENGAGEMENT_ID: ${{ needs.create_engagement.outputs.engagement_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Auto-close DefectDojo findings + complete engagement
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/defectdojo_autoclose_on_merge.py


