name: Vuln Bank Ultra Modular CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  id-token: write
  issues: write
  actions: read
  packages: write

env:
  REGISTRY: docker.io
  IMAGE_NAME: vuln-bank
  REPORT_DIR: security-reports

jobs:
  checkout:
    uses: ./.github/workflows/jobs/01_checkout.yml

  sonarqube_sast:
    needs: checkout
    uses: ./.github/workflows/jobs/02_sonarqube.yml

  semgrep:
    needs: checkout
    uses: ./.github/workflows/jobs/03_semgrep.yml

  snyk_sca:
    needs: checkout
    uses: ./.github/workflows/jobs/04_snyk.yml

  trivy_fs:
    needs: checkout
    uses: ./.github/workflows/jobs/05_trivy.yml

  checkov_iac:
    needs: checkout
    uses: ./.github/workflows/jobs/06_checkov.yml

  build_and_push:
    needs: [semgrep, snyk_sca, trivy_fs, checkov_iac]
    uses: ./.github/workflows/jobs/07_build_push.yml

  cosign_sign:
    needs: build_and_push
    uses: ./.github/workflows/jobs/08_cosign.yml

  zap_dast:
    needs: cosign_sign
    uses: ./.github/workflows/jobs/09_zap.yml

  auto_issue:
    needs: [semgrep, snyk_sca, trivy_fs]
    uses: ./.github/workflows/jobs/10_auto_issue.yml

  deploy_vm2:
    needs: build_and_push
    uses: ./.github/workflows/jobs/11_deploy_vm2.yml
