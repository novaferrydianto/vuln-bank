name: Vuln Bank CI

permissions:
  contents: read
  packages: write
  id-token: write   # required for cosign + slsa

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: vuln-bank-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  IMAGE_REPO: xbash81/vuln-bank
  EPSS_THRESHOLD: "0.5"

jobs:
  ci_security_build:
    name: Security Scan ‚Üí Build ‚Üí Trust
    runs-on: [self-hosted, linux]

    steps:
      # ==================================================
      # 0) CHECKOUT & BASE PREP
      # ==================================================
      - uses: actions/checkout@v4

      - run: mkdir -p "$REPORT_DIR"

      - name: Ensure required CLI tools
        run: |
          for cmd in jq bc curl; do
            command -v $cmd >/dev/null || sudo yum install -y $cmd || sudo apt-get install -y $cmd
          done

      # ==================================================
      # 1) SECURITY SCANS (SAME AS YOU HAVE)
      # ==================================================
      # Gitleaks / pip-audit / Bandit / Trivy FS & Image
      # (UNCHANGED ‚Äì OMITTED HERE FOR BREVITY)
      # ==================================================

      # ==================================================
      # 7) SECURITY GATE
      # ==================================================
      - name: Security gate (Severity + EPSS)
        run: |
          # ‚úÖ unchanged ‚Äì your logic is correct
          # gate logic here

      # ==================================================
      # üîê 8) PUSH IMAGE (MAIN ONLY)
      # ==================================================
      - name: Push trusted image
        if: github.ref == 'refs/heads/main'
        id: push
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

          docker tag "$IMAGE_REPO:${{ github.sha }}" "$IMAGE_REPO:latest"
          docker push "$IMAGE_REPO:${{ github.sha }}"
          docker push "$IMAGE_REPO:latest"

          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' \
            "$IMAGE_REPO:${{ github.sha }}")
          echo "IMAGE_DIGEST=$DIGEST" >> "$GITHUB_OUTPUT"

      # ==================================================
      # üîê 9) INSTALL TRUST TOOLS (MAIN ONLY)
      # ==================================================
      - name: Install Syft & Cosign
        if: github.ref == 'refs/heads/main'
        run: |
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          curl -sSL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b "$BIN"

          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o "$BIN/cosign"
          chmod +x "$BIN/cosign"

      # ==================================================
      # üîê 10) SBOM (MAIN ONLY)
      # ==================================================
      - name: Generate SBOM
        if: github.ref == 'refs/heads/main'
        run: |
          syft "${{ steps.push.outputs.IMAGE_DIGEST }}" \
            -o json > "$REPORT_DIR/sbom.json"

      # ==================================================
      # üîê 11) COSIGN SIGN (MAIN ONLY)
      # ==================================================
      - name: Cosign sign image
        if: github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes "${{ steps.push.outputs.IMAGE_DIGEST }}"

      # ==================================================
      # üîê 12) SLSA PROVENANCE (LEVEL 3)
      # ==================================================
      - name: Generate SLSA provenance
        if: github.ref == 'refs/heads/main'
        uses: slsa-framework/slsa-github-generator/actions/container@v1
        with:
          image: ${{ env.IMAGE_REPO }}
          digest: ${{ steps.push.outputs.IMAGE_DIGEST }}

      # ==================================================
      # 13) UPLOAD ARTIFACTS
      # ==================================================
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-security-reports
          path: security-reports
