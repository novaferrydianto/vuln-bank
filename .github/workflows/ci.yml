name: Vuln Bank CI

permissions:
  contents: read
  packages: write
  id-token: write   # for cosign keyless

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: vuln-bank-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  IMAGE_REPO: xbash81/vuln-bank
  EPSS_THRESHOLD: "0.5"

jobs:
  build:
    name: Security Scan â†’ Build â†’ Sign
    runs-on: [self-hosted, linux]

    steps:
      # --------------------------------------------------
      # 0) CHECKOUT & TOOLING
      # --------------------------------------------------
      - uses: actions/checkout@v4
      - run: mkdir -p "$REPORT_DIR"

      - name: Ensure base tools
        run: |
          for c in jq bc curl; do
            command -v $c >/dev/null || sudo yum install -y $c || sudo apt-get install -y $c
          done

      # --------------------------------------------------
      # 1) SECURITY SCANS (INTENTIONALLY OMITTED)
      # --------------------------------------------------
      # gitleaks / pip-audit / bandit / trivy fs + image
      # keep as-is from your previous version

      # --------------------------------------------------
      # 2) SECURITY GATE
      # --------------------------------------------------
      - name: EPSS + Severity Gate
        run: |
          critical=false
          epss=false

          if jq -e '..|objects|select((.Severity?=="HIGH")or(.Severity?=="CRITICAL"))' \
            "$REPORT_DIR"/*.json >/dev/null 2>&1; then
            critical=true
          fi

          if [ -f "$REPORT_DIR/trivy-image.json" ]; then
            for cve in $(jq -r '.Results[].Vulnerabilities[]?.VulnerabilityID' "$REPORT_DIR/trivy-image.json"); do
              score=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" | jq -r '.data[0].epss // 0')
              (( $(echo "$score >= $EPSS_THRESHOLD" | bc -l) )) && epss=true
            done
          fi

          if $critical && $epss; then
            echo "âŒ CI BLOCKED"
            exit 1
          fi

      # --------------------------------------------------
      # ðŸ” 3) BUILD + PUSH (MAIN ONLY)
      # --------------------------------------------------
      - name: Build image
        run: |
          docker build -f containers/app/Dockerfile -t "$IMAGE_REPO:${{ github.sha }}" .

      - name: Push image
        if: github.ref == 'refs/heads/main'
        id: push
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker tag "$IMAGE_REPO:${{ github.sha }}" "$IMAGE_REPO:latest"
          docker push "$IMAGE_REPO:${{ github.sha }}"
          docker push "$IMAGE_REPO:latest"

          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_REPO:${{ github.sha }}")
          echo "IMAGE_DIGEST=$DIGEST" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # ðŸ” 4) SBOM + COSIGN (MAIN ONLY)
      # --------------------------------------------------
      - name: Install syft + cosign
        if: github.ref == 'refs/heads/main'
        run: |
          BIN="$RUNNER_TEMP/bin"; mkdir -p "$BIN"; echo "$BIN" >> "$GITHUB_PATH"
          curl -sSL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b "$BIN"
          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o "$BIN/cosign"
          chmod +x "$BIN/cosign"

      - name: Generate SBOM
        if: github.ref == 'refs/heads/main'
        run: |
          syft "${{ steps.push.outputs.IMAGE_DIGEST }}" -o json > "$REPORT_DIR/sbom.json"

      - name: Cosign sign image
        if: github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes "${{ steps.push.outputs.IMAGE_DIGEST }}"

      # --------------------------------------------------
      # 5) ARTIFACTS
      # --------------------------------------------------
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-security-artifacts
          path: security-reports
