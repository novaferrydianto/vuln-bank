name: Vuln Bank CI

permissions:
  contents: read
  packages: write
  id-token: write   # required for cosign keyless signing (OIDC)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: vuln-bank-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  IMAGE_REPO: xbash81/vuln-bank
  EPSS_THRESHOLD: "0.5"

jobs:
  ci_security_build:
    name: Security Scan → Build → Gate
    runs-on: [self-hosted, linux]

    steps:
      # ==================================================
      # 0) CHECKOUT & BASE PREP
      # ==================================================
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Prepare report directory
        run: mkdir -p "$REPORT_DIR"

      - name: Ensure required CLI tools
        run: |
          for cmd in jq bc curl; do
            if ! command -v $cmd >/dev/null 2>&1; then
              sudo yum install -y $cmd || sudo apt-get install -y $cmd
            fi
          done

      # ==================================================
      # 1) SECRET SCANNING – GITLEAKS
      # ==================================================
      - name: Secret scan (Gitleaks)
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          export PATH="$BIN:$PATH"

          if ! command -v gitleaks >/dev/null; then
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.24.3/gitleaks_8.24.3_linux_x64.tar.gz \
              | tar -xz -C "$BIN"
            chmod +x "$BIN/gitleaks"
          fi

          gitleaks detect \
            --source . \
            --no-git \
            --redact \
            --report-format json \
            --report-path "$REPORT_DIR/gitleaks.json" || true

      # ==================================================
      # 2) SCA – pip-audit
      # ==================================================
      - name: Dependency scan (pip-audit)
        continue-on-error: true
        run: |
          $PYTHON_BIN -m pip install --upgrade pip pip-audit
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f json -o "$REPORT_DIR/pip-audit.json" || true
          fi

      # ==================================================
      # 3) SAST – Bandit
      # ==================================================
      - name: Static analysis (Bandit)
        continue-on-error: true
        run: |
          $PYTHON_BIN -m pip install bandit
          bandit -r . -f json -o "$REPORT_DIR/bandit.json" || true

      # ==================================================
      # 4) MISCONFIGURATION – TRIVY
      # ==================================================
      - name: Trivy filesystem scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-fs.json
          severity: HIGH,CRITICAL

      - name: Trivy config scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: config
          scan-ref: .
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-config.json
          severity: HIGH,CRITICAL

      # ==================================================
      # 5) BUILD IMAGE
      # ==================================================
      - name: Runner cleanup (pre-build)
        run: |
          docker system prune -af || true
          docker builder prune -af || true
          rm -rf ~/.cache/trivy || true

      - name: Build container image
        run: |
          docker build \
            -f containers/app/Dockerfile \
            -t "$IMAGE_REPO:${{ github.sha }}" \
            .

      # ==================================================
      # 6) IMAGE SCAN – TRIVY
      # ==================================================
      - name: Trivy image scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ github.sha }}
          format: json
          output: ${{ env.REPORT_DIR }}/trivy-image.json
          severity: HIGH,CRITICAL

      # ==================================================
      # 7) SECURITY GATE (SEVERITY + EPSS)
      # ==================================================
      - name: Security gate (Severity + EPSS)
        shell: bash
        run: |
          set -euo pipefail

          critical=false
          epss=false

          if jq -e '
            .. | objects |
            select(
              (.Severity? == "HIGH") or
              (.Severity? == "CRITICAL") or
              (.severity? == "HIGH") or
              (.severity? == "CRITICAL")
            )
          ' "$REPORT_DIR"/*.json >/dev/null 2>&1; then
            critical=true
          fi

          if [ -f "$REPORT_DIR/trivy-image.json" ]; then
            CVES=$(jq -r '.Results[].Vulnerabilities[]?.VulnerabilityID' \
              "$REPORT_DIR/trivy-image.json" | sort -u)

            for cve in $CVES; do
              score=$(curl -s "https://api.first.org/data/v1/epss?cve=$cve" \
                | jq -r '.data[0].epss // 0')
              if (( $(echo "$score >= $EPSS_THRESHOLD" | bc -l) )); then
                epss=true
              fi
            done
          fi

          if [ "$critical" = true ] && [ "$epss" = true ]; then
            echo "❌ CI BLOCKED: Exploitable vulnerabilities detected"
            exit 1
          fi

          echo "✅ CI PASSED: Artifact is deployable"

      # ==================================================
      # 8) PUSH TRUSTED IMAGE (CAPTURE DIGEST)
      # ==================================================
      - name: Push trusted image
        if: success()
        id: push
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

          docker tag "$IMAGE_REPO:${{ github.sha }}" "$IMAGE_REPO:latest"
          docker push "$IMAGE_REPO:${{ github.sha }}"
          docker push "$IMAGE_REPO:latest"

          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' \
            "$IMAGE_REPO:${{ github.sha }}")

          echo "IMAGE_DIGEST=$DIGEST" >> "$GITHUB_OUTPUT"

      # ==================================================
      # 9) INSTALL SBOM + SIGNING TOOLS
      # ==================================================
      - name: Install Syft & Cosign
        run: |
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          curl -sSL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b "$BIN"

          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o "$BIN/cosign"
          chmod +x "$BIN/cosign"

      # ==================================================
      # 10) SBOM GENERATION (DIGEST-BASED)
      # ==================================================
      - name: Generate SBOM
        run: |
          syft "${{ steps.push.outputs.IMAGE_DIGEST }}" \
            -o json > "$REPORT_DIR/sbom.json"

      # ==================================================
      # 11) SIGN IMAGE (COSIGN KEYLESS)
      # ==================================================
      - name: Cosign sign image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes "${{ steps.push.outputs.IMAGE_DIGEST }}"

      # ==================================================
      # 12) VERIFY SIGNATURE (PR-SAFE)
      # ==================================================
      - name: Cosign verify image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-identity-regexp \
            "https://github.com/${{ github.repository }}/.github/workflows/ci.yml@refs/.*" \
            --certificate-oidc-issuer \
            "https://token.actions.githubusercontent.com" \
            "${{ steps.push.outputs.IMAGE_DIGEST }}"

      # ==================================================
      # 13) UPLOAD ARTIFACTS
      # ==================================================
      - name: Upload CI reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-security-reports
          path: security-reports
