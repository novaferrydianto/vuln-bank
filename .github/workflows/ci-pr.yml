name: Vuln Bank – PR Security Gate

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
# =====================================================
# 0) PYTHON COMPATIBILITY GUARD (FAST, RUNTIME ONLY)
# =====================================================
  python_guard:
    name: Python 3.8 Compatibility Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Ruff
        run: pip install -q ruff==0.5.5

      - name: Python syntax & runtime compatibility (py38)
        run: |
          ruff check scripts \
            --target-version py38 \
            --select E,F \
            --ignore \
              E401,E701,E702,E741,E722, \
              F401,F541, \
              UP006,UP007,UP015,UP034 \
            --output-format github

      - name: Bytecode compile (runtime truth)
        run: |
          python3 -m compileall scripts

# =====================================================
# 1) PR SECURITY GATE (FAST)
# =====================================================
  pr_security_gate:
    name: PR Security Gate (Fast)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Security Scan Core (PR)
        uses: ./.github/actions/security-scan
        with:
          mode: pr
          run_dast: "false"
          epss_threshold: "0.5"

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      - name: Block PR if security gate failed
        shell: bash
        run: |
          set -euo pipefail
          if [ -f security-reports/gate_failed ]; then
            echo "❌ PR blocked: new exploitable risk detected"
            exit 1
          fi
          echo "✅ PR security gate passed"
