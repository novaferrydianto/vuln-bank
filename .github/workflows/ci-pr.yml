name: Vuln Bank – PR Security Gate (Fast)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  EPSS_THRESHOLD: "0.5"

jobs:
  # ==================================================
  # 0) PYTHON COMPATIBILITY GUARD (PY38+)
  # ==================================================
  python_guard:
    name: Python Compatibility Guard (py38+)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Ruff AST + compatibility check
        shell: bash
        run: |
          set -euo pipefail
          pip install -q ruff==0.5.5
          ruff check scripts \
            --target-version py38 \
            --output-format github

  # ==================================================
  # 1) PR SECURITY GATE (FAST, NO DAST)
  # ==================================================
  pr_security_gate:
    name: PR Security Gate (Fast)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      # ---------------- CORE SCAN ----------------
      - name: Security Scan Core (PR mode)
        uses: ./.github/actions/security-scan
        with:
          mode: pr
          run_dast: "false"
          epss_threshold: ${{ env.EPSS_THRESHOLD }}

      # ---------------- SARIF UPLOAD ----------------
      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      # ---------------- FINAL PR DECISION ----------------
      - name: Enforce PR security gate
        shell: bash
        run: |
          set -euo pipefail
          if [ -f security-reports/gate_failed ]; then
            echo "❌ PR blocked: new security risk detected"
            exit 1
          fi
          echo "✅ PR security gate passed"
