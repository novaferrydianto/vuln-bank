name: Vuln Bank ‚Äì PR Security Gate

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"

jobs:
# =====================================================
# 0) DEFECTDOJO AUTO-CLOSE (ON MERGE)
# =====================================================
  defectdojo_autoclose:
    name: DefectDojo ‚Äì Auto-close findings on merge
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Auto-close DefectDojo findings
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          python3 scripts/defectdojo_autoclose_on_merge.py

# =====================================================
# 1) PYTHON RUNTIME COMPATIBILITY GUARD
# =====================================================
  python_guard:
    name: Python 3.8 Compatibility Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Python syntax & runtime compatibility
        run: |
          pip install -q ruff==0.5.5
          ruff check scripts \
            --target-version py38 \
            --select E,F \
            --ignore E401,E501,E701,E702,E741,E722,F401,F541,UP006,UP007,UP015,UP034

      - name: Bytecode compile
        run: python3 -m compileall scripts

# =====================================================
# 2) PR SECURITY SCAN (FAST, NO DAST)
# =====================================================
  pr_security_gate:
    name: PR Security Gate (EPSS-aware)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Security Scan Core (PR)
        uses: ./.github/actions/security-scan
        with:
          mode: pr
          run_dast: "false"
          epss_threshold: ${{ env.EPSS_THRESHOLD }}

      - name: Upload Gitleaks SARIF
        if: hashFiles('security-reports/gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      - name: Sync findings to DefectDojo (PR preview)
        if: always()
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          set -euo pipefail

          # Skip if no findings
          if [ ! -f security-reports/trivy-sca.json ]; then
            echo "‚ÑπÔ∏è No Trivy report, skipping DefectDojo sync"
            exit 0
          fi

          # Skip silently if DefectDojo not configured
          if [ -z "${DEFECTDOJO_API_KEY}" ] || [ -z "${DEFECTDOJO_URL}" ]; then
            echo "‚ÑπÔ∏è DefectDojo secrets not configured, skipping"
            exit 0
          fi

          scripts/defectdojo_import.sh \
            "Trivy Scan (PR Preview)" \
            security-reports/trivy-sca.json \
            false

      - name: PR Security Summary (Risk Delta + EPSS)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="$(python3 scripts/pr_security_summary.py)"
          jq -Rn --arg body "$BODY" '{body: $body}' > payload.json

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d @payload.json

      - name: Block PR if security gate failed
        run: |
          if [ -f "${REPORT_DIR}/gate_failed" ]; then
            exit 1
          fi

      - name: Notify Slack on gate failure
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          # Exit if no gate failure
          if [ ! -f security-reports/gate_failed ]; then
            exit 0
          fi

          # Exit silently if webhook not configured
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "‚ÑπÔ∏è Slack webhook not configured, skipping notification"
            exit 0
          fi

          BODY="$(python3 scripts/pr_security_summary.py)"
          jq -n --arg text "üö® *PR Security Gate Failed*\n$BODY" '{text:$text}' | \
            curl -s -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d @-