name: Vuln Bank – PR Security Gate

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  python_guard:
    uses: ./.github/workflows/python-compat-guard.yml
    with:
      target_version: py38

  pr_security_gate:
    name: PR Security Gate (Fast)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      # ---------------- CORE SCAN (NO DAST) ----------------
      - name: Security Scan (PR)
        uses: ./.github/actions/security-scan
        with:
          mode: pr
          run_dast: "false"
          epss_threshold: "0.5"

      # ---------------- SANITY ----------------
      - name: Sanity check reports
        shell: bash
        run: |
          test -d security-reports || exit 1

      # ---------------- SARIF ----------------
      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      # ---------------- FINAL PR DECISION ----------------
      - name: Block PR if gate failed
        shell: bash
        run: |
          if [ -f security-reports/gate_failed ]; then
            echo "❌ PR blocked: new security risk detected"
            exit 1
          fi
          echo "✅ PR security gate passed"
