name: Vuln Bank – PR Security Gate

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  REPORT_DIR: security-reports
  EPSS_THRESHOLD: "0.5"

jobs:
# =====================================================
# 0) PYTHON RUNTIME COMPATIBILITY GUARD (FAST, HARD FAIL)
# =====================================================
  python_guard:
    name: Python 3.8 Compatibility Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Syntax + runtime compatibility (py38)
        shell: bash
        run: |
          set -euo pipefail
          pip install -q ruff==0.5.5
          ruff check scripts \
            --target-version py38 \
            --select E,F \
            --ignore E401,E701,E702,E741,E722,F401,F541,UP006,UP007,UP015,UP034 \
            --output-format github

      - name: Bytecode compile (runtime truth)
        run: |
          python3 -m compileall scripts

# =====================================================
# 1) PR SECURITY SCAN (NO DAST, FAST)
# =====================================================
  pr_security_gate:
    name: PR Security Gate (EPSS-aware)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      # ---------------- CORE SCAN ----------------
      - name: Security Scan Core (PR)
        uses: ./.github/actions/security-scan
        with:
          mode: pr
          run_dast: "false"
          epss_threshold: ${{ env.EPSS_THRESHOLD }}

      # ---------------- SARIF ----------------
      - name: Upload Gitleaks SARIF
        if: always() && hashFiles('security-reports/gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      # ---------------- DEFECTDOJO (PR = INACTIVE) ----------------
      - name: Sync findings to DefectDojo (PR preview)
        if: always()
        env:
          DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
          DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
          DEFECTDOJO_PRODUCT_ID: ${{ secrets.DEFECTDOJO_PRODUCT_ID }}
          DEFECTDOJO_ENGAGEMENT_ID: ${{ secrets.DEFECTDOJO_ENGAGEMENT_ID }}
        run: |
          scripts/defectdojo_import.sh \
            "Trivy Scan" \
            security-reports/trivy-sca.json \
            false || true

      # ---------------- PR COMMENT SUMMARY ----------------
      - name: PR Security Summary (Risk Delta + EPSS)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="$(python3 scripts/pr_security_summary.py)"
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "$BODY"

      # ---------------- FINAL PR GATE ----------------
      - name: Block PR if security gate failed
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${REPORT_DIR}/gate_failed" ]; then
            echo "❌ PR blocked: exploitable risk detected (EPSS / KEV)"
            exit 1
          fi
          echo "✅ PR security gate passed"
