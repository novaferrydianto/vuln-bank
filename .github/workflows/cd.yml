name: Vuln Bank CD

on:
  workflow_run:
    workflows: ["Vuln Bank CI"]
    types: [completed]

env:
  IMAGE_REPO: xbash81/vuln-bank
  APP_HOST: 192.168.107.135
  SSH_USER: hosting
  DAST_TARGET_URL: http://192.168.107.135:5000

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, linux]

    steps:
      # --------------------------------------------------
      # 1) DEPLOY TRUSTED IMAGE
      # --------------------------------------------------
      - name: Deploy to VM2
        run: |
          ssh $SSH_USER@$APP_HOST << EOF
            cd /opt/vuln-bank/containers/app
            export IMAGE_WITH_TAG=$IMAGE_REPO:${{ github.event.workflow_run.head_sha }}
            docker compose pull
            docker compose up -d
          EOF

      # --------------------------------------------------
      # 2) HEALTHCHECK
      # --------------------------------------------------
      - name: App Healthcheck
        run: |
          for i in {1..20}; do
            curl -sf "$DAST_TARGET_URL/healthz" && exit 0
            sleep 5
          done
          exit 1

      # --------------------------------------------------
      # 3) RUNTIME DAST
      # --------------------------------------------------
      - name: OWASP ZAP Baseline
        continue-on-error: true
        run: |
          docker run --rm \
            -v "$PWD:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$DAST_TARGET_URL" \
              -J zap-report.json || true

      # --------------------------------------------------
      # 4) SLACK NOTIFICATION (RUNTIME ONLY)
      # --------------------------------------------------
      - name: Slack Alert (Runtime)
        if: always()
        run: |
          curl -X POST -H "Content-type: application/json" \
            --data '{"text":":rocket: Vuln Bank deployed successfully"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
