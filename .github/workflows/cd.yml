name: Vuln Bank CD

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

env:
  IMAGE_REPO: xbash81/vuln-bank
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_BUILDKIT: 1
  KUBECONFIG: /home/bastion/.kube/config

jobs:
  release:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      # --- Docker Auth ---
      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password-stdin

      # --- Build & Push ---
      - name: Build
        run: docker build -t $IMAGE_REPO:$IMAGE_TAG .

      - name: Push
        run: docker push $IMAGE_REPO:$IMAGE_TAG

      # --- Cosign ---
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: Sign Image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes $IMAGE_REPO:$IMAGE_TAG

      - name: Verify Signature
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-identity-regexp \
            "https://github.com/.+/.+/.github/workflows/cd.yml@refs/heads/main" \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            $IMAGE_REPO:$IMAGE_TAG

      # --- Deploy ---
      - name: Deploy to K8s
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$IMAGE_REPO:$IMAGE_TAG|g" k3s/app/*.yml
          kubectl apply -f k3s/db/
          kubectl apply -f k3s/app/
