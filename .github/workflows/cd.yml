name: Vuln Bank CD

permissions:
  contents: read
  id-token: write   # REQUIRED for cosign verify & slsa

on:
  workflow_run:
    workflows: ["Vuln Bank CI"]
    types: [completed]

env:
  IMAGE_REPO: xbash81/vuln-bank
  APP_HOST: 192.168.107.135
  SSH_USER: hosting
  SSH_PORT: 22
  DAST_TARGET_URL: http://192.168.107.135:5000

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, linux]

    steps:
      # ==================================================
      # 0) INSTALL TRUST TOOLING
      # ==================================================
      - name: Install Cosign & SLSA tools
        run: |
          BIN="$RUNNER_TEMP/bin"
          mkdir -p "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"

          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 \
            -o "$BIN/cosign"
          chmod +x "$BIN/cosign"

          curl -sSL https://github.com/slsa-framework/slsa-verifier/releases/latest/download/slsa-verifier-linux-amd64 \
            -o "$BIN/slsa-verifier"
          chmod +x "$BIN/slsa-verifier"

      # ==================================================
      # 1) RESOLVE IMAGE DIGEST (FROM CI)
      # ==================================================
      - name: Resolve image digest
        id: digest
        run: |
          DIGEST=$(skopeo inspect docker://${IMAGE_REPO}:latest | jq -r .Digest)
          echo "IMAGE_DIGEST=${IMAGE_REPO}@${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "âœ… Deploying ${IMAGE_REPO}@${DIGEST}"

      # ==================================================
      # 2) COSIGN VERIFY (MANDATORY)
      # ==================================================
      - name: Verify image signature (Cosign)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*$" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            "${{ steps.digest.outputs.IMAGE_DIGEST }}"

      # ==================================================
      # 3) SLSA PROVENANCE VERIFY (MANDATORY)
      # ==================================================
      - name: Verify SLSA provenance
        run: |
          slsa-verifier verify-image \
            "${{ steps.digest.outputs.IMAGE_DIGEST }}" \
            --source-uri "github.com/${{ github.repository }}" \
            --builder-id "https://github.com/actions/runner"

      # ==================================================
      # 4) DEPLOY TRUSTED IMAGE (BY DIGEST)
      # ==================================================
      - name: Deploy trusted image to VM2
        env:
          IMAGE_WITH_DIGEST: ${{ steps.digest.outputs.IMAGE_DIGEST }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" << EOF
              set -e
              cd /opt/vuln-bank/containers/app

              echo '${{ secrets.DOCKERHUB_TOKEN }}' | \
                docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin

              export IMAGE_WITH_TAG="$IMAGE_WITH_DIGEST"
              export DB_HOST="$DB_HOST"
              export DB_USER="$DB_USER"
              export DB_PASSWORD="$DB_PASSWORD"
              export DEEPSEEK_API_KEY="$DEEPSEEK_API_KEY"

              docker compose pull
              docker compose up -d
          EOF

      # ==================================================
      # 5) IMAGE RETENTION (SAFE)
      # ==================================================
      - name: Docker image retention on VM2
        run: |
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" \
            "KEEP_IMAGES=5 sudo /usr/local/bin/vuln-bank-image-retention.sh"

      # ==================================================
      # 6) HEALTHCHECK
      # ==================================================
      - name: App Healthcheck
        run: |
          for i in {1..20}; do
            curl -sf "$DAST_TARGET_URL/healthz" && exit 0
            sleep 5
          done
          exit 1

      # ==================================================
      # 7) RUNTIME DAST
      # ==================================================
      - name: OWASP ZAP Baseline
        continue-on-error: true
        run: |
          docker run --rm \
            -v "$PWD:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$DAST_TARGET_URL" \
              -J zap-runtime.json || true

      # ==================================================
      # 8) SLACK NOTIFICATION
      # ==================================================
      - name: Slack Alert (Runtime)
        if: always()
        run: |
          curl -X POST -H "Content-type: application/json" \
            --data '{"text":":shield: Vuln Bank deployed with verified supply chain"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
