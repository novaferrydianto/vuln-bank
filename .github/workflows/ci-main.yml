name: Vuln Bank – Main Security Pipeline (Authoritative)

on:
  push:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *" # ~01:00 WIB nightly assurance
  workflow_dispatch:

concurrency:
  group: main-security
  cancel-in-progress: true

permissions:
  contents: write
  security-events: write

env:
  REPORT_DIR: security-reports
  BASELINE_DIR: security-baselines
  METRICS_DIR: security-metrics
  EPSS_THRESHOLD: "0.5"

jobs:
# =====================================================
# 0) PYTHON COMPATIBILITY GUARD (HARD BLOCK)
# =====================================================
  python_guard:
    name: Python 3.8 Compatibility Guard
    uses: ./.github/workflows/python-compat-guard.yml
    with:
      target_version: py38

# =====================================================
# 1) AUTHORITATIVE SECURITY SCAN (WITH DAST)
# =====================================================
  scan_authoritative:
    name: Scan + DAST + ASVS (Source of Truth)
    needs: [python_guard]
    runs-on: self-hosted
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false

      # ---------------- CORE SCAN ----------------
      - name: Security Scan Core (Authoritative)
        uses: ./.github/actions/security-scan
        with:
          mode: main
          run_dast: "true"
          epss_threshold: ${{ env.EPSS_THRESHOLD }}
          zap_fail_severity: "HIGH"

      # ---------------- SARIF ----------------
      - name: Upload Gitleaks SARIF
        if: always() && hashFiles('security-reports/gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: security-reports/gitleaks.sarif

      # ---------------- FINAL GATE ----------------
      - name: Enforce security gate
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "${REPORT_DIR}/gate_failed" ]; then
            echo "❌ Main pipeline blocked by security gate"
            exit 1
          fi
          echo "✅ Authoritative security gate passed"

      # ---------------- ARTIFACT ----------------
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports

# =====================================================
# 2) SINGLE WRITER – BASELINES, METRICS, PAGES
# =====================================================
  write_truth:
    name: Write baselines, trends, and Pages data
    needs: [scan_authoritative]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: security-reports

      - name: Prepare directories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p \
            "${BASELINE_DIR}" \
            "${METRICS_DIR}/weekly" \
            docs/data/trends

      # ---------------- TRENDS ----------------
      - name: Append security trends
        shell: bash
        run: |
          set -euo pipefail

          python3 scripts/append_pass_trend.py \
            --asvs security-reports/governance/asvs-coverage.json \
            --out "${METRICS_DIR}/weekly/pass-trend.json"

          python3 scripts/append_pass_trend.py \
            --asvs security-reports/governance/asvs-coverage.json \
            --out docs/data/trends/pass-trend.json

          python3 scripts/append_kev_trend.py \
            --epss security-reports/epss-findings.json \
            --out "${METRICS_DIR}/weekly/kev-trend.json" || true

          python3 scripts/append_kev_trend.py \
            --epss security-reports/epss-findings.json \
            --out docs/data/trends/kev-trend.json || true

      # ---------------- BASELINES ----------------
      - name: Update baselines
        shell: bash
        run: |
          set -euo pipefail
          cp security-reports/semgrep.json \
            "${BASELINE_DIR}/semgrep-baseline.json"
          cp security-reports/governance/asvs-coverage.json \
            "${BASELINE_DIR}/asvs-baseline.json"

      # ---------------- COMMIT ----------------
      - name: Commit updates (idempotent)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "security-bot"
          git config user.email "security-bot@users.noreply.github.com"

          git add \
            "${BASELINE_DIR}" \
            "${METRICS_DIR}" \
            docs/data/trends || true

          if git diff --cached --quiet; then
            echo "ℹ️ No baseline or trend changes"
          else
            git commit -m "chore(security): update baselines & trends"
            git push
          fi
