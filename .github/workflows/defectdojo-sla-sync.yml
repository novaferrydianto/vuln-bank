name: DefectDojo – SLA Governance Sync

on:
  schedule:
    - cron: "0 1 * * *"   # 08:00 WIB daily
  workflow_dispatch:

permissions:
  contents: read

jobs:
  defectdojo_sla_sync:
    name: DefectDojo SLA Sync
    runs-on: self-hosted
    timeout-minutes: 10

    env:
      DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
      DEFECTDOJO_API_KEY: ${{ secrets.DEFECTDOJO_API_KEY }}
      PYTHON_BIN: python3.11

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -------------------------------------------------
      # Guard rails – fail fast if env missing
      # -------------------------------------------------
      - name: Validate environment
        shell: bash
        run: |
          set -euo pipefail
          : "${DEFECTDOJO_URL:?Missing DEFECTDOJO_URL}"
          : "${DEFECTDOJO_API_KEY:?Missing DEFECTDOJO_API_KEY}"
          command -v ${PYTHON_BIN} >/dev/null \
            || { echo "❌ ${PYTHON_BIN} not found"; exit 1; }
          ${PYTHON_BIN} --version
          echo "✅ Environment & runtime OK"

      # -------------------------------------------------
      # DefectDojo API preflight (governance gate)
      # -------------------------------------------------
      - name: DefectDojo API health check
        shell: bash
        run: |
          set -euo pipefail

          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Token ${DEFECTDOJO_API_KEY}" \
            "${DEFECTDOJO_URL}/api/v2/users/")

          if [ "$status" != "200" ]; then
            echo "❌ DefectDojo API unhealthy (HTTP $status)"
            exit 1
          fi

          echo "✅ DefectDojo API healthy"

      # -------------------------------------------------
      # Run SLA sync (governance logic)
      # -------------------------------------------------
      - name: Sync DefectDojo SLA governance
        shell: bash
        timeout-minutes: 5
        run: |
          set -euo pipefail
          python scripts/defectdojo_sla_sync.py
