name: Vuln Bank Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: vuln-bank-security-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  PYTHON_BIN: python3.11
  IMAGE_REPO: xbash81/vuln-bank
  EPSS_THRESHOLD: "0.5"

defaults:
  run:
    shell: bash

jobs:
  security_build:
    name: Security Scan â†’ Normalize â†’ Policy â†’ Gate
    runs-on: [self-hosted, linux]
    environment: production

    outputs:
      critical_found: ${{ steps.policy_gate.outputs.critical_found }}

    steps:
    # ------------------------------------------------------------
    # 0. Checkout & Prepare
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    - name: Prepare report directory
      run: mkdir -p "$REPORT_DIR"

    # ------------------------------------------------------------
    # 1. Tool sanity
    # ------------------------------------------------------------
    - name: Ensure required CLI tools exist
      run: |
        for cmd in jq curl bc; do
          command -v $cmd >/dev/null || sudo apt-get install -y $cmd
        done

    # ------------------------------------------------------------
    # 2. Python setup
    # ------------------------------------------------------------
    - name: Install Python dependencies
      run: |
        $PYTHON_BIN -m pip install --upgrade pip
        pip install -r requirements.txt || true

    # ------------------------------------------------------------
    # 3. Scanners (Raw Inputs Only)
    # ------------------------------------------------------------
    - name: Gitleaks
      continue-on-error: true
      run: |
        gitleaks detect --source . --no-git \
          --report-format json \
          --report-path "$REPORT_DIR/gitleaks.json" || true

    - name: Bandit
      continue-on-error: true
      run: |
        bandit -r . -f json -o "$REPORT_DIR/bandit.json" || true

    - name: Semgrep
      continue-on-error: true
      run: |
        docker run --rm -v "$PWD:/src" -w /src semgrep/semgrep \
          semgrep scan --config semgrep/ --json \
          -o "$REPORT_DIR/semgrep.json"

    - name: LLM-SAST
      if: github.ref == 'refs/heads/main'
      continue-on-error: true
      env:
        AI_API_ENDPOINT: ${{ secrets.AI_API_ENDPOINT }}
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
      run: |
        cd llm-sast
        pip install -r requirements.txt
        python main.py --scan-path "$GITHUB_WORKSPACE"

    - name: Trivy FS
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: fs
        scan-ref: .
        format: json
        output: ${{ env.REPORT_DIR }}/trivy-fs.json

    - name: Trivy Image
      uses: aquasecurity/trivy-action@0.28.0
      with:
        image-ref: ${{ env.IMAGE_REPO }}:${{ github.sha }}
        format: json
        output: ${{ env.REPORT_DIR }}/trivy-image.json

    # ------------------------------------------------------------
    # 4. Normalize & Policy Engine âœ…
    # ------------------------------------------------------------
    - name: Normalize reports
      run: $PYTHON_BIN scripts/normalize_reports.py

    - name: Apply baseline
      run: $PYTHON_BIN scripts/baseline_apply.py

    - name: EPSS enrichment
      run: $PYTHON_BIN scripts/epss_enrich.py

    # ------------------------------------------------------------
    # 5. Policy Gate âœ… (SINGLE DECISION POINT)
    # ------------------------------------------------------------
    - name: Security policy gate
      id: policy_gate
      run: |
        if jq -e '
          .summary.asvs_failed == true and
          .summary.exploitable == true
        ' "$REPORT_DIR/normalized.json"; then
          echo "âŒ BLOCKED: ASVS + EPSS violated"
          echo "critical_found=true" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "critical_found=false" >> $GITHUB_OUTPUT

    # ------------------------------------------------------------
    # 6. Artifacts & Summary
    # ------------------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: vuln-bank-security-reports
        path: ${{ env.REPORT_DIR }}

  notify:
    needs: security_build
    if: needs.security_build.outputs.critical_found == 'true'
    runs-on: [self-hosted, linux]
    steps:
    - name: Slack alert
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H "Content-Type: application/json" \
          --data '{"text":"ðŸš¨ Vuln Bank blocked: exploitable ASVS violations"}' \
          "$SLACK_WEBHOOK_URL"
