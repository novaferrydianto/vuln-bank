name: Weekly OWASP Trend (GitHub Labels â†’ Metrics)

on:
  schedule:
    - cron: "0 2 * * 1"   # Monday 09:00 WIB (02:00 UTC)
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  weekly_trend:
    name: Weekly OWASP Trend Report
    runs-on: ubuntu-latest

    steps:
      - name: Generate OWASP weekly metrics from PR labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          python3 - <<'PY'
          import os, json, urllib.request, urllib.parse
          from datetime import datetime, timedelta, timezone

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          owner, name = repo.split("/", 1)

          # Last 7 days window
          since = (datetime.now(timezone.utc) - timedelta(days=7)).date().isoformat()

          owasp = [f"A{str(i).zfill(2)}" for i in range(1, 11)]
          counts = {k: 0 for k in owasp}

          def gh_get(url):
              req = urllib.request.Request(url, headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "User-Agent": "vuln-bank-weekly"
              })
              with urllib.request.urlopen(req, timeout=25) as r:
                  return json.load(r)

          # Search PRs updated/merged in last 7 days and labeled OWASP:Ax
          # We use GitHub search API over issues (PRs are issues too).
          for k in owasp:
              label = f'OWASP:{k}'
              q = f'repo:{repo} is:pr updated:>={since} label:"{label}"'
              url = "https://api.github.com/search/issues?q=" + urllib.parse.quote(q) + "&per_page=1"
              data = gh_get(url)
              counts[k] = int(data.get("total_count", 0))

          # Build ranked list
          ranked = sorted(counts.items(), key=lambda x: x[1], reverse=True)
          top = [r for r in ranked if r[1] > 0][:5]

          lines = []
          lines.append("*ðŸ“Š Weekly OWASP Trend (last 7 days)*")
          lines.append(f"Repo: `{repo}` | Window: `{since} â†’ today`")
          lines.append("")
          lines.append("*Counts by label:*")
          for k,v in ranked:
              lines.append(f"â€¢ {k}: `{v}`")

          if top:
              lines.append("")
              lines.append("*Top drivers:*")
              for k,v in top:
                  lines.append(f"â€¢ {k}: `{v}` PR(s) labeled")

          payload = {"text": "\n".join(lines)}
          print(json.dumps(payload))
          PY > slack_payload.json

      - name: Post weekly trend to Slack
        if: env.SLACK_WEBHOOK_URL != ''
        shell: bash
        run: |
          set -euo pipefail
          curl -sS -X POST -H "Content-Type: application/json" \
            --data @slack_payload.json \
            "$SLACK_WEBHOOK_URL"
