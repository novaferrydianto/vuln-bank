name: Weekly OWASP Trend

on:
  schedule:
    - cron: "0 1 * * 1"   # Senin 08:00 WIB
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  owasp_trend:
    name: Collect OWASP Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Collect merged PR OWASP labels (last 7 days)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 - <<'PY'
          import subprocess, json, datetime, collections

          since = (datetime.datetime.utcnow() - datetime.timedelta(days=7)).isoformat()+"Z"

          cmd = [
            "gh","pr","list",
            "--repo", "$REPO",
            "--state","merged",
            "--search", f"merged:>={since}",
            "--json","number,labels"
          ]

          result = subprocess.check_output(" ".join(cmd), shell=True)
          prs = json.loads(result)

          counter = collections.Counter()
          for pr in prs:
            for label in pr["labels"]:
              name = label["name"]
              if name.startswith("OWASP-"):
                counter[name] += 1

          report = {
            "period": "last_7_days",
            "total_prs": len(prs),
            "owasp_counts": dict(counter)
          }

          with open("owasp-trend.json", "w") as f:
            json.dump(report, f, indent=2)

          print(json.dumps(report, indent=2))
          PY

      - name: Upload trend artifact
        uses: actions/upload-artifact@v4
        with:
          name: owasp-trend
          path: owasp-trend.json

      - name: Slack weekly summary
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python3 - <<'PY'
          import json, os, urllib.request

          d=json.load(open("owasp-trend.json"))
          lines=[
            "*ðŸ“Š Weekly OWASP Trend*",
            f"PRs merged: `{d['total_prs']}`"
          ]

          for k,v in sorted(d["owasp_counts"].items()):
            lines.append(f"â€¢ `{k}` â†’ {v}")

          payload={"text":"\n".join(lines)}

          req=urllib.request.Request(
            os.environ["SLACK_WEBHOOK_URL"],
            data=json.dumps(payload).encode(),
            headers={"Content-Type":"application/json"}
          )
          urllib.request.urlopen(req)
          PY
