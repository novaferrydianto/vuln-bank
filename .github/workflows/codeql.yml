name: CodeQL Ultra

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "15 8 * * 4"

concurrency:
  group: codeql-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  # ==========================================================
  # 1) DETECT LANGUAGES (WITH SAFE FALLBACK)
  # ==========================================================
  detect-languages:
    name: Detect Languages
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        shell: bash
        run: |
          echo "üîç Attempting CodeQL language detection..."
          detected=$(codeql resolve languages --format=json 2>/dev/null || echo "")
          
          if [[ -z "$detected" || "$detected" == "null" ]]; then
            echo "‚ö† No languages detected. Using fallback."
            detected='["javascript-typescript","python"]'
          fi

          echo "Detected: $detected"
          echo "languages=$detected" >> $GITHUB_OUTPUT

  # ==========================================================
  # 2) MAIN ULTRA ANALYSIS
  # ==========================================================
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    needs: detect-languages

    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.detect-languages.outputs.languages) }}

    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      # ------------------------------
      # ‚ö° Caching for extreme speed
      # ------------------------------
      - name: Cache CodeQL DB
        id: cache-codeql
        uses: actions/cache@v4
        with:
          path: /home/runner/work/_temp/codeql_db_${{ matrix.language }}
          key: codeql-db-${{ matrix.language }}-${{ github.sha }}
          restore-keys: codeql-db-${{ matrix.language }}-

      # ------------------------------
      # ‚ö° Initialize CodeQL
      # ------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: none

          # FIXED: Queries must be a YAML list, not a multi-line string
          queries: >
            security-extended,
            security-and-quality
          
          # PR quick mode
          codeql-query-packs: >
            ${{ github.event_name == 'pull_request' && 'codeql-suites/code-scanning' || '' }}

          db-location: /home/runner/work/_temp/codeql_db_${{ matrix.language }}

          paths-ignore: |
            node_modules
            venv
            .venv
            vendor
            dist
            build
            static
            migrations

      # ------------------------------
      # ‚ö° Ultra optimized analysis
      # ------------------------------
      - name: Analyze ‚Äì Ultra Mode
        uses: github/codeql-action/analyze@v4
        with:
          category: ultra-${{ matrix.language }}
          add-snippets: false
          upload: true
          threads: 2
          ram: 4096

  # ==========================================================
  # 3) AUTO CLOSE SECURITY ISSUE
  # ==========================================================
  auto_close:
    name: Auto Close CodeQL Issue
    runs-on: ubuntu-latest
    needs: analyze
    permissions:
      issues: write
      security-events: read

    steps:
      - name: Auto-close issue if clean
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issues = await github.rest.issues.listForRepo({
              owner, repo, state: "open", labels: "security,critical"
            });

            if (issues.data.length === 0) return;

            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner, repo, state: "open"
            });

            if (alerts.data.length > 0) {
              console.log("‚ùå Still has unresolved CodeQL alerts");
              return;
            }

            const issue = issues.data[0];

            await github.rest.issues.createComment({
              owner, repo, issue_number: issue.number,
              body: "‚úÖ CodeQL Ultra: No remaining security findings. Auto-closed."
            });

            await github.rest.issues.update({
              owner, repo, issue_number: issue.number, state: "closed"
            });

            console.log("Issue closed successfully.");
