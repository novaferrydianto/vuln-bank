name: "CodeQL"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '15 8 * * 4'

concurrency:
  group: codeql-${{ github.ref }}
  cancel-in-progress: true

jobs:
# ==========================================================
# 1) CODEQL ANALYSIS (UNCHANGED âœ…)
# ==========================================================
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: actions
            build-mode: none
          - language: javascript-typescript
            build-mode: none
          - language: python
            build-mode: none

    steps:
      - uses: actions/checkout@v6

      # âœ… Python hygiene (ONLY runs on python job)
      - name: Set up Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Python syntax check
        if: matrix.language == 'python'
        run: |
          python -m compileall .

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

# ==========================================================
# 2) AUTO-CLOSE SECURITY ISSUE (FIX âœ…)
# ==========================================================
  auto_close_security_issue:
    name: Auto Close Security Issue (CodeQL Clean)
    runs-on: ubuntu-latest
    needs: analyze

    permissions:
      issues: write
      security-events: read
      contents: read

    steps:
      - name: Close security issue if CodeQL clean
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log("ğŸ” Looking for open security issuesâ€¦");

            // 1ï¸âƒ£ Find open security + critical issue
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: "security,critical"
            });

            if (issues.data.length === 0) {
              console.log("âœ… No open security issues found");
              return;
            }

            const issue = issues.data[0];
            console.log(`ğŸ“Œ Found issue #${issue.number}`);

            // 2ï¸âƒ£ Check open CodeQL alerts
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner,
              repo,
              state: "open"
            });

            const blocking = alerts.data.filter(a =>
              ["error", "warning"].includes(a.rule.severity)
            );

            if (blocking.length > 0) {
              console.log(`âŒ ${blocking.length} CodeQL alerts still open`);
              return;
            }

            // 3ï¸âƒ£ Close issue
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: "âœ… CodeQL results are clean. No remaining security findings. Auto-closing issue."
            });

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issue.number,
              state: "closed"
            });

            console.log(`âœ… Issue #${issue.number} closed`);
