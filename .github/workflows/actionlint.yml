name: Lint Pipeline

on:
  pull_request:
    branches: ["main"]
    paths:
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.json"
      - "**/*.md"
      - "**/*.sh"
      - "**/*.tf"
      - "**/Dockerfile"
      - ".github/workflows/**"
      - "ansible/**"
      - "k8s/**"
      - "k3s/**"

permissions:
  contents: read

jobs:
# ==========================================================
# 1) GitHub Actions Workflow Lint
# ==========================================================
  actionlint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/actionlint@v1.7.1

# ==========================================================
# 2) YAML Lint
# ==========================================================
  yamllint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y yamllint
      - run: yamllint -c .yamllint .

# ==========================================================
# 3) Markdown Lint
# ==========================================================
  markdownlint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: npm install -g markdownlint-cli
      - run: markdownlint "**/*.md"

# ==========================================================
# 4) ShellCheck
# ==========================================================
  shellcheck:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: |
          shopt -s globstar
          if ls **/*.sh 1> /dev/null 2>&1; then
            shellcheck **/*.sh
          else
            echo "No shell scripts found, skipping"
          fi

# ==========================================================
# 5) Dockerfile Lint (Hadolint)
# ==========================================================
  hadolint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: |
          curl -sL https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64 \
            -o hadolint
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      - run: |
          if ls **/Dockerfile 1> /dev/null 2>&1; then
            hadolint **/Dockerfile
          else
            echo "No Dockerfile found, skipping"
          fi

# ==========================================================
# 6) Terraform Lint
# ==========================================================
  terraform:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3.1.2

      - run: terraform fmt -check -recursive

      - run: terraform init -backend=false
      - run: terraform validate

      - run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          tflint --recursive

# ==========================================================
# 7) Ansible Lint
# ==========================================================
  ansible:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: python3 -m pip install --user ansible ansible-lint
      - run: |
          if [ -d "ansible" ]; then
            ansible-lint ansible/ --profile basic
          else
            echo "No ansible dir, skipping"
          fi

# ==========================================================
# 8) Kubernetes Lint
# ==========================================================
  k8s-lint:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz
          sudo mv kubeconform /usr/local/bin/

      - run: |
          curl -sL https://github.com/zegl/kube-score/releases/download/v1.19.0/kube-score_1.19.0_linux_amd64 \
            -o kube-score
          chmod +x kube-score
          sudo mv kube-score /usr/local/bin/

      - run: |
          if [ -d "k8s" ]; then
            kubeconform -ignore-missing-schemas k8s/
            kube-score score k8s/ --ignore-test container-image-pull-policy
          else
            echo "No k8s manifests found, skipping"
          fi

# ==========================================================
# 9) Semgrep (PR = Soft)
# ==========================================================
  semgrep:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - run: python3 -m pip install --user semgrep
      - run: |
          semgrep scan \
            --config=auto \
            --severity=ERROR \
            --exclude-dir=.terraform
