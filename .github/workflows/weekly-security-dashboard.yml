name: Vuln Bank – Weekly Security Dashboard Builder

on:
  workflow_run:
    workflows:
      - Vuln Bank – Weekly Security Data (OWASP / SLA / Scorecard)
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: weekly-dashboard-builder
  cancel-in-progress: true

jobs:
  build_dashboards:
    name: Build Static Security Dashboards
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # =================================================
      # Checkout (full history required for commit)
      # =================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # =================================================
      # Runtime
      # =================================================
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dashboard dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install reportlab matplotlib

      # =================================================
      # Pre-flight data contract checks
      # =================================================
      - name: Verify required data inputs
        run: |
          set -euo pipefail
          test -f docs/data/security-scorecard.json
          jq . docs/data/security-scorecard.json >/dev/null

          test -f docs/data/governance/asvs-coverage.json
          jq . docs/data/governance/asvs-coverage.json >/dev/null

          echo "✅ Required dashboard input data present"

      # =================================================
      # 1) ASVS Static Dashboard
      # =================================================
      - name: Generate ASVS dashboard (static HTML)
        run: |
          set -euo pipefail
          python scripts/asvs_dashboard.py \
            --scorecard docs/data/security-scorecard.json \
            --asvs docs/data/governance/asvs-coverage.json \
            --outdir docs/dashboards/asvs

      # =================================================
      # 2) EPSS / KEV Dashboard (static)
      # =================================================
      - name: Generate EPSS dashboard (static HTML)
        run: |
          set -euo pipefail
          python scripts/epss_dashboard.py \
            --input docs/data/epss-findings.json \
            --outdir docs/dashboards/epss

      # =================================================
      # 3) Executive PDFs (optional but recommended)
      # =================================================
      - name: Generate executive one-pager (PDF)
        run: |
          set -euo pipefail
          python scripts/generate_executive_summary.py
          python scripts/render_executive_pdf.py

      # =================================================
      # Guard rails – prevent JS regression forever
      # =================================================
      - name: Guard – verify static dashboards
        run: |
          set -euo pipefail

          ASVS=docs/dashboards/asvs/index.html
          EPSS=docs/dashboards/epss/index.html

          test -f "$ASVS"
          ! grep -q "app.js" "$ASVS"
          ! grep -q "Failed to load security dashboard data" "$ASVS"

          test -f "$EPSS"
          ! grep -q "app.js" "$EPSS"

          echo "✅ Dashboards are static & JS-free"

      # =================================================
      # Commit dashboards to main
      # =================================================
      - name: Commit dashboards & executive outputs
        run: |
          set -euo pipefail
          git config user.name "dashboard-bot"
          git config user.email "dashboard-bot@users.noreply.github.com"

          git add \
            docs/dashboards \
            docs/executive || true

          if git diff --cached --quiet; then
            echo "ℹ️ No dashboard changes to commit"
          else
            git commit -m "chore(dashboard): weekly static security dashboards"
            git push
          fi
