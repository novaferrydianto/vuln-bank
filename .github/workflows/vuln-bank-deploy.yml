name: Vuln Bank Deploy & DAST

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

env:
  APP_NAME: vuln-bank
  REPORT_DIR: security-reports
  IMAGE_REPO: xbash81/vuln-bank

  APP_HOST: "192.168.107.135"
  SSH_USER: "hosting"
  SSH_PORT: "22"
  DAST_TARGET_URL: "http://192.168.107.135:5000"

defaults:
  run:
    shell: bash

jobs:
  deploy_and_dast:
    name: Deploy to VM2 → ZAP DAST
    runs-on: [self-hosted, linux]

    steps:
      - name: Checkout source (for scripts/config)
        uses: actions/checkout@v4

      - name: Prepare report directory
        run: |
          set -e
          mkdir -p "$REPORT_DIR/zap"

      - name: Deploy app to VM2
        env:
          IMAGE_WITH_TAG: ${{ env.IMAGE_REPO }}:${{ github.event.inputs.image_tag }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          set -e
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" << EOF
              set -e
              cd /opt/vuln-bank/containers/app

              echo '${{ secrets.DOCKERHUB_TOKEN }}' | \
                docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin

              export IMAGE_WITH_TAG="${IMAGE_WITH_TAG}"
              export DB_HOST="${DB_HOST}"
              export DB_USER="${DB_USER}"
              export DB_PASSWORD="${DB_PASSWORD}"
              export DEEPSEEK_API_KEY="${DEEPSEEK_API_KEY}"

              echo "Using image: \$IMAGE_WITH_TAG"
              docker compose pull
              docker compose up -d
          EOF

      - name: Docker image retention on VM2
        run: |
          set -e
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$APP_HOST" \
            "KEEP_IMAGES=5 sudo /usr/local/bin/vuln-bank-image-retention.sh"

      - name: Wait for application
        run: |
          set -e
          for i in {1..30}; do
            if curl -sf "$DAST_TARGET_URL" > /dev/null; then
              echo "✅ App is reachable at $DAST_TARGET_URL"
              exit 0
            fi
            echo "Waiting for app at $DAST_TARGET_URL... ($i/30)"
            sleep 5
          done
          echo "❌ App did not become ready in time"
          exit 1

      - name: OWASP ZAP baseline scan
        continue-on-error: true
        run: |
          set -e
          mkdir -p "$REPORT_DIR/zap"
          chmod -R u+rwX "$REPORT_DIR/zap"

          docker pull ghcr.io/zaproxy/zaproxy:stable

          docker run --rm \
            --userns=keep-id \
            -v "$REPORT_DIR/zap:/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "$DAST_TARGET_URL" \
              -J /zap/wrk/zap-report.json \
              -r /zap/wrk/zap-report.html \
              -m 5 \
              -T 120 || true

          echo "✅ ZAP baseline completed"

          if jq -e '
            .site[].alerts[] |
            select(.riskcode == "3" or .riskcode == 3)
          ' "$REPORT_DIR/zap/zap-report.json" >/dev/null 2>&1; then
            echo "❌ ZAP HIGH risk vulnerabilities found"
          else
            echo "✅ No ZAP HIGH risk vulnerabilities"
          fi

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: |
            security-reports/zap/zap-report.json
            security-reports/zap/zap-report.html
          if-no-files-found: warn
