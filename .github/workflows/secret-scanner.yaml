name: Secret Scanning (TruffleHog)

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  pull_request:
    branches: [master]

jobs:
  secret_scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # =============================
      # 1) RUN TRUFFLEHOG JSON SCAN
      # =============================
      - name: üö® Run TruffleHog Scan
        run: |
          trufflehog git . --json --no-update > trufflehog-report.json || true

      # =============================
      # 2) PARSE SECRET COUNT
      # =============================
      - name: üìä Parse Secret Findings
        id: parse
        run: |
          COUNT=$(jq '. | length' trufflehog-report.json 2>/dev/null || echo "0")
          echo "SECRET_COUNT=$COUNT" >> $GITHUB_ENV
          jq -r '.[] | {File:.SourceMetadata.data.file, Line:.SourceMetadata.data.line, Detector:.DetectorName} | @json' trufflehog-report.json > secret-map.json
          echo "Found $COUNT secrets."

      # =============================
      # 3) AUTO COMMENT ON PR
      # =============================
      - name: üí¨ Comment on PR
        if: env.SECRET_COUNT != '0'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            üö® **Secret(s) Detected by TruffleHog**  
            Count: `${{ env.SECRET_COUNT }}`  
            See uploaded artifact + generated issue for details.  
            PR **cannot** be merged until resolved. üîí

      # =============================
      # 4) CREATE SECURITY ISSUE
      # =============================
      - name: üìù Create Issue
        if: env.SECRET_COUNT != '0'
        uses: peter-evans/create-issue-from-file@v6
        with:
          title: "üö® Secret Leak Detected ‚Äî Blocking PR"
          content-filepath: trufflehog-report.json
          labels: |
            security
            high-risk
            secrets

      # =============================
      # 5) UPLOAD FULL REPORT
      # =============================
      - name: üì§ Upload Full Report
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-full-report
          path: |
            trufflehog-report.json
            secret-map.json

      # =============================
      # 6) AUTO-REVOKE TOKENS (GitHub PAT)
      # =============================
      - name: üîë Auto Revoke GitHub Tokens
        if: env.SECRET_COUNT != '0'
        run: |
          echo "Checking for GitHub tokens..."
          TOKENS=$(grep -oE "gh[pousr]_[A-Za-z0-9]{36}" trufflehog-report.json || true)

          if [ -n "$TOKENS" ]; then
            echo "Revoking exposed GitHub tokens..."
            while read -r token; do
              curl -X POST \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 https://api.github.com/applications/${{ github.repository_owner }} \
                 -d "{\"access_token\":\"$token\"}"
            done <<< "$TOKENS"
          else
            echo "No GitHub PAT tokens detected."
          fi

      # =============================
      # 7) FAIL JOB ‚Üí BLOCK PR MERGE
      # =============================
      - name: ‚ùå Fail the build if secrets exist
        if: env.SECRET_COUNT != '0'
        run: |
          echo "‚ùå Secret leak detected. Blocking PR merge."
          exit 1