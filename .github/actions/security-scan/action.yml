name: "Vuln Bank – Security Scan Core"
description: >
  Reusable DevSecOps security scan core:
  Secrets, SAST, SCA + EPSS/KEV, optional DAST, ASVS export.

inputs:
  mode:
    description: "Scan mode: pr | main"
    required: false
    default: "pr"

  run_dast:
    description: "Run DAST (true/false)"
    required: false
    default: "false"

  epss_threshold:
    description: "EPSS exploitability threshold"
    required: false
    default: "0.5"

  zap_fail_severity:
    description: "ZAP fail severity"
    required: false
    default: "HIGH"

runs:
  using: "composite"
  steps:
    # ==================================================
    # PREPARE
    # ==================================================
    - name: Prepare workspace
      shell: bash
      run: |
        set -euo pipefail
        mkdir -p security-reports/zap security-reports/governance .trivy-cache
        rm -f security-reports/gate_failed || true

    # ==================================================
    # SECRETS
    # ==================================================
    - name: Gitleaks
      shell: bash
      run: |
        set -euo pipefail
        docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:v8.21.0 \
          detect --source /repo \
          --config /repo/.gitleaks.toml \
          --report-format sarif \
          --report-path /repo/security-reports/gitleaks.sarif \
          --redact \
          --exit-code 0

    - name: Gitleaks gate
      shell: bash
      run: |
        set -euo pipefail
        python3 scripts/gitleaks_gate.py security-reports/gitleaks.sarif

    # ==================================================
    # SAST
    # ==================================================
    - name: Bandit
      shell: bash
      run: |
        set -euo pipefail
        python3 -m pip install -q bandit
        bandit -r app.py database.py auth.py ai_agent_deepseek.py \
          -f json -o security-reports/bandit.json || true
        test -f security-reports/bandit.json || echo '{"results":[]}' > security-reports/bandit.json

    - name: Bandit normalize
      shell: bash
      run: |
        set -euo pipefail
        python3 scripts/bandit_normalize.py \
          security-reports/bandit.json \
          security-reports/bandit_dd.json

    - name: Semgrep
      shell: bash
      run: |
        set -euo pipefail
        docker run --rm -v "$PWD:/src" returntocorp/semgrep:1.75.0 \
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/python \
            --json \
            --output /src/security-reports/semgrep.json || true
        test -f security-reports/semgrep.json || echo '{"results":[]}' > security-reports/semgrep.json

    - name: Semgrep OWASP gate
      shell: bash
      run: |
        set -euo pipefail
        if [ "${{ inputs.mode }}" = "main" ] && [ -f security-baselines/semgrep-baseline.json ]; then
          python3 scripts/semgrep_owasp_gate.py \
            security-reports/semgrep.json \
            security-baselines/semgrep-baseline.json
        else
          python3 scripts/semgrep_owasp_gate.py security-reports/semgrep.json
        fi

    # ==================================================
    # SCA + EPSS / KEV
    # ==================================================
    - name: Trivy FS
      shell: bash
      run: |
        set -euo pipefail
        docker run --rm \
          -u "$(id -u):$(id -g)" \
          -e TRIVY_CACHE_DIR=/tmp/trivy-cache \
          -v "$PWD:/work" \
          -v "$PWD/.trivy-cache:/tmp/trivy-cache" \
          aquasec/trivy:0.49.1 \
          fs /work \
          --severity HIGH,CRITICAL \
          --ignore-unfixed \
          --format json \
          -o /work/security-reports/trivy-sca.json

    - name: EPSS + KEV gate
      shell: bash
      run: |
        set -euo pipefail
        python3 scripts/epss_gate.py \
          --input security-reports/trivy-sca.json \
          --output security-reports/epss-findings.json \
          --threshold "${{ inputs.epss_threshold }}"

    # ==================================================
    # DAST (OPTIONAL – MAIN ONLY)
    # ==================================================
    - name: Build app image (DAST)
      if: inputs.run_dast == 'true'
      shell: bash
      run: |
        set -euo pipefail
        docker build -t vuln-bank:ci -f containers/app/Dockerfile .

    - name: ZAP DAST
      if: inputs.run_dast == 'true'
      shell: bash
      run: |
        set -euo pipefail
        docker compose -f docker-compose.dast.yml up -d
        docker run --rm \
          --network vuln-bank_dastnet \
          -e TARGET_URL=http://vuln-bank-dast:5000 \
          -v "$PWD/security-reports/zap:/zap/wrk" \
          -v "$PWD/security-policies/zap-automation.yml:/zap/automation.yml:ro" \
          ghcr.io/zaproxy/zaproxy:2.15.0 \
          zap.sh -cmd -autorun /zap/automation.yml

    # ==================================================
    # ASVS EXPORT
    # ==================================================
    - name: ASVS export
      shell: bash
      run: |
        set -euo pipefail
        python3 scripts/asvs_export.py \
          --tool-map schemas/asvs-tool-map.json \
          --semgrep security-reports/semgrep.json \
          --bandit security-reports/bandit_dd.json \
          --trivy security-reports/trivy-sca.json \
          --gitleaks security-reports/gitleaks.sarif \
          --out-json security-reports/governance/asvs-coverage.json
