<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin Panel - Vulnerable Bank</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='favicon-16.svg') }}">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">

    <!-- CSRF ready -->
    {% if csrf_token is defined %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>

<body>
<div class="container">

    <!-- STATUS MESSAGE -->
    <div id="message" aria-live="polite"></div>

    <!-- HEADER -->
    <header class="admin-header">
        <h1 class="admin-title">Admin Control Panel</h1>
        <p class="admin-subtitle">Privileged Operations — Authorized Only</p>
    </header>

    <!-- ADMIN PROFILE -->
    <section class="profile-section">
        <img class="profile-picture"
             src="{{ url_for('static', filename='uploads/admin.png') }}"
             alt="Admin Profile">
        <h2>System Administrator</h2>
    </section>

    <!-- USER MANAGEMENT -->
    <section class="section">
        <h2>User Management</h2>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Account</th>
                <th>Balance</th>
                <th>Admin</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            {% for user in users %}
            <tr data-user-id="{{ user[0] }}">
                <td>{{ user[0] }}</td>
                <td>{{ user[1] }}</td>
                <td>{{ user[3] }}</td>
                <td>${{ user[4] }}</td>
                <td>{{ 'Yes' if user[5] else 'No' }}</td>
                <td>
                    {% if not user[5] %}
                    <button class="danger-btn delete-user-btn">Delete</button>
                    {% else %}
                    <span class="muted">Protected</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>

    <!-- CREATE ADMIN -->
    <section class="section">
        <h2>Create Admin Account</h2>

        <form id="createAdminForm">
            {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% endif %}

            <label>
                Username
                <input type="text" name="username" required minlength="3">
            </label>

            <label>
                Password
                <input type="password" name="password"
                       required
                       minlength="12"
                       autocomplete="new-password">
            </label>

            <button type="submit">Create Admin</button>
        </form>
    </section>

    <!-- LOANS -->
    <section class="section">
        <h2>Pending Loan Applications</h2>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>User</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            {% for loan in pending_loans %}
            <tr data-loan-id="{{ loan[0] }}">
                <td>{{ loan[0] }}</td>
                <td>{{ loan[1] }}</td>
                <td>${{ loan[2] }}</td>
                <td>{{ loan[3] }}</td>
                <td>
                    <button class="approve-loan-btn">Approve</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>

    <a href="{{ url_for('dashboard') }}" class="button">← Back to Dashboard</a>
</div>

<script>
const token = localStorage.getItem("jwt_token");
if (!token) location.href = "/login";

const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

function showMessage(text, ok = true) {
    const el = document.getElementById("message");
    el.textContent = text;
    el.className = ok ? "success" : "error";
}

document.addEventListener("click", async e => {

    if (e.target.classList.contains("delete-user-btn")) {
        const row = e.target.closest("tr");
        const userId = row.dataset.userId;

        if (!confirm("Delete this user permanently?")) return;

        const res = await fetch(`/admin/delete_account/${userId}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "X-CSRF-Token": csrfToken || ""
            }
        });

        const data = await res.json();
        if (data.status === "success") {
            row.remove();
            showMessage("User deleted");
        } else showMessage("Delete failed", false);
    }

    if (e.target.classList.contains("approve-loan-btn")) {
        const row = e.target.closest("tr");
        const loanId = row.dataset.loanId;

        if (!confirm("Approve this loan?")) return;

        const res = await fetch(`/admin/approve_loan/${loanId}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "X-CSRF-Token": csrfToken || ""
            }
        });

        const data = await res.json();
        if (data.status === "success") {
            row.remove();
            showMessage("Loan approved");
        } else showMessage("Approval failed", false);
    }
});

document.getElementById("createAdminForm").addEventListener("submit", async e => {
    e.preventDefault();

    const form = e.target;
    const payload = Object.fromEntries(new FormData(form));

    const res = await fetch("/admin/create_admin", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken || ""
        },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.status === "success") {
        showMessage("Admin created — page will reload");
        setTimeout(() => location.reload(), 1500);
    } else showMessage("Failed to create admin", false);
});
</script>
</body>
</html>
