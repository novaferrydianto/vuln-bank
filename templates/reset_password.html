<!DOCTYPE html>
<html lang="en">
<head>
    <title>Reset Password - Vuln Bank</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">

    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='favicon-16.svg') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='auth.css') }}">
</head>
<body>

<div class="container">
    <h1>Reset Password</h1>

    <div id="message" role="alert" aria-live="polite"></div>

    <form id="resetPasswordForm" autocomplete="off" novalidate>
        <input
            type="text"
            name="username"
            placeholder="Username"
            required
            minlength="3"
            maxlength="32"
        >

        <input
            type="text"
            name="reset_pin"
            placeholder="6-digit Reset PIN"
            required
            pattern="[0-9]{6}"
            inputmode="numeric"
            autocomplete="one-time-code"
        >

        <input
            type="password"
            name="new_password"
            placeholder="New Password"
            required
            minlength="10"
            autocomplete="new-password"
        >

        <button type="submit">Reset Password</button>
    </form>

    <div class="links">
        <a href="{{ url_for('login') }}">Back to Login</a>
    </div>

    <div class="version-indicator">
        Reset Flow: v2 (CSRF + Hardened)
    </div>
</div>

<script>
/* ======================================================
   RESET PASSWORD â€” HARDENED UX
   ====================================================== */

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(";").shift() : null;
}

function showMessage(msg, type = "error") {
    const el = document.getElementById("message");
    el.textContent = msg;   // âœ… anti-XSS
    el.className = type;
    el.style.color = type === "success" ? "green" : "red";
}

function validatePassword(password) {
    return (
        password.length >= 10 &&
        /[a-z]/.test(password) &&
        /[A-Z]/.test(password) &&
        /[0-9]/.test(password)
    );
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("resetPasswordForm");
    const button = form.querySelector("button");

    let cooldown = false;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (cooldown) return;

        showMessage("");
        button.disabled = true;
        cooldown = true;

        const payload = {
            username: form.username.value.trim(),
            reset_pin: form.reset_pin.value.trim(),
            new_password: form.new_password.value
        };

        if (!validatePassword(payload.new_password)) {
            showMessage(
                "Password must be at least 10 characters and include upper, lower, and number."
            );
            button.disabled = false;
            cooldown = false;
            return;
        }

        const csrfToken = getCookie("csrf_token");

        try {
            const res = await fetch("/reset-password", {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken || ""
                },
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (res.ok && result.status === "success") {
                showMessage(
                    "Password reset successful. Redirecting to loginâ€¦",
                    "success"
                );
                setTimeout(() => location.href = "/login", 2000);
            } else {
                showMessage(
                    "Reset failed. Please check your PIN and try again."
                );
                button.disabled = false;
            }
        } catch {
            showMessage("Network error. Please try again later.");
            button.disabled = false;
        }

        /* ðŸ” UX cooldown (anti-bruteforce hint) */
        setTimeout(() => {
            cooldown = false;
            button.disabled = false;
        }, 3000);
    });
});
</script>

</body>
</html>
