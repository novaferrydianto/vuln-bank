<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login - Vuln Bank</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Hardening headers (frontend-side signaling) -->
    <meta name="robots" content="noindex,nofollow">

    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='favicon-16.svg') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='auth.css') }}">
</head>

<body>
<div class="container">

    <h1>Welcome Back</h1>

    <div id="message" role="alert" aria-live="polite"></div>

    <form id="loginForm" autocomplete="off" novalidate>
        <input
            type="text"
            name="username"
            placeholder="Enter your username"
            required
            minlength="3"
            pattern="[A-Za-z0-9_]+"
            title="Letters, numbers, underscore only"
        >

        <input
            type="password"
            name="password"
            placeholder="Enter your password"
            required
            minlength="8"
            autocomplete="current-password"
        >

        <button type="submit">Login</button>
    </form>

    <div class="links">
        <a href="{{ url_for('register') }}">Don’t have an account? Register</a><br>
        <a href="{{ url_for('forgot_password') }}">Forgot password?</a>
    </div>

    <div class="version-indicator">
        Auth Flow: v2 (Hardened)
    </div>
</div>

<script>
/* ======================================================
   LOGIN — CSRF + ANTI-BRUTEFORCE UX + SAFE TOKEN FLOW
   ====================================================== */

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
        return parts.pop().split(";").shift();
    }
    return null;
}

function showMessage(msg, type = "info") {
    const el = document.getElementById("message");
    el.textContent = msg;                  // ✅ anti-XSS
    el.className = type;
    el.style.color = type === "error" ? "red" : "green";
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("loginForm");
    const button = form.querySelector("button");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        showMessage("");

        const payload = {
            username: form.username.value.trim(),
            password: form.password.value
        };

        // UI-based rate-limit / abuse friction
        button.disabled = true;

        const csrfToken = getCookie("csrf_token");

        try {
            const res = await fetch("/login", {
                method: "POST",
                credentials: "include",            // ✅ allow HttpOnly cookie
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken || ""
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (data.status === "success") {
                showMessage("Login successful. Redirecting…", "success");

                // ✅ TOKEN SHOULD BE SET AS HttpOnly BY SERVER
                setTimeout(() => {
                    window.location.href = "/dashboard";
                }, 1200);
            } else {
                showMessage(
                    "Invalid credentials or account unavailable.",
                    "error"
                );
                button.disabled = false;
            }

        } catch (err) {
            showMessage("Login request received. Try again shortly.", "error");
            button.disabled = false;
        }
    });
});
</script>

</body>
</html>
