<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard - Vulnerable Bank</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='favicon-16.svg') }}">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">

    <!-- CSRF ready (optional backend) -->
    {% if csrf_token is defined %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
</head>

<body>

<!-- Mobile menu -->
<button class="menu-toggle" onclick="toggleSidePanel()">â˜°</button>

<!-- âœ… SINGLE SIDEBAR -->
<aside class="side-panel">
    <div class="bank-logo">
        <h1>Vulnerable Bank</h1>
    </div>

    <nav>
        <a href="#profile" class="nav-link">ğŸ‘¤ Profile</a>
        <a href="#transfers" class="nav-link">â†—ï¸ Transfer</a>
        <a href="#loans" class="nav-link">ğŸ’° Loans</a>
        <a href="#transactions" class="nav-link">ğŸ“Š Transactions</a>
        <a href="#virtual-cards" class="nav-link">ğŸ’³ Virtual Cards</a>
        <a href="#bill-payments" class="nav-link">ğŸ“ƒ Bills</a>

        {% if is_admin %}
        <a href="{{ url_for('admin_panel') }}" class="nav-link">âš™ï¸ Admin</a>
        {% endif %}

        <a href="#" class="nav-link" onclick="confirmLogout(event)">ğŸ”’ Logout</a>
    </nav>
</aside>

<main class="main-content">

<!-- âœ… GREETING (XSS SAFE) -->
<section class="greeting-section">
    <div class="greeting-text">
        <h1>Welcome back, {{ username }}</h1>
        <p id="current-date"></p>
    </div>

    <div class="account-card">
        <div class="account-label">Current Balance</div>
        <div class="account-balance">${{ balance }}</div>
        <div class="account-number-display">
            Account Number: {{ account_number }}
        </div>
    </div>
</section>

<div id="message" aria-live="polite"></div>

<!-- ========= PROFILE ========= -->
<section id="profile" class="dashboard-section profile-section">
    <h2>Profile</h2>

    <img class="profile-picture"
         src="{{ url_for('static', filename='uploads/' + user.profile_picture) if user.profile_picture else url_for('static', filename='uploads/user.png') }}"
         alt="Profile Picture">

    <form id="profileUploadForm" enctype="multipart/form-data">
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <input type="file"
               name="profile_picture"
               accept=".png,.jpg,.jpeg"
               required>

        <button type="submit">Upload</button>
    </form>

    <div id="upload-message"></div>
</section>

<!-- ========= TRANSFER ========= -->
<section id="transfers" class="dashboard-section">
    <h2>Money Transfer</h2>

    <form id="transferForm">
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <input type="text" name="to_account" placeholder="Recipient Account" required>
        <input type="number" name="amount" min="0.01" step="0.01" required>

        <textarea name="description" placeholder="Optional note"></textarea>

        <button type="submit">Send Money</button>
    </form>
</section>

<!-- ========= LOANS ========= -->
<section id="loans" class="dashboard-section">
    <h2>Loan Request</h2>

    <form id="loanForm">
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <input type="number" name="amount" min="1" step="0.01" required>
        <button type="submit">Submit</button>
    </form>

    {% if loans %}
    <table>
        <thead><tr><th>Amount</th><th>Status</th></tr></thead>
        <tbody>
        {% for loan in loans %}
        <tr>
            <td>${{ loan[2] }}</td>
            <td>{{ loan[3] }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}
</section>

<!-- ========= TRANSACTIONS ========= -->
<section id="transactions" class="dashboard-section">
    <h2>Transaction History</h2>
    <div id="transaction-list"></div>
</section>

<!-- ========= FOOTER ========= -->
</main>

<script>
function confirmLogout(e) {
    e.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
        logout();
    }
}
</script>

<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>
