<!DOCTYPE html>
<html lang="en">
<head>
    <title>Forgot Password - Vuln Bank</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">

    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" sizes="16x16" href="{{ url_for('static', filename='favicon-16.svg') }}">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='auth.css') }}">
</head>

<body>
<div class="container">
    <h1>Forgot Password</h1>

    <div id="message" role="alert" aria-live="polite"></div>

    <form id="forgotPasswordForm" autocomplete="off" novalidate>
        <input
            type="text"
            name="username"
            placeholder="Username"
            required
            minlength="3"
            maxlength="32"
            pattern="[A-Za-z0-9_]+"
            title="Letters, numbers, underscore only"
        >
        <button type="submit">Request Reset PIN</button>
    </form>

    <div class="links">
        <a href="{{ url_for('login') }}">Back to Login</a>
    </div>

    <div class="version-indicator">
        Recovery Flow: v2 (Hardened)
    </div>
</div>

<script>
/* ======================================================
   FORGOT PASSWORD â€” HARDENED + ANTI-ENUM
   ====================================================== */

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(";").shift() : null;
}

function showMessage(msg, type = "info") {
    const el = document.getElementById("message");
    el.textContent = msg;                 // âœ… anti-XSS
    el.className = type;
    el.style.color = type === "success" ? "green" : "gray";
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("forgotPasswordForm");
    const button = form.querySelector("button");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        showMessage("");

        button.disabled = true;

        const payload = {
            username: form.username.value.trim()
        };

        const csrfToken = getCookie("csrf_token");

        try {
            await fetch("/forgot-password", {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken || ""
                },
                body: JSON.stringify(payload)
            });

            // ðŸ” Same response no matter what
            showMessage(
                "If the account exists, a reset PIN has been generated.",
                "success"
            );

            setTimeout(() => {
                window.location.href = "/reset-password";
            }, 2000);

        } catch {
            showMessage(
                "If the account exists, a reset PIN has been generated.",
                "success"
            );
        }
    });
});
</script>
</body>
</html>
