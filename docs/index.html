<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vuln Bank – Security Dashboard</title>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111;
      --muted: #666;
      --accent: #4f46e5;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 40px;
      background: var(--bg);
      color: var(--text);
    }

    h1 { margin-bottom: 6px; }
    h2 { margin-top: 50px; }

    .subtitle {
      color: var(--muted);
      margin-bottom: 32px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 48px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }

    .label {
      font-size: 13px;
      color: var(--muted);
    }

    .big {
      font-size: 36px;
      font-weight: 700;
      margin-top: 4px;
    }

    canvas {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      margin-bottom: 40px;
    }

    .error {
      padding: 20px;
      background: #fee2e2;
      border-radius: 10px;
      color: #991b1b;
      font-weight: 600;
    }
  </style>
</head>

<body>

<h1>Vuln Bank – Security Dashboard</h1>
<div class="subtitle">
  Source: <code>docs/data/security-scorecard.json</code> · auto-updated by GitHub Actions
</div>

<!-- ================= EXECUTIVE CARDS ================= -->
<div class="cards">
  <div class="card">
    <div class="label">Overall Score</div>
    <div id="overallScore" class="big">–</div>
  </div>
  <div class="card">
    <div class="label">Grade</div>
    <div id="grade" class="big">–</div>
  </div>
  <div class="card">
    <div class="label">High-Risk CVEs (EPSS)</div>
    <div id="epssCount" class="big">–</div>
  </div>
  <div class="card">
    <div class="label">SLA Breaches</div>
    <div id="slaBreaches" class="big">–</div>
  </div>
</div>

<!-- ================= OVERALL ================= -->
<canvas id="overallChart" height="200"></canvas>

<!-- ================= PER ASSET ================= -->
<h2>Per-Asset Scorecard</h2>
<canvas id="assetChart" height="200"></canvas>

<div id="errorBox" class="error" style="display:none;"></div>

<script>
const SCORECARD_PATH = "./data/security-scorecard.json";

/* ----------------- Helpers ----------------- */
const el = id => document.getElementById(id);
const safe = (v, d = 0) => Number.isFinite(v) ? v : d;

/* ----------------- Renderers ----------------- */
function renderExecutive(data) {
  el("overallScore").innerText = safe(data.score?.overall, "–");
  el("grade").innerText = data.grade || "–";
  el("epssCount").innerText = safe(data.epss?.high_risk_count);
  el("slaBreaches").innerText =
    safe(data.sla?.breaches?.Critical) +
    safe(data.sla?.breaches?.High);
}

function renderOverallChart(data) {
  new Chart(el("overallChart"), {
    type: "radar",
    data: {
      labels: ["OWASP", "EPSS", "SLA"],
      datasets: [{
        label: "Security Posture",
        data: [
          safe(data.score?.owasp),
          safe(data.score?.epss),
          safe(data.score?.sla)
        ],
        fill: true
      }]
    },
    options: {
      scales: {
        r: {
          suggestedMin: 0,
          suggestedMax: 100
        }
      }
    }
  });
}

function renderAssetChart(data) {
  if (!data.assets || Object.keys(data.assets).length === 0) return;

  const labels = Object.keys(data.assets);
  const values = labels.map(a => safe(data.assets[a]?.overall));

  new Chart(el("assetChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Asset Security Score",
        data: values
      }]
    },
    options: {
      scales: {
        y: {
          suggestedMin: 0,
          suggestedMax: 100
        }
      }
    }
  });
}

/* ----------------- Bootstrap ----------------- */
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(SCORECARD_PATH);
    if (!res.ok) throw new Error("Scorecard JSON not found");

    const data = await res.json();
    console.log("Security Scorecard loaded:", data);

    renderExecutive(data);
    renderOverallChart(data);
    renderAssetChart(data);

  } catch (err) {
    console.error(err);
    el("errorBox").style.display = "block";
    el("errorBox").innerText =
      "Failed to load security dashboard data. Check JSON path or GitHub Pages build.";
  }
});
</script>

</body>
</html>
