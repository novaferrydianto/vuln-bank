<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vuln Bank – Security Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .card { border: 1px solid #2222; border-radius: 14px; padding: 16px; }
    .kpi { font-size: 28px; font-weight: 700; }
    .muted { opacity: 0.75; }
    code { background: #00000010; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Vuln Bank – Security Dashboard</h1>
  <p class="muted">Data source: <code>docs/data/*.json</code> (auto-updated weekly by GitHub Actions)</p>

  <div class="grid">
    <div class="card">
      <div class="kpi" id="overallScore">—</div>
      <div id="overallMeta" class="muted">—</div>
    </div>
    <div class="card">
      <canvas id="scoreBreakdown"></canvas>
    </div>
    <div class="card">
      <canvas id="owaspBar"></canvas>
    </div>
    <div class="card">
      <canvas id="trendLine"></canvas>
    </div>
  </div>

  <h2>Per-Asset Scorecard</h2>
  <div class="grid" id="assetCards"></div>

<script>
async function fetchJson(path) {
  const res = await fetch(path, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
  return await res.json();
}

function jsonlToSeries(text) {
  const lines = text.trim().split("\n").filter(Boolean);
  return lines.map(l => JSON.parse(l));
}

async function fetchJsonl(path) {
  const res = await fetch(path, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
  return jsonlToSeries(await res.text());
}

function owaspKeys() {
  return Array.from({length: 10}, (_,i) => `A${String(i+1).padStart(2,"0")}`);
}

function renderAssetCards(assets) {
  const root = document.getElementById("assetCards");
  root.innerHTML = "";
  Object.entries(assets).forEach(([name, v]) => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="kpi">${name.toUpperCase()} – ${v.overall} (${v.grade})</div>
      <div class="muted">OWASP ${v.owasp} • EPSS ${v.epss} • SLA ${v.sla}</div>
      <div class="muted">High-risk EPSS: ${v.raw?.epss?.high_risk_count ?? 0}</div>
    `;
    root.appendChild(el);
  });
}

(async () => {
  const scorecard = await fetchJson("./data/security-scorecard.json");
  const assets = await fetchJson("./data/security-scorecard-assets.json");
  const owaspLatest = await fetchJson("./data/owasp-latest.json");
  const trend = await fetchJsonl("./data/security-scorecard-history.jsonl").catch(() => []);

  // KPI
  document.getElementById("overallScore").textContent =
    `${scorecard.score.overall} / 100 (Grade ${scorecard.grade})`;
  document.getElementById("overallMeta").textContent =
    `Repo: ${scorecard.repo} • Generated: ${scorecard.generated_at}`;

  // Score breakdown (radar)
  new Chart(document.getElementById("scoreBreakdown"), {
    type: "radar",
    data: {
      labels: ["OWASP", "EPSS", "SLA"],
      datasets: [{
        label: "Score",
        data: [scorecard.score.owasp, scorecard.score.epss, scorecard.score.sla]
      }]
    },
    options: { responsive: true, scales: { r: { suggestedMin: 0, suggestedMax: 100 } } }
  });

  // OWASP bar
  const keys = owaspKeys();
  const counts = keys.map(k => (owaspLatest.counts?.[k] ?? 0));
  new Chart(document.getElementById("owaspBar"), {
    type: "bar",
    data: { labels: keys, datasets: [{ label: "OWASP findings (7d)", data: counts }] },
    options: { responsive: true }
  });

  // Trend line (overall)
  if (trend.length > 0) {
    const labels = trend.map(x => (x.generated_at || "").slice(0, 10));
    const overall = trend.map(x => x.score?.overall ?? null);
    new Chart(document.getElementById("trendLine"), {
      type: "line",
      data: { labels, datasets: [{ label: "Overall score (weekly)", data: overall }] },
      options: { responsive: true }
    });
  } else {
    document.getElementById("trendLine").replaceWith(
      Object.assign(document.createElement("div"), { className: "card", textContent: "Trend will appear after 2+ weekly runs." })
    );
  }

  // Assets
  renderAssetCards(assets.assets || {});
})();
</script>
</body>
</html>
