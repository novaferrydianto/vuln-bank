version: "3.8"

services:
  vuln-bank-dast:
    image: ${IMAGE_WITH_TAG}
    container_name: vuln-bank-dast

    environment:
      FLASK_ENV: production

    ports:
      - "5000:5000"

    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://127.0.0.1:5000/healthz', timeout=2)"
        ]
      interval: 15s
      timeout: 5s
      retries: 6

    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    networks:
      - dastnet

  zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: zap
    depends_on:
      vuln-bank-dast:
        condition: service_healthy

    command: >
      zap-baseline.py
      -t http://vuln-bank-dast:5000
      -J zap.json
      -m 5

    volumes:
      - ./security-reports/dast:/zap/wrk

    mem_limit: 2g
    networks:
      - dastnet

networks:
  dastnet:
    driver: bridge
