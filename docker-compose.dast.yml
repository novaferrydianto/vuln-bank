version: "3.9"

services:

  # ============================================================
  # 1) TARGET APPLICATION (LOCAL BUILD IMAGE)
  # ============================================================
  vuln-bank-dast:
    image: vuln-bank:${IMAGE_TAG}
    container_name: vuln-bank-dast
    restart: unless-stopped

    # Penting untuk pengujian DAST
    network_mode: "bridge"
    expose:
      - "5000"

    environment:
      FLASK_ENV: production
      PYTHONUNBUFFERED: 1

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1:5000/"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ============================================================
  # 2) OWASP ZAP (BASELINE + SPIDER + ACTIVE SCAN)
  # ============================================================
  zap:
    image: owasp/zap2docker-stable
    container_name: zap
    restart: unless-stopped

    command: >
      bash -c "
        mkdir -p /zap/wrk &&
        chmod -R 777 /zap/wrk &&
        tail -f /dev/null
      "

    # Agar ZAP + App bisa saling komunikasi
    network_mode: "service:vuln-bank-dast"

    volumes:
      # tempat report baseline, active scan, html
      - ./security-reports/dast:/zap/wrk
      # untuk disable Automation Framework
      - ./zap-scripts:/zap/scripts:rw

    environment:
      ZAP_PORT: 8090
      ZAP_API_KEY: ""
      JAVA_OPTS: "-Xmx2G"

    depends_on:
      vuln-bank-dast:
        condition: service_healthy
